@{
    ViewData["Title"] = "Chi tiết Phiếu Bảo Dưỡng";
    Layout = "~/vn.fpt.edu.views/Shared/_DashboardLayout.cshtml";
    var apiBaseUrl = ViewBag.ApiBaseUrl ?? "https://localhost:7173/api";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="fas fa-wrench me-2"></i>
                        Chi tiết Phiếu Bảo Dưỡng
                    </h4>
                    <div>
                        <a href="/MaintenanceTickets" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-1"></i>
                            Quay lại
                        </a>
                        <a href="#" class="btn btn-warning" id="editTicketBtn">
                            <i class="fas fa-edit me-1"></i>
                            Chỉnh sửa
                        </a>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="row">
                <!-- Left Column - Ticket Info -->
                <div class="col-md-8">
                    <!-- Basic Information -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-info-circle me-2"></i>
                                Thông tin cơ bản
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row" id="basicInfo">
                                <!-- Basic info will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- Vehicle Check-in Information -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-car me-2"></i>
                                Thông tin Vehicle Check-in
                            </h5>
                        </div>
                        <div class="card-body" id="checkinInfo">
                            <!-- Check-in info will be loaded here -->
                        </div>
                    </div>

                    <!-- Service Tasks -->
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-tasks me-2"></i>
                                Danh sách công việc
                            </h5>
                            <button class="btn btn-sm btn-primary" id="addServiceTaskBtn">
                                <i class="fas fa-plus me-1"></i>
                                Thêm công việc
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="serviceTasksList">
                                <!-- Service tasks will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- Components Used -->
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-cogs me-2"></i>
                                Phụ tùng sử dụng
                            </h5>
                            <button class="btn btn-sm btn-primary" id="addComponentBtn">
                                <i class="fas fa-plus me-1"></i>
                                Thêm phụ tùng
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="componentsList">
                                <!-- Components will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column - Actions & Timeline -->
                <div class="col-md-4">
                    <!-- Status & Actions -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-cog me-2"></i>
                                Trạng thái & Thao tác
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="text-center mb-3">
                                <div id="statusBadge" class="mb-2">
                                    <!-- Status badge will be loaded here -->
                                </div>
                                <div id="progressBar" class="mb-3">
                                    <!-- Progress bar will be loaded here -->
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2" id="actionButtons">
                                <!-- Action buttons will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- Timeline -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-history me-2"></i>
                                Lịch sử hoạt động
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="timeline">
                                <!-- Timeline will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- Cost Summary -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-calculator me-2"></i>
                                Tổng chi phí
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="costSummary">
                                <!-- Cost summary will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add Service Task Modal -->
<div class="modal fade" id="addServiceTaskModal" tabindex="-1" aria-labelledby="addServiceTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addServiceTaskModalLabel">Thêm công việc</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="serviceTaskForm">
                    <div class="mb-3">
                        <label for="taskName" class="form-label">Tên công việc <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="taskName" required>
                    </div>
                    <div class="mb-3">
                        <label for="taskDescription" class="form-label">Mô tả</label>
                        <textarea class="form-control" id="taskDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="taskNote" class="form-label">Ghi chú</label>
                        <textarea class="form-control" id="taskNote" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" id="saveServiceTaskBtn">Lưu</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Component Modal -->
<div class="modal fade" id="addComponentModal" tabindex="-1" aria-labelledby="addComponentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addComponentModalLabel">Thêm phụ tùng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="componentForm">
                    <div class="mb-3">
                        <label for="componentSelect" class="form-label">Phụ tùng <span class="text-danger">*</span></label>
                        <select class="form-select" id="componentSelect" required>
                            <option value="">Chọn phụ tùng</option>
                            <!-- Will be loaded dynamically -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="componentQuantity" class="form-label">Số lượng <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="componentQuantity" min="1" required>
                    </div>
                    <div class="mb-3">
                        <label for="componentUnitPrice" class="form-label">Đơn giá (VNĐ)</label>
                        <input type="number" class="form-control" id="componentUnitPrice" min="0" step="1000">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" id="saveComponentBtn">Lưu</button>
            </div>
        </div>
    </div>
</div>

<!-- Confirm Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmModalLabel">Xác nhận</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="confirmModalBody">
                <!-- Content will be set dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-danger" id="confirmModalBtn">Xác nhận</button>
            </div>
        </div>
    </div>
</div>

<script>
const API_BASE_URL = '@apiBaseUrl';
let maintenanceTicketId = @ViewBag.MaintenanceTicketId;
let maintenanceTicketData = null;

$(document).ready(function() {
    loadMaintenanceTicketDetails();
    
    // Modal events
    $('#addServiceTaskBtn').on('click', function() {
        $('#addServiceTaskModal').modal('show');
    });
    
    $('#addComponentBtn').on('click', function() {
        loadComponents();
        $('#addComponentModal').modal('show');
    });
    
    $('#saveServiceTaskBtn').on('click', function() {
        saveServiceTask();
    });
    
    $('#saveComponentBtn').on('click', function() {
        saveComponent();
    });
    
    $('#editTicketBtn').on('click', function() {
        window.location.href = `/MaintenanceTickets/Edit/${maintenanceTicketId}`;
    });

    // Gán kỹ thuật viên (mở modal chọn nhiều)
    $(document).on('click', '#assignTechnicianBtn', function() {
        openAssignTechniciansModal();
    });
});

function loadMaintenanceTicketDetails() {
    const token = localStorage.getItem('authToken');
    fetch(`${API_BASE_URL}/MaintenanceTicket/${maintenanceTicketId}`, {
        headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        }
    })
        .then(async response => {
            if (!response.ok) {
                // Try read json; fallback to text
                try { return { __httpError: true, status: response.status, ...(await response.json()) }; }
                catch { return { __httpError: true, status: response.status, message: await response.text() }; }
            }
            return response.json();
        })
        .then(data => {
            if (data.__httpError) {
                const msg = data.status === 404 ? 'Không tìm thấy phiếu bảo dưỡng hoặc đã bị xóa.' : (data.message || 'Lỗi tải dữ liệu');
                showAlert(msg, 'danger');
                setTimeout(() => window.location.href = '/MaintenanceTickets', 1200);
                return;
            }
            if (data.success) {
                maintenanceTicketData = data.data;
                displayBasicInfo(data.data);
                displayCheckinInfo(data.data);
                displayStatusAndActions(data.data);
                displayTimeline(data.data);
                displayCostSummary(data.data);
                loadServiceTasks();
                // loadComponents(); // Tạm thời comment vì chức năng phụ tùng chưa làm
                $('#componentsList').html('<p class="text-muted text-center py-3"><i class="fas fa-info-circle me-2"></i>Chức năng phụ tùng đang được phát triển</p>');
            } else {
                showAlert('Lỗi tải dữ liệu: ' + data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Có lỗi xảy ra khi tải dữ liệu', 'danger');
        });
}

function displayBasicInfo(data) {
    const basicInfo = $('#basicInfo');
    const createdAt = new Date(data.createdDate).toLocaleDateString('vi-VN');
    const startTime = data.startTime ? new Date(data.startTime).toLocaleDateString('vi-VN') : 'Chưa bắt đầu';
    const endTime = data.endTime ? new Date(data.endTime).toLocaleDateString('vi-VN') : 'Chưa hoàn thành';
    
    basicInfo.html(`
        <div class="col-md-6">
            <strong>Mã phiếu:</strong><br>
            ${data.code || 'MTK-' + data.id}
        </div>
        <div class="col-md-6">
            <strong>Xe:</strong><br>
            ${data.carName || 'N/A'}
        </div>
        <div class="col-md-6">
            <strong>Biển số:</strong><br>
            ${data.licensePlate || 'N/A'}
        </div>
        <div class="col-md-6">
            <strong>Mẫu xe:</strong><br>
            ${data.carModel || 'N/A'}
        </div>
        <div class="col-12"><hr class="my-2"></div>
        <div class="col-md-6">
            <strong>Khách hàng:</strong><br>
            ${data.customerName || 'N/A'}
        </div>
        <div class="col-md-6">
            <strong>Điện thoại:</strong><br>
            ${data.customerPhone || 'N/A'}
        </div>
        <div class="col-12">
            <strong>Địa chỉ:</strong><br>
            ${data.customerAddress || 'N/A'}
        </div>
        <div class="col-md-6">
            <strong>Tư vấn viên:</strong><br>
            ${data.consulterName || 'N/A'}
        </div>
        <div class="col-md-6">
            <strong>Kỹ thuật viên:</strong><br>
            ${data.technicians && data.technicians.length > 0 
                ? data.technicians.map(t => {
                    const roleBadge = t.roleInTicket === 'PRIMARY' 
                        ? '<span class="badge bg-success ms-1">Chính</span>' 
                        : '<span class="badge bg-info ms-1">Phụ</span>';
                    const canRemove = data.statusCode === 'PENDING' || data.statusCode === 'IN_PROGRESS' || data.statusCode === 'ASSIGNED';
                    const removeBtn = canRemove 
                        ? `<button type="button" class="btn btn-sm btn-link text-danger p-0 ms-2" onclick="removeSingleTechnician(${data.id}, ${t.technicianId})" title="Xóa kỹ thuật viên">
                            <i class="fas fa-times"></i>
                           </button>`
                        : '';
                    return `<div class="mb-1 d-flex align-items-center">
                        <span>${t.technicianName || 'N/A'} ${roleBadge}</span>
                        ${removeBtn}
                    </div>`;
                }).join('')
                : (data.technicianName ? `<div>${data.technicianName}</div>` : '<div>Chưa gán</div>')
            }
        </div>
        <div class="col-md-6">
            <strong>Chi nhánh:</strong><br>
            ${data.branchName || 'N/A'}
        </div>
        <div class="col-md-6">
            <strong>Dịch vụ:</strong><br>
            ${data.scheduleServiceName || 'N/A'}
        </div>
        <div class="col-md-6">
            <strong>Ngày tạo:</strong><br>
            ${createdAt}
        </div>
        <div class="col-md-6">
            <strong>Mức độ ưu tiên:</strong><br>
            ${getPriorityBadge(data.priorityLevel)}
        </div>
        <div class="col-md-6">
            <strong>Bắt đầu:</strong><br>
            ${startTime}
        </div>
        <div class="col-md-6">
            <strong>Hoàn thành:</strong><br>
            ${endTime}
        </div>
        <div class="col-12">
            <strong>Mô tả:</strong><br>
            ${data.description || 'Không có mô tả'}
        </div>
    `);
}

function displayCheckinInfo(data) {
    const checkinInfo = $('#checkinInfo');
    
    if (data.vehicleCheckinId) {
        checkinInfo.html(`
            <div class="row">
                <div class="col-md-6">
                    <strong>Mã Check-in:</strong><br>
                    VCI-${data.vehicleCheckinId}
                </div>
                <div class="col-md-6">
                    <strong>Số km:</strong><br>
                    ${data.mileage ? data.mileage.toLocaleString() + ' km' : 'N/A'}
                </div>
            </div>
        `);
    } else {
        checkinInfo.html('<p class="text-muted">Không có thông tin check-in</p>');
    }
}

function displayStatusAndActions(data) {
    const statusBadge = $('#statusBadge');
    const progressBar = $('#progressBar');
    const actionButtons = $('#actionButtons');
    
    // Status badge
    statusBadge.html(getStatusBadge(data.statusCode));
    
    // Progress bar
    const progress = getProgressPercentage(data.statusCode);
    progressBar.html(`
        <div class="progress">
            <div class="progress-bar" role="progressbar" style="width: ${progress}%" aria-valuenow="${progress}" aria-valuemin="0" aria-valuemax="100">
                ${progress}%
            </div>
        </div>
    `);
    
    // Action buttons
    let buttons = '';
    const canCancel = data.statusCode !== 'COMPLETED' && data.statusCode !== 'CANCELLED';
    
    switch(data.statusCode) {
        case 'PENDING':
            buttons = `
                <button class="btn btn-info mb-2" id="assignTechnicianBtn">
                    <i class="fas fa-user-plus me-1"></i>
                    Gán kỹ thuật viên
                </button>
                ${canCancel ? `
                <button class="btn btn-danger" onclick="cancelMaintenanceTicket(${data.id})">
                    <i class="fas fa-times-circle me-1"></i>
                    Hủy phiếu
                </button>
                ` : ''}
            `;
            break;
        case 'ASSIGNED':
            buttons = `
                <button class="btn btn-warning mb-2" onclick="startMaintenance(${data.id})">
                    <i class="fas fa-play me-1"></i>
                    Bắt đầu bảo dưỡng
                </button>
                ${canCancel ? `
                <button class="btn btn-danger" onclick="cancelMaintenanceTicket(${data.id})">
                    <i class="fas fa-times-circle me-1"></i>
                    Hủy phiếu
                </button>
                ` : ''}
            `;
            break;
        case 'IN_PROGRESS':
            buttons = `
                <button class="btn btn-info mb-2" onclick="openAssignTechniciansModal()">
                    <i class="fas fa-user-plus me-1"></i>
                    Thêm kỹ thuật viên
                </button>
                <button class="btn btn-success mb-2" onclick="completeMaintenance(${data.id})">
                    <i class="fas fa-check me-1"></i>
                    Hoàn thành
                </button>
                ${canCancel ? `
                <button class="btn btn-danger" onclick="cancelMaintenanceTicket(${data.id})">
                    <i class="fas fa-times-circle me-1"></i>
                    Hủy phiếu
                </button>
                ` : ''}
            `;
            break;
        case 'COMPLETED':
            buttons = `
                <button class="btn btn-secondary" disabled>
                    <i class="fas fa-check-circle me-1"></i>
                    Đã hoàn thành
                </button>
            `;
            break;
        case 'CANCELLED':
            buttons = `
                <button class="btn btn-danger" disabled>
                    <i class="fas fa-times-circle me-1"></i>
                    Đã hủy
                </button>
            `;
            break;
    }
    
    actionButtons.html(buttons);
}

// Modal chọn kỹ thuật viên
function openAssignTechniciansModal() {
    const modalHtml = `
    <div class="modal fade" id="assignTechniciansModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">${(maintenanceTicketData.technicians && maintenanceTicketData.technicians.length > 0) ? 'Thêm/Chỉnh sửa kỹ thuật viên' : 'Gán kỹ thuật viên'}</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            ${(maintenanceTicketData.technicians && maintenanceTicketData.technicians.length > 0) ? `
            <div class="alert alert-info mb-3">
              <i class="fas fa-info-circle me-1"></i>
              <strong>Danh sách hiện tại:</strong> ${maintenanceTicketData.technicians.map(t => t.technicianName).join(', ')}
              <br><small>Bạn có thể thêm kỹ thuật viên mới hoặc bỏ chọn để xóa người không còn tham gia.</small>
            </div>
            ` : ''}
            <div class="mb-3">
              <input type="text" class="form-control" id="assignTechSearch" placeholder="Tìm kỹ thuật viên theo tên hoặc username...">
              <small class="text-muted">Gõ để lọc nhanh. Kết quả hiển thị tức thì như Google.</small>
            </div>
            <div class="mb-3">
              <label class="form-label">Chọn kỹ thuật viên chính</label>
              <select id="primaryTechSelect" class="form-select">
                <option value="">-- Chưa chọn --</option>
              </select>
            </div>
            <div id="assignTechContainer" class="row g-2"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
            <button type="button" class="btn btn-primary" id="saveAssignTechBtn">Lưu</button>
          </div>
        </div>
      </div>
    </div>`;

    $('body').append(modalHtml);
    const modal = new bootstrap.Modal(document.getElementById('assignTechniciansModal'));
    modal.show();

    // Tải danh sách kỹ thuật viên
    const token = localStorage.getItem('authToken');
    fetch(`${API_BASE_URL}/Employee/filter?roleId=4`, {
        headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        }
    })
      .then(r => {
          if (!r.ok) {
              throw new Error(`HTTP error! status: ${r.status}`);
          }
          return r.json();
      })
      .then(list => {
        const container = $('#assignTechContainer');
        container.empty();
        const employees = (list || []).map(emp => ({
          id: emp.id,
          name: (`${emp.firstName || ''} ${emp.lastName || ''}`).trim() || emp.username || `#${emp.id}`,
          username: emp.username || ''
        }));

        function render(listToRender) {
          container.empty();
          if (!listToRender || listToRender.length === 0) {
            container.html('<div class="text-center text-muted py-3">Không có kỹ thuật viên phù hợp</div>');
            return;
          }
          listToRender.forEach(emp => {
            const checked = (maintenanceTicketData.technicians || []).some(t => t.technicianId === emp.id) ? 'checked' : '';
            container.append(`
              <div class="col-md-6">
                <div class="form-check border rounded p-2">
                  <input class="form-check-input assign-tech-checkbox" type="checkbox" value="${emp.id}" id="assign_${emp.id}" ${checked}>
                  <label class="form-check-label w-100" for="assign_${emp.id}"><strong>${emp.name}</strong><br><small class="text-muted">${emp.username}</small></label>
                </div>
              </div>
            `);
          });
          // Build primary select options
          const primarySelect = $('#primaryTechSelect');
          primarySelect.empty();
          primarySelect.append('<option value="">-- Chưa chọn --</option>');
          listToRender.forEach(emp => {
            const isPrimary = (maintenanceTicketData.technicians || []).some(t => t.technicianId === emp.id && t.roleInTicket === 'PRIMARY');
            primarySelect.append(`<option value="${emp.id}" ${isPrimary ? 'selected' : ''}>${emp.name}</option>`);
          });
        }

        // Lần đầu render tất cả
        render(employees);

        // Lọc theo thời gian thực với debounce
        let t;
        $('#assignTechSearch').on('input', function() {
          clearTimeout(t);
          const q = $(this).val().toLowerCase();
          t = setTimeout(() => {
            if (!q) { render(employees); return; }
            const filtered = employees.filter(e => e.name.toLowerCase().includes(q) || e.username.toLowerCase().includes(q));
            render(filtered);
          }, 120);
        });
      })
      .catch(error => {
          console.error('Error loading employees:', error);
          $('#assignTechContainer').html('<div class="text-center text-danger py-3">Lỗi tải danh sách kỹ thuật viên: ' + error.message + '</div>');
          showAlert('Không thể tải danh sách kỹ thuật viên. Vui lòng thử lại sau.', 'danger');
      });

    $(document).on('click', '#saveAssignTechBtn', function() {
      const ids = [];
      $('.assign-tech-checkbox:checked').each(function(){ ids.push(parseInt($(this).val())); });
      const primaryIdVal = $('#primaryTechSelect').val();
      const primaryId = primaryIdVal ? parseInt(primaryIdVal) : null;
      if (primaryId && !ids.includes(primaryId)) ids.push(primaryId);
      const token = localStorage.getItem('authToken');
      fetch(`${API_BASE_URL}/MaintenanceTicket/${maintenanceTicketId}/technicians`, {
        method: 'PUT',
        headers: { 
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ technicianIds: ids, primaryId })
      }).then(r => r.json()).then(res => {
        if (res.success) {
          maintenanceTicketData = res.data;
          displayBasicInfo(maintenanceTicketData);
          displayStatusAndActions(maintenanceTicketData);
          showAlert('Gán kỹ thuật viên thành công', 'success');
          bootstrap.Modal.getInstance(document.getElementById('assignTechniciansModal')).hide();
          $('#assignTechniciansModal').remove();
        } else {
          showAlert(res.message || 'Gán kỹ thuật viên thất bại', 'danger');
        }
      }).catch(()=> showAlert('Lỗi kết nối máy chủ', 'danger'));
    });
}

function displayTimeline(data) {
    const timeline = $('#timeline');
    const events = [];
    
    // Add events based on data
    if (data.createdDate) {
        events.push({
            date: new Date(data.createdDate),
            title: 'Tạo phiếu bảo dưỡng',
            description: 'Phiếu bảo dưỡng được tạo',
            icon: 'fas fa-plus-circle',
            color: 'primary'
        });
    }
    
    if (data.technicianName) {
        events.push({
            date: new Date(data.createdDate), // You might want to track actual assignment date
            title: 'Gán kỹ thuật viên',
            description: `Gán cho ${data.technicianName}`,
            icon: 'fas fa-user-plus',
            color: 'info'
        });
    }
    
    if (data.startTime) {
        events.push({
            date: new Date(data.startTime),
            title: 'Bắt đầu bảo dưỡng',
            description: 'Bắt đầu thực hiện bảo dưỡng',
            icon: 'fas fa-play',
            color: 'warning'
        });
    }
    
    if (data.endTime) {
        events.push({
            date: new Date(data.endTime),
            title: 'Hoàn thành bảo dưỡng',
            description: 'Bảo dưỡng đã hoàn thành',
            icon: 'fas fa-check-circle',
            color: 'success'
        });
    }
    
    if (data.statusCode === 'CANCELLED') {
        events.push({
            date: new Date(data.createdDate), // Hoặc có thể có cancelledDate nếu có
            title: 'Hủy phiếu bảo dưỡng',
            description: 'Phiếu bảo dưỡng đã được hủy',
            icon: 'fas fa-times-circle',
            color: 'danger'
        });
    }
    
    // Sort events by date
    events.sort((a, b) => a.date - b.date);
    
    if (events.length === 0) {
        timeline.html('<p class="text-muted">Chưa có hoạt động nào</p>');
        return;
    }
    
    let timelineHtml = '';
    events.forEach((event, index) => {
        const isLast = index === events.length - 1;
                timelineHtml += `
                    <div class="d-flex ${!isLast ? 'mb-3' : ''}">
                        <div class="flex-shrink-0">
                    <div class="bg-${event.color} text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                        <i class="${event.icon}"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                    <h6 class="mb-1">${event.title}</h6>
                    <p class="mb-1 text-muted">${event.description}</p>
                    <small class="text-muted">${event.date.toLocaleDateString('vi-VN')} ${event.date.toLocaleTimeString('vi-VN')}</small>
                        </div>
                    </div>
                    ${!isLast ? '<hr class="my-2">' : ''}
                `;
            });
            
            timeline.html(timelineHtml);
}

function displayCostSummary(data) {
    const costSummary = $('#costSummary');
    const estimatedCost = data.totalEstimatedCost || 0;
    
    costSummary.html(`
        <div class="text-center">
            <h4 class="text-primary">${new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(estimatedCost)}</h4>
            <p class="text-muted mb-0">Chi phí ước tính</p>
        </div>
        <hr>
        <div class="row text-center">
            <div class="col-6">
                <h6 class="text-muted">Phụ tùng</h6>
                <p class="mb-0">0 VNĐ</p>
            </div>
            <div class="col-6">
                <h6 class="text-muted">Nhân công</h6>
                <p class="mb-0">0 VNĐ</p>
            </div>
        </div>
    `);
}

function loadServiceTasks() {
    // Lấy token để authenticate
    const token = localStorage.getItem('authToken');
    
    fetch(`${API_BASE_URL}/ServiceTask/by-ticket/${maintenanceTicketId}`, {
        headers: {
            'Authorization': token ? `Bearer ${token}` : ''
        }
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayServiceTasks(data.data || []);
            } else {
                console.error('Error loading service tasks:', data.message);
                $('#serviceTasksList').html('<p class="text-muted text-danger">Lỗi tải danh sách công việc</p>');
            }
        })
        .catch(error => {
            console.error('Error loading service tasks:', error);
            $('#serviceTasksList').html('<p class="text-muted text-danger">Lỗi tải danh sách công việc</p>');
        });
}

function displayServiceTasks(tasks) {
    const container = $('#serviceTasksList');
    
    if (!tasks || tasks.length === 0) {
        container.html('<p class="text-muted text-center py-3"><i class="fas fa-inbox me-2"></i>Chưa có công việc nào</p>');
        return;
    }
    
    let html = '';
    tasks.forEach(task => {
        const statusBadge = getTaskStatusBadge(task.statusCode);
        html += `
            <div class="card mb-2 border-start border-3 ${getTaskBorderColor(task.statusCode)}">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6 class="mb-1 fw-bold">${escapeHtml(task.taskName || 'N/A')}</h6>
                            ${task.description ? `<p class="mb-1 text-muted small">${escapeHtml(task.description)}</p>` : ''}
                            ${task.note ? `<div class="mt-2"><small class="text-info"><i class="fas fa-sticky-note me-1"></i>${escapeHtml(task.note)}</small></div>` : ''}
                        </div>
                        <div class="ms-3 text-end">
                            ${statusBadge}
                            ${task.statusCode === 'PENDING' ? `
                                <button class="btn btn-sm btn-primary mt-2" onclick="updateTaskStatus(${task.id}, 'IN_PROGRESS')" title="Bắt đầu">
                                    <i class="fas fa-play"></i>
                                </button>
                            ` : ''}
                            ${task.statusCode === 'IN_PROGRESS' ? `
                                <button class="btn btn-sm btn-success mt-2" onclick="updateTaskStatus(${task.id}, 'DONE')" title="Hoàn thành">
                                    <i class="fas fa-check"></i>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.html(html);
}

function updateTaskStatus(taskId, newStatus) {
    const token = localStorage.getItem('authToken');
    
    fetch(`${API_BASE_URL}/ServiceTask/${taskId}/status`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': token ? `Bearer ${token}` : ''
        },
        body: JSON.stringify({ statusCode: newStatus })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Cập nhật trạng thái công việc thành công!', 'success');
            loadServiceTasks(); // Reload danh sách
        } else {
            showAlert('Lỗi: ' + (data.message || 'Không thể cập nhật trạng thái'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Có lỗi xảy ra khi cập nhật trạng thái', 'danger');
    });
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function getTaskBorderColor(statusCode) {
    const colorMap = {
        'PENDING': 'border-warning',
        'IN_PROGRESS': 'border-primary',
        'DONE': 'border-success',
        'CANCELLED': 'border-danger'
    };
    return colorMap[statusCode] || 'border-secondary';
}

function loadComponents() {
    // Tạm thời comment vì chức năng phụ tùng chưa làm
    $('#componentsList').html('<p class="text-muted text-center py-3"><i class="fas fa-info-circle me-2"></i>Chức năng phụ tùng đang được phát triển</p>');
    
    /* 
    const token = localStorage.getItem('authToken');
    fetch(`${API_BASE_URL}/TicketComponent/by-maintenance-ticket/${maintenanceTicketId}`, {
        headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        }
    })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                displayComponents(data.data);
            }
        })
        .catch(error => {
            console.error('Error loading components:', error);
            $('#componentsList').html('<p class="text-danger">Lỗi tải danh sách phụ tùng: ' + error.message + '</p>');
        });
    */
}

function displayComponents(components) {
    const container = $('#componentsList');
    
    if (components.length === 0) {
        container.html('<p class="text-muted">Chưa sử dụng phụ tùng nào</p>');
        return;
    }
    
    let html = '<div class="table-responsive"><table class="table table-sm"><thead><tr><th>Phụ tùng</th><th>Số lượng</th><th>Đơn giá</th><th>Thành tiền</th></tr></thead><tbody>';
    
    components.forEach(component => {
        const total = component.quantity * (component.unitPrice || 0);
        html += `
            <tr>
                <td>${component.componentName || 'N/A'}</td>
                <td>${component.quantity}</td>
                <td>${new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(component.unitPrice || 0)}</td>
                <td>${new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(total)}</td>
            </tr>
        `;
    });
    
    html += '</tbody></table></div>';
    container.html(html);
}

// Helper functions
function getStatusBadge(statusCode) {
    const statusMap = {
        'PENDING': { class: 'bg-warning', text: 'Chờ xử lý' },
        'ASSIGNED': { class: 'bg-info', text: 'Đã gán' },
        'IN_PROGRESS': { class: 'bg-primary', text: 'Đang thực hiện' },
        'COMPLETED': { class: 'bg-success', text: 'Hoàn thành' },
        'CANCELLED': { class: 'bg-danger', text: 'Đã hủy' }
    };
    
    const status = statusMap[statusCode] || { class: 'bg-secondary', text: statusCode };
    return `<span class="badge ${status.class} fs-6">${status.text}</span>`;
}

function getPriorityBadge(priority) {
    const priorityMap = {
        'NORMAL': { class: 'bg-secondary', text: 'Bình thường' },
        'HIGH': { class: 'bg-warning', text: 'Cao' },
        'URGENT': { class: 'bg-danger', text: 'Khẩn cấp' }
    };
    
    const priorityInfo = priorityMap[priority] || { class: 'bg-secondary', text: priority };
    return `<span class="badge ${priorityInfo.class}">${priorityInfo.text}</span>`;
}

function getProgressPercentage(statusCode) {
    const progressMap = {
        'PENDING': 25,
        'ASSIGNED': 50,
        'IN_PROGRESS': 75,
        'COMPLETED': 100,
        'CANCELLED': 0
    };
    
    return progressMap[statusCode] || 0;
}

function getTaskStatusBadge(statusCode) {
    const statusMap = {
        'PENDING': { class: 'bg-warning', text: 'Chờ' },
        'IN_PROGRESS': { class: 'bg-primary', text: 'Đang làm' },
        'DONE': { class: 'bg-success', text: 'Xong' }
    };
    
    const status = statusMap[statusCode] || { class: 'bg-secondary', text: statusCode };
    return `<span class="badge ${status.class}">${status.text}</span>`;
}

// Action functions
function assignTechnician(ticketId) {
    // Implementation for assigning technician
    showAlert('Chức năng gán kỹ thuật viên đang được phát triển', 'info');
}

function showConfirmModal(message, onConfirm) {
    $('#confirmModalBody').html(message);
    $('#confirmModalBtn').off('click').on('click', function() {
        $('#confirmModal').modal('hide');
        if (onConfirm) onConfirm();
    });
    $('#confirmModal').modal('show');
}

function startMaintenance(ticketId) {
    showConfirmModal(
        '<p>Bạn có chắc chắn muốn bắt đầu bảo dưỡng không?</p>',
        function() {
            executeStartMaintenance(ticketId);
        }
    );
}

function executeStartMaintenance(ticketId) {
    const token = localStorage.getItem('authToken');
    
    fetch(`${API_BASE_URL}/MaintenanceTicket/${ticketId}/start`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': token ? `Bearer ${token}` : ''
        }
    })
    .then(async response => {
        const data = await response.json();
        if (!response.ok) {
            throw new Error(data.message || 'Lỗi khi bắt đầu bảo dưỡng');
        }
        return data;
    })
    .then(data => {
        if (data.success) {
            showAlert('Bắt đầu bảo dưỡng thành công!', 'success');
            loadMaintenanceTicketDetails(); // Reload để cập nhật UI
        } else {
            showAlert('Lỗi: ' + (data.message || 'Không thể bắt đầu bảo dưỡng'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Có lỗi xảy ra: ' + error.message, 'danger');
    });
}

function completeMaintenance(ticketId) {
    showConfirmModal(
        '<p>Bạn có chắc chắn muốn hoàn thành phiếu bảo dưỡng này không?</p>',
        function() {
            executeCompleteMaintenance(ticketId);
        }
    );
}

function removeSingleTechnician(ticketId, technicianId) {
    // Tìm tên kỹ thuật viên để hiển thị trong popup
    const technician = maintenanceTicketData?.technicians?.find(t => t.technicianId === technicianId);
    const technicianName = technician ? technician.technicianName : 'kỹ thuật viên này';
    
    showConfirmModal(
        `<p>Bạn có chắc chắn muốn xóa <strong>${technicianName}</strong> khỏi phiếu bảo dưỡng?</p>`,
        function() {
            executeRemoveTechnician(ticketId, technicianId);
        }
    );
}

function executeRemoveTechnician(ticketId, technicianId) {
    if (!maintenanceTicketData || !maintenanceTicketData.technicians) {
        showAlert('Không tìm thấy dữ liệu kỹ thuật viên', 'danger');
        return;
    }

    // Lấy danh sách kỹ thuật viên còn lại (loại bỏ người được xóa)
    const remainingTechnicians = maintenanceTicketData.technicians
        .filter(t => t.technicianId !== technicianId)
        .map(t => t.technicianId);

    // Xác định primary mới (nếu người bị xóa là primary, chọn người đầu tiên còn lại)
    let primaryId = null;
    const currentPrimary = maintenanceTicketData.technicians.find(t => t.roleInTicket === 'PRIMARY');
    
    if (remainingTechnicians.length > 0) {
        // Còn kỹ thuật viên khác
        if (currentPrimary && currentPrimary.technicianId === technicianId) {
            // Nếu xóa primary, chọn người đầu tiên còn lại làm primary
            primaryId = remainingTechnicians[0];
        } else if (currentPrimary) {
            // Giữ nguyên primary hiện tại nếu không bị xóa
            primaryId = currentPrimary.technicianId;
        } else {
            // Nếu không có primary, chọn người đầu tiên
            primaryId = remainingTechnicians[0];
        }
    }
    // Nếu remainingTechnicians.length === 0, primaryId sẽ là null (không còn ai)

    const token = localStorage.getItem('authToken');
    fetch(`${API_BASE_URL}/MaintenanceTicket/${ticketId}/technicians`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ 
            technicianIds: remainingTechnicians, 
            primaryId: primaryId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Xóa kỹ thuật viên thành công', 'success');
            maintenanceTicketData = data.data;
            displayBasicInfo(maintenanceTicketData);
            displayStatusAndActions(maintenanceTicketData);
        } else {
            showAlert(data.message || 'Xóa kỹ thuật viên thất bại', 'danger');
        }
    })
    .catch(error => {
        console.error('Error removing technician:', error);
        showAlert('Có lỗi xảy ra khi xóa kỹ thuật viên', 'danger');
    });
}

function executeCompleteMaintenance(ticketId) {
    const token = localStorage.getItem('authToken');
    
    fetch(`${API_BASE_URL}/MaintenanceTicket/${ticketId}/complete`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': token ? `Bearer ${token}` : ''
        }
    })
    .then(async response => {
        const data = await response.json();
        if (!response.ok) {
            throw new Error(data.message || 'Lỗi khi hoàn thành phiếu bảo dưỡng');
        }
        return data;
    })
    .then(data => {
        if (data.success) {
            showAlert('Hoàn thành phiếu bảo dưỡng thành công!', 'success');
            loadMaintenanceTicketDetails(); // Reload để cập nhật UI
        } else {
            showAlert('Lỗi: ' + (data.message || 'Không thể hoàn thành phiếu'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Có lỗi xảy ra: ' + error.message, 'danger');
    });
}

function cancelMaintenanceTicket(ticketId) {
    showConfirmModal(
        '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i><strong>Cảnh báo!</strong></div><p>Bạn có chắc chắn muốn hủy phiếu bảo dưỡng này không? Hành động này không thể hoàn tác.</p>',
        function() {
            executeCancelMaintenanceTicket(ticketId);
        }
    );
}

function executeCancelMaintenanceTicket(ticketId) {
    const token = localStorage.getItem('authToken');
    
    fetch(`${API_BASE_URL}/MaintenanceTicket/${ticketId}/cancel`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': token ? `Bearer ${token}` : ''
        }
    })
    .then(async response => {
        const data = await response.json();
        if (!response.ok) {
            throw new Error(data.message || 'Lỗi khi hủy phiếu bảo dưỡng');
        }
        return data;
    })
    .then(data => {
        if (data.success) {
            showAlert('Hủy phiếu bảo dưỡng thành công!', 'success');
            loadMaintenanceTicketDetails(); // Reload để cập nhật UI
        } else {
            showAlert('Lỗi: ' + (data.message || 'Không thể hủy phiếu'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Có lỗi xảy ra: ' + error.message, 'danger');
    });
}

function saveServiceTask() {
    const taskName = $('#taskName').val().trim();
    const taskDescription = $('#taskDescription').val().trim();
    const taskNote = $('#taskNote').val().trim();
    
    if (!taskName) {
        showAlert('Vui lòng nhập tên công việc', 'warning');
        return;
    }
    
    const taskData = {
        maintenanceTicketId: maintenanceTicketId,
        taskName: taskName,
        description: taskDescription || null,
        note: taskNote || null,
        statusCode: 'PENDING' // Mặc định là PENDING
    };
    
    // Lấy token để authenticate
    const token = localStorage.getItem('authToken');
    
    // Show loading
    const btn = $('#saveServiceTaskBtn');
    const originalText = btn.html();
    btn.html('<i class="fas fa-spinner fa-spin me-1"></i>Đang lưu...');
    btn.prop('disabled', true);
    
    fetch(`${API_BASE_URL}/ServiceTask`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': token ? `Bearer ${token}` : ''
        },
        body: JSON.stringify(taskData)
    })
    .then(response => response.json())
    .then(data => {
        btn.html(originalText);
        btn.prop('disabled', false);
        
        if (data.success) {
            showAlert('Thêm công việc thành công!', 'success');
            $('#addServiceTaskModal').modal('hide');
            // Reset form
            $('#serviceTaskForm')[0].reset();
            // Reload danh sách công việc
            loadServiceTasks();
        } else {
            showAlert('Lỗi: ' + (data.message || 'Không thể thêm công việc'), 'danger');
        }
    })
    .catch(error => {
        btn.html(originalText);
        btn.prop('disabled', false);
        console.error('Error:', error);
        showAlert('Có lỗi xảy ra khi thêm công việc', 'danger');
    });
}

function saveComponent() {
    // Implementation for saving component
    showAlert('Chức năng thêm phụ tùng đang được phát triển', 'info');
}

function showAlert(message, type) {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show position-fixed" 
             style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    $('body').append(alertHtml);
    
    setTimeout(() => {
        $('.alert').alert('close');
    }, 3000);
}
</script>
