@{
    ViewData["Title"] = "Chi ti·∫øt Phi·∫øu B·∫£o D∆∞·ª°ng";
    Layout = "~/vn.fpt.edu.views/Shared/_DashboardLayout.cshtml";
    var apiBaseUrl = ViewBag.ApiBaseUrl ?? "https://localhost:7173/api";
}

<style>
    .basic-info-grid .info-section-title {
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        color: var(--bs-secondary);
        margin-bottom: 0.75rem;
    }

    .basic-info-grid .info-section + .info-section {
        border-top: 1px solid var(--bs-border-color);
        padding-top: 1.5rem;
    }

    .basic-info-grid .info-row {
        padding: 0.35rem 0;
        border-bottom: 1px dashed rgba(0, 0, 0, 0.05);
    }

    .basic-info-grid .info-row:last-child {
        border-bottom: none;
    }

    .basic-info-grid .info-label {
        font-size: 0.85rem;
        font-weight: 500;
    }

    .basic-info-grid .info-value {
        font-size: 0.95rem;
    }

    .basic-info-grid .info-text-wrap {
        white-space: normal;
        word-break: break-word;
    }

    .basic-info-grid .info-description {
        background: rgba(0, 0, 0, 0.02);
        border: 1px solid var(--bs-border-color);
        border-radius: 0.5rem;
        padding: 1rem;
        font-size: 0.95rem;
        min-height: 3rem;
    }

    .basic-info-grid .info-description p {
        margin-bottom: 0.5rem;
    }

    .basic-info-grid .info-description p:last-child {
        margin-bottom: 0;
    }

    .basic-info-grid .tech-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .basic-info-grid .tech-pill {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.4rem 0.7rem;
        border-radius: 999px;
        border: 1px solid var(--bs-border-color);
        background-color: var(--bs-light);
        font-size: 0.85rem;
    }

    .basic-info-grid .tech-pill .btn-link {
        font-size: 0.75rem;
    }

    @@media (min-width: 576px) {
        .basic-info-grid .info-row {
            display: grid;
            grid-template-columns: 160px 1fr;
            align-items: start;
            gap: 0.25rem 0.75rem;
        }
        .basic-info-grid .info-label {
            min-width: 160px;
            text-align: right;
        }
        .basic-info-grid .info-value {
            padding-left: 0;
        }
    }

    /* Timeline styles for activity history modal */
    .timeline-vertical {
        position: relative;
    }

    .timeline-item {
        position: relative;
    }

    .timeline-icon {
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: transform 0.2s;
    }

    .timeline-item:hover .timeline-icon {
        transform: scale(1.1);
    }

    .timeline-line {
        position: relative;
    }

    #activityHistoryCard:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        transition: box-shadow 0.2s;
    }

    /* Component Card Styles */
    .component-card {
        transition: all 0.2s ease;
        cursor: pointer;
    }

    .component-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        border-color: #0d6efd !important;
    }

    .component-item.selected .component-card {
        border-color: #0d6efd !important;
        background-color: #e7f1ff !important;
        box-shadow: 0 2px 8px rgba(13, 110, 253, 0.2);
    }

    #componentListContainer {
        scrollbar-width: thin;
        scrollbar-color: #cbd5e0 #f7fafc;
    }

    #componentListContainer::-webkit-scrollbar {
        width: 8px;
    }

    #componentListContainer::-webkit-scrollbar-track {
        background: #f7fafc;
        border-radius: 4px;
    }

    #componentListContainer::-webkit-scrollbar-thumb {
        background: #cbd5e0;
        border-radius: 4px;
    }

    #componentListContainer::-webkit-scrollbar-thumb:hover {
        background: #a0aec0;
    }
</style>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="fas fa-wrench me-2"></i>
                        Chi ti·∫øt Phi·∫øu B·∫£o D∆∞·ª°ng
                    </h4>
                    <div>
                        <a href="/MaintenanceTickets" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-1"></i>
                            Quay l·∫°i
                        </a>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="row">
                <!-- Left Column - Ticket Info -->
                <div class="col-md-8">
                    <!-- Basic Information -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-info-circle me-2"></i>
                                Th√¥ng tin c∆° b·∫£n
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row" id="basicInfo">
                                <!-- Basic info will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- Vehicle Check-in Information -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-car me-2"></i>
                                Th√¥ng tin Vehicle Check-in
                            </h5>
                        </div>
                        <div class="card-body" id="checkinInfo">
                            <!-- Check-in info will be loaded here -->
                        </div>
                    </div>

                    <!-- Service Tasks -->
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-tasks me-2"></i>
                                Danh s√°ch c√¥ng vi·ªác
                            </h5>
                            <button class="btn btn-sm btn-outline-primary" id="addServiceTaskBtn">
                                <i class="fas fa-plus me-1"></i>
                                Th√™m c√¥ng vi·ªác
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="serviceTasksList">
                                <!-- Service tasks will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- Components Used -->
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-cogs me-2"></i>
                                Ph·ª• t√πng s·ª≠ d·ª•ng
                            </h5>
                            <div>
                                <button class="btn btn-sm btn-outline-primary me-2" id="applyServicePackageBtn" style="display: none;" title="√Åp d·ª•ng g√≥i d·ªãch v·ª•">
                                    <i class="fas fa-box me-1"></i>
                                    √Åp d·ª•ng g√≥i d·ªãch v·ª•
                                </button>
                                <button class="btn btn-sm btn-outline-primary" id="addComponentBtn" style="display: none;">
                                <i class="fas fa-plus me-1"></i>
                                Th√™m ph·ª• t√πng
                            </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Service Package Info -->
                            <div id="servicePackageInfo" class="alert alert-light border mb-3" style="display: none;">
                                <i class="fas fa-box me-2"></i>
                                <strong>G√≥i d·ªãch v·ª• ƒë√£ √°p d·ª•ng:</strong> 
                                <span id="servicePackageNameDisplay"></span>
                                <span class="text-dark ms-2" id="servicePackagePriceDisplay"></span>
                            </div>
                            <div id="componentsList">
                                <!-- Components will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column - Actions & Timeline -->
                <div class="col-md-4">
                    <!-- Status & Actions -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-cog me-2"></i>
                                Tr·∫°ng th√°i & Thao t√°c
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="text-center mb-3">
                                <div id="statusBadge" class="mb-2">
                                    <!-- Status badge will be loaded here -->
                                </div>
                                <div id="progressBar" class="mb-3">
                                    <!-- Progress bar will be loaded here -->
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2" id="actionButtons">
                                <!-- Action buttons will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- Timeline -->
                    <div class="card mb-4" id="activityHistoryCard" style="cursor: pointer;" onclick="openActivityHistoryModal()">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-history me-2"></i>
                                L·ªãch s·ª≠ ho·∫°t ƒë·ªông
                                <i class="fas fa-external-link-alt ms-2" style="font-size: 0.8em; opacity: 0.7;"></i>
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="timeline">
                                <!-- Timeline will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- Cost Summary -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-calculator me-2"></i>
                                T·ªïng chi ph√≠
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="costSummary">
                                <!-- Cost summary will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Service Task Modal -->
<div class="modal fade" id="addServiceTaskModal" tabindex="-1" aria-labelledby="addServiceTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addServiceTaskModalLabel">Th√™m c√¥ng vi·ªác</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="serviceTaskForm">
                    <input type="hidden" id="taskId">
                    <div class="mb-3">
                        <label for="taskName" class="form-label">T√™n c√¥ng vi·ªác <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="taskName" required>
                    </div>
                    <div class="mb-3">
                        <label for="taskDescription" class="form-label">M√¥ t·∫£</label>
                        <textarea class="form-control" id="taskDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="taskStandardLaborTime" class="form-label">Th·ªùi gian chu·∫©n (gi·ªù)</label>
                        <input type="number" class="form-control" id="taskStandardLaborTime" min="0" max="999.99" step="0.01" placeholder="VD: 0.5">
                        <small class="text-dark">Th·ªùi gian ∆∞·ªõc t√≠nh ƒë·ªÉ ho√†n th√†nh c√¥ng vi·ªác (gi·ªù)</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">K·ªπ thu·∫≠t vi√™n</label>
                        <div id="taskTechniciansContainer" class="border rounded p-2" style="max-height: 200px; overflow-y: auto;">
                            <small class="text-dark">ƒêang t·∫£i danh s√°ch...</small>
                        </div>
                        
                    </div>
                    <div class="mb-3">
                        <label for="taskNote" class="form-label">Ghi ch√∫</label>
                        <textarea class="form-control" id="taskNote" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-primary" id="saveServiceTaskBtn">L∆∞u</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Component Modal -->
<div class="modal fade" id="addComponentModal" tabindex="-1" aria-labelledby="addComponentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="addComponentModalLabel">
                    <i class="fas fa-cog me-2"></i>Th√™m ph·ª• t√πng
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="componentForm">
                    <!-- Search Section -->
                    <div class="mb-4">
                        <div class="input-group input-group-lg">
                            <span class="input-group-text bg-light">
                                <i class="fas fa-search text-muted"></i>
                            </span>
                            <input type="text" class="form-control" id="componentSearch" 
                                   placeholder="T√¨m ki·∫øm ph·ª• t√πng theo t√™n ho·∫∑c m√£..." 
                                   autocomplete="off">
                        </div>
                    </div>

                    <!-- Component List -->
                    <div class="mb-4">
                        <label class="form-label fw-semibold mb-2">
                            <i class="fas fa-list me-1"></i>Ch·ªçn ph·ª• t√πng <span class="text-danger">*</span>
                        </label>
                        <div id="componentListContainer" style="max-height: 300px; overflow-y: auto; border: 1px solid #dee2e6; border-radius: 0.375rem; padding: 0.5rem;">
                            <div class="text-center text-muted py-4">
                                <i class="fas fa-spinner fa-spin fa-2x mb-2"></i>
                                <p class="mb-0">ƒêang t·∫£i danh s√°ch ph·ª• t√πng...</p>
                            </div>
                        </div>
                        <input type="hidden" id="componentSelect" required>
                    </div>

                    <!-- Selected Component Info -->
                    <div id="selectedComponentInfo" class="alert alert-info mb-3" style="display: none;">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-check-circle me-2"></i>
                            <div class="flex-grow-1">
                                <strong id="selectedComponentName">-</strong>
                                <div class="small mt-1">
                                    <span class="text-muted">ƒê∆°n gi√°: </span>
                                    <strong id="selectedComponentPrice" class="text-primary">-</strong>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quantity Input -->
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="componentQuantity" class="form-label fw-semibold">
                                <i class="fas fa-hashtag me-1"></i>S·ªë l∆∞·ª£ng <span class="text-danger">*</span>
                            </label>
                            <input type="number" class="form-control form-control-lg" id="componentQuantity" 
                                   min="1" required placeholder="Nh·∫≠p s·ªë l∆∞·ª£ng">
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label fw-semibold">
                                <i class="fas fa-money-bill-wave me-1"></i>Th√†nh ti·ªÅn
                            </label>
                            <div class="form-control form-control-lg bg-light" id="componentTotalPrice" style="line-height: 2.5;">
                                <strong class="text-primary">0 ‚Ç´</strong>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>H·ªßy
                </button>
                <button type="button" class="btn btn-outline-primary" id="saveAndAddMoreBtn">
                    <i class="fas fa-plus me-1"></i>L∆∞u v√† th√™m ti·∫øp
                </button>
                <button type="button" class="btn btn-primary" id="saveComponentBtn">
                    <i class="fas fa-save me-1"></i>L∆∞u
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Component Modal -->
<div class="modal fade" id="editComponentModal" tabindex="-1" aria-labelledby="editComponentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editComponentModalLabel">Ch·ªânh s·ª≠a ph·ª• t√πng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editComponentForm">
                    <input type="hidden" id="editComponentId">
                    <div class="mb-3">
                        <label for="editComponentSelect" class="form-label">Ph·ª• t√πng <span class="text-danger">*</span></label>
                        <input type="text" class="form-control mb-2" id="editComponentSearch" placeholder="üîç T√¨m ki·∫øm ph·ª• t√πng (t√™n, m√£...)">
                        <select class="form-select" id="editComponentSelect" size="8" required style="max-height: 200px; overflow-y: auto;">
                            <option value="">-- Ch·ªçn ph·ª• t√πng --</option>
                            <!-- Will be loaded dynamically -->
                        </select>
                        <small class="text-muted">G√µ ƒë·ªÉ t√¨m ki·∫øm, sau ƒë√≥ ch·ªçn t·ª´ danh s√°ch</small>
                    </div>
                    <div class="mb-3">
                        <label for="editComponentQuantity" class="form-label">S·ªë l∆∞·ª£ng ban ƒë·∫ßu <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="editComponentQuantity" min="1" required>
                        <small class="text-dark">S·ªë l∆∞·ª£ng ph·ª• t√πng ƒë√£ l·∫•y t·ª´ kho</small>
                    </div>
                    <div class="mb-3">
                        <label for="editComponentActualQuantity" class="form-label">S·ªë l∆∞·ª£ng th·ª±c t·∫ø s·ª≠ d·ª•ng</label>
                        <input type="number" class="form-control" id="editComponentActualQuantity" min="0" step="0.01">
                        <small class="text-dark">S·ªë l∆∞·ª£ng th·ª±c t·∫ø ƒë√£ s·ª≠ d·ª•ng (c√≥ th·ªÉ nh·∫≠p s·ªë th·∫≠p ph√¢n, v√≠ d·ª•: 0.8). N·∫øu ƒë·ªÉ tr·ªëng, s·∫Ω l·∫•y b·∫±ng s·ªë l∆∞·ª£ng ban ƒë·∫ßu. Chi ph√≠ s·∫Ω ƒë∆∞·ª£c t√≠nh d·ª±a tr√™n s·ªë l∆∞·ª£ng th·ª±c t·∫ø.</small>
                    </div>
                    <div class="mb-3">
                        <label for="editComponentUnitPrice" class="form-label">ƒê∆°n gi√° (VNƒê)</label>
                        <input type="number" class="form-control" id="editComponentUnitPrice" min="0" step="1000" readonly>
                        <small class="text-dark">ƒê∆°n gi√° t·ª± ƒë·ªông l·∫•y t·ª´ gi√° xu·∫•t trong kho. N·∫øu c·∫ßn gi·∫£m gi√°, vui l√≤ng s·ª≠ d·ª•ng ph·∫ßn gi·∫£m gi√° trong h√≥a ƒë∆°n.</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-primary" id="updateComponentBtn">C·∫≠p nh·∫≠t</button>
            </div>
        </div>
    </div>
</div>

<!-- Apply Service Package Modal -->
<div class="modal fade" id="applyServicePackageModal" tabindex="-1" aria-labelledby="applyServicePackageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="applyServicePackageModalLabel">Ch·ªçn g√≥i d·ªãch v·ª•</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="servicePackageSearch" class="form-label">T√¨m ki·∫øm g√≥i d·ªãch v·ª•</label>
                    <input type="text" class="form-control" id="servicePackageSearch" placeholder="T√¨m theo t√™n, m√£ g√≥i d·ªãch v·ª•...">
                </div>
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-hover">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th>Ch·ªçn</th>
                                <th>M√£ g√≥i</th>
                                <th>T√™n g√≥i</th>
                                <th>Gi√°</th>
                                <th>S·ªë ph·ª• t√πng</th>
                                <th>M√¥ t·∫£</th>
                            </tr>
                        </thead>
                        <tbody id="servicePackageTableBody">
                            <tr>
                                <td colspan="6" class="text-center">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                                        <span class="visually-hidden">ƒêang t·∫£i...</span>
                                    </div>
                                    ƒêang t·∫£i danh s√°ch g√≥i d·ªãch v·ª•...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div id="selectedServicePackageInfo" class="alert alert-info mt-3" style="display: none;">
                    <h6><i class="fas fa-info-circle me-2"></i>Th√¥ng tin g√≥i d·ªãch v·ª• ƒë√£ ch·ªçn:</h6>
                    <div id="selectedServicePackageDetails"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-primary" id="confirmApplyServicePackageBtn" disabled>√Åp d·ª•ng g√≥i d·ªãch v·ª•</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Standard Labor Time Modal -->
<div class="modal fade" id="editStandardLaborTimeModal" tabindex="-1" aria-labelledby="editStandardLaborTimeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editStandardLaborTimeModalLabel">Ch·ªânh s·ª≠a th·ªùi gian chu·∫©n</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editStandardLaborTimeForm">
                    <input type="hidden" id="editStandardLaborTimeTaskId">
                    <div class="mb-3">
                        <label for="editStandardLaborTime" class="form-label">Th·ªùi gian chu·∫©n (gi·ªù)</label>
                        <input type="number" class="form-control" id="editStandardLaborTime" min="0" max="999.99" step="0.01">
                        <small class="text-dark">Th·ªùi gian ∆∞·ªõc t√≠nh ƒë·ªÉ ho√†n th√†nh c√¥ng vi·ªác. <span id="standardLaborTimeNote" class="text-warning"></span></small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-primary" id="saveStandardLaborTimeBtn">L∆∞u</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Labor Time Modal (Standard + Actual) -->
<div class="modal fade" id="editLaborTimeModal" tabindex="-1" aria-labelledby="editLaborTimeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editLaborTimeModalLabel">Ch·ªânh s·ª≠a th·ªùi gian lao ƒë·ªông</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editLaborTimeForm">
                    <input type="hidden" id="editLaborTimeTaskId">
                    <div class="mb-3">
                        <label for="editStandardLaborTimeInModal" class="form-label">Th·ªùi gian chu·∫©n (gi·ªù)</label>
                        <input type="number" class="form-control" id="editStandardLaborTimeInModal" min="0" max="999.99" step="0.01">
                        <small class="text-dark">Th·ªùi gian ∆∞·ªõc t√≠nh ƒë·ªÉ ho√†n th√†nh c√¥ng vi·ªác. <span id="standardLaborTimeNoteInModal" class="text-warning"></span></small>
                    </div>
                    <div class="mb-3">
                        <label for="editActualLaborTime" class="form-label">Th·ªùi gian th·ª±c t·∫ø (gi·ªù) <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="editActualLaborTime" min="0.01" max="999.99" step="0.01" required>
                        <small class="text-dark">
                            Th·ªùi gian th·ª±c t·∫ø ƒë√£ l√†m vi·ªác.
                        </small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-primary" id="saveLaborTimeBtn">L∆∞u</button>
            </div>
        </div>
    </div>
</div>

<!-- Confirm Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmModalLabel">X√°c nh·∫≠n</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="confirmModalBody">
                <!-- Content will be set dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-danger" id="confirmModalBtn">X√°c nh·∫≠n</button>
            </div>
        </div>
    </div>
</div>

<!-- Completion Note Modal -->
<div class="modal fade" id="completionNoteModal" tabindex="-1" aria-labelledby="completionNoteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="completionNoteModalLabel">Ho√†n th√†nh c√¥ng vi·ªác</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="completionNoteInput" class="form-label">Ghi ch√∫ ho√†n th√†nh <span class="text-danger">*</span></label>
                    <textarea class="form-control" id="completionNoteInput" rows="4" placeholder="Nh·∫≠p ghi ch√∫ khi ho√†n th√†nh c√¥ng vi·ªác..."></textarea>
                    <small class="text-dark">Vui l√≤ng nh·∫≠p ghi ch√∫ m√¥ t·∫£ c√¥ng vi·ªác ƒë√£ ho√†n th√†nh</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                <button type="button" class="btn btn-success" id="submitCompletionNoteBtn">
                    <i class="fas fa-check me-1"></i>Ho√†n th√†nh
                </button>
            </div>
        </div>
    </div>
</div>

<script>
const API_BASE_URL = '@apiBaseUrl';
let maintenanceTicketId = @ViewBag.MaintenanceTicketId;
let maintenanceTicketData = null;
let currentUserRoleId = null; // L∆∞u roleId c·ªßa user hi·ªán t·∫°i
let currentUserId = null; // L∆∞u userId c·ªßa user hi·ªán t·∫°i

$(document).ready(function() {
    loadCurrentUserInfo(); // Load th√¥ng tin user ƒë·ªÉ ki·ªÉm tra quy·ªÅn
    loadMaintenanceTicketDetails();
    
    // Modal events
    $('#addServiceTaskBtn').on('click', function() {
        // Reset form v√† set mode l√† "Th√™m"
        $('#serviceTaskForm')[0].reset();
        $('#taskId').val('');
        $('#addServiceTaskModalLabel').text('Th√™m c√¥ng vi·ªác');
        $('#saveServiceTaskBtn').html('L∆∞u');
        loadTechniciansForTask();
        $('#addServiceTaskModal').modal('show');
    });
    
    // Reset form khi ƒë√≥ng modal
    $('#addServiceTaskModal').on('hidden.bs.modal', function() {
        $('#serviceTaskForm')[0].reset();
        $('#taskId').val('');
        $('#addServiceTaskModalLabel').text('Th√™m c√¥ng vi·ªác');
        $('#saveServiceTaskBtn').html('L∆∞u');
    });
    
    $('#addComponentBtn').on('click', function() {
        loadComponentsForAdd();
        $('#addComponentModal').modal('show');
    });
    
    $('#applyServicePackageBtn').on('click', function() {
        selectedServicePackageId = null;
        selectedServicePackageData = null;
        $('#servicePackageSearch').val('');
        $('#confirmApplyServicePackageBtn').prop('disabled', true);
        $('#selectedServicePackageInfo').hide();
        loadServicePackages();
        $('#applyServicePackageModal').modal('show');
    });
    
    // Reset modal when closed
    $('#applyServicePackageModal').on('hidden.bs.modal', function() {
        selectedServicePackageId = null;
        selectedServicePackageData = null;
        $('#servicePackageSearch').val('');
        $('#confirmApplyServicePackageBtn').prop('disabled', true);
        $('#selectedServicePackageInfo').hide();
        $('.service-package-radio').prop('checked', false);
    });
    
    // Search component functionality
    let allComponentsForAdd = []; // L∆∞u danh s√°ch components g·ªëc
    $(document).on('input', '#componentSearch', function() {
        const searchTerm = $(this).val().toLowerCase().trim();
        const items = $('.component-item');
        
        if (!searchTerm) {
            // Hi·ªÉn th·ªã t·∫•t c·∫£
            items.show();
            return;
        }
        
        // Filter items
        items.each(function() {
            const item = $(this);
            const name = item.data('component-name') || '';
            const code = item.data('component-code') || '';
            const searchText = (name + ' ' + code).toLowerCase();
            
            if (searchText.includes(searchTerm)) {
                item.show();
            } else {
                item.hide();
            }
        });
    });
    
    // Update total price when quantity changes
    $(document).on('input', '#componentQuantity', function() {
        updateComponentTotalPrice();
    });
    
    // Auto-fill unit price when component is selected
    $(document).on('change', '#componentSelect', function() {
        const selectedOption = $(this).find('option:selected');
        const price = selectedOption.data('price') || 0;
        $('#componentUnitPrice').val(price);
    });
    
    // Search component functionality for edit modal
    $(document).on('input', '#editComponentSearch', function() {
        const searchTerm = $(this).val().toLowerCase().trim();
        const select = $('#editComponentSelect');
        const options = select.find('option');
        
        if (!searchTerm) {
            // Hi·ªÉn th·ªã t·∫•t c·∫£
            options.show();
            return;
        }
        
        // Filter options
        options.each(function() {
            const option = $(this);
            const text = option.text().toLowerCase();
            if (option.val() === '' || text.includes(searchTerm)) {
                option.show();
            } else {
                option.hide();
            }
        });
    });
    
    $(document).on('change', '#editComponentSelect', function() {
        const selectedOption = $(this).find('option:selected');
        const price = selectedOption.data('price') || 0;
        $('#editComponentUnitPrice').val(price);
    });
    
    // Service Package selection
    let selectedServicePackageId = null;
    let selectedServicePackageData = null;
    $(document).on('change', '.service-package-radio', function() {
        selectedServicePackageId = $(this).val();
        selectedServicePackageData = $(this).closest('tr').data('package-data');
        $('#confirmApplyServicePackageBtn').prop('disabled', !selectedServicePackageId);
        
        if (selectedServicePackageId && selectedServicePackageData) {
            displaySelectedServicePackage(selectedServicePackageData);
        } else {
            $('#selectedServicePackageInfo').hide();
        }
    });
    
    $('#confirmApplyServicePackageBtn').on('click', function() {
        if (!selectedServicePackageId) {
            showAlert('Vui l√≤ng ch·ªçn g√≥i d·ªãch v·ª•', 'warning');
            return;
        }
        applyServicePackage(selectedServicePackageId);
    });
    
    // Search service packages
    let servicePackageSearchTimeout;
    $('#servicePackageSearch').on('input', function() {
        clearTimeout(servicePackageSearchTimeout);
        const searchTerm = $(this).val().toLowerCase();
        servicePackageSearchTimeout = setTimeout(() => {
            filterServicePackages(searchTerm);
        }, 300);
    });
    
    $('#saveServiceTaskBtn').on('click', function() {
        saveServiceTask();
    });
    
    $('#saveComponentBtn').on('click', function() {
        saveComponent(false); // ƒê√≥ng modal sau khi l∆∞u
    });
    
    $('#saveAndAddMoreBtn').on('click', function() {
        saveComponent(true); // Gi·ªØ modal m·ªü ƒë·ªÉ th√™m ti·∫øp
    });
    
    $('#updateComponentBtn').on('click', function() {
        updateComponent();
    });

    // G√°n k·ªπ thu·∫≠t vi√™n (m·ªü modal ch·ªçn nhi·ªÅu)
    $(document).on('click', '#assignTechnicianBtn', function() {
        openAssignTechniciansModal();
    });
    
    // Save labor time (Standard + Actual)
    $('#saveLaborTimeBtn').on('click', function() {
        saveLaborTime();
    });
    
    // Save standard labor time only
    $('#saveStandardLaborTimeBtn').on('click', function() {
        saveStandardLaborTime();
    });
    
    // Reset standard labor time modal when closed
    $('#editStandardLaborTimeModal').on('hidden.bs.modal', function() {
        $('#editStandardLaborTimeForm')[0].reset();
        $('#editStandardLaborTimeTaskId').val('');
        $('#editStandardLaborTime').val('').prop('readonly', false).removeClass('bg-light');
        $('#standardLaborTimeNote').text('');
    });
});

// Load th√¥ng tin user hi·ªán t·∫°i ƒë·ªÉ ki·ªÉm tra quy·ªÅn
function loadCurrentUserInfo() {
    const token = localStorage.getItem('authToken');
    
    // G·ªçi API Employee/me ƒë·ªÉ l·∫•y th√¥ng tin user
    fetch(`${API_BASE_URL}/Employee/me`, {
        headers: {
            'Authorization': token ? `Bearer ${token}` : '',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.data) {
            currentUserRoleId = data.data.roleId || null;
            currentUserId = data.data.id || null;
            console.log('[loadCurrentUserInfo] User RoleId:', currentUserRoleId, 'UserId:', currentUserId);
        } else {
            console.warn('[loadCurrentUserInfo] Could not load user info');
        }
    })
    .catch(error => {
        console.error('[loadCurrentUserInfo] Error:', error);
    });
}

function loadMaintenanceTicketDetails() {
    const token = localStorage.getItem('authToken');
    fetch(`${API_BASE_URL}/MaintenanceTicket/${maintenanceTicketId}`, {
        headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        }
    })
        .then(async response => {
            if (!response.ok) {
                // Try read json; fallback to text
                try { return { __httpError: true, status: response.status, ...(await response.json()) }; }
                catch { return { __httpError: true, status: response.status, message: await response.text() }; }
            }
            return response.json();
        })
        .then(async data => {
            if (data.__httpError) {
                const msg = data.status === 404 ? 'Kh√¥ng t√¨m th·∫•y phi·∫øu b·∫£o d∆∞·ª°ng ho·∫∑c ƒë√£ b·ªã x√≥a.' : (data.message || 'T·∫£i d·ªØ li·ªáu th·∫•t b·∫°i');
                showAlert(msg, 'danger');
                setTimeout(() => window.location.href = '/MaintenanceTickets', 1200);
                return;
            }
            if (data.success) {
                maintenanceTicketData = data.data;
                await displayBasicInfo(data.data);
                displayCheckinInfo(data.data);
                displayStatusAndActions(data.data);
                displayTimeline(data.data);
                displayServicePackageInfo(data.data);
                
                // Show/hide add component and apply service package buttons based on status
                const canEditComponents = data.data.statusCode === 'PENDING' || data.data.statusCode === 'ASSIGNED' || data.data.statusCode === 'IN_PROGRESS';
                $('#addComponentBtn').toggle(canEditComponents);
                $('#applyServicePackageBtn').toggle(canEditComponents);
                $('#addServiceTaskBtn').toggle(canEditComponents);
                
                loadServiceTasks();
                loadComponents(); // This will also update cost summary
                // Cost summary will be updated after components and tasks are loaded
            } else {
                showAlert('T·∫£i d·ªØ li·ªáu th·∫•t b·∫°i: ' + data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu', 'danger');
        });
}

const vehicleCheckinDetailCache = new Map();

async function fetchVehicleCheckinDetail(checkinId) {
    if (!checkinId) {
        return null;
    }
    if (vehicleCheckinDetailCache.has(checkinId)) {
        return vehicleCheckinDetailCache.get(checkinId);
    }

    try {
        const token = localStorage.getItem('authToken');
        const response = await fetch(`${API_BASE_URL}/VehicleCheckin/${checkinId}`, {
            headers: token ? { 'Authorization': `Bearer ${token}` } : undefined
        });

        if (!response.ok) {
            console.warn('Kh√¥ng th·ªÉ t·∫£i chi ti·∫øt vehicle check-in:', response.status);
            vehicleCheckinDetailCache.set(checkinId, null);
            return null;
        }

        const json = await response.json();
        const detail = json && json.success ? json.data : json;
        vehicleCheckinDetailCache.set(checkinId, detail);
        return detail;
    } catch (error) {
        console.error('L·ªói khi t·∫£i chi ti·∫øt vehicle check-in:', error);
        vehicleCheckinDetailCache.set(checkinId, null);
        return null;
    }
}

async function displayBasicInfo(data) {
    const basicInfo = $('#basicInfo');
    const createdAt = new Date(data.createdDate).toLocaleDateString('vi-VN');
    const startTime = data.startTime ? new Date(data.startTime).toLocaleDateString('vi-VN') : 'Ch∆∞a b·∫Øt ƒë·∫ßu';
    const endTime = data.endTime ? new Date(data.endTime).toLocaleDateString('vi-VN') : 'Ch∆∞a ho√†n th√†nh';
    const snapshot = data.vehicleInfo || data.vehicleSnapshot || null;
    const checkin = data.vehicleCheckin || null;
    const checkinVehicleInfo = checkin && checkin.vehicleInfo ? checkin.vehicleInfo : null;

    let manufactureYear = snapshot?.yearOfManufacture
        ?? snapshot?.manufactureYear
        ?? data.yearOfManufacture
        ?? data.manufacturingYear
        ?? data.manufactureYear
        ?? data.carManufactureYear
        ?? data.carYear
        ?? checkin?.yearOfManufacture
        ?? checkin?.manufactureYear
        ?? checkinVehicleInfo?.yearOfManufacture
        ?? checkinVehicleInfo?.manufactureYear
        ?? null;

    let vinNumber = snapshot?.vinNumber
        ?? snapshot?.vin
        ?? data.vinNumber
        ?? data.vehicleVinNumber
        ?? data.vehicleEngineNumber // fallback c√°c h·ªá c≈©
        ?? (data.vehicle && (data.vehicle.vinNumber || data.vehicle.vin))
        ?? (checkin && (checkin.vinNumber || checkin.vin))
        ?? (checkinVehicleInfo && (checkinVehicleInfo.vinNumber || checkinVehicleInfo.vin))
        ?? (data.car && data.car.vinNumber)
        ?? (data.checkin && data.checkin.vinNumber)
        ?? null;

    let engineNumber = snapshot?.engineNumber
        ?? snapshot?.engineNo
        ?? data.engineNumber
        ?? data.engineNo
        ?? data.vehicleEngineNumber
        ?? (data.vehicleInfo && (data.vehicleInfo.engineNumber || data.vehicleInfo.engineNo))
        ?? (data.vehicle && (data.vehicle.engineNumber || data.vehicle.engineNo))
        ?? (checkin && (checkin.engineNumber || checkin.vehicleEngineNumber))
        ?? (checkinVehicleInfo && (checkinVehicleInfo.engineNumber || checkinVehicleInfo.engineNo))
        ?? (data.car && data.car.engineNumber)
        ?? (data.checkin && data.checkin.engineNumber)
        ?? null;

    let licensePlate = snapshot?.licensePlate
        ?? data.licensePlate
        ?? (checkin && checkin.licensePlate)
        ?? (checkinVehicleInfo && checkinVehicleInfo.licensePlate)
        ?? (data.vehicle && data.vehicle.licensePlate)
        ?? null;

    let carName = snapshot?.carName
        ?? data.carName
        ?? (checkin && checkin.carName)
        ?? (checkinVehicleInfo && checkinVehicleInfo.carName)
        ?? (data.vehicle && data.vehicle.carName)
        ?? null;

    let carModel = snapshot?.carModel
        ?? data.carModel
        ?? (checkin && checkin.carModel)
        ?? (checkinVehicleInfo && checkinVehicleInfo.carModel)
        ?? (data.vehicle && data.vehicle.carModel)
        ?? null;

    if ((!vinNumber || !engineNumber || !manufactureYear || !licensePlate || !carName || !carModel) && (data.vehicleCheckinId || checkin?.id)) {
        const checkinId = data.vehicleCheckinId || checkin?.id;
        const checkinDetail = await fetchVehicleCheckinDetail(checkinId);
        if (checkinDetail) {
            vinNumber = vinNumber
                || checkinDetail.vinNumber
                || (checkinDetail.vehicle && (checkinDetail.vehicle.vinNumber || checkinDetail.vehicle.vin))
                || (checkinDetail.vehicleInfo && (checkinDetail.vehicleInfo.vinNumber || checkinDetail.vehicleInfo.vin));

            engineNumber = engineNumber
                || checkinDetail.vehicleEngineNumber
                || checkinDetail.engineNumber
                || (checkinDetail.vehicle && (checkinDetail.vehicle.engineNumber || checkinDetail.vehicle.engineNo))
                || (checkinDetail.vehicleInfo && (checkinDetail.vehicleInfo.engineNumber || checkinDetail.vehicleInfo.engineNo));

            manufactureYear = manufactureYear
                || checkinDetail.yearOfManufacture
                || checkinDetail.manufactureYear
                || (checkinDetail.vehicle && (checkinDetail.vehicle.yearOfManufacture || checkinDetail.vehicle.manufactureYear))
                || (checkinDetail.vehicleInfo && (checkinDetail.vehicleInfo.yearOfManufacture || checkinDetail.vehicleInfo.manufactureYear));

            licensePlate = licensePlate
                || checkinDetail.licensePlate
                || (checkinDetail.vehicle && checkinDetail.vehicle.licensePlate)
                || (checkinDetail.vehicleInfo && checkinDetail.vehicleInfo.licensePlate);

            carName = carName
                || checkinDetail.carName
                || (checkinDetail.vehicle && checkinDetail.vehicle.carName)
                || (checkinDetail.vehicleInfo && checkinDetail.vehicleInfo.carName);

            carModel = carModel
                || checkinDetail.carModel
                || (checkinDetail.vehicle && checkinDetail.vehicle.carModel)
                || (checkinDetail.vehicleInfo && checkinDetail.vehicleInfo.carModel);
        }
    }

    const renderRow = (label, value, options = {}) => {
        const { raw = false, valueClass = 'fw-semibold text-body' } = options;
        const hasValue = value !== undefined && value !== null && value !== '';
        const displayValue = hasValue ? value : 'N/A';
        const formattedValue = raw ? displayValue : escapeHtml(String(displayValue));
        return `
            <div class="info-row d-flex flex-column flex-sm-row align-items-sm-start mb-2">
                <span class="info-label text-dark text-sm-end me-sm-3">${escapeHtml(label)}</span>
                <span class="info-value flex-grow-1 text-start ${valueClass}">${formattedValue}</span>
            </div>
        `;
    };

    let techniciansHtml = '<div class="text-dark">Ch∆∞a g√°n</div>';
    if (data.technicians && data.technicians.length > 0) {
        const techItems = data.technicians.map(t => {
                    const roleBadge = t.roleInTicket === 'PRIMARY' 
                        ? '<span class="badge bg-warning text-dark ms-1">Ch√≠nh</span>' 
                        : '<span class="badge bg-light text-dark ms-1">Ph·ª•</span>';
                    const canRemove = data.statusCode === 'PENDING' || data.statusCode === 'IN_PROGRESS' || data.statusCode === 'ASSIGNED';
                    const removeBtn = canRemove 
                ? `<button type="button" class="btn btn-sm btn-link text-dark p-0" onclick="removeSingleTechnician(${data.id}, ${t.technicianId})" title="X√≥a k·ªπ thu·∫≠t vi√™n">
                            <i class="fas fa-times"></i>
                           </button>`
                        : '';
            return `
                <div class="tech-pill">
                    <span>${escapeHtml(t.technicianName || 'N/A')} ${roleBadge}</span>
                        ${removeBtn}
        </div>
            `;
        }).join('\n');
        techniciansHtml = `<div class="tech-list">${techItems}</div>`;
    } else if (data.technicianName) {
        techniciansHtml = `
            <div class="tech-list">
                <div class="tech-pill">
                    <span>${escapeHtml(data.technicianName)}</span>
            </div>
        </div>
        `;
    }

    const descriptionHtml = data.description
        ? escapeHtml(data.description).replace(/\n/g, '<br>')
        : '<span class="text-dark">Kh√¥ng c√≥ m√¥ t·∫£</span>';

    const codeValue = data.code || `MTK-${data.id}`;

    basicInfo.html(`
        <div class="row basic-info-grid">
            <div class="col-lg-6">
                <div class="info-section mb-4">
                    <h6 class="info-section-title">Th√¥ng tin kh√°ch h√†ng</h6>
                    ${renderRow('Kh√°ch h√†ng', data.customerName)}
                    ${renderRow('ƒêi·ªán tho·∫°i', data.customerPhone)}
                    ${renderRow('ƒê·ªãa ch·ªâ', data.customerAddress, { valueClass: 'fw-semibold text-body info-text-wrap' })}
            </div>
                <div class="info-section mb-4">
                    <h6 class="info-section-title">Th√¥ng tin xe</h6>
                    ${renderRow('Xe', carName)}
                    ${renderRow('Bi·ªÉn s·ªë', licensePlate)}
                    ${renderRow('M·∫´u xe', carModel)}
                    ${renderRow('S·ªë khung (VIN)', vinNumber)}
                    ${renderRow('S·ªë m√°y', engineNumber)}
                    ${renderRow('NƒÉm s·∫£n xu·∫•t', manufactureYear)}
        </div>
                <div class="info-section mb-0">
                    <h6 class="info-section-title mb-2">M√¥ t·∫£</h6>
                    <div class="info-description info-text-wrap">${descriptionHtml}</div>
            </div>
        </div>
            <div class="col-lg-6">
                <div class="info-section mb-4">
                    <h6 class="info-section-title">Th√¥ng tin phi·∫øu</h6>
                    ${renderRow('M√£ phi·∫øu', codeValue)}
                    ${renderRow('Chi nh√°nh', data.branchName)}
                    ${renderRow('D·ªãch v·ª•', data.serviceCategoryName || data.scheduleServiceName)}
                    ${renderRow('M·ª©c ∆∞u ti√™n', getPriorityBadge(data.priorityLevel), { raw: true, valueClass: 'd-inline-flex align-items-center gap-2' })}
                    ${renderRow('Tr·∫°ng th√°i', getStatusBadge(data.statusCode), { raw: true, valueClass: 'd-inline-flex align-items-center gap-2' })}
                    ${renderRow('Ng√†y t·∫°o', createdAt)}
                    ${renderRow('B·∫Øt ƒë·∫ßu', startTime)}
                    ${renderRow('Ho√†n th√†nh', endTime)}
                    ${renderRow('T∆∞ v·∫•n vi√™n', data.consulterName)}
            </div>
                <div class="info-section mb-4">
                    <h6 class="info-section-title mb-2">K·ªπ thu·∫≠t vi√™n</h6>
                    ${techniciansHtml}
        </div>
            </div>
        </div>
    `);
}

function displayCheckinInfo(data) {
    const checkinInfo = $('#checkinInfo');
    
    if (data.vehicleCheckinId) {
        const checkinId = data.vehicleCheckinId;
        checkinInfo.html(`
            <div class="row">
                <div class="col-md-6">
                    <strong>M√£ Check-in:</strong><br>
                    <a href="/VehicleCheckins/Details/${checkinId}" 
                       class="text-decoration-none" 
                       style="color: #007bff; cursor: pointer;"
                       onmouseover="this.style.textDecoration='underline'; this.style.color='#0056b3';"
                       onmouseout="this.style.textDecoration='none'; this.style.color='#007bff';"
                       title="Xem chi ti·∫øt phi·∫øu check-in">
                        VCI-${checkinId}
                        <i class="fas fa-external-link-alt ms-1" style="font-size: 0.8em;"></i>
                    </a>
                </div>
                <div class="col-md-6">
                    <strong>S·ªë km:</strong><br>
                    ${data.mileage ? data.mileage.toLocaleString() + ' km' : 'N/A'}
                </div>
            </div>
        `);
    } else {
        checkinInfo.html('<p class="text-dark">Kh√¥ng c√≥ th√¥ng tin check-in</p>');
    }
}

function displayServicePackageInfo(data) {
    const servicePackageInfo = $('#servicePackageInfo');
    const servicePackageNameDisplay = $('#servicePackageNameDisplay');
    const servicePackagePriceDisplay = $('#servicePackagePriceDisplay');
    
    // H·ªó tr·ª£ c·∫£ PascalCase v√† camelCase
    const servicePackageId = data?.ServicePackageId ?? data?.servicePackageId;
    const servicePackageName = data?.ServicePackageName ?? data?.servicePackageName;
    const servicePackagePrice = data?.ServicePackagePrice ?? data?.servicePackagePrice;
    
    // Debug log
    console.log('Service Package Info Debug:', {
        servicePackageId: servicePackageId,
        servicePackageName: servicePackageName,
        servicePackagePrice: servicePackagePrice,
        data: data
    });
    
    if (servicePackageId && servicePackageName) {
        servicePackageNameDisplay.text(servicePackageName);
        if (servicePackagePrice) {
            servicePackagePriceDisplay.text(`(${formatCurrency(servicePackagePrice)})`);
        } else {
            servicePackagePriceDisplay.text('');
        }
        servicePackageInfo.show();
    } else {
        servicePackageInfo.hide();
    }
}

function displayStatusAndActions(data) {
    const statusBadge = $('#statusBadge');
    const progressBar = $('#progressBar');
    const actionButtons = $('#actionButtons');
    
    // Status badge
    statusBadge.html(getStatusBadge(data.statusCode));
    
    // Progress bar
    const progress = getProgressPercentage(data.statusCode);
    progressBar.html(`
        <div class="progress" style="height: 8px;">
            <div class="progress-bar bg-primary" role="progressbar" style="width: ${progress}%" aria-valuenow="${progress}" aria-valuemin="0" aria-valuemax="100">
            </div>
        </div>
        <small class="text-dark d-block mt-1">${progress}% ho√†n th√†nh</small>
    `);
    
    // Action buttons
    let buttons = '';
    const canCancel = data.statusCode !== 'COMPLETED' && data.statusCode !== 'CANCELLED';
    
    switch(data.statusCode) {
        case 'PENDING':
            buttons = `
                <button class="btn btn-outline-primary mb-2" id="assignTechnicianBtn">
                    <i class="fas fa-user-plus me-1"></i>
                    G√°n k·ªπ thu·∫≠t vi√™n
                </button>
                ${canCancel ? `
                <button class="btn btn-outline-danger" onclick="cancelMaintenanceTicket(${data.id})">
                    <i class="fas fa-times-circle me-1"></i>
                    H·ªßy phi·∫øu
                </button>
                ` : ''}
            `;
            break;
        case 'ASSIGNED':
            buttons = `
                <button class="btn btn-outline-primary mb-2" onclick="startMaintenance(${data.id})">
                    <i class="fas fa-play me-1"></i>
                    B·∫Øt ƒë·∫ßu b·∫£o d∆∞·ª°ng
                </button>
                ${canCancel ? `
                <button class="btn btn-outline-danger" onclick="cancelMaintenanceTicket(${data.id})">
                    <i class="fas fa-times-circle me-1"></i>
                    H·ªßy phi·∫øu
                </button>
                ` : ''}
            `;
            break;
        case 'IN_PROGRESS':
            // Ki·ªÉm tra xem c√≥ c√¥ng vi·ªác n√†o ch∆∞a ho√†n th√†nh kh√¥ng
            // S·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t sau khi loadServiceTasks()
            // ‚úÖ VALIDATION: Ch·ªâ qu·∫£n l√Ω/t∆∞ v·∫•n vi√™n/Admin m·ªõi ƒë∆∞·ª£c ho√†n th√†nh phi·∫øu (roleId: 1=Admin, 2=Branch Manager, 6=Consulter)
            // K·ªπ thu·∫≠t vi√™n (roleId=4) KH√îNG ƒë∆∞·ª£c ph√©p ho√†n th√†nh phi·∫øu
            const canCompleteMaintenance = currentUserRoleId !== 4; // 4 = Technician
            buttons = `
                <button class="btn btn-outline-primary mb-2" onclick="openAssignTechniciansModal()">
                    <i class="fas fa-user-plus me-1"></i>
                    Th√™m k·ªπ thu·∫≠t vi√™n
                </button>
                <button class="btn btn-outline-danger mb-2" onclick="exportPdf(${data.id})">
                    <i class="fas fa-file-pdf me-1"></i>
                    Xu·∫•t PDF
                </button>
                ${canCompleteMaintenance ? `
                <button class="btn btn-outline-success mb-2" id="completeMaintenanceBtn" onclick="completeMaintenance(${data.id})">
                    <i class="fas fa-check me-1"></i>
                    Ho√†n th√†nh
                </button>
                ` : `
                <div class="alert alert-info mb-2">
                    <small><i class="fas fa-info-circle me-1"></i>Ch·ªâ qu·∫£n l√Ω, t∆∞ v·∫•n vi√™n ho·∫∑c Admin m·ªõi ƒë∆∞·ª£c ph√©p ho√†n th√†nh phi·∫øu b·∫£o d∆∞·ª°ng.</small>
                </div>
                `}
                ${canCancel ? `
                <button class="btn btn-outline-danger" onclick="cancelMaintenanceTicket(${data.id})">
                    <i class="fas fa-times-circle me-1"></i>
                    H·ªßy phi·∫øu
                </button>
                ` : ''}
            `;
            break;
        case 'COMPLETED':
            buttons = `
                <button class="btn btn-outline-danger mb-2" onclick="exportPdf(${data.id})">
                    <i class="fas fa-file-pdf me-1"></i>
                    Xu·∫•t PDF
                </button>
                <button class="btn btn-outline-success" disabled style="opacity: 0.7;">
                    <i class="fas fa-check-circle me-1"></i>
                    ƒê√£ ho√†n th√†nh
                </button>
            `;
            break;
        case 'CANCELLED':
            buttons = `
                <button class="btn btn-outline-danger mb-2" onclick="exportPdf(${data.id})">
                    <i class="fas fa-file-pdf me-1"></i>
                    Xu·∫•t PDF
                </button>
                <button class="btn btn-outline-danger" disabled style="opacity: 0.7;">
                    <i class="fas fa-times-circle me-1"></i>
                    ƒê√£ h·ªßy
                </button>
            `;
            break;
    }
    
    actionButtons.html(buttons);
}

// Modal ch·ªçn k·ªπ thu·∫≠t vi√™n
function openAssignTechniciansModal() {
    const modalHtml = `
    <div class="modal fade" id="assignTechniciansModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="fas fa-user-plus me-2"></i>
              ${(maintenanceTicketData.technicians && maintenanceTicketData.technicians.length > 0) ? 'Th√™m/Ch·ªânh s·ª≠a k·ªπ thu·∫≠t vi√™n' : 'G√°n k·ªπ thu·∫≠t vi√™n'}
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            ${(maintenanceTicketData.technicians && maintenanceTicketData.technicians.length > 0) ? `
            <div class="alert alert-light border mb-3">
              <i class="fas fa-info-circle me-1"></i>
              <strong>Danh s√°ch hi·ªán t·∫°i:</strong> ${maintenanceTicketData.technicians.map(t => t.technicianName).join(', ')}
              <br><small>B·∫°n c√≥ th·ªÉ th√™m k·ªπ thu·∫≠t vi√™n m·ªõi ho·∫∑c b·ªè ch·ªçn ƒë·ªÉ x√≥a ng∆∞·ªùi kh√¥ng c√≤n tham gia.</small>
            </div>
            ` : ''}
            <div class="mb-3">
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-search"></i></span>
                <input type="text" class="form-control" id="assignTechSearch" placeholder="T√¨m k·ªπ thu·∫≠t vi√™n theo t√™n ho·∫∑c m√£ nh√¢n vi√™n...">
              </div>
              <small class="text-dark">G√µ ƒë·ªÉ l·ªçc nhanh.</small>
            </div>
            <div class="mb-3 d-flex justify-content-between align-items-center">
              <div class="d-flex gap-2">
                <button type="button" class="btn btn-sm btn-outline-primary" id="selectAllTechBtn">
                  <i class="fas fa-check-double me-1"></i>Ch·ªçn t·∫•t c·∫£
                </button>
                <button type="button" class="btn btn-sm btn-outline-primary" id="deselectAllTechBtn">
                  <i class="fas fa-times me-1"></i>B·ªè ch·ªçn t·∫•t c·∫£
                </button>
              </div>
              <div>
                <span class="badge bg-primary" id="selectedCountBadge">ƒê√£ ch·ªçn: 0</span>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">
                <i class="fas fa-star text-dark me-1"></i>Ch·ªçn k·ªπ thu·∫≠t vi√™n ch√≠nh
              </label>
              <select id="primaryTechSelect" class="form-select">
                <option value="">-- Ch∆∞a ch·ªçn --</option>
              </select>
              <small class="text-dark">K·ªπ thu·∫≠t vi√™n ch√≠nh s·∫Ω ƒë∆∞·ª£c t·ª± ƒë·ªông ch·ªçn n·∫øu b·∫°n ch·ªçn checkbox ƒë·∫ßu ti√™n</small>
            </div>
            <div id="assignTechContainer" class="row g-2" style="max-height: 400px; overflow-y: auto;"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              <i class="fas fa-times me-1"></i>H·ªßy
            </button>
            <button type="button" class="btn btn-primary" id="saveAssignTechBtn">
              <i class="fas fa-save me-1"></i>L∆∞u
            </button>
          </div>
        </div>
      </div>
    </div>`;

    $('body').append(modalHtml);
    const modal = new bootstrap.Modal(document.getElementById('assignTechniciansModal'));
    modal.show();
    
    // Focus v√†o search box khi modal hi·ªÉn th·ªã
    setTimeout(() => $('#assignTechSearch').focus(), 300);

    let allEmployees = [];
    let currentPrimaryId = null;
    
    // L·∫•y primary technician hi·ªán t·∫°i
    if (maintenanceTicketData.technicians && maintenanceTicketData.technicians.length > 0) {
      const primaryTech = maintenanceTicketData.technicians.find(t => t.roleInTicket === 'PRIMARY');
      if (primaryTech) {
        currentPrimaryId = primaryTech.technicianId;
      }
    }

    // T·∫£i danh s√°ch k·ªπ thu·∫≠t vi√™n - ch·ªâ l·∫•y k·ªπ thu·∫≠t vi√™n c√πng chi nh√°nh
    const branchId = maintenanceTicketData?.branchId;
    if (!branchId) {
      showAlert('Kh√¥ng t√¨m th·∫•y th√¥ng tin chi nh√°nh. Vui l√≤ng t·∫£i l·∫°i trang.', 'warning');
      bootstrap.Modal.getInstance(document.getElementById('assignTechniciansModal')).hide();
      $('#assignTechniciansModal').remove();
      return;
    }
    
    const token = localStorage.getItem('authToken');
    fetch(`${API_BASE_URL}/Employee/filter?roleId=4&branchId=${branchId}`, {
        headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        }
    })
      .then(r => {
          if (!r.ok) {
              throw new Error(`HTTP error! status: ${r.status}`);
          }
          return r.json();
      })
      .then(list => {
        allEmployees = (list || []).map(emp => ({
          id: emp.id,
          name: (`${emp.firstName || ''} ${emp.lastName || ''}`).trim() || emp.code || `#${emp.id}`,
          code: emp.code || ''
        }));

        function updateSelectedCount() {
          const count = $('.assign-tech-checkbox:checked').length;
          $('#selectedCountBadge').text(`ƒê√£ ch·ªçn: ${count}`);
        }

        function updatePrimarySelect() {
          const primarySelect = $('#primaryTechSelect');
          const checkedIds = [];
          $('.assign-tech-checkbox:checked').each(function() {
            checkedIds.push(parseInt($(this).val()));
          });
          
          primarySelect.empty();
          primarySelect.append('<option value="">-- Ch∆∞a ch·ªçn --</option>');
          
          allEmployees.forEach(emp => {
            if (checkedIds.includes(emp.id)) {
              const isPrimary = currentPrimaryId === emp.id;
              primarySelect.append(`<option value="${emp.id}" ${isPrimary ? 'selected' : ''}>${emp.name}</option>`);
            }
          });
          
          // N·∫øu ch∆∞a c√≥ primary v√† c√≥ √≠t nh·∫•t 1 checkbox ƒë∆∞·ª£c ch·ªçn, t·ª± ƒë·ªông ch·ªçn checkbox ƒë·∫ßu ti√™n l√†m primary
          if (!currentPrimaryId && checkedIds.length > 0) {
            currentPrimaryId = checkedIds[0];
            primarySelect.val(currentPrimaryId);
          }
        }

        function render(listToRender, searchQuery = '') {
          const container = $('#assignTechContainer');
          container.empty();
          
          if (!listToRender || listToRender.length === 0) {
            container.html('<div class="text-center text-dark py-5"><i class="fas fa-user-slash fa-3x mb-3"></i><p>Kh√¥ng c√≥ k·ªπ thu·∫≠t vi√™n ph√π h·ª£p</p></div>');
            updateSelectedCount();
            return;
          }
          
          // L·∫•y danh s√°ch ƒë√£ ch·ªçn t·ª´ checkbox hi·ªán t·∫°i ho·∫∑c t·ª´ data ban ƒë·∫ßu
          const checkedIds = [];
          $('.assign-tech-checkbox:checked').each(function() {
            checkedIds.push(parseInt($(this).val()));
          });
          
          // N·∫øu ch∆∞a c√≥ checkbox n√†o (l·∫ßn ƒë·∫ßu render), l·∫•y t·ª´ maintenanceTicketData
          if (checkedIds.length === 0 && maintenanceTicketData.technicians && maintenanceTicketData.technicians.length > 0) {
            maintenanceTicketData.technicians.forEach(t => {
              if (!checkedIds.includes(t.technicianId)) {
                checkedIds.push(t.technicianId);
              }
            });
          }
          
          listToRender.forEach(emp => {
            const isChecked = checkedIds.includes(emp.id);
            const isPrimary = currentPrimaryId === emp.id;
            const highlightClass = isPrimary ? 'border-secondary bg-light' : '';
            const primaryBadge = isPrimary ? '<span class="badge bg-warning text-dark ms-2"><i class="fas fa-star me-1"></i>Ch√≠nh</span>' : '';
            
            // Highlight search query
            let displayName = emp.name;
            let displayCode = emp.code;
            if (searchQuery) {
              const regex = new RegExp(`(${searchQuery.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
              displayName = displayName.replace(regex, '<mark>$1</mark>');
              displayCode = displayCode.replace(regex, '<mark>$1</mark>');
            }
            
            container.append(`
              <div class="col-md-6">
                <div class="form-check border rounded p-3 ${highlightClass} tech-card" style="transition: all 0.2s; cursor: pointer;" data-tech-id="${emp.id}">
                  <input class="form-check-input assign-tech-checkbox" type="checkbox" value="${emp.id}" id="assign_${emp.id}" ${isChecked ? 'checked' : ''} style="cursor: pointer; pointer-events: auto;">
                  <label class="form-check-label w-100" for="assign_${emp.id}" style="cursor: pointer; pointer-events: auto;">
                    <strong>${displayName}</strong>${primaryBadge}
                    <br><small class="text-dark">M√£ nh√¢n vi√™n: ${displayCode}</small>
                  </label>
                </div>
              </div>
            `);
          });
          
          updateSelectedCount();
          updatePrimarySelect();
        }

        // X·ª≠ l√Ω click v√†o card ƒë·ªÉ toggle checkbox (ch·ªâ khi click v√†o v√πng tr·ªëng, kh√¥ng ph·∫£i checkbox/label)
        $(document).on('click', '.tech-card', function(e) {
          // N·∫øu click v√†o checkbox, ƒë·ªÉ browser x·ª≠ l√Ω t·ª± nhi√™n
          if ($(e.target).is('input[type="checkbox"]')) {
            return; // Cho ph√©p default behavior c·ªßa checkbox
          }
          // N·∫øu click v√†o label, ƒë·ªÉ browser x·ª≠ l√Ω t·ª± nhi√™n (label t·ª± ƒë·ªông toggle checkbox)
          if ($(e.target).is('label') || $(e.target).closest('label').length > 0) {
            return; // Cho ph√©p default behavior c·ªßa label
          }
          // N·∫øu click v√†o v√πng kh√°c c·ªßa card, toggle checkbox
          e.preventDefault();
          e.stopPropagation();
          const checkbox = $(this).find('input[type="checkbox"]');
          if (checkbox.length) {
            checkbox.prop('checked', !checkbox.prop('checked'));
            checkbox.trigger('change');
          }
          return false;
        });

        // X·ª≠ l√Ω checkbox change
        $(document).on('change', '.assign-tech-checkbox', function(e) {
          e.stopPropagation();
          const techId = parseInt($(this).val());
          const isChecked = $(this).is(':checked');
          
          // N·∫øu ƒë√¢y l√† checkbox ƒë·∫ßu ti√™n ƒë∆∞·ª£c ch·ªçn v√† ch∆∞a c√≥ primary, t·ª± ƒë·ªông set l√†m primary
          if (isChecked && !currentPrimaryId && $('.assign-tech-checkbox:checked').length === 1) {
            currentPrimaryId = techId;
            $('#primaryTechSelect').val(techId);
          }
          
          // N·∫øu b·ªè ch·ªçn primary technician, x√≥a primary
          if (!isChecked && currentPrimaryId === techId) {
            currentPrimaryId = null;
            $('#primaryTechSelect').val('');
          }
          
          // C·∫≠p nh·∫≠t UI m√† kh√¥ng re-render to√†n b·ªô
          updateSelectedCount();
          updatePrimarySelect();
          
          // C·∫≠p nh·∫≠t highlight cho card
          const card = $(this).closest('.tech-card');
          if (currentPrimaryId === techId) {
            card.addClass('border-secondary bg-light');
            card.find('label strong').html(function() {
              const text = $(this).text().replace(/\s*\(Ch√≠nh\)\s*$/, '');
              return text + ' <span class="badge bg-warning text-dark ms-2"><i class="fas fa-star me-1"></i>Ch√≠nh</span>';
            });
          } else {
            card.removeClass('border-secondary bg-light');
            card.find('label strong').html(function() {
              return $(this).text().replace(/\s*\(Ch√≠nh\)\s*$/, '');
            });
          }
        });

        // X·ª≠ l√Ω thay ƒë·ªïi primary select
        $(document).on('change', '#primaryTechSelect', function() {
          currentPrimaryId = $(this).val() ? parseInt($(this).val()) : null;
          // ƒê·∫£m b·∫£o checkbox c·ªßa primary ƒë∆∞·ª£c ch·ªçn
          if (currentPrimaryId) {
            $(`#assign_${currentPrimaryId}`).prop('checked', true);
          }
          // Re-render ƒë·ªÉ highlight
          const searchQuery = $('#assignTechSearch').val().toLowerCase();
          const filtered = searchQuery ? 
            allEmployees.filter(e => e.name.toLowerCase().includes(searchQuery) || (e.code && e.code.toLowerCase().includes(searchQuery))) :
            allEmployees;
          render(filtered, searchQuery);
        });

        // Ch·ªçn t·∫•t c·∫£
        $(document).on('click', '#selectAllTechBtn', function() {
          const searchQuery = $('#assignTechSearch').val().toLowerCase();
          const filtered = searchQuery ? 
            allEmployees.filter(e => e.name.toLowerCase().includes(searchQuery) || (e.code && e.code.toLowerCase().includes(searchQuery))) :
            allEmployees;
          
          filtered.forEach(emp => {
            $(`#assign_${emp.id}`).prop('checked', true);
          });
          
          // T·ª± ƒë·ªông ch·ªçn primary n·∫øu ch∆∞a c√≥
          if (!currentPrimaryId && filtered.length > 0) {
            currentPrimaryId = filtered[0].id;
            $('#primaryTechSelect').val(currentPrimaryId);
          }
          
          updateSelectedCount();
          updatePrimarySelect();
        });

        // B·ªè ch·ªçn t·∫•t c·∫£
        $(document).on('click', '#deselectAllTechBtn', function() {
          $('.assign-tech-checkbox').prop('checked', false);
          currentPrimaryId = null;
          $('#primaryTechSelect').val('');
          updateSelectedCount();
          updatePrimarySelect();
        });

        // L·∫ßn ƒë·∫ßu render t·∫•t c·∫£
        render(allEmployees);

        // L·ªçc theo th·ªùi gian th·ª±c v·ªõi debounce
        let t;
        $('#assignTechSearch').on('input', function() {
          clearTimeout(t);
          const q = $(this).val().toLowerCase();
          t = setTimeout(() => {
            if (!q) { 
              render(allEmployees); 
              return; 
            }
            const filtered = allEmployees.filter(e => 
              e.name.toLowerCase().includes(q) || (e.code && e.code.toLowerCase().includes(q))
            );
            render(filtered, q);
          }, 120);
        });
      })
      .catch(error => {
          console.error('Error loading employees:', error);
          $('#assignTechContainer').html('<div class="text-center text-danger py-5"><i class="fas fa-exclamation-triangle fa-3x mb-3"></i><p>Kh√¥ng th·ªÉ t·∫£i danh s√°ch k·ªπ thu·∫≠t vi√™n: ' + error.message + '</p></div>');
          showAlert('Kh√¥ng th·ªÉ t·∫£i danh s√°ch k·ªπ thu·∫≠t vi√™n. Vui l√≤ng th·ª≠ l·∫°i sau.', 'danger');
      });

    $(document).on('click', '#saveAssignTechBtn', function() {
      const ids = [];
      $('.assign-tech-checkbox:checked').each(function(){ 
        ids.push(parseInt($(this).val())); 
      });
      
      const primaryIdVal = $('#primaryTechSelect').val();
      const primaryId = primaryIdVal ? parseInt(primaryIdVal) : null;
      
      if (ids.length === 0) {
        showAlert('Vui l√≤ng ch·ªçn √≠t nh·∫•t m·ªôt k·ªπ thu·∫≠t vi√™n', 'warning');
        return;
      }
      
      if (primaryId && !ids.includes(primaryId)) {
        ids.push(primaryId);
      }
      
      const submitBtn = $(this);
      const originalText = submitBtn.html();
      submitBtn.html('<i class="fas fa-spinner fa-spin me-1"></i>ƒêang l∆∞u...');
      submitBtn.prop('disabled', true);
      
      const token = localStorage.getItem('authToken');
      fetch(`${API_BASE_URL}/MaintenanceTicket/${maintenanceTicketId}/technicians`, {
        method: 'PUT',
        headers: { 
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ technicianIds: ids, primaryId })
      }).then(r => r.json()).then(res => {
        if (res.success) {
          maintenanceTicketData = res.data;
          displayBasicInfo(maintenanceTicketData);
          displayStatusAndActions(maintenanceTicketData);
          
          // ‚úÖ G√°n k·ªπ thu·∫≠t vi√™n ·ªü "Thao t√°c" ch·ªâ ƒë·ªÉ qu·∫£n l√Ω, KH√îNG t·ª± ƒë·ªông g√°n cho c√¥ng vi·ªác
          // C√¥ng vi·ªác ch·ªâ hi·ªÉn th·ªã khi ƒë∆∞·ª£c g√°n TR·ª∞C TI·∫æP v√†o t·ª´ng ServiceTask
          showAlert('G√°n k·ªπ thu·∫≠t vi√™n th√†nh c√¥ng!', 'success');
          
          bootstrap.Modal.getInstance(document.getElementById('assignTechniciansModal')).hide();
          $('#assignTechniciansModal').remove();
        } else {
          showAlert(res.message || 'G√°n k·ªπ thu·∫≠t vi√™n th·∫•t b·∫°i', 'danger');
          submitBtn.html(originalText);
          submitBtn.prop('disabled', false);
        }
      }).catch(() => {
        showAlert('Kh√¥ng th·ªÉ k·∫øt n·ªëi m√°y ch·ªß', 'danger');
        submitBtn.html(originalText);
        submitBtn.prop('disabled', false);
      });
    });
}

function displayTimeline(data) {
    const timeline = $('#timeline');
    const events = [];
    
    // Add events based on data
    if (data.createdDate) {
        events.push({
            date: new Date(data.createdDate),
            title: 'T·∫°o phi·∫øu b·∫£o d∆∞·ª°ng',
            description: 'Phi·∫øu b·∫£o d∆∞·ª°ng ƒë∆∞·ª£c t·∫°o',
            icon: 'fas fa-plus-circle',
            color: 'secondary'
        });
    }
    
    if (data.technicianName) {
        events.push({
            date: new Date(data.createdDate), // You might want to track actual assignment date
            title: 'G√°n k·ªπ thu·∫≠t vi√™n',
            description: `G√°n cho ${data.technicianName}`,
            icon: 'fas fa-user-plus',
            color: 'secondary'
        });
    }
    
    if (data.startTime) {
        events.push({
            date: new Date(data.startTime),
            title: 'B·∫Øt ƒë·∫ßu b·∫£o d∆∞·ª°ng',
            description: 'B·∫Øt ƒë·∫ßu th·ª±c hi·ªán b·∫£o d∆∞·ª°ng',
            icon: 'fas fa-play',
            color: 'secondary'
        });
    }
    
    if (data.endTime) {
        events.push({
            date: new Date(data.endTime),
            title: 'Ho√†n th√†nh b·∫£o d∆∞·ª°ng',
            description: 'B·∫£o d∆∞·ª°ng ƒë√£ ho√†n th√†nh',
            icon: 'fas fa-check-circle',
            color: 'secondary'
        });
    }
    
    if (data.statusCode === 'CANCELLED') {
        events.push({
            date: new Date(data.createdDate), // Ho·∫∑c c√≥ th·ªÉ c√≥ cancelledDate n·∫øu c√≥
            title: 'H·ªßy phi·∫øu b·∫£o d∆∞·ª°ng',
            description: 'Phi·∫øu b·∫£o d∆∞·ª°ng ƒë√£ ƒë∆∞·ª£c h·ªßy',
            icon: 'fas fa-times-circle',
            color: 'secondary'
        });
    }
    
    // Sort events by date
    events.sort((a, b) => a.date - b.date);
    
    if (events.length === 0) {
        timeline.html('<p class="text-dark">Ch∆∞a c√≥ ho·∫°t ƒë·ªông n√†o</p>');
        return;
    }
    
    let timelineHtml = '';
    events.forEach((event, index) => {
        const isLast = index === events.length - 1;
                timelineHtml += `
                    <div class="d-flex ${!isLast ? 'mb-3' : ''}">
                        <div class="flex-shrink-0">
                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                        <i class="${event.icon}"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                    <h6 class="mb-1">${event.title}</h6>
                    <p class="mb-1 text-dark">${event.description}</p>
                    <small class="text-dark">${formatVietnamDateTime(event.date)}</small>
                        </div>
                    </div>
                    ${!isLast ? '<hr class="my-2">' : ''}
                `;
            });
            
            timeline.html(timelineHtml);
}

function displayCostSummary(data, componentTotal = 0, laborCostTotal = 0) {
    const costSummary = $('#costSummary');
    const estimatedCost = data?.totalEstimatedCost || (componentTotal + laborCostTotal);
    
    costSummary.html(`
        <div class="text-center mb-3">
            <h4 class="text-primary">${formatCurrency(estimatedCost)}</h4>
            <p class="text-dark mb-0">T·ªïng chi ph√≠ ∆∞·ªõc t√≠nh</p>
        </div>
        <hr>
        <div class="mb-2">
            <div class="d-flex justify-content-between mb-2">
                <span class="text-dark small">T·ªïng ph·ª• t√πng:</span>
                <strong>${formatCurrency(componentTotal)}</strong>
            </div>
            <div class="d-flex justify-content-between mb-2">
                <span class="text-dark small">T·ªïng ph√≠ nh√¢n c√¥ng:</span>
                <strong class="text-success">${formatCurrency(laborCostTotal)}</strong>
            </div>
        </div>
        <hr>
        <div class="text-center">
            <small class="text-dark">Chi ph√≠ s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t t·ª± ƒë·ªông khi th√™m/s·ª≠a ph·ª• t√πng ho·∫∑c c√¥ng vi·ªác</small>
        </div>
    `);
}

function loadServiceTasks() {
    // L·∫•y token ƒë·ªÉ authenticate
    const token = localStorage.getItem('authToken');
    
    fetch(`${API_BASE_URL}/ServiceTask/by-ticket/${maintenanceTicketId}`, {
        headers: {
            'Authorization': token ? `Bearer ${token}` : ''
        }
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayServiceTasks(data.data || []);
            } else {
                console.error('Error loading service tasks:', data.message);
                $('#serviceTasksList').html('<p class="text-dark text-danger">Kh√¥ng th·ªÉ t·∫£i danh s√°ch c√¥ng vi·ªác</p>');
            }
            // Update cost summary after loading service tasks
            // This ensures labor cost is included in the summary
            updateCostSummary();
        })
        .catch(error => {
            console.error('Error loading service tasks:', error);
            $('#serviceTasksList').html('<p class="text-dark text-danger">L·ªói t·∫£i danh s√°ch c√¥ng vi·ªác</p>');
            // Still try to update cost summary even if service tasks fail
            updateCostSummary();
        });
}

function displayServiceTasks(tasks) {
    const container = $('#serviceTasksList');
    
    if (!tasks || tasks.length === 0) {
        container.html('<p class="text-dark text-center py-3"><i class="fas fa-inbox me-2"></i>Ch∆∞a c√≥ c√¥ng vi·ªác n√†o</p>');
        // N·∫øu kh√¥ng c√≥ c√¥ng vi·ªác n√†o, v·∫´n cho ph√©p ho√†n th√†nh phi·∫øu
        updateCompleteButtonState([]);
        return;
    }
    
    const canEdit = maintenanceTicketData && (maintenanceTicketData.statusCode === 'PENDING' || maintenanceTicketData.statusCode === 'ASSIGNED' || maintenanceTicketData.statusCode === 'IN_PROGRESS');
    
    // Ki·ªÉm tra c√¥ng vi·ªác ch∆∞a ho√†n th√†nh
    const incompleteTasks = tasks.filter(t => t.statusCode !== 'DONE' && t.statusCode !== 'COMPLETED');
    
    // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t "Ho√†n th√†nh"
    updateCompleteButtonState(incompleteTasks);
    
    let html = '';
    tasks.forEach(task => {
        const statusBadge = getTaskStatusBadge(task.statusCode);
        const standardLaborTime = task.standardLaborTime ?? null;
        const actualLaborTime = task.actualLaborTime ?? 0;
        const laborCost = task.laborCost || 0;
        const standardLaborTimeDisplay = standardLaborTime !== null ? standardLaborTime.toFixed(2) : '0.00';
        const standardLaborTimeForModal = standardLaborTime !== null ? standardLaborTime : 'null';
        
        // Ki·ªÉm tra c√¥ng vi·ªác ƒë√£ ho√†n th√†nh ch∆∞a
        const isTaskCompleted = task.statusCode === 'DONE' || task.statusCode === 'COMPLETED';
        const canEditTask = canEdit && !isTaskCompleted;
        
        html += `
            <div class="card mb-2 border-start border-3 ${getTaskBorderColor(task.statusCode)}">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6 class="mb-1 fw-bold">${escapeHtml(task.taskName || 'N/A')}</h6>
                            ${task.description ? `<p class="mb-1 text-dark small">${escapeHtml(task.description)}</p>` : ''}
                            ${task.note ? `<div class="mt-2"><small class="text-dark"><i class="fas fa-sticky-note me-1"></i>${escapeHtml(task.note)}</small></div>` : ''}
                            ${task.completionNote ? `<div class="mt-2"><small class="text-dark"><i class="fas fa-check-circle me-1"></i><strong>Ghi ch√∫ ho√†n th√†nh:</strong> ${escapeHtml(task.completionNote)}</small></div>` : ''}
                            
                            <!-- Technician Info -->
                            ${task.technicians && task.technicians.length > 0 ? `
                                <div class="mt-2">
                                    <small class="text-dark d-block">K·ªπ thu·∫≠t vi√™n:</small>
                                    <div>
                                        ${task.technicians.map(tech => {
                                            const roleBadge = tech.roleInTask === 'PRIMARY' 
                                                ? '<span class="badge bg-warning text-dark ms-1"><i class="fas fa-star me-1"></i>Ch√≠nh</span>' 
                                                : '';
                                            return `<span class="badge bg-light text-dark me-1"><i class="fas fa-user-tie me-1"></i>${escapeHtml(tech.technicianName || 'N/A')}${roleBadge}</span>`;
                                        }).join('')}
                                    </div>
                                </div>
                            ` : (task.technicianName ? `
                                <div class="mt-2">
                                    <small class="text-dark d-block">K·ªπ thu·∫≠t vi√™n:</small>
                                    <strong><i class="fas fa-user-tie me-1"></i>${escapeHtml(task.technicianName)}</strong>
                                </div>
                            ` : '')}
                            
                            <!-- Time Info -->
                            ${task.startTime ? `
                                <div class="mt-1">
                                    <small class="text-dark">B·∫Øt ƒë·∫ßu: ${formatVietnamDateTime(task.startTime)}</small>
                                </div>
                            ` : ''}
                            ${task.endTime ? `
                                <div class="mt-1">
                                    <small class="text-dark">K·∫øt th√∫c: ${formatVietnamDateTime(task.endTime)}</small>
                                </div>
                            ` : ''}
                            
                            <!-- Labor Cost Information -->
                            <div class="mt-2 row g-2">
                                <div class="col-md-4">
                                    <small class="text-dark d-block">Th·ªùi gian chu·∫©n:</small>
                                    <strong>${standardLaborTimeDisplay} gi·ªù</strong>
                                    ${canEditTask && currentUserRoleId !== 4 ? `
                                        <button class="btn btn-sm btn-link p-0 ms-1" onclick="openEditStandardLaborTimeModal(${task.id})" title="Ch·ªânh s·ª≠a th·ªùi gian chu·∫©n">
                                            <i class="fas fa-edit text-dark"></i>
                                        </button>
                                    ` : ''}
                                </div>
                                <div class="col-md-4">
                                    <small class="text-dark d-block">Th·ªùi gian th·ª±c t·∫ø:</small>
                                    <strong>${actualLaborTime.toFixed(2)} gi·ªù</strong>
                                    ${canEditTask ? `
                                        <button class="btn btn-sm btn-link p-0 ms-1" onclick="openEditLaborTimeModal(${task.id})" title="Ch·ªânh s·ª≠a th·ªùi gian lao ƒë·ªông">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                    ` : ''}
                                    ${task.startTime && task.endTime ? `
                                        <div class="mt-1">
                                            <small class="text-muted"><i class="fas fa-info-circle me-1"></i>Th·ªùi gian t·ª± ƒë·ªông t√≠nh ch·ªâ l√† g·ª£i √Ω</small>
                                        </div>
                                    ` : ''}
                                    ${standardLaborTime !== null && actualLaborTime > (standardLaborTime * 1.5) ? `
                                        <div class="mt-1">
                                            <span class="badge bg-danger text-white"><i class="fas fa-exclamation-triangle me-1"></i>C·∫£nh b√°o: V∆∞·ª£t qu√° ${((actualLaborTime / standardLaborTime - 1) * 100).toFixed(0)}% th·ªùi gian chu·∫©n</span>
                                        </div>
                                    ` : ''}
                                    ${standardLaborTime !== null && actualLaborTime > standardLaborTime && actualLaborTime <= (standardLaborTime * 1.5) ? `
                                        <div class="mt-1">
                                            <span class="badge bg-warning text-dark"><i class="fas fa-info-circle me-1"></i>V∆∞·ª£t qu√° th·ªùi gian chu·∫©n ${((actualLaborTime / standardLaborTime - 1) * 100).toFixed(0)}%</span>
                                        </div>
                                    ` : ''}
                                </div>
                                <div class="col-md-4">
                                    <small class="text-dark d-block">Ph√≠ nh√¢n c√¥ng:</small>
                                    <strong>${formatCurrency(laborCost)}</strong>
                                </div>
                            </div>
                        </div>
                        <div class="ms-3 text-end">
                            ${statusBadge}
                            ${canEditTask ? `
                                <button class="btn btn-link text-dark p-1 me-1" onclick="editServiceTask(${task.id})" title="Ch·ªânh s·ª≠a" style="font-size: 0.875rem;">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-link text-dark p-1 me-1" onclick="deleteServiceTask(${task.id})" title="X√≥a" style="font-size: 0.875rem;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            ` : ''}
                            ${task.statusCode === 'PENDING' ? `
                                <button class="btn btn-sm btn-outline-primary mt-2" onclick="updateTaskStatus(${task.id}, 'IN_PROGRESS')" title="B·∫Øt ƒë·∫ßu">
                                    <i class="fas fa-play"></i>
                                </button>
                            ` : ''}
                            ${task.statusCode === 'IN_PROGRESS' ? `
                                <button class="btn btn-sm btn-outline-success mt-2" onclick="updateTaskStatus(${task.id}, 'DONE')" title="Ho√†n th√†nh">
                                    <i class="fas fa-check"></i>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.html(html);
}

// Bi·∫øn l∆∞u taskId v√† newStatus ƒë·ªÉ d√πng trong modal
let pendingTaskStatusUpdate = null;

function updateTaskStatus(taskId, newStatus) {
    // ‚úÖ N·∫øu ho√†n th√†nh (DONE), y√™u c·∫ßu nh·∫≠p CompletionNote qua modal
    if (newStatus === 'DONE' || newStatus === 'COMPLETED') {
        // L∆∞u th√¥ng tin ƒë·ªÉ d√πng sau khi user nh·∫≠p note
        pendingTaskStatusUpdate = { taskId, newStatus };
        
        // Reset v√† hi·ªÉn th·ªã modal
        $('#completionNoteInput').val('');
        $('#completionNoteModal').modal('show');
    } else {
        updateTaskStatusWithNote(taskId, newStatus, null);
    }
}

// X·ª≠ l√Ω khi user submit completion note
$(document).on('click', '#submitCompletionNoteBtn', function() {
    const completionNote = $('#completionNoteInput').val().trim();
    
    if (!completionNote) {
        showAlert('Vui l√≤ng nh·∫≠p ghi ch√∫ ho√†n th√†nh', 'warning');
        $('#completionNoteInput').focus();
        return;
    }
    
    if (!pendingTaskStatusUpdate) {
        showAlert('ƒê√£ x·∫£y ra s·ª± c·ªë. Vui l√≤ng th·ª≠ l·∫°i.', 'danger');
        $('#completionNoteModal').modal('hide');
        return;
    }
    
    // Disable button v√† hi·ªÉn th·ªã loading
    const btn = $(this);
    const originalHtml = btn.html();
    btn.html('<i class="fas fa-spinner fa-spin me-1"></i>ƒêang x·ª≠ l√Ω...');
    btn.prop('disabled', true);
    
    // G·ªçi API
    updateTaskStatusWithNote(
        pendingTaskStatusUpdate.taskId, 
        pendingTaskStatusUpdate.newStatus, 
        completionNote
    ).then(() => {
        // ƒê√≥ng modal v√† reset
        $('#completionNoteModal').modal('hide');
        pendingTaskStatusUpdate = null;
    }).catch(() => {
    }).finally(() => {
        btn.html(originalHtml);
        btn.prop('disabled', false);
    });
});

// Reset khi ƒë√≥ng modal
$('#completionNoteModal').on('hidden.bs.modal', function() {
    $('#completionNoteInput').val('');
    pendingTaskStatusUpdate = null;
});

function updateTaskStatusWithNote(taskId, newStatus, completionNote) {
    const token = localStorage.getItem('authToken');
    
    return fetch(`${API_BASE_URL}/ServiceTask/${taskId}/status`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': token ? `Bearer ${token}` : ''
        },
        body: JSON.stringify({ 
            statusCode: newStatus,
            completionNote: completionNote
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('C·∫≠p nh·∫≠t tr·∫°ng th√°i c√¥ng vi·ªác th√†nh c√¥ng!', 'success');
            loadServiceTasks(); // Reload danh s√°ch (s·∫Ω t·ª± ƒë·ªông c·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t "Ho√†n th√†nh")
            updateCostSummary(); // Update cost summary
            return Promise.resolve();
        } else {
            showAlert(data.message || 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i', 'danger');
            return Promise.reject(new Error(data.message || 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i', 'danger');
        return Promise.reject(error);
    });
}

function openEditLaborTimeModal(taskId) {
    const token = localStorage.getItem('authToken');
    
    // Load task ƒë·ªÉ l·∫•y th√¥ng tin
    fetch(`${API_BASE_URL}/ServiceTask/${taskId}`, {
        headers: {
            'Authorization': token ? `Bearer ${token}` : '',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.data) {
            const task = data.data;
            
            // Set gi√° tr·ªã v√†o form
            $('#editLaborTimeTaskId').val(taskId);
            
            // Standard Labor Time
            if (task.standardLaborTime !== null && task.standardLaborTime !== undefined) {
                $('#editStandardLaborTimeInModal').val(task.standardLaborTime);
            } else {
                $('#editStandardLaborTimeInModal').val('');
            }
            
            // Actual Labor Time - LU√îN cho ph√©p s·ª≠a
            if (task.actualLaborTime !== null && task.actualLaborTime !== undefined) {
                $('#editActualLaborTime').val(task.actualLaborTime);
            } else {
                $('#editActualLaborTime').val('');
            }
            
            // ‚úÖ Ki·ªÉm tra quy·ªÅn: N·∫øu l√† k·ªπ thu·∫≠t vi√™n (roleId = 4), disable StandardLaborTime
            if (currentUserRoleId === 4) {
                $('#editStandardLaborTimeInModal').prop('readonly', true).addClass('bg-light');
                $('#standardLaborTimeNoteInModal').text('(K·ªπ thu·∫≠t vi√™n kh√¥ng ƒë∆∞·ª£c ph√©p ch·ªânh s·ª≠a th·ªùi gian chu·∫©n)');
            } else {
                $('#editStandardLaborTimeInModal').prop('readonly', false).removeClass('bg-light');
                $('#standardLaborTimeNoteInModal').text('');
            }
            
            // Actual Labor Time LU√îN cho ph√©p s·ª≠a (kh√¥ng disable)
            $('#editActualLaborTime').prop('readonly', false).removeClass('bg-light');
            
            // Hi·ªÉn th·ªã c·∫£nh b√°o n·∫øu c√≥ StartTime v√† EndTime
            if (task.startTime && task.endTime) {
                const startTime = new Date(task.startTime);
                const endTime = new Date(task.endTime);
                const autoCalculated = ((endTime - startTime) / (1000 * 60 * 60)).toFixed(2);
                $('#editActualLaborTime').attr('placeholder', `T·ª± ƒë·ªông t√≠nh: ${autoCalculated} gi·ªù (c√≥ th·ªÉ s·ª≠a l·∫°i)`);
            } else {
                $('#editActualLaborTime').attr('placeholder', 'Nh·∫≠p th·ªùi gian th·ª±c t·∫ø');
            }
            
            // M·ªü modal
            $('#editLaborTimeModal').modal('show');
        } else {
            showAlert('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin c√¥ng vi·ªác', 'danger');
        }
    })
    .catch(error => {
        console.error('Error loading task:', error);
        showAlert('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin c√¥ng vi·ªác', 'danger');
    });
}

function openEditStandardLaborTimeModal(taskId) {
    const token = localStorage.getItem('authToken');
    
    // Load task ƒë·ªÉ l·∫•y th√¥ng tin
    fetch(`${API_BASE_URL}/ServiceTask/${taskId}`, {
        headers: {
            'Authorization': token ? `Bearer ${token}` : '',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.data) {
            const task = data.data;
            
            // Set gi√° tr·ªã v√†o form
            $('#editStandardLaborTimeTaskId').val(taskId);
            if (task.standardLaborTime !== null && task.standardLaborTime !== undefined) {
                $('#editStandardLaborTime').val(task.standardLaborTime);
            } else {
                $('#editStandardLaborTime').val('');
            }
            
            // ‚úÖ Ki·ªÉm tra quy·ªÅn: N·∫øu l√† k·ªπ thu·∫≠t vi√™n (roleId = 4), disable StandardLaborTime
            if (currentUserRoleId === 4) {
                $('#editStandardLaborTime').prop('readonly', true).addClass('bg-light');
                $('#standardLaborTimeNote').text('(K·ªπ thu·∫≠t vi√™n kh√¥ng ƒë∆∞·ª£c ph√©p ch·ªânh s·ª≠a th·ªùi gian chu·∫©n)');
            } else {
                $('#editStandardLaborTime').prop('readonly', false).removeClass('bg-light');
                $('#standardLaborTimeNote').text('');
            }
            
            // M·ªü modal
            $('#editStandardLaborTimeModal').modal('show');
        } else {
            showAlert('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin c√¥ng vi·ªác', 'danger');
        }
    })
    .catch(error => {
        console.error('Error loading task:', error);
        showAlert('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin c√¥ng vi·ªác', 'danger');
    });
}

function saveLaborTime() {
    const taskId = $('#editLaborTimeTaskId').val();
    const standardLaborTimeInput = $('#editStandardLaborTimeInModal').val();
    const actualLaborTimeInput = $('#editActualLaborTime').val();
    
    if (!taskId) {
        showAlert('Kh√¥ng t√¨m th·∫•y ID c√¥ng vi·ªác', 'warning');
        return;
    }
    
    // ‚úÖ LU√îN cho ph√©p s·ª≠a ActualLaborTime (kh√¥ng ch·∫∑n)
    // Th·ªùi gian t·ª± ƒë·ªông t√≠nh ch·ªâ l√† g·ª£i √Ω, nh√¢n vi√™n/qu·∫£n l√Ω c√≥ th·ªÉ s·ª≠a l·∫°i
    
    if (!actualLaborTimeInput || actualLaborTimeInput === '') {
        showAlert('Vui l√≤ng nh·∫≠p th·ªùi gian th·ª±c t·∫ø', 'warning');
        return;
    }
    
    const actualLaborTime = parseFloat(actualLaborTimeInput);
    if (actualLaborTime < 0.01 || actualLaborTime > 999.99) {
        showAlert('Th·ªùi gian th·ª±c t·∫ø ph·∫£i t·ª´ 0.01 ƒë·∫øn 999.99 gi·ªù', 'warning');
        return;
    }
    
    const standardLaborTime = standardLaborTimeInput && standardLaborTimeInput !== '' 
        ? parseFloat(standardLaborTimeInput) 
        : null;
    if (standardLaborTime !== null && (standardLaborTime < 0 || standardLaborTime > 999.99)) {
        showAlert('Th·ªùi gian chu·∫©n ph·∫£i t·ª´ 0 ƒë·∫øn 999.99 gi·ªù', 'warning');
        return;
    }
    
    const token = localStorage.getItem('authToken');
    const btn = $('#saveLaborTimeBtn');
    const originalText = btn.html();
    btn.html('<i class="fas fa-spinner fa-spin me-1"></i>ƒêang l∆∞u...');
    btn.prop('disabled', true);
    
    // Load task hi·ªán t·∫°i ƒë·ªÉ l·∫•y ƒë·∫ßy ƒë·ªß th√¥ng tin
    fetch(`${API_BASE_URL}/ServiceTask/${taskId}`, {
        headers: {
            'Authorization': token ? `Bearer ${token}` : '',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(taskData => {
        if (!taskData.success) {
            throw new Error(taskData.message || 'Kh√¥ng th·ªÉ t·∫£i th√¥ng tin c√¥ng vi·ªác');
        }
        
        const task = taskData.data;
        
        // ‚úÖ LU√îN CHO PH√âP S·ª¨A ActualLaborTime (kh√¥ng ch·∫∑n)
        // L√Ω do: Th·ªùi gian t·ª± ƒë·ªông t√≠nh (EndTime - StartTime) kh√¥ng ch√≠nh x√°c v√¨:
        // - Nh√¢n vi√™n c√≥ th·ªÉ v·ªÅ nh√† gi·ªØa ch·ª´ng (h·∫øt gi·ªù l√†m)
        // - C√≥ gi·ªù ngh·ªâ tr∆∞a, gi·ªù ngh·ªâ gi·∫£i lao
        // - C√¥ng vi·ªác c√≥ th·ªÉ k√©o d√†i nhi·ªÅu ng√†y
        // - Th·ªùi gian th·ª±c t·∫ø l√†m vi·ªác kh√¥ng ph·∫£i l√† EndTime - StartTime
        // V√¨ v·∫≠y LU√îN cho ph√©p s·ª≠a th·ªß c√¥ng ƒë·ªÉ ghi nh·∫≠n ch√≠nh x√°c
        
        // ‚úÖ N·∫øu l√† k·ªπ thu·∫≠t vi√™n, kh√¥ng cho ph√©p thay ƒë·ªïi StandardLaborTime
        let finalStandardLaborTime = standardLaborTime;
        if (currentUserRoleId === 4) {
            // K·ªπ thu·∫≠t vi√™n ch·ªâ ƒë∆∞·ª£c ch·ªânh ActualLaborTime, gi·ªØ nguy√™n StandardLaborTime
            finalStandardLaborTime = task.standardLaborTime;
        }
        
        // Update task v·ªõi th√¥ng tin m·ªõi
        const updateData = {
            id: parseInt(taskId),
            maintenanceTicketId: task.maintenanceTicketId,
            taskName: task.taskName,
            description: task.description || null,
            statusCode: task.statusCode,
            note: task.note || null,
            serviceCategoryId: task.serviceCategoryId || null,
            standardLaborTime: finalStandardLaborTime,
            actualLaborTime: actualLaborTime
        };
        
        // G·ªçi API update
        return fetch(`${API_BASE_URL}/ServiceTask/${taskId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': token ? `Bearer ${token}` : ''
        },
            body: JSON.stringify(updateData)
        });
    })
    .then(response => response.json())
    .then(data => {
        btn.html(originalText);
        btn.prop('disabled', false);
        
        if (data.success) {
            showAlert('C·∫≠p nh·∫≠t th·ªùi gian lao ƒë·ªông th√†nh c√¥ng!', 'success');
            $('#editLaborTimeModal').modal('hide');
            loadServiceTasks(); // Reload danh s√°ch
            updateCostSummary(); // Update cost summary
        } else {
            showAlert(data.message || 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t th·ªùi gian lao ƒë·ªông', 'danger');
        }
    })
    .catch(error => {
        btn.html(originalText);
        btn.prop('disabled', false);
        console.error('Error:', error);
        showAlert('Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t th·ªùi gian lao ƒë·ªông: ' + error.message, 'danger');
    });
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function getTaskBorderColor(statusCode) {
    // ‚úÖ ƒê∆°n gi·∫£n h√≥a: ch·ªâ d√πng border-secondary cho t·∫•t c·∫£
    return 'border-secondary';
}

function loadComponents() {
    const token = localStorage.getItem('authToken');
    fetch(`${API_BASE_URL}/TicketComponent/by-maintenance-ticket/${maintenanceTicketId}`, {
        headers: {
            'Authorization': token ? `Bearer ${token}` : '',
            'Content-Type': 'application/json'
        }
    })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                displayComponents(data.data || []);
                // Update cost summary after displaying components
                // This will also load service tasks to calculate labor cost
                updateCostSummary();
            }
        })
        .catch(error => {
            console.error('Error loading components:', error);
            $('#componentsList').html('<p class="text-dark text-center py-3 text-danger">Kh√¥ng th·ªÉ t·∫£i danh s√°ch ph·ª• t√πng: ' + error.message + '</p>');
            // Still try to update cost summary even if components fail
            updateCostSummary();
        });
}

function displayComponents(components) {
    const container = $('#componentsList');
    
    if (!components || components.length === 0) {
        container.html('<p class="text-dark text-center py-3"><i class="fas fa-inbox me-2"></i>Ch∆∞a s·ª≠ d·ª•ng ph·ª• t√πng n√†o</p>');
        return;
    }
    
    let html = '<div class="table-responsive"><table class="table table-hover table-sm"><thead class="table-light"><tr><th>Ph·ª• t√πng</th><th>Lo·∫°i</th><th>S·ªë l∆∞·ª£ng ban ƒë·∫ßu</th><th>S·ªë l∆∞·ª£ng th·ª±c t·∫ø</th><th>ƒê∆°n gi√°</th><th>Th√†nh ti·ªÅn</th><th>Thao t√°c</th></tr></thead><tbody>';
    
    let totalCost = 0;
    components.forEach(component => {
        const actualQuantity = component.actualQuantity ?? component.quantity;
        const total = component.totalPrice || (actualQuantity * (component.unitPrice || 0));
        totalCost += total;
        const canEdit = maintenanceTicketData && (maintenanceTicketData.statusCode === 'PENDING' || maintenanceTicketData.statusCode === 'ASSIGNED' || maintenanceTicketData.statusCode === 'IN_PROGRESS');
        const quantityDisplay = component.actualQuantity !== null && component.actualQuantity !== undefined && component.actualQuantity !== component.quantity
            ? `<span>${component.quantity}</span> <small class="text-dark">‚Üí</small> <strong class="text-warning">${actualQuantity}</strong>`
            : `<span>${component.quantity}</span>`;
        html += `
            <tr>
                <td>
                    <div class="d-flex align-items-center">
                        ${component.componentImageUrl ? `<img src="${component.componentImageUrl}" alt="${component.componentName || ''}" class="me-2" style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px;">` : ''}
                        <div>
                            <strong>${escapeHtml(component.componentName || 'N/A')}</strong>
                            ${component.isFromServicePackage || component.servicePackageId ? '<span class="badge bg-info text-dark ms-2"><i class="fas fa-box me-1"></i>T·ª´ g√≥i d·ªãch v·ª•</span>' : ''}
                            ${component.componentCode ? `<br><small class="text-dark">M√£: ${escapeHtml(component.componentCode)}</small>` : ''}
                        </div>
                    </div>
                </td>
                <td>${escapeHtml(component.typeComponentName || '-')}</td>
                <td>${component.quantity}</td>
                <td>${actualQuantity.toFixed(2)}${component.actualQuantity !== null && component.actualQuantity !== undefined && component.actualQuantity !== component.quantity ? ' <span class="badge bg-info text-dark">ƒê√£ ƒëi·ªÅu ch·ªânh</span>' : ''}</td>
                <td>${formatCurrency(component.unitPrice || 0)}</td>
                <td><strong>${formatCurrency(total)}</strong></td>
                <td>
                    ${canEdit ? `
                        <button class="btn btn-link text-dark p-1 me-1" onclick="editComponent(${component.id})" title="Ch·ªânh s·ª≠a" style="font-size: 0.875rem;">
                            <i class="fas fa-edit"></i>
                        </button>
                        ${component.isFromServicePackage || component.servicePackageId ? 
                            '<button class="btn btn-link text-dark p-1" disabled title="Kh√¥ng th·ªÉ x√≥a ph·ª• t√πng t·ª´ g√≥i d·ªãch v·ª•" style="font-size: 0.875rem; cursor: not-allowed; opacity: 0.5;"><i class="fas fa-trash"></i></button>' :
                            `<button class="btn btn-link text-dark p-1" onclick="deleteComponent(${component.id})" title="X√≥a" style="font-size: 0.875rem;">
                                <i class="fas fa-trash"></i>
                            </button>`
                        }
                    ` : '<span class="text-dark">-</span>'}
                </td>
            </tr>
        `;
    });
    
    html += `</tbody><tfoot class="table-light"><tr><th colspan="5" class="text-end">T·ªïng ti·ªÅn ph·ª• t√πng:</th><th colspan="2">${formatCurrency(totalCost)}</th></tr></tfoot></table></div>`;
    container.html(html);
}

// Helper functions
// Helper function ƒë·ªÉ chuy·ªÉn ƒë·ªïi UTC sang gi·ªù Vi·ªát Nam (UTC+7)
function toVietnamTime(dateInput) {
    if (!dateInput) return null;
    let date;
    if (dateInput instanceof Date) {
        date = dateInput;
    } else {
        // N·∫øu l√† string, ƒë·∫£m b·∫£o parse nh∆∞ UTC
        // N·∫øu string kh√¥ng c√≥ timezone indicator (Z ho·∫∑c +HH:MM), th√™m 'Z' ƒë·ªÉ coi nh∆∞ UTC
        let dateStr = dateInput.toString();
        if (!dateStr.includes('Z') && !dateStr.includes('+') && !dateStr.includes('-', dateStr.indexOf('T') + 1)) {
            // N·∫øu kh√¥ng c√≥ timezone, th√™m 'Z' ƒë·ªÉ coi nh∆∞ UTC
            if (dateStr.includes('T')) {
                dateStr = dateStr.endsWith('Z') ? dateStr : dateStr + 'Z';
            }
        }
        date = new Date(dateStr);
    }
    if (isNaN(date.getTime())) return null;
    // Th√™m 7 gi·ªù ƒë·ªÉ chuy·ªÉn t·ª´ UTC sang gi·ªù Vi·ªát Nam
    return new Date(date.getTime() + (7 * 60 * 60 * 1000));
}

// Helper function ƒë·ªÉ format th·ªùi gian Vi·ªát Nam (gi·ªëng v·ªõi ServiceSchedule)
function formatVietnamDateTime(dateInput) {
    if (!dateInput) return 'Kh√¥ng x√°c ƒë·ªãnh';
    
    // Parse date string, ƒë·∫£m b·∫£o coi nh∆∞ UTC n·∫øu kh√¥ng c√≥ timezone indicator
    let dateStr = dateInput.toString();
    if (typeof dateStr === 'string' && !dateStr.endsWith('Z') && !dateStr.includes('+') && !dateStr.includes('-', 10)) {
        dateStr = dateStr + 'Z';
    }
    const date = new Date(dateStr);
    
    if (isNaN(date.getTime())) return 'Kh√¥ng x√°c ƒë·ªãnh';
    
    // Convert UTC to Vietnam time (UTC+7) - add 7 hours
    const vietnamTime = new Date(date.getTime() + (7 * 60 * 60 * 1000));
    
    // Format: dd/MM/yyyy HH:mm:ss (use getUTCDate/getUTCHours after conversion)
    const day = String(vietnamTime.getUTCDate()).padStart(2, '0');
    const month = String(vietnamTime.getUTCMonth() + 1).padStart(2, '0');
    const year = vietnamTime.getUTCFullYear();
    const hours = String(vietnamTime.getUTCHours()).padStart(2, '0');
    const minutes = String(vietnamTime.getUTCMinutes()).padStart(2, '0');
    const seconds = String(vietnamTime.getUTCSeconds()).padStart(2, '0');
    
    return `${day}/${month}/${year} ${hours}:${minutes}:${seconds}`;
}

function getStatusBadge(statusCode) {
    const statusMap = {
        'PENDING': { text: 'Ch·ªù x·ª≠ l√Ω', class: 'bg-info' },
        'ASSIGNED': { text: 'ƒê√£ g√°n', class: 'bg-primary' },
        'IN_PROGRESS': { text: 'ƒêang th·ª±c hi·ªán', class: 'bg-primary' },
        'COMPLETED': { text: 'Ho√†n th√†nh', class: 'bg-success' },
        'CANCELLED': { text: 'ƒê√£ h·ªßy', class: 'bg-danger' }
    };
    
    const status = statusMap[statusCode] || { text: statusCode, class: 'bg-light text-dark' };
    return `<span class="badge ${status.class} fs-6">${status.text}</span>`;
}

function getPriorityBadge(priority) {
    const priorityMap = {
        'NORMAL': { text: 'B√¨nh th∆∞·ªùng', class: 'bg-light text-dark' },
        'HIGH': { text: 'Cao', class: 'bg-warning text-dark' },
        'URGENT': { text: 'Kh·∫©n c·∫•p', class: 'bg-danger' }
    };
    
    const priorityInfo = priorityMap[priority] || { text: priority, class: 'bg-light text-dark' };
    return `<span class="badge ${priorityInfo.class}">${priorityInfo.text}</span>`;
}

function getProgressPercentage(statusCode) {
    const progressMap = {
        'PENDING': 25,
        'ASSIGNED': 50,
        'IN_PROGRESS': 75,
        'COMPLETED': 100,
        'CANCELLED': 0
    };
    
    return progressMap[statusCode] || 0;
}

function getTaskStatusBadge(statusCode) {
    const statusMap = {
        'PENDING': { text: 'Ch·ªù', class: 'bg-info' },
        'IN_PROGRESS': { text: 'ƒêang l√†m', class: 'bg-primary' },
        'DONE': { text: 'Xong', class: 'bg-success' }
    };
    
    const status = statusMap[statusCode] || { text: statusCode, class: 'bg-light text-dark' };
    return `<span class="badge ${status.class}">${status.text}</span>`;
}

// Action functions
function assignTechnician(ticketId) {
    // Implementation for assigning technician
    showAlert('Ch·ª©c nƒÉng g√°n k·ªπ thu·∫≠t vi√™n ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn', 'info');
}

function showConfirmModal(message, onConfirm) {
    $('#confirmModalBody').html(message);
    $('#confirmModalBtn').off('click').on('click', function() {
        $('#confirmModal').modal('hide');
        if (onConfirm) onConfirm();
    });
    $('#confirmModal').modal('show');
}

function startMaintenance(ticketId) {
    showConfirmModal(
        '<p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën b·∫Øt ƒë·∫ßu b·∫£o d∆∞·ª°ng kh√¥ng?</p>',
        function() {
            executeStartMaintenance(ticketId);
        }
    );
}

function executeStartMaintenance(ticketId) {
    const token = localStorage.getItem('authToken');
    
    fetch(`${API_BASE_URL}/MaintenanceTicket/${ticketId}/start`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': token ? `Bearer ${token}` : ''
        }
    })
    .then(async response => {
        const data = await response.json();
        if (!response.ok) {
            throw new Error(data.message || 'Kh√¥ng th·ªÉ b·∫Øt ƒë·∫ßu b·∫£o d∆∞·ª°ng');
        }
        return data;
    })
    .then(data => {
        if (data.success) {
            showAlert('B·∫Øt ƒë·∫ßu b·∫£o d∆∞·ª°ng th√†nh c√¥ng!', 'success');
            loadMaintenanceTicketDetails(); // Reload ƒë·ªÉ c·∫≠p nh·∫≠t UI
        } else {
            showAlert(data.message || 'Kh√¥ng th·ªÉ b·∫Øt ƒë·∫ßu b·∫£o d∆∞·ª°ng', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('ƒê√£ x·∫£y ra s·ª± c·ªë: ' + error.message, 'danger');
    });
}

function completeMaintenance(ticketId) {
    // Ki·ªÉm tra l·∫°i c√¥ng vi·ªác ch∆∞a ho√†n th√†nh tr∆∞·ªõc khi hi·ªÉn th·ªã confirm
    const token = localStorage.getItem('authToken');
    fetch(`${API_BASE_URL}/ServiceTask/by-ticket/${maintenanceTicketId}`, {
        headers: {
            'Authorization': token ? `Bearer ${token}` : ''
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const tasks = data.data || [];
            const incompleteTasks = tasks.filter(t => t.statusCode !== 'DONE' && t.statusCode !== 'COMPLETED');
            
            if (incompleteTasks.length > 0) {
                const taskNames = incompleteTasks.slice(0, 5).map(t => t.taskName || `Task ${t.id}`).join(', ');
                const message = incompleteTasks.length > 5
                    ? `<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i><strong>C·∫£nh b√°o!</strong></div><p>Kh√¥ng th·ªÉ ho√†n th√†nh phi·∫øu. C√≤n <strong>${incompleteTasks.length} c√¥ng vi·ªác</strong> ch∆∞a ho√†n th√†nh:</p><ul><li>${taskNames}</li><li>... v√† ${incompleteTasks.length - 5} c√¥ng vi·ªác kh√°c</li></ul><p class="mb-0">Vui l√≤ng ho√†n th√†nh t·∫•t c·∫£ c√¥ng vi·ªác tr∆∞·ªõc khi ho√†n th√†nh phi·∫øu.</p>`
                    : `<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i><strong>C·∫£nh b√°o!</strong></div><p>Kh√¥ng th·ªÉ ho√†n th√†nh phi·∫øu. C√≤n <strong>${incompleteTasks.length} c√¥ng vi·ªác</strong> ch∆∞a ho√†n th√†nh:</p><ul>${incompleteTasks.map(t => `<li>${escapeHtml(t.taskName || `Task ${t.id}`)}</li>`).join('')}</ul><p class="mb-0">Vui l√≤ng ho√†n th√†nh t·∫•t c·∫£ c√¥ng vi·ªác tr∆∞·ªõc khi ho√†n th√†nh phi·∫øu.</p>`;
                
                showAlert(message, 'warning');
                return;
            }
            
            // T·∫•t c·∫£ c√¥ng vi·ªác ƒë√£ ho√†n th√†nh, hi·ªÉn th·ªã confirm
            showConfirmModal(
                '<p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ho√†n th√†nh phi·∫øu b·∫£o d∆∞·ª°ng n√†y kh√¥ng?</p>',
                function() {
                    executeCompleteMaintenance(ticketId);
                }
            );
        } else {
            // N·∫øu kh√¥ng load ƒë∆∞·ª£c danh s√°ch c√¥ng vi·ªác, v·∫´n cho ph√©p th·ª≠ ho√†n th√†nh (backend s·∫Ω validate)
            showConfirmModal(
                '<p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ho√†n th√†nh phi·∫øu b·∫£o d∆∞·ª°ng n√†y kh√¥ng?</p>',
                function() {
                    executeCompleteMaintenance(ticketId);
                }
            );
        }
    })
    .catch(error => {
        console.error('Error checking tasks:', error);
        showConfirmModal(
            '<p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën ho√†n th√†nh phi·∫øu b·∫£o d∆∞·ª°ng n√†y kh√¥ng?</p>',
            function() {
                executeCompleteMaintenance(ticketId);
            }
        );
    });
}

function updateCompleteButtonState(incompleteTasks) {
    const completeBtn = $('#completeMaintenanceBtn');
    if (completeBtn.length === 0) return; // N√∫t ch∆∞a ƒë∆∞·ª£c render
    
    if (incompleteTasks.length > 0) {
        // Disable n√∫t v√† th√™m tooltip
        completeBtn.prop('disabled', true);
        completeBtn.attr('title', `C√≤n ${incompleteTasks.length} c√¥ng vi·ªác ch∆∞a ho√†n th√†nh`);
        completeBtn.css('opacity', '0.6');
        
        // Th√™m th√¥ng b√°o b√™n d∆∞·ªõi n√∫t
        if ($('#completeWarningMessage').length === 0) {
            completeBtn.after(`
                <div id="completeWarningMessage" class="alert alert-warning mt-2 mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <small>C√≤n <strong>${incompleteTasks.length}</strong> c√¥ng vi·ªác ch∆∞a ho√†n th√†nh. Vui l√≤ng ho√†n th√†nh t·∫•t c·∫£ c√¥ng vi·ªác tr∆∞·ªõc khi ho√†n th√†nh phi·∫øu.</small>
                </div>
            `);
        } else {
            $('#completeWarningMessage').html(`
                <i class="fas fa-exclamation-triangle me-2"></i>
                <small>C√≤n <strong>${incompleteTasks.length}</strong> c√¥ng vi·ªác ch∆∞a ho√†n th√†nh. Vui l√≤ng ho√†n th√†nh t·∫•t c·∫£ c√¥ng vi·ªác tr∆∞·ªõc khi ho√†n th√†nh phi·∫øu.</small>
            `);
        }
    } else {
        // Enable n√∫t
        completeBtn.prop('disabled', false);
        completeBtn.removeAttr('title');
        completeBtn.css('opacity', '1');
        $('#completeWarningMessage').remove();
    }
}

function removeSingleTechnician(ticketId, technicianId) {
    // T√¨m t√™n k·ªπ thu·∫≠t vi√™n ƒë·ªÉ hi·ªÉn th·ªã trong popup
    const technician = maintenanceTicketData?.technicians?.find(t => t.technicianId === technicianId);
    const technicianName = technician ? technician.technicianName : 'k·ªπ thu·∫≠t vi√™n n√†y';
    
    showConfirmModal(
        `<p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a <strong>${technicianName}</strong> kh·ªèi phi·∫øu b·∫£o d∆∞·ª°ng?</p>`,
        function() {
            executeRemoveTechnician(ticketId, technicianId);
        }
    );
}

function executeRemoveTechnician(ticketId, technicianId) {
    if (!maintenanceTicketData || !maintenanceTicketData.technicians) {
        showAlert('Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu k·ªπ thu·∫≠t vi√™n', 'danger');
        return;
    }

    // L·∫•y danh s√°ch k·ªπ thu·∫≠t vi√™n c√≤n l·∫°i (lo·∫°i b·ªè ng∆∞·ªùi ƒë∆∞·ª£c x√≥a)
    const remainingTechnicians = maintenanceTicketData.technicians
        .filter(t => t.technicianId !== technicianId)
        .map(t => t.technicianId);

    // X√°c ƒë·ªãnh primary m·ªõi (n·∫øu ng∆∞·ªùi b·ªã x√≥a l√† primary, ch·ªçn ng∆∞·ªùi ƒë·∫ßu ti√™n c√≤n l·∫°i)
    let primaryId = null;
    const currentPrimary = maintenanceTicketData.technicians.find(t => t.roleInTicket === 'PRIMARY');
    
    if (remainingTechnicians.length > 0) {
        // C√≤n k·ªπ thu·∫≠t vi√™n kh√°c
        if (currentPrimary && currentPrimary.technicianId === technicianId) {
            // N·∫øu x√≥a primary, ch·ªçn ng∆∞·ªùi ƒë·∫ßu ti√™n c√≤n l·∫°i l√†m primary
            primaryId = remainingTechnicians[0];
        } else if (currentPrimary) {
            // Gi·ªØ nguy√™n primary hi·ªán t·∫°i n·∫øu kh√¥ng b·ªã x√≥a
            primaryId = currentPrimary.technicianId;
        } else {
            // N·∫øu kh√¥ng c√≥ primary, ch·ªçn ng∆∞·ªùi ƒë·∫ßu ti√™n
            primaryId = remainingTechnicians[0];
        }
    }
    // N·∫øu remainingTechnicians.length === 0, primaryId s·∫Ω l√† null (kh√¥ng c√≤n ai)

    const token = localStorage.getItem('authToken');
    fetch(`${API_BASE_URL}/MaintenanceTicket/${ticketId}/technicians`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ 
            technicianIds: remainingTechnicians, 
            primaryId: primaryId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('X√≥a k·ªπ thu·∫≠t vi√™n th√†nh c√¥ng', 'success');
            maintenanceTicketData = data.data;
            displayBasicInfo(maintenanceTicketData);
            displayStatusAndActions(maintenanceTicketData);
        } else {
            showAlert(data.message || 'X√≥a k·ªπ thu·∫≠t vi√™n th·∫•t b·∫°i', 'danger');
        }
    })
    .catch(error => {
        console.error('Error removing technician:', error);
        showAlert('Kh√¥ng th·ªÉ x√≥a k·ªπ thu·∫≠t vi√™n', 'danger');
    });
}

    // Export PDF function
    function exportPdf(ticketId) {
        const token = localStorage.getItem('authToken');
        const url = `${API_BASE_URL}/MaintenanceTicket/${ticketId}/export-pdf`;
        
        // T·∫°o link t·∫°m ƒë·ªÉ download
        const link = document.createElement('a');
        link.href = url;
        link.download = `PhieuBaoDuong_${ticketId}_${new Date().toISOString().slice(0,10)}.pdf`;
        link.style.display = 'none';
        
        // Th√™m token v√†o header b·∫±ng c√°ch fetch v√† t·∫°o blob
        fetch(url, {
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${token}`
            }
        })
        .then(response => {
            if (!response.ok) {
                throw new Error('Kh√¥ng th·ªÉ t·∫£i PDF');
            }
            return response.blob();
        })
        .then(blob => {
            const blobUrl = window.URL.createObjectURL(blob);
            link.href = blobUrl;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(blobUrl);
            showAlert('ƒêang t·∫£i file PDF...', 'success');
        })
        .catch(error => {
            console.error('Error exporting PDF:', error);
            showAlert('Kh√¥ng th·ªÉ xu·∫•t PDF. Vui l√≤ng th·ª≠ l·∫°i.', 'danger');
        });
    }

    function executeCompleteMaintenance(ticketId) {
    const token = localStorage.getItem('authToken');
    
    fetch(`${API_BASE_URL}/MaintenanceTicket/${ticketId}/complete`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': token ? `Bearer ${token}` : ''
        }
    })
    .then(async response => {
        const data = await response.json();
        if (!response.ok) {
            throw new Error(data.message || 'Kh√¥ng th·ªÉ ho√†n th√†nh phi·∫øu b·∫£o d∆∞·ª°ng');
        }
        return data;
    })
    .then(data => {
        if (data.success) {
            showAlert('Ho√†n th√†nh phi·∫øu b·∫£o d∆∞·ª°ng th√†nh c√¥ng!', 'success');
            loadMaintenanceTicketDetails(); // Reload ƒë·ªÉ c·∫≠p nh·∫≠t UI
        } else {
            showAlert(data.message || 'Kh√¥ng th·ªÉ ho√†n th√†nh phi·∫øu', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('ƒê√£ x·∫£y ra s·ª± c·ªë: ' + error.message, 'danger');
    });
}

function cancelMaintenanceTicket(ticketId) {
    showConfirmModal(
        '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i><strong>C·∫£nh b√°o!</strong></div><p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën h·ªßy phi·∫øu b·∫£o d∆∞·ª°ng n√†y kh√¥ng? H√†nh ƒë·ªông n√†y kh√¥ng th·ªÉ ho√†n t√°c.</p>',
        function() {
            executeCancelMaintenanceTicket(ticketId);
        }
    );
}

function executeCancelMaintenanceTicket(ticketId) {
    const token = localStorage.getItem('authToken');
    
    fetch(`${API_BASE_URL}/MaintenanceTicket/${ticketId}/cancel`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': token ? `Bearer ${token}` : ''
        }
    })
    .then(async response => {
        const data = await response.json();
        if (!response.ok) {
            throw new Error(data.message || 'Kh√¥ng th·ªÉ h·ªßy phi·∫øu b·∫£o d∆∞·ª°ng');
        }
        return data;
    })
    .then(data => {
        if (data.success) {
            showAlert('H·ªßy phi·∫øu b·∫£o d∆∞·ª°ng th√†nh c√¥ng!', 'success');
            loadMaintenanceTicketDetails(); // Reload ƒë·ªÉ c·∫≠p nh·∫≠t UI
        } else {
            showAlert(data.message || 'Kh√¥ng th·ªÉ h·ªßy phi·∫øu', 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('ƒê√£ x·∫£y ra s·ª± c·ªë: ' + error.message, 'danger');
    });
}

function saveServiceTask() {
    const taskName = $('#taskName').val().trim();
    const taskDescription = $('#taskDescription').val().trim();
    const taskNote = $('#taskNote').val().trim();
    const taskStandardLaborTime = $('#taskStandardLaborTime').val() ? parseFloat($('#taskStandardLaborTime').val()) : null;
    // ‚úÖ Th·ªùi gian th·ª±c t·∫ø ch·ªâ t√≠nh t·ª± ƒë·ªông, kh√¥ng nh·∫≠p t·ª´ form
    
    if (!taskName) {
        showAlert('Vui l√≤ng nh·∫≠p t√™n c√¥ng vi·ªác', 'warning');
        return;
    }
    
    // Validate labor time
    if (taskStandardLaborTime !== null && (taskStandardLaborTime < 0 || taskStandardLaborTime > 999.99)) {
        showAlert('Th·ªùi gian chu·∫©n ph·∫£i t·ª´ 0 ƒë·∫øn 999.99 gi·ªù', 'warning');
        return;
    }
    
    // ‚úÖ Th·ªùi gian th·ª±c t·∫ø ch·ªâ t√≠nh t·ª± ƒë·ªông, kh√¥ng c·∫ßn validate t·ª´ form
    
    const taskId = $('#taskId').val();
    const isEdit = taskId && taskId !== '';
    
    // L·∫•y token ƒë·ªÉ authenticate
    const token = localStorage.getItem('authToken');
    
    // Show loading
    const btn = $('#saveServiceTaskBtn');
    const originalText = btn.html();
    btn.html('<i class="fas fa-spinner fa-spin me-1"></i>ƒêang l∆∞u...');
    btn.prop('disabled', true);
    
    if (isEdit) {
        // Update mode: Load task hi·ªán t·∫°i ƒë·ªÉ l·∫•y ƒë·∫ßy ƒë·ªß th√¥ng tin
        fetch(`${API_BASE_URL}/ServiceTask/${taskId}`, {
            headers: {
                'Authorization': token ? `Bearer ${token}` : '',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(taskData => {
            if (!taskData.success) {
                throw new Error(taskData.message || 'Kh√¥ng th·ªÉ t·∫£i th√¥ng tin c√¥ng vi·ªác');
            }
            
            const task = taskData.data;
            
            // ‚úÖ L·∫•y danh s√°ch technicians ƒë√£ ch·ªçn (checkbox)
            const selectedTechnicianIds = [];
            $('.task-technician-checkbox:checked').each(function() {
                selectedTechnicianIds.push(parseInt($(this).val()));
            });
            const primaryTechnicianId = $('.task-technician-checkbox:checked[data-is-primary="true"]').first().val() 
                ? parseInt($('.task-technician-checkbox:checked[data-is-primary="true"]').first().val()) 
                : (selectedTechnicianIds.length > 0 ? selectedTechnicianIds[0] : null);
            
            // ‚úÖ N·∫øu th·ªùi gian ƒë√£ ƒë∆∞·ª£c t√≠nh t·ª± ƒë·ªông, kh√¥ng g·ª≠i actualLaborTime (gi·ªØ nguy√™n gi√° tr·ªã ƒë√£ t√≠nh)
            const shouldIncludeActualLaborTime = !(task.startTime && task.endTime);
            
            const updateData = {
                id: parseInt(taskId),
                maintenanceTicketId: task.maintenanceTicketId,
                taskName: taskName,
                description: taskDescription || null,
                statusCode: task.statusCode, // Gi·ªØ nguy√™n status hi·ªán t·∫°i
                note: taskNote || null,
                serviceCategoryId: task.serviceCategoryId || null,
                standardLaborTime: taskStandardLaborTime,
                // ‚úÖ Th·ªùi gian th·ª±c t·∫ø ch·ªâ t√≠nh t·ª± ƒë·ªông, kh√¥ng g·ª≠i t·ª´ form
                technicianId: primaryTechnicianId // Gi·ªØ l·∫°i ƒë·ªÉ backward compatibility
            };
            
            // G·ªçi API update
            return fetch(`${API_BASE_URL}/ServiceTask/${taskId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': token ? `Bearer ${token}` : ''
                },
                body: JSON.stringify(updateData)
            }).then(response => response.json()).then(updateResult => {
                // ‚úÖ Sau khi update task, g√°n technicians n·∫øu c√≥
                if (updateResult.success && selectedTechnicianIds.length > 0) {
                    return fetch(`${API_BASE_URL}/ServiceTask/${taskId}/technicians`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': token ? `Bearer ${token}` : ''
                        },
                        body: JSON.stringify({
                            technicianIds: selectedTechnicianIds,
                            primaryTechnicianId: primaryTechnicianId
                        })
                    }).then(response => response.json()).then(assignResult => {
                        // Tr·∫£ v·ªÅ k·∫øt qu·∫£ update task (kh√¥ng ph·∫£i assign)
                        return updateResult;
                    });
                }
                return updateResult;
            });
        })
        .then(data => {
            btn.html(originalText);
            btn.prop('disabled', false);
            
            if (data.success) {
                showAlert('C·∫≠p nh·∫≠t c√¥ng vi·ªác th√†nh c√¥ng!', 'success');
                $('#addServiceTaskModal').modal('hide');
                loadServiceTasks();
                updateCostSummary();
            } else {
                showAlert(data.message || 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t c√¥ng vi·ªác', 'danger');
            }
        })
        .catch(error => {
            btn.html(originalText);
            btn.prop('disabled', false);
            console.error('Error:', error);
            showAlert('Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t c√¥ng vi·ªác: ' + error.message, 'danger');
        });
    } else {
        // Create mode
        // ‚úÖ L·∫•y danh s√°ch technicians ƒë√£ ch·ªçn (checkbox)
        const selectedTechnicianIds = [];
        $('.task-technician-checkbox:checked').each(function() {
            selectedTechnicianIds.push(parseInt($(this).val()));
        });
        const primaryTechnicianId = $('.task-technician-checkbox:checked[data-is-primary="true"]').first().val() 
            ? parseInt($('.task-technician-checkbox:checked[data-is-primary="true"]').first().val()) 
            : (selectedTechnicianIds.length > 0 ? selectedTechnicianIds[0] : null);
        
        const taskData = {
            maintenanceTicketId: maintenanceTicketId,
            taskName: taskName,
            description: taskDescription || null,
            note: taskNote || null,
            statusCode: 'PENDING', // M·∫∑c ƒë·ªãnh l√† PENDING
            standardLaborTime: taskStandardLaborTime,
            // ‚úÖ Th·ªùi gian th·ª±c t·∫ø ch·ªâ t√≠nh t·ª± ƒë·ªông, kh√¥ng g·ª≠i t·ª´ form
            technicianId: primaryTechnicianId // Gi·ªØ l·∫°i ƒë·ªÉ backward compatibility
        };
        
        fetch(`${API_BASE_URL}/ServiceTask`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': token ? `Bearer ${token}` : ''
            },
            body: JSON.stringify(taskData)
        })
        .then(response => response.json())
        .then(data => {
            btn.html(originalText);
            btn.prop('disabled', false);
            
            if (data.success) {
                const createdTaskId = data.data?.id;
                
                // ‚úÖ N·∫øu c√≥ ch·ªçn technicians, g√°n cho c√¥ng vi·ªác v·ª´a t·∫°o
                if (selectedTechnicianIds.length > 0 && createdTaskId) {
                    return fetch(`${API_BASE_URL}/ServiceTask/${createdTaskId}/technicians`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': token ? `Bearer ${token}` : ''
                        },
                        body: JSON.stringify({
                            technicianIds: selectedTechnicianIds,
                            primaryTechnicianId: primaryTechnicianId
                        })
                    }).then(response => response.json()).then(assignData => {
                        if (assignData.success) {
                            showAlert('Th√™m c√¥ng vi·ªác v√† g√°n k·ªπ thu·∫≠t vi√™n th√†nh c√¥ng!', 'success');
                        } else {
                            showAlert('Th√™m c√¥ng vi·ªác th√†nh c√¥ng, nh∆∞ng kh√¥ng th·ªÉ g√°n k·ªπ thu·∫≠t vi√™n', 'warning');
                        }
                        $('#addServiceTaskModal').modal('hide');
                        loadServiceTasks();
                        updateCostSummary();
                    });
                } else {
                showAlert('Th√™m c√¥ng vi·ªác th√†nh c√¥ng!', 'success');
                $('#addServiceTaskModal').modal('hide');
                loadServiceTasks();
                updateCostSummary();
                }
            } else {
                showAlert(data.message || 'Kh√¥ng th·ªÉ th√™m c√¥ng vi·ªác', 'danger');
            }
        })
        .catch(error => {
            btn.html(originalText);
            btn.prop('disabled', false);
            console.error('Error:', error);
            showAlert('Kh√¥ng th·ªÉ th√™m c√¥ng vi·ªác', 'danger');
        });
    }
}

function editServiceTask(taskId) {
    const token = localStorage.getItem('authToken');
    
    fetch(`${API_BASE_URL}/ServiceTask/${taskId}`, {
        headers: {
            'Authorization': token ? `Bearer ${token}` : '',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.data) {
            const task = data.data;
            
            // ƒêi·ªÅn d·ªØ li·ªáu v√†o form
            $('#taskId').val(task.id);
            $('#taskName').val(task.taskName || '');
            $('#taskDescription').val(task.description || '');
            $('#taskNote').val(task.note || '');
            $('#taskStandardLaborTime').val(task.standardLaborTime || '');
            
            // Load v√† set technicians (checkbox)
            loadTechniciansForTask().then(() => {
                // Uncheck t·∫•t c·∫£ tr∆∞·ªõc
                $('.task-technician-checkbox').prop('checked', false);
                
                // Check c√°c technicians ƒë√£ ƒë∆∞·ª£c g√°n
                if (task.technicians && Array.isArray(task.technicians) && task.technicians.length > 0) {
                    task.technicians.forEach(tech => {
                        $(`#taskTech_${tech.technicianId}`).prop('checked', true);
                    });
                } else if (task.technicianId) {
                    // Backward compatibility: n·∫øu ch·ªâ c√≥ technicianId c≈©
                    $(`#taskTech_${task.technicianId}`).prop('checked', true);
                }
            });
            
            // ƒê·ªïi ti√™u ƒë·ªÅ modal
            $('#addServiceTaskModalLabel').text('Ch·ªânh s·ª≠a c√¥ng vi·ªác');
            
            // ƒê·ªïi title v√† button text
            $('#addServiceTaskModalLabel').text('Ch·ªânh s·ª≠a c√¥ng vi·ªác');
            $('#saveServiceTaskBtn').html('C·∫≠p nh·∫≠t');
            
            // M·ªü modal
            $('#addServiceTaskModal').modal('show');
        } else {
            showAlert('T·∫£i th√¥ng tin c√¥ng vi·ªác th·∫•t b·∫°i: ' + (data.message || 'Kh√¥ng t√¨m th·∫•y c√¥ng vi·ªác'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin c√¥ng vi·ªác', 'danger');
    });
}

function loadTechniciansForTask() {
    return new Promise((resolve, reject) => {
        const container = $('#taskTechniciansContainer');
        
        // ‚úÖ L·∫•y danh s√°ch k·ªπ thu·∫≠t vi√™n t·ª´ maintenanceTicketData.technicians (ƒë√£ ƒë∆∞·ª£c g√°n ·ªü thao t√°c)
        if (maintenanceTicketData && maintenanceTicketData.technicians && maintenanceTicketData.technicians.length > 0) {
            let html = '';
            maintenanceTicketData.technicians.forEach(tech => {
                const techName = tech.technicianName || `K·ªπ thu·∫≠t vi√™n #${tech.technicianId}`;
                const isPrimary = tech.roleInTicket === 'PRIMARY';
                const primaryBadge = isPrimary ? '<span class="badge bg-warning text-dark ms-2"><i class="fas fa-star me-1"></i>Ch√≠nh</span>' : '';
                html += `
                    <div class="form-check">
                        <input class="form-check-input task-technician-checkbox" type="checkbox" 
                               value="${tech.technicianId}" 
                               id="taskTech_${tech.technicianId}"
                               ${isPrimary ? 'data-is-primary="true"' : ''}>
                        <label class="form-check-label" for="taskTech_${tech.technicianId}">
                            ${techName}${primaryBadge}
                        </label>
                    </div>
                `;
            });
            container.html(html);
            console.log('[loadTechniciansForTask] Loaded', maintenanceTicketData.technicians.length, 'technicians from maintenanceTicketData');
        } else {
            // N·∫øu ch∆∞a c√≥ k·ªπ thu·∫≠t vi√™n n√†o ƒë∆∞·ª£c g√°n, hi·ªÉn th·ªã th√¥ng b√°o
            container.html('<div class="text-dark text-center py-2"><small>Vui l√≤ng g√°n k·ªπ thu·∫≠t vi√™n ·ªü ph·∫ßn "Thao t√°c" tr∆∞·ªõc</small></div>');
            console.warn('[loadTechniciansForTask] No technicians assigned to this ticket yet');
        }
        
        resolve();
    });
}

// ‚úÖ H√†m t·ª± ƒë·ªông c·∫≠p nh·∫≠t TechnicianId cho t·∫•t c·∫£ ServiceTask hi·ªán c√≥
function updateAllServiceTasksWithTechnicians(technicianIds, primaryId) {
    return new Promise((resolve, reject) => {
        if (!technicianIds || technicianIds.length === 0) {
            resolve();
            return;
        }
        
        const token = localStorage.getItem('authToken');
        
        // L·∫•y danh s√°ch t·∫•t c·∫£ c√¥ng vi·ªác hi·ªán c√≥
        fetch(`${API_BASE_URL}/ServiceTask/by-ticket/${maintenanceTicketId}`, {
            headers: {
                'Authorization': token ? `Bearer ${token}` : '',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            let tasks = [];
            if (data.success && Array.isArray(data.data)) {
                tasks = data.data;
            } else if (Array.isArray(data)) {
                tasks = data;
            }
            
            if (tasks.length === 0) {
                console.log('[updateAllServiceTasksWithTechnicians] No tasks to update');
                resolve();
                return;
            }
            
            // C·∫≠p nh·∫≠t t·ª´ng c√¥ng vi·ªác: n·∫øu ch∆∞a c√≥ TechnicianId, g√°n primaryId ho·∫∑c technicianIds[0]
            const updatePromises = tasks.map(task => {
                // Ch·ªâ c·∫≠p nh·∫≠t n·∫øu c√¥ng vi·ªác ch∆∞a c√≥ TechnicianId
                if (!task.technicianId) {
                    const technicianIdToAssign = primaryId || technicianIds[0];
                    
                    // Load task ƒë·∫ßy ƒë·ªß ƒë·ªÉ update
                    return fetch(`${API_BASE_URL}/ServiceTask/${task.id}`, {
                        headers: {
                            'Authorization': token ? `Bearer ${token}` : '',
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => response.json())
                    .then(taskData => {
                        if (taskData.success && taskData.data) {
                            const fullTask = taskData.data;
                            const updateData = {
                                id: fullTask.id,
                                maintenanceTicketId: fullTask.maintenanceTicketId,
                                taskName: fullTask.taskName,
                                description: fullTask.description,
                                statusCode: fullTask.statusCode,
                                note: fullTask.note,
                                serviceCategoryId: fullTask.serviceCategoryId,
                                standardLaborTime: fullTask.standardLaborTime,
                                actualLaborTime: fullTask.actualLaborTime,
                                technicianId: technicianIdToAssign,
                                displayOrder: fullTask.displayOrder
                            };
                            
                            return fetch(`${API_BASE_URL}/ServiceTask/${task.id}`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': token ? `Bearer ${token}` : ''
                                },
                                body: JSON.stringify(updateData)
                            });
                        }
                        return Promise.resolve();
                    });
                }
                return Promise.resolve();
            });
            
            return Promise.all(updatePromises);
        })
        .then(() => {
            console.log('[updateAllServiceTasksWithTechnicians] All tasks updated successfully');
            resolve();
        })
        .catch(error => {
            console.error('[updateAllServiceTasksWithTechnicians] Error:', error);
            reject(error);
        });
    });
}

function deleteServiceTask(taskId) {
    showConfirmModal(
        '<p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a c√¥ng vi·ªác n√†y kh√¥ng?</p>',
        function() {
            const token = localStorage.getItem('authToken');
            
            fetch(`${API_BASE_URL}/ServiceTask/${taskId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': token ? `Bearer ${token}` : '',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('X√≥a c√¥ng vi·ªác th√†nh c√¥ng!', 'success');
                    loadServiceTasks();
                    updateCostSummary();
                } else {
                    showAlert(data.message || 'Kh√¥ng th·ªÉ x√≥a c√¥ng vi·ªác', 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Kh√¥ng th·ªÉ x√≥a c√¥ng vi·ªác', 'danger');
            });
        }
    );
}

function saveComponent(keepModalOpen = false) {
    const componentId = $('#componentSelect').val();
    const quantity = parseInt($('#componentQuantity').val());
    
    if (!componentId || !quantity || quantity <= 0) {
        showAlert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc', 'warning');
        return;
    }
    
    // Kh√¥ng g·ª≠i unitPrice - backend s·∫Ω t·ª± l·∫•y t·ª´ Component
    const formData = {
        maintenanceTicketId: maintenanceTicketId,
        componentId: parseInt(componentId),
        quantity: quantity
    };
    
    const token = localStorage.getItem('authToken');
    const saveBtn = $('#saveComponentBtn');
    const saveAndAddMoreBtn = $('#saveAndAddMoreBtn');
    const originalSaveText = saveBtn.html();
    const originalAddMoreText = saveAndAddMoreBtn.html();
    
    // Disable c·∫£ 2 n√∫t khi ƒëang l∆∞u
    saveBtn.html('<i class="fas fa-spinner fa-spin me-1"></i>ƒêang l∆∞u...');
    saveBtn.prop('disabled', true);
    saveAndAddMoreBtn.html('<i class="fas fa-spinner fa-spin me-1"></i>ƒêang l∆∞u...');
    saveAndAddMoreBtn.prop('disabled', true);
    
    fetch(`${API_BASE_URL}/TicketComponent`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': token ? `Bearer ${token}` : ''
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        saveBtn.html(originalSaveText);
        saveBtn.prop('disabled', false);
        saveAndAddMoreBtn.html(originalAddMoreText);
        saveAndAddMoreBtn.prop('disabled', false);
        
        if (data.success) {
            showAlert('Th√™m ph·ª• t√πng th√†nh c√¥ng!', 'success');
            
            // Reset form
            $('#componentForm')[0].reset();
            $('#componentSearch').val(''); // Reset search
            $('#componentSelect').val(''); // Reset selection
            $('.component-item').removeClass('selected');
            $('.component-card').removeClass('border-primary bg-light');
            $('.component-item .fa-check-circle').hide();
            $('#selectedComponentInfo').hide();
            $('#componentQuantity').val('');
            $('#componentTotalPrice').html('<strong class="text-primary">0 ‚Ç´</strong>');
            
            // Reload danh s√°ch ph·ª• t√πng v√† c·∫≠p nh·∫≠t cost
            loadComponents();
            updateCostSummary();
            
            if (!keepModalOpen) {
                // ƒê√≥ng modal n·∫øu kh√¥ng ph·∫£i "th√™m ti·∫øp"
                $('#addComponentModal').modal('hide');
            } else {
                // Focus v√†o √¥ search ƒë·ªÉ ti·∫øp t·ª•c th√™m
                setTimeout(() => {
                    $('#componentSearch').focus();
                }, 100);
            }
        } else {
            showAlert(data.message || 'Kh√¥ng th·ªÉ th√™m ph·ª• t√πng', 'danger');
        }
    })
    .catch(error => {
        saveBtn.html(originalSaveText);
        saveBtn.prop('disabled', false);
        saveAndAddMoreBtn.html(originalAddMoreText);
        saveAndAddMoreBtn.prop('disabled', false);
        console.error('Error:', error);
        showAlert('Kh√¥ng th·ªÉ th√™m ph·ª• t√πng', 'danger');
    });
}

function editComponent(componentId) {
    const token = localStorage.getItem('authToken');
    fetch(`${API_BASE_URL}/TicketComponent/${componentId}`, {
        headers: {
            'Authorization': token ? `Bearer ${token}` : ''
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const component = data.data;
            $('#editComponentId').val(component.id);
            $('#editComponentQuantity').val(component.quantity);
            $('#editComponentActualQuantity').val(component.actualQuantity || '');
            $('#editComponentUnitPrice').val(component.unitPrice || '');
            
            // Load components v√† set gi√° tr·ªã sau khi load xong
            loadComponentsForEdit().then(() => {
                $('#editComponentSelect').val(component.componentId);
            $('#editComponentModal').modal('show');
            });
        } else {
            showAlert('T·∫£i th√¥ng tin ph·ª• t√πng th·∫•t b·∫°i: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Kh√¥ng th·ªÉ t·∫£i th√¥ng tin ph·ª• t√πng', 'danger');
    });
}

function updateComponent() {
    const id = $('#editComponentId').val();
    const componentId = $('#editComponentSelect').val();
    const quantity = parseInt($('#editComponentQuantity').val());
    const actualQuantityInput = $('#editComponentActualQuantity').val();
    const actualQuantity = actualQuantityInput && actualQuantityInput !== '' ? parseFloat(actualQuantityInput) : null;
    
    if (!id || !componentId || !quantity || quantity <= 0) {
        showAlert('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin b·∫Øt bu·ªôc', 'warning');
        return;
    }
    
    if (actualQuantity !== null && actualQuantity < 0) {
        showAlert('S·ªë l∆∞·ª£ng th·ª±c t·∫ø ph·∫£i l·ªõn h∆°n ho·∫∑c b·∫±ng 0', 'warning');
        return;
    }
    
    // Cho ph√©p actualQuantity > quantity ƒë·ªÉ c√≥ th·ªÉ b·ªï sung th√™m ph·ª• t√πng n·∫øu c·∫ßn
    // Kh√¥ng g·ª≠i unitPrice - backend s·∫Ω t·ª± l·∫•y t·ª´ Component
    const formData = {
        maintenanceTicketId: maintenanceTicketId,
        componentId: parseInt(componentId),
        quantity: quantity,
        actualQuantity: actualQuantity // G·ª≠i c·∫£ null n·∫øu ƒë·ªÉ tr·ªëng
    };
    
    const token = localStorage.getItem('authToken');
    const btn = $('#updateComponentBtn');
    const originalText = btn.html();
    btn.html('<i class="fas fa-spinner fa-spin me-1"></i>ƒêang c·∫≠p nh·∫≠t...');
    btn.prop('disabled', true);
    
    fetch(`${API_BASE_URL}/TicketComponent/${id}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': token ? `Bearer ${token}` : ''
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        btn.html(originalText);
        btn.prop('disabled', false);
        
        if (data.success) {
            showAlert('C·∫≠p nh·∫≠t ph·ª• t√πng th√†nh c√¥ng!', 'success');
            $('#editComponentModal').modal('hide');
            loadComponents();
            updateCostSummary(); // Update cost summary
        } else {
            showAlert(data.message || 'Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t ph·ª• t√πng', 'danger');
        }
    })
    .catch(error => {
        btn.html(originalText);
        btn.prop('disabled', false);
        console.error('Error:', error);
        showAlert('Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t ph·ª• t√πng', 'danger');
    });
}

function deleteComponent(componentId) {
    showConfirmModal(
        '<p>B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a ph·ª• t√πng n√†y kh·ªèi phi·∫øu b·∫£o d∆∞·ª°ng?</p>',
        function() {
            const token = localStorage.getItem('authToken');
            fetch(`${API_BASE_URL}/TicketComponent/${componentId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': token ? `Bearer ${token}` : ''
                }
            })
            .then(async response => {
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.message || 'Kh√¥ng th·ªÉ x√≥a ph·ª• t√πng');
                }
                return data;
            })
            .then(data => {
                if (data.success) {
                    showAlert('X√≥a ph·ª• t√πng th√†nh c√¥ng!', 'success');
                    loadComponents();
                    updateCostSummary(); // Update cost summary
                } else {
                    showAlert(data.message || 'Kh√¥ng th·ªÉ x√≥a ph·ª• t√πng', 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert(error.message || 'Kh√¥ng th·ªÉ x√≥a ph·ª• t√πng t·ª´ g√≥i d·ªãch v·ª•', 'danger');
            });
        }
    );
}

function loadComponentsForAdd() {
    const token = localStorage.getItem('authToken');
    const branchId = maintenanceTicketData?.branchId;
    if (!branchId) {
        showAlert('Kh√¥ng t√¨m th·∫•y th√¥ng tin chi nh√°nh', 'warning');
        return;
    }
    
    const container = $('#componentListContainer');
    container.html('<div class="text-center text-muted py-4"><i class="fas fa-spinner fa-spin fa-2x mb-2"></i><p class="mb-0">ƒêang t·∫£i danh s√°ch ph·ª• t√πng...</p></div>');
    
    // ‚úÖ S·ª≠a: Th√™m pageSize l·ªõn ƒë·ªÉ l·∫•y t·∫•t c·∫£ components
    fetch(`${API_BASE_URL}/Component?branchId=${branchId}&statusCode=ACTIVE&page=1&pageSize=1000`, {
        headers: {
            'Authorization': token ? `Bearer ${token}` : ''
        }
    })
    .then(response => response.json())
    .then(result => {
        // ‚úÖ S·ª≠a: X·ª≠ l√Ω ƒë√∫ng format response {success: true, data: [...]}
        const components = (result.success && result.data && Array.isArray(result.data)) ? result.data : [];
        allComponentsForAdd = components; // L∆∞u danh s√°ch g·ªëc
        
        renderComponentList(components);
        
        // Reset search box v√† selection
        $('#componentSearch').val('');
        $('#componentSelect').val('');
        $('#selectedComponentInfo').hide();
        $('#componentQuantity').val('');
        $('#componentTotalPrice').html('<strong class="text-primary">0 ‚Ç´</strong>');
    })
    .catch(error => {
        console.error('Error loading components:', error);
        container.html('<div class="alert alert-danger text-center py-3"><i class="fas fa-exclamation-triangle me-2"></i>Kh√¥ng th·ªÉ t·∫£i danh s√°ch ph·ª• t√πng</div>');
        showAlert('Kh√¥ng th·ªÉ t·∫£i danh s√°ch ph·ª• t√πng', 'danger');
    });
}

function renderComponentList(components) {
    const container = $('#componentListContainer');
    
    if (!components || components.length === 0) {
        container.html('<div class="text-center text-muted py-4"><i class="fas fa-inbox fa-2x mb-2"></i><p class="mb-0">Kh√¥ng c√≥ ph·ª• t√πng n√†o</p></div>');
        return;
    }
    
    let html = '<div class="row g-2">';
    components.forEach(comp => {
        const imageUrl = comp.imageUrl || '';
        const stockInfo = comp.quantityStock !== null && comp.quantityStock !== undefined 
            ? `<span class="badge ${comp.quantityStock > 0 ? 'bg-success' : 'bg-danger'}">T·ªìn: ${comp.quantityStock}</span>`
            : '';
        
        html += `
            <div class="col-12 component-item" data-component-id="${comp.id}" 
                 data-component-name="${escapeHtml(comp.name || '')}" 
                 data-component-code="${escapeHtml(comp.code || '')}" 
                 data-component-price="${comp.unitPrice || 0}"
                 style="cursor: pointer;">
                <div class="card border component-card h-100" style="transition: all 0.2s;">
                    <div class="card-body p-3">
                        <div class="d-flex align-items-center">
                            ${imageUrl ? `<img src="${imageUrl}" alt="${escapeHtml(comp.name || '')}" class="me-3" style="width: 60px; height: 60px; object-fit: cover; border-radius: 0.375rem;">` : '<div class="me-3" style="width: 60px; height: 60px; background: #f0f0f0; border-radius: 0.375rem; display: flex; align-items: center; justify-content: center;"><i class="fas fa-cog text-muted"></i></div>'}
                            <div class="flex-grow-1">
                                <h6 class="mb-1 fw-semibold">${escapeHtml(comp.name || 'N/A')}</h6>
                                ${comp.code ? `<small class="text-muted d-block">M√£: ${escapeHtml(comp.code)}</small>` : ''}
                                <div class="mt-2">
                                    <span class="text-primary fw-bold">${formatCurrency(comp.unitPrice || 0)}</span>
                                    ${stockInfo}
                                </div>
                            </div>
                            <div class="ms-2">
                                <i class="fas fa-check-circle text-success" style="display: none; font-size: 1.5rem;"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    html += '</div>';
    
    container.html(html);
    
    // Add click handler
    $('.component-item').on('click', function() {
        $('.component-item').removeClass('selected');
        $('.component-card').removeClass('border-primary bg-light');
        $('.component-item .fa-check-circle').hide();
        
        $(this).addClass('selected');
        $(this).find('.component-card').addClass('border-primary bg-light');
        $(this).find('.fa-check-circle').show();
        
        const componentId = $(this).data('component-id');
        const componentName = $(this).data('component-name');
        const componentCode = $(this).data('component-code');
        const componentPrice = $(this).data('component-price');
        
        $('#componentSelect').val(componentId);
        $('#selectedComponentName').text(componentName + (componentCode ? ` (${componentCode})` : ''));
        $('#selectedComponentPrice').text(formatCurrency(componentPrice));
        $('#selectedComponentInfo').show();
        
        // Update total price
        updateComponentTotalPrice();
    });
}

function updateComponentTotalPrice() {
    const quantity = parseInt($('#componentQuantity').val()) || 0;
    const selectedComponent = $('.component-item.selected');
    if (selectedComponent.length > 0) {
        const price = selectedComponent.data('component-price') || 0;
        const total = quantity * price;
        $('#componentTotalPrice').html(`<strong class="text-primary">${formatCurrency(total)}</strong>`);
    } else {
        $('#componentTotalPrice').html('<strong class="text-primary">0 ‚Ç´</strong>');
    }
}

function loadComponentsForEdit() {
    return new Promise((resolve, reject) => {
    const token = localStorage.getItem('authToken');
    const branchId = maintenanceTicketData?.branchId;
    if (!branchId) {
        showAlert('Kh√¥ng t√¨m th·∫•y th√¥ng tin chi nh√°nh', 'warning');
            reject(new Error('Branch ID not found'));
        return;
    }
    
    // ‚úÖ S·ª≠a: Th√™m pageSize l·ªõn ƒë·ªÉ l·∫•y t·∫•t c·∫£ components
    fetch(`${API_BASE_URL}/Component?branchId=${branchId}&statusCode=ACTIVE&page=1&pageSize=1000`, {
        headers: {
            'Authorization': token ? `Bearer ${token}` : ''
        }
    })
    .then(response => response.json())
    .then(result => {
        // ‚úÖ S·ª≠a: X·ª≠ l√Ω ƒë√∫ng format response {success: true, data: [...]}
        const components = (result.success && result.data && Array.isArray(result.data)) ? result.data : [];
        const select = $('#editComponentSelect');
        select.empty();
        select.append('<option value="">-- Ch·ªçn ph·ª• t√πng --</option>');
        if (components.length > 0) {
            components.forEach(comp => {
                const displayText = `${comp.name}${comp.code ? ' (M√£: ' + comp.code + ')' : ''} - ${formatCurrency(comp.unitPrice || 0)}`;
                select.append(`<option value="${comp.id}" data-price="${comp.unitPrice || 0}">${displayText}</option>`);
            });
        } else {
            select.append('<option value="" disabled>Kh√¥ng c√≥ ph·ª• t√πng n√†o</option>');
        }
        
        // Reset search box
        $('#editComponentSearch').val('');
        resolve();
    })
    .catch(error => {
        console.error('Error loading components:', error);
        showAlert('Kh√¥ng th·ªÉ t·∫£i danh s√°ch ph·ª• t√πng', 'danger');
            reject(error);
        });
    });
}

function updateCostSummary() {
    const token = localStorage.getItem('authToken');
    
    // Load component total and labor cost total
    Promise.all([
        fetch(`${API_BASE_URL}/TicketComponent/by-maintenance-ticket/${maintenanceTicketId}/total-cost`, {
            headers: {
                'Authorization': token ? `Bearer ${token}` : ''
            }
        }).then(r => r.json()),
        fetch(`${API_BASE_URL}/ServiceTask/by-ticket/${maintenanceTicketId}`, {
            headers: {
                'Authorization': token ? `Bearer ${token}` : ''
            }
        }).then(r => r.json())
    ])
    .then(([componentData, taskData]) => {
        const componentTotal = componentData.success ? (componentData.data?.totalCost || 0) : 0;
        const laborCostTotal = taskData.success ? (taskData.data || []).reduce((sum, task) => sum + (task.laborCost || 0), 0) : 0;
        
        // Use existing maintenanceTicketData or calculate from totals
        const estimatedCost = maintenanceTicketData?.totalEstimatedCost || (componentTotal + laborCostTotal);
        const dataToDisplay = maintenanceTicketData || { totalEstimatedCost: estimatedCost };
        
        displayCostSummary(dataToDisplay, componentTotal, laborCostTotal);
    })
    .catch(error => {
        console.error('Error loading cost summary:', error);
        // Fallback: try to display with current data
        if (maintenanceTicketData) {
            displayCostSummary(maintenanceTicketData, 0, 0);
        }
    });
}

function formatCurrency(amount) {
    return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
}

let allServicePackages = [];

function loadServicePackages() {
    const token = localStorage.getItem('authToken');
    const branchId = maintenanceTicketData?.branchId;
    if (!branchId) {
        showAlert('Kh√¥ng t√¨m th·∫•y th√¥ng tin chi nh√°nh', 'warning');
        return;
    }
    
    // ‚úÖ S·ª≠a: Th√™m pageSize l·ªõn ƒë·ªÉ l·∫•y t·∫•t c·∫£ service packages
    fetch(`${API_BASE_URL}/ServicePackage?branchId=${branchId}&statusCode=ACTIVE&page=1&pageSize=1000`, {
        headers: {
            'Authorization': token ? `Bearer ${token}` : ''
        }
    })
    .then(response => response.json())
    .then(result => {
        // ‚úÖ S·ª≠a: X·ª≠ l√Ω ƒë√∫ng format response {success: true, data: [...]}
        allServicePackages = (result.success && result.data && Array.isArray(result.data)) ? result.data : [];
        displayServicePackages(allServicePackages);
    })
    .catch(error => {
        console.error('Error loading service packages:', error);
        $('#servicePackageTableBody').html('<tr><td colspan="6" class="text-center text-danger">Kh√¥ng th·ªÉ t·∫£i danh s√°ch g√≥i d·ªãch v·ª•</td></tr>');
        showAlert('Kh√¥ng th·ªÉ t·∫£i danh s√°ch g√≥i d·ªãch v·ª•', 'danger');
    });
}

function displayServicePackages(packages) {
    const tbody = $('#servicePackageTableBody');
    
    if (!packages || packages.length === 0) {
        tbody.html('<tr><td colspan="6" class="text-center text-dark">Kh√¥ng c√≥ g√≥i d·ªãch v·ª• n√†o</td></tr>');
        return;
    }
    
    tbody.empty();
    packages.forEach(pkg => {
        const componentCount = pkg.components && Array.isArray(pkg.components) ? pkg.components.length : 0;
        const price = pkg.price ? formatCurrency(pkg.price) : 'Ch∆∞a c√≥ gi√°';
        
        // Store package data in a way that can be retrieved
        const row = $(`
            <tr>
                <td>
                    <input type="radio" name="servicePackageSelect" class="service-package-radio" 
                           value="${pkg.id}">
                </td>
                <td><strong>${escapeHtml(pkg.code || '-')}</strong></td>
                <td>${escapeHtml(pkg.name || '-')}</td>
                <td>${price}</td>
                <td>${componentCount} ph·ª• t√πng</td>
                <td><small class="text-dark">${escapeHtml((pkg.description || '-').substring(0, 50))}${pkg.description && pkg.description.length > 50 ? '...' : ''}</small></td>
            </tr>
        `);
        
        // Store full package data in a data attribute
        row.data('package-data', pkg);
        tbody.append(row);
    });
}

function filterServicePackages(searchTerm) {
    if (!searchTerm) {
        displayServicePackages(allServicePackages);
        return;
    }
    
    const filtered = allServicePackages.filter(pkg => {
        const name = (pkg.name || '').toLowerCase();
        const code = (pkg.code || '').toLowerCase();
        const description = (pkg.description || '').toLowerCase();
        return name.includes(searchTerm) || code.includes(searchTerm) || description.includes(searchTerm);
    });
    
    displayServicePackages(filtered);
}

function displaySelectedServicePackage(packageData) {
    const infoDiv = $('#selectedServicePackageInfo');
    const detailsDiv = $('#selectedServicePackageDetails');
    
    const componentList = packageData.components && Array.isArray(packageData.components) 
        ? packageData.components.map(c => `- ${c.name} (${formatCurrency(c.unitPrice || 0)})`).join('<br>')
        : '<p class="text-dark mb-0">Kh√¥ng c√≥ ph·ª• t√πng</p>';
    
    // Calculate component total
    const componentTotal = packageData.components && Array.isArray(packageData.components)
        ? packageData.components.reduce((sum, c) => sum + (c.unitPrice || 0), 0)
        : 0;
    
    // ‚ùå ƒê√É LO·∫†I B·ªé: Hi·ªÉn th·ªã ServiceCategories
    // L√Ω do: ServiceCategory ch·ªâ d√πng cho ScheduleService (ƒë·∫∑t l·ªãch), kh√¥ng ph·∫£i ƒë·ªÉ t·∫°o c√¥ng vi·ªác th·ª±c t·∫ø
    // ServicePackage ch·ªâ ch·ª©a Components (ph·ª• t√πng)
    // ServiceTasks n√™n ƒë∆∞·ª£c t·∫°o th·ªß c√¥ng b·ªüi ng∆∞·ªùi d√πng
    
    detailsDiv.html(`
        <p><strong>T√™n g√≥i:</strong> ${escapeHtml(packageData.name || '-')}</p>
        <p><strong>M√£ g√≥i:</strong> ${escapeHtml(packageData.code || '-')}</p>
        <p><strong>Gi√°:</strong> ${formatCurrency(packageData.price || 0)}</p>
        <p><strong>M√¥ t·∫£:</strong> ${escapeHtml(packageData.description || '-')}</p>
        <hr>
        <p><strong>Danh s√°ch ph·ª• t√πng (${packageData.components?.length || 0}):</strong></p>
        <div class="ms-3 mb-2">${componentList}</div>
        <p class="mb-1"><strong>T·ªïng ph·ª• t√πng:</strong> ${formatCurrency(componentTotal)}</p>
        <div class="alert alert-info mt-2 mb-0">
            <i class="fas fa-info-circle me-2"></i>
            <small>C√°c ph·ª• t√πng trong g√≥i s·∫Ω ƒë∆∞·ª£c th√™m v√†o phi·∫øu b·∫£o d∆∞·ª°ng. Ph·ª• t√πng ƒë√£ t·ªìn t·∫°i s·∫Ω ƒë∆∞·ª£c b·ªè qua.</small>
        </div>
        <div class="alert alert-warning mt-2 mb-0">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <small><strong>L∆∞u √Ω:</strong> C√¥ng vi·ªác (ServiceTasks) c·∫ßn ƒë∆∞·ª£c t·∫°o th·ªß c√¥ng b·∫±ng n√∫t "Th√™m c√¥ng vi·ªác". G√≥i d·ªãch v·ª• ch·ªâ t·ª± ƒë·ªông th√™m ph·ª• t√πng.</small>
        </div>
    `);
    
    infoDiv.show();
}

function applyServicePackage(servicePackageId) {
    const token = localStorage.getItem('authToken');
    const btn = $('#confirmApplyServicePackageBtn');
    const originalText = btn.html();
    btn.html('<i class="fas fa-spinner fa-spin me-1"></i>ƒêang √°p d·ª•ng...');
    btn.prop('disabled', true);
    
    fetch(`${API_BASE_URL}/MaintenanceTicket/${maintenanceTicketId}/apply-service-package/${servicePackageId}`, {
        method: 'PUT',
        headers: {
            'Authorization': token ? `Bearer ${token}` : '',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        btn.html(originalText);
        btn.prop('disabled', false);
        
        if (data.success) {
            showAlert('√Åp d·ª•ng g√≥i d·ªãch v·ª• th√†nh c√¥ng!', 'success');
            $('#applyServicePackageModal').modal('hide');
            selectedServicePackageId = null;
            $('#confirmApplyServicePackageBtn').prop('disabled', true);
            $('#selectedServicePackageInfo').hide();
            $('.service-package-radio').prop('checked', false);
            
            // Reload components, service tasks and cost summary
            loadComponents();
            loadServiceTasks();
            loadMaintenanceTicketDetails();
            updateCostSummary(); // Update cost summary
        } else {
            showAlert(data.message || 'Kh√¥ng th·ªÉ √°p d·ª•ng g√≥i d·ªãch v·ª•', 'danger');
        }
    })
    .catch(error => {
        btn.html(originalText);
        btn.prop('disabled', false);
        console.error('Error:', error);
        showAlert('Kh√¥ng th·ªÉ √°p d·ª•ng g√≥i d·ªãch v·ª•: ' + error.message, 'danger');
    });
}

function showAlert(message, type) {
    // X√≥a prefix "L·ªói: " n·∫øu c√≥
    let cleanMessage = message.replace(/^L·ªói:\s*/i, '');
    
    // X√°c ƒë·ªãnh icon v√† m√†u s·∫Øc
    let icon = '';
    let bgColor = '';
    let textColor = '';
    let title = '';
    
    switch(type) {
        case 'success':
            icon = 'fa-check-circle';
            bgColor = 'bg-success';
            textColor = 'text-white';
            title = 'Th√†nh c√¥ng';
            break;
        case 'warning':
            icon = 'fa-exclamation-triangle';
            bgColor = 'bg-warning';
            textColor = 'text-dark';
            title = 'C·∫£nh b√°o';
            break;
        case 'danger':
            icon = 'fa-times-circle';
            bgColor = 'bg-danger';
            textColor = 'text-white';
            title = 'Th√¥ng b√°o';
            break;
        default:
            icon = 'fa-info-circle';
            bgColor = 'bg-info';
            textColor = 'text-white';
            title = 'Th√¥ng tin';
    }
    
    const modalId = 'alertModal_' + Date.now();
    const modalHtml = `
        <div class="modal fade" id="${modalId}" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header ${bgColor} ${textColor}">
                        <h5 class="modal-title">
                            <i class="fas ${icon} me-2"></i>${title}
                        </h5>
                        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <p class="mb-0">${cleanMessage}</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">ƒê√≥ng</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    $('body').append(modalHtml);
    const modal = new bootstrap.Modal(document.getElementById(modalId));
    modal.show();
    
    // T·ª± ƒë·ªông ƒë√≥ng sau 5 gi√¢y (tr·ª´ khi l√† l·ªói th√¨ gi·ªØ l√¢u h∆°n)
    const autoCloseTime = type === 'danger' ? 8000 : 5000;
    setTimeout(() => {
        modal.hide();
        setTimeout(() => {
            $('#' + modalId).remove();
        }, 300);
    }, autoCloseTime);
    
    // X√≥a modal khi ƒë√≥ng
    $('#' + modalId).on('hidden.bs.modal', function() {
        $(this).remove();
    });
}

// M·ªü modal l·ªãch s·ª≠ ho·∫°t ƒë·ªông chi ti·∫øt
function openActivityHistoryModal() {
    const modalHtml = `
    <div class="modal fade" id="activityHistoryModal" tabindex="-1">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="fas fa-history me-2"></i>
              L·ªãch s·ª≠ ho·∫°t ƒë·ªông chi ti·∫øt
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div id="activityHistoryContent">
              <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">ƒêang t·∫£i...</span>
                </div>
                <p class="mt-3 text-dark">ƒêang t·∫£i l·ªãch s·ª≠ ho·∫°t ƒë·ªông...</p>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              <i class="fas fa-times me-1"></i>ƒê√≥ng
            </button>
          </div>
        </div>
      </div>
    </div>`;

    // X√≥a modal c≈© n·∫øu c√≥
    $('#activityHistoryModal').remove();
    
    $('body').append(modalHtml);
    const modal = new bootstrap.Modal(document.getElementById('activityHistoryModal'));
    modal.show();
    
    // Load history logs
    loadActivityHistory();
}

// Load l·ªãch s·ª≠ ho·∫°t ƒë·ªông t·ª´ API
function loadActivityHistory() {
    const token = localStorage.getItem('authToken');
    const content = $('#activityHistoryContent');
    
    fetch(`${API_BASE_URL}/MaintenanceTicket/${maintenanceTicketId}/history`, {
        headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success && data.data) {
            displayActivityHistory(data.data);
        } else {
            content.html(`
                <div class="text-center py-5">
                    <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                    <p class="text-dark">Kh√¥ng c√≥ d·ªØ li·ªáu l·ªãch s·ª≠ ho·∫°t ƒë·ªông</p>
                </div>
            `);
        }
    })
    .catch(error => {
        console.error('Error loading activity history:', error);
        content.html(`
            <div class="text-center py-5">
                <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                <p class="text-danger">Kh√¥ng th·ªÉ t·∫£i l·ªãch s·ª≠ ho·∫°t ƒë·ªông: ${error.message}</p>
                <button class="btn btn-primary mt-3" onclick="loadActivityHistory()">
                    <i class="fas fa-redo me-1"></i>Th·ª≠ l·∫°i
                </button>
            </div>
        `);
    });
}

// Hi·ªÉn th·ªã l·ªãch s·ª≠ ho·∫°t ƒë·ªông
function displayActivityHistory(historyLogs) {
    const content = $('#activityHistoryContent');
    
    if (!historyLogs || historyLogs.length === 0) {
        content.html(`
            <div class="text-center py-5">
                <i class="fas fa-history fa-3x text-dark mb-3"></i>
                <p class="text-dark">Ch∆∞a c√≥ ho·∫°t ƒë·ªông n√†o</p>
            </div>
        `);
        return;
    }
    
    // S·∫Øp x·∫øp theo th·ªùi gian (m·ªõi nh·∫•t tr∆∞·ªõc)
    const sortedLogs = [...historyLogs].sort((a, b) => {
        const dateA = a.createdAt ? new Date(a.createdAt) : new Date(0);
        const dateB = b.createdAt ? new Date(b.createdAt) : new Date(0);
        return dateB - dateA;
    });
    
    let html = '<div class="timeline-vertical">';
    
    sortedLogs.forEach((log, index) => {
        const isLast = index === sortedLogs.length - 1;
        const actionInfo = getActionInfo(log.action);
        const userName = log.userName || 'H·ªá th·ªëng';
        // Chuy·ªÉn ƒë·ªïi t·ª´ UTC sang gi·ªù Vi·ªát Nam (UTC+7)
        const dateStr = formatVietnamDateTime(log.createdAt);
        
        html += `
            <div class="timeline-item ${!isLast ? 'mb-4' : ''}">
                <div class="d-flex">
                    <div class="flex-shrink-0">
                        <div class="timeline-icon bg-${actionInfo.color} text-white rounded-circle d-flex align-items-center justify-content-center" 
                             style="width: 48px; height: 48px;">
                            <i class="${actionInfo.icon}"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="mb-0 fw-bold">${actionInfo.title}</h6>
                                    <small class="text-dark">${dateStr}</small>
                                </div>
                                <div class="mb-2">
                                    <span class="badge bg-light text-dark">
                                        <i class="fas fa-user me-1"></i>
                                        ${escapeHtml(userName)}
                                    </span>
                                </div>
                                ${log.newData ? `
                                    <div class="mt-2">
                                        <small class="text-dark d-block mb-1">Chi ti·∫øt:</small>
                                        <div class="bg-light p-2 rounded">
                                            <pre class="mb-0" style="white-space: pre-wrap; font-size: 0.85rem;">${escapeHtml(log.newData)}</pre>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
                ${!isLast ? '<div class="timeline-line ms-5" style="width: 2px; height: 20px; background: #dee2e6; margin-left: 24px;"></div>' : ''}
            </div>
        `;
    });
    
    html += '</div>';
    content.html(html);
}

// L·∫•y th√¥ng tin icon v√† m√†u s·∫Øc d·ª±a tr√™n action
function getActionInfo(action) {
    if (!action) {
        return { title: 'Ho·∫°t ƒë·ªông', icon: 'fas fa-circle', color: 'secondary' };
    }
    
    const actionLower = action.toLowerCase();
    
    if (actionLower.includes('t·∫°o') || actionLower.includes('create')) {
        return { title: 'T·∫°o phi·∫øu b·∫£o d∆∞·ª°ng', icon: 'fas fa-plus-circle', color: 'primary' };
    }
    if (actionLower.includes('g√°n') || actionLower.includes('assign') || actionLower.includes('technician')) {
        return { title: 'G√°n k·ªπ thu·∫≠t vi√™n', icon: 'fas fa-user-plus', color: 'info' };
    }
    if (actionLower.includes('x√≥a') || actionLower.includes('remove') || actionLower.includes('delete')) {
        if (actionLower.includes('technician')) {
            return { title: 'X√≥a k·ªπ thu·∫≠t vi√™n', icon: 'fas fa-user-minus', color: 'warning' };
        }
        return { title: 'X√≥a', icon: 'fas fa-trash', color: 'danger' };
    }
    if (actionLower.includes('th√™m') || actionLower.includes('add') || actionLower.includes('component')) {
        return { title: 'Th√™m ph·ª• t√πng', icon: 'fas fa-plus', color: 'success' };
    }
    if (actionLower.includes('s·ª≠a') || actionLower.includes('update') || actionLower.includes('edit')) {
        return { title: 'C·∫≠p nh·∫≠t', icon: 'fas fa-edit', color: 'warning' };
    }
    if (actionLower.includes('b·∫Øt ƒë·∫ßu') || actionLower.includes('start')) {
        return { title: 'B·∫Øt ƒë·∫ßu b·∫£o d∆∞·ª°ng', icon: 'fas fa-play', color: 'warning' };
    }
    if (actionLower.includes('ho√†n th√†nh') || actionLower.includes('complete') || actionLower.includes('finish')) {
        return { title: 'Ho√†n th√†nh b·∫£o d∆∞·ª°ng', icon: 'fas fa-check-circle', color: 'success' };
    }
    if (actionLower.includes('h·ªßy') || actionLower.includes('cancel')) {
        return { title: 'H·ªßy phi·∫øu b·∫£o d∆∞·ª°ng', icon: 'fas fa-times-circle', color: 'danger' };
    }
    if (actionLower.includes('c√¥ng vi·ªác') || actionLower.includes('task') || actionLower.includes('service')) {
        if (actionLower.includes('th√™m') || actionLower.includes('add') || actionLower.includes('add_service_task')) {
            return { title: 'Th√™m c√¥ng vi·ªác', icon: 'fas fa-tasks', color: 'info' };
        }
        if (actionLower.includes('b·∫Øt ƒë·∫ßu') || actionLower.includes('start') || actionLower.includes('start_service_task')) {
            return { title: 'B·∫Øt ƒë·∫ßu c√¥ng vi·ªác', icon: 'fas fa-play-circle', color: 'warning' };
        }
        if (actionLower.includes('ho√†n th√†nh') || actionLower.includes('complete') || actionLower.includes('complete_service_task')) {
            return { title: 'Ho√†n th√†nh c√¥ng vi·ªác', icon: 'fas fa-check-circle', color: 'success' };
        }
        return { title: 'C·∫≠p nh·∫≠t c√¥ng vi·ªác', icon: 'fas fa-tasks', color: 'warning' };
    }
    if (actionLower.includes('ph·ª• t√πng') || actionLower.includes('component') || actionLower.includes('add_component')) {
        return { title: 'Th√™m ph·ª• t√πng', icon: 'fas fa-cog', color: 'success' };
    }
    
    return { title: action, icon: 'fas fa-circle', color: 'secondary' };
}
</script>
