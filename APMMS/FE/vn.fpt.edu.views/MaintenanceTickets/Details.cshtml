@{
    ViewData["Title"] = "Chi tiết Phiếu Bảo Dưỡng";
    Layout = "~/vn.fpt.edu.views/Shared/_DashboardLayout.cshtml";
    var apiBaseUrl = ViewBag.ApiBaseUrl ?? "https://localhost:7173/api";
}

<style>
    .basic-info-grid .info-section-title {
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.04em;
        color: var(--bs-secondary);
        margin-bottom: 0.75rem;
    }

    .basic-info-grid .info-section + .info-section {
        border-top: 1px solid var(--bs-border-color);
        padding-top: 1.5rem;
    }

    .basic-info-grid .info-row {
        padding: 0.35rem 0;
        border-bottom: 1px dashed rgba(0, 0, 0, 0.05);
    }

    .basic-info-grid .info-row:last-child {
        border-bottom: none;
    }

    .basic-info-grid .info-label {
        font-size: 0.85rem;
        font-weight: 500;
    }

    .basic-info-grid .info-value {
        font-size: 0.95rem;
    }

    .basic-info-grid .info-text-wrap {
        white-space: normal;
        word-break: break-word;
    }

    .basic-info-grid .info-description {
        background: rgba(0, 0, 0, 0.02);
        border: 1px solid var(--bs-border-color);
        border-radius: 0.5rem;
        padding: 1rem;
        font-size: 0.95rem;
        min-height: 3rem;
    }

    .basic-info-grid .info-description p {
        margin-bottom: 0.5rem;
    }

    .basic-info-grid .info-description p:last-child {
        margin-bottom: 0;
    }

    .basic-info-grid .tech-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
    }

    .basic-info-grid .tech-pill {
        display: inline-flex;
        align-items: center;
        gap: 0.35rem;
        padding: 0.4rem 0.7rem;
        border-radius: 999px;
        border: 1px solid var(--bs-border-color);
        background-color: var(--bs-light);
        font-size: 0.85rem;
    }

    .basic-info-grid .tech-pill .btn-link {
        font-size: 0.75rem;
    }

    @@media (min-width: 576px) {
        .basic-info-grid .info-row {
            display: grid;
            grid-template-columns: 160px 1fr;
            align-items: start;
            gap: 0.25rem 0.75rem;
        }
        .basic-info-grid .info-label {
            min-width: 160px;
            text-align: right;
        }
        .basic-info-grid .info-value {
            padding-left: 0;
        }
    }

    /* Timeline styles for activity history modal */
    .timeline-vertical {
        position: relative;
    }

    .timeline-item {
        position: relative;
    }

    .timeline-icon {
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        transition: transform 0.2s;
    }

    .timeline-item:hover .timeline-icon {
        transform: scale(1.1);
    }

    .timeline-line {
        position: relative;
    }

    #activityHistoryCard:hover {
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        transition: box-shadow 0.2s;
    }
</style>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <!-- Header -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="fas fa-wrench me-2"></i>
                        Chi tiết Phiếu Bảo Dưỡng
                    </h4>
                    <div>
                        <a href="/MaintenanceTickets" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-1"></i>
                            Quay lại
                        </a>
                    </div>
                </div>
            </div>

            <!-- Main Content -->
            <div class="row">
                <!-- Left Column - Ticket Info -->
                <div class="col-md-8">
                    <!-- Basic Information -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-info-circle me-2"></i>
                                Thông tin cơ bản
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="row" id="basicInfo">
                                <!-- Basic info will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- Vehicle Check-in Information -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-car me-2"></i>
                                Thông tin Vehicle Check-in
                            </h5>
                        </div>
                        <div class="card-body" id="checkinInfo">
                            <!-- Check-in info will be loaded here -->
                        </div>
                    </div>

                    <!-- Service Tasks -->
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-tasks me-2"></i>
                                Danh sách công việc
                            </h5>
                            <button class="btn btn-sm btn-outline-primary" id="addServiceTaskBtn">
                                <i class="fas fa-plus me-1"></i>
                                Thêm công việc
                            </button>
                        </div>
                        <div class="card-body">
                            <div id="serviceTasksList">
                                <!-- Service tasks will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- Components Used -->
                    <div class="card mb-4">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-cogs me-2"></i>
                                Phụ tùng sử dụng
                            </h5>
                            <div>
                                <button class="btn btn-sm btn-outline-primary me-2" id="applyServicePackageBtn" style="display: none;" title="Áp dụng gói dịch vụ">
                                    <i class="fas fa-box me-1"></i>
                                    Áp dụng gói dịch vụ
                                </button>
                                <button class="btn btn-sm btn-outline-primary" id="addComponentBtn" style="display: none;">
                                <i class="fas fa-plus me-1"></i>
                                Thêm phụ tùng
                            </button>
                            </div>
                        </div>
                        <div class="card-body">
                            <!-- Service Package Info -->
                            <div id="servicePackageInfo" class="alert alert-light border mb-3" style="display: none;">
                                <i class="fas fa-box me-2"></i>
                                <strong>Gói dịch vụ đã áp dụng:</strong> 
                                <span id="servicePackageNameDisplay"></span>
                                <span class="text-dark ms-2" id="servicePackagePriceDisplay"></span>
                            </div>
                            <div id="componentsList">
                                <!-- Components will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Right Column - Actions & Timeline -->
                <div class="col-md-4">
                    <!-- Status & Actions -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-cog me-2"></i>
                                Trạng thái & Thao tác
                            </h5>
                        </div>
                        <div class="card-body">
                            <div class="text-center mb-3">
                                <div id="statusBadge" class="mb-2">
                                    <!-- Status badge will be loaded here -->
                                </div>
                                <div id="progressBar" class="mb-3">
                                    <!-- Progress bar will be loaded here -->
                                </div>
                            </div>
                            
                            <div class="d-grid gap-2" id="actionButtons">
                                <!-- Action buttons will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- Timeline -->
                    <div class="card mb-4" id="activityHistoryCard" style="cursor: pointer;" onclick="openActivityHistoryModal()">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-history me-2"></i>
                                Lịch sử hoạt động
                                <i class="fas fa-external-link-alt ms-2" style="font-size: 0.8em; opacity: 0.7;"></i>
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="timeline">
                                <!-- Timeline will be loaded here -->
                            </div>
                        </div>
                    </div>

                    <!-- Cost Summary -->
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0">
                                <i class="fas fa-calculator me-2"></i>
                                Tổng chi phí
                            </h5>
                        </div>
                        <div class="card-body">
                            <div id="costSummary">
                                <!-- Cost summary will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add/Edit Service Task Modal -->
<div class="modal fade" id="addServiceTaskModal" tabindex="-1" aria-labelledby="addServiceTaskModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addServiceTaskModalLabel">Thêm công việc</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="serviceTaskForm">
                    <input type="hidden" id="taskId">
                    <div class="mb-3">
                        <label for="taskName" class="form-label">Tên công việc <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="taskName" required>
                    </div>
                    <div class="mb-3">
                        <label for="taskDescription" class="form-label">Mô tả</label>
                        <textarea class="form-control" id="taskDescription" rows="3"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="taskStandardLaborTime" class="form-label">Thời gian chuẩn (giờ)</label>
                        <input type="number" class="form-control" id="taskStandardLaborTime" min="0" max="999.99" step="0.01" placeholder="VD: 0.5">
                        <small class="text-dark">Thời gian ước tính để hoàn thành công việc (giờ)</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Kỹ thuật viên</label>
                        <div id="taskTechniciansContainer" class="border rounded p-2" style="max-height: 200px; overflow-y: auto;">
                            <small class="text-dark">Đang tải danh sách...</small>
                        </div>
                        <small class="text-dark">Chọn một hoặc nhiều kỹ thuật viên đã được gán ở phần "Thao tác"</small>
                    </div>
                    <div class="mb-3">
                        <label for="taskNote" class="form-label">Ghi chú</label>
                        <textarea class="form-control" id="taskNote" rows="2"></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" id="saveServiceTaskBtn">Lưu</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Component Modal -->
<div class="modal fade" id="addComponentModal" tabindex="-1" aria-labelledby="addComponentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addComponentModalLabel">Thêm phụ tùng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="componentForm">
                    <div class="mb-3">
                        <label for="componentSelect" class="form-label">Phụ tùng <span class="text-danger">*</span></label>
                        <select class="form-select" id="componentSelect" required>
                            <option value="">Chọn phụ tùng</option>
                            <!-- Will be loaded dynamically -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="componentQuantity" class="form-label">Số lượng <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="componentQuantity" min="1" required>
                    </div>
                    <div class="mb-3">
                        <label for="componentUnitPrice" class="form-label">Đơn giá (VNĐ)</label>
                        <input type="number" class="form-control" id="componentUnitPrice" min="0" step="1000" readonly>
                        <small class="text-dark">Đơn giá tự động lấy từ giá xuất trong kho. Nếu cần giảm giá, vui lòng sử dụng phần giảm giá trong hóa đơn.</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" id="saveComponentBtn">Lưu</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Component Modal -->
<div class="modal fade" id="editComponentModal" tabindex="-1" aria-labelledby="editComponentModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editComponentModalLabel">Chỉnh sửa phụ tùng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editComponentForm">
                    <input type="hidden" id="editComponentId">
                    <div class="mb-3">
                        <label for="editComponentSelect" class="form-label">Phụ tùng <span class="text-danger">*</span></label>
                        <select class="form-select" id="editComponentSelect" required>
                            <option value="">Chọn phụ tùng</option>
                            <!-- Will be loaded dynamically -->
                        </select>
                    </div>
                    <div class="mb-3">
                        <label for="editComponentQuantity" class="form-label">Số lượng ban đầu <span class="text-danger">*</span></label>
                        <input type="number" class="form-control" id="editComponentQuantity" min="1" required>
                        <small class="text-dark">Số lượng phụ tùng đã lấy từ kho</small>
                    </div>
                    <div class="mb-3">
                        <label for="editComponentActualQuantity" class="form-label">Số lượng thực tế sử dụng</label>
                        <input type="number" class="form-control" id="editComponentActualQuantity" min="0" step="0.01">
                        <small class="text-dark">Số lượng thực tế đã sử dụng (có thể nhập số thập phân, ví dụ: 0.8). Nếu để trống, sẽ lấy bằng số lượng ban đầu. Chi phí sẽ được tính dựa trên số lượng thực tế.</small>
                    </div>
                    <div class="mb-3">
                        <label for="editComponentUnitPrice" class="form-label">Đơn giá (VNĐ)</label>
                        <input type="number" class="form-control" id="editComponentUnitPrice" min="0" step="1000" readonly>
                        <small class="text-dark">Đơn giá tự động lấy từ giá xuất trong kho. Nếu cần giảm giá, vui lòng sử dụng phần giảm giá trong hóa đơn.</small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" id="updateComponentBtn">Cập nhật</button>
            </div>
        </div>
    </div>
</div>

<!-- Apply Service Package Modal -->
<div class="modal fade" id="applyServicePackageModal" tabindex="-1" aria-labelledby="applyServicePackageModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="applyServicePackageModalLabel">Chọn gói dịch vụ</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="servicePackageSearch" class="form-label">Tìm kiếm gói dịch vụ</label>
                    <input type="text" class="form-control" id="servicePackageSearch" placeholder="Tìm theo tên, mã gói dịch vụ...">
                </div>
                <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                    <table class="table table-hover">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th>Chọn</th>
                                <th>Mã gói</th>
                                <th>Tên gói</th>
                                <th>Giá</th>
                                <th>Số phụ tùng</th>
                                <th>Mô tả</th>
                            </tr>
                        </thead>
                        <tbody id="servicePackageTableBody">
                            <tr>
                                <td colspan="6" class="text-center">
                                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                                        <span class="visually-hidden">Đang tải...</span>
                                    </div>
                                    Đang tải danh sách gói dịch vụ...
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div id="selectedServicePackageInfo" class="alert alert-info mt-3" style="display: none;">
                    <h6><i class="fas fa-info-circle me-2"></i>Thông tin gói dịch vụ đã chọn:</h6>
                    <div id="selectedServicePackageDetails"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" id="confirmApplyServicePackageBtn" disabled>Áp dụng gói dịch vụ</button>
            </div>
        </div>
    </div>
</div>

<!-- Edit Standard Labor Time Modal -->
<div class="modal fade" id="editStandardLaborTimeModal" tabindex="-1" aria-labelledby="editStandardLaborTimeModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editStandardLaborTimeModalLabel">Chỉnh sửa thời gian chuẩn</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="editStandardLaborTimeForm">
                    <input type="hidden" id="editStandardLaborTimeTaskId">
                    <div class="mb-3">
                        <label for="editStandardLaborTime" class="form-label">Thời gian chuẩn (giờ)</label>
                        <input type="number" class="form-control" id="editStandardLaborTime" min="0" max="999.99" step="0.01">
                        <small class="text-dark">Thời gian ước tính để hoàn thành công việc (từ 0 đến 999.99 giờ). <span id="standardLaborTimeNote" class="text-warning"></span></small>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" id="saveStandardLaborTimeBtn">Lưu</button>
            </div>
        </div>
    </div>
</div>

<!-- Confirm Modal -->
<div class="modal fade" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmModalLabel">Xác nhận</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="confirmModalBody">
                <!-- Content will be set dynamically -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-danger" id="confirmModalBtn">Xác nhận</button>
            </div>
        </div>
    </div>
</div>

<!-- Completion Note Modal -->
<div class="modal fade" id="completionNoteModal" tabindex="-1" aria-labelledby="completionNoteModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="completionNoteModalLabel">Hoàn thành công việc</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label for="completionNoteInput" class="form-label">Ghi chú hoàn thành <span class="text-danger">*</span></label>
                    <textarea class="form-control" id="completionNoteInput" rows="4" placeholder="Nhập ghi chú khi hoàn thành công việc..."></textarea>
                    <small class="text-dark">Vui lòng nhập ghi chú mô tả công việc đã hoàn thành</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-success" id="submitCompletionNoteBtn">
                    <i class="fas fa-check me-1"></i>Hoàn thành
                </button>
            </div>
        </div>
    </div>
</div>

<script>
const API_BASE_URL = '@apiBaseUrl';
let maintenanceTicketId = @ViewBag.MaintenanceTicketId;
let maintenanceTicketData = null;
let currentUserRoleId = null; // Lưu roleId của user hiện tại
let currentUserId = null; // Lưu userId của user hiện tại

$(document).ready(function() {
    loadCurrentUserInfo(); // Load thông tin user để kiểm tra quyền
    loadMaintenanceTicketDetails();
    
    // Modal events
    $('#addServiceTaskBtn').on('click', function() {
        // Reset form và set mode là "Thêm"
        $('#serviceTaskForm')[0].reset();
        $('#taskId').val('');
        $('#addServiceTaskModalLabel').text('Thêm công việc');
        $('#saveServiceTaskBtn').html('Lưu');
        loadTechniciansForTask();
        $('#addServiceTaskModal').modal('show');
    });
    
    // Reset form khi đóng modal
    $('#addServiceTaskModal').on('hidden.bs.modal', function() {
        $('#serviceTaskForm')[0].reset();
        $('#taskId').val('');
        $('#addServiceTaskModalLabel').text('Thêm công việc');
        $('#saveServiceTaskBtn').html('Lưu');
    });
    
    $('#addComponentBtn').on('click', function() {
        loadComponentsForAdd();
        $('#addComponentModal').modal('show');
    });
    
    $('#applyServicePackageBtn').on('click', function() {
        selectedServicePackageId = null;
        selectedServicePackageData = null;
        $('#servicePackageSearch').val('');
        $('#confirmApplyServicePackageBtn').prop('disabled', true);
        $('#selectedServicePackageInfo').hide();
        loadServicePackages();
        $('#applyServicePackageModal').modal('show');
    });
    
    // Reset modal when closed
    $('#applyServicePackageModal').on('hidden.bs.modal', function() {
        selectedServicePackageId = null;
        selectedServicePackageData = null;
        $('#servicePackageSearch').val('');
        $('#confirmApplyServicePackageBtn').prop('disabled', true);
        $('#selectedServicePackageInfo').hide();
        $('.service-package-radio').prop('checked', false);
    });
    
    // Auto-fill unit price when component is selected
    $(document).on('change', '#componentSelect', function() {
        const selectedOption = $(this).find('option:selected');
        const price = selectedOption.data('price') || 0;
        $('#componentUnitPrice').val(price);
    });
    
    $(document).on('change', '#editComponentSelect', function() {
        const selectedOption = $(this).find('option:selected');
        const price = selectedOption.data('price') || 0;
        $('#editComponentUnitPrice').val(price);
    });
    
    // Service Package selection
    let selectedServicePackageId = null;
    let selectedServicePackageData = null;
    $(document).on('change', '.service-package-radio', function() {
        selectedServicePackageId = $(this).val();
        selectedServicePackageData = $(this).closest('tr').data('package-data');
        $('#confirmApplyServicePackageBtn').prop('disabled', !selectedServicePackageId);
        
        if (selectedServicePackageId && selectedServicePackageData) {
            displaySelectedServicePackage(selectedServicePackageData);
        } else {
            $('#selectedServicePackageInfo').hide();
        }
    });
    
    $('#confirmApplyServicePackageBtn').on('click', function() {
        if (!selectedServicePackageId) {
            showAlert('Vui lòng chọn gói dịch vụ', 'warning');
            return;
        }
        applyServicePackage(selectedServicePackageId);
    });
    
    // Search service packages
    let servicePackageSearchTimeout;
    $('#servicePackageSearch').on('input', function() {
        clearTimeout(servicePackageSearchTimeout);
        const searchTerm = $(this).val().toLowerCase();
        servicePackageSearchTimeout = setTimeout(() => {
            filterServicePackages(searchTerm);
        }, 300);
    });
    
    $('#saveServiceTaskBtn').on('click', function() {
        saveServiceTask();
    });
    
    $('#saveComponentBtn').on('click', function() {
        saveComponent();
    });
    
    $('#updateComponentBtn').on('click', function() {
        updateComponent();
    });

    // Gán kỹ thuật viên (mở modal chọn nhiều)
    $(document).on('click', '#assignTechnicianBtn', function() {
        openAssignTechniciansModal();
    });
    
    // Save labor time
    $('#saveStandardLaborTimeBtn').on('click', function() {
        saveStandardLaborTime();
    });
    
    // Reset standard labor time modal when closed
    $('#editStandardLaborTimeModal').on('hidden.bs.modal', function() {
        $('#editStandardLaborTimeForm')[0].reset();
        $('#editStandardLaborTimeTaskId').val('');
        $('#editStandardLaborTime').val('').prop('readonly', false).removeClass('bg-light');
        $('#standardLaborTimeNote').text('');
    });
});

// Load thông tin user hiện tại để kiểm tra quyền
function loadCurrentUserInfo() {
    const token = localStorage.getItem('authToken');
    
    // Gọi API Employee/me để lấy thông tin user
    fetch(`${API_BASE_URL}/Employee/me`, {
        headers: {
            'Authorization': token ? `Bearer ${token}` : '',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.data) {
            currentUserRoleId = data.data.roleId || null;
            currentUserId = data.data.id || null;
            console.log('[loadCurrentUserInfo] User RoleId:', currentUserRoleId, 'UserId:', currentUserId);
        } else {
            console.warn('[loadCurrentUserInfo] Could not load user info');
        }
    })
    .catch(error => {
        console.error('[loadCurrentUserInfo] Error:', error);
    });
}

function loadMaintenanceTicketDetails() {
    const token = localStorage.getItem('authToken');
    fetch(`${API_BASE_URL}/MaintenanceTicket/${maintenanceTicketId}`, {
        headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        }
    })
        .then(async response => {
            if (!response.ok) {
                // Try read json; fallback to text
                try { return { __httpError: true, status: response.status, ...(await response.json()) }; }
                catch { return { __httpError: true, status: response.status, message: await response.text() }; }
            }
            return response.json();
        })
        .then(async data => {
            if (data.__httpError) {
                const msg = data.status === 404 ? 'Không tìm thấy phiếu bảo dưỡng hoặc đã bị xóa.' : (data.message || 'Lỗi tải dữ liệu');
                showAlert(msg, 'danger');
                setTimeout(() => window.location.href = '/MaintenanceTickets', 1200);
                return;
            }
            if (data.success) {
                maintenanceTicketData = data.data;
                await displayBasicInfo(data.data);
                displayCheckinInfo(data.data);
                displayStatusAndActions(data.data);
                displayTimeline(data.data);
                displayServicePackageInfo(data.data);
                
                // Show/hide add component and apply service package buttons based on status
                const canEditComponents = data.data.statusCode === 'PENDING' || data.data.statusCode === 'ASSIGNED' || data.data.statusCode === 'IN_PROGRESS';
                $('#addComponentBtn').toggle(canEditComponents);
                $('#applyServicePackageBtn').toggle(canEditComponents);
                $('#addServiceTaskBtn').toggle(canEditComponents);
                
                loadServiceTasks();
                loadComponents(); // This will also update cost summary
                // Cost summary will be updated after components and tasks are loaded
            } else {
                showAlert('Lỗi tải dữ liệu: ' + data.message, 'danger');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showAlert('Có lỗi xảy ra khi tải dữ liệu', 'danger');
        });
}

const vehicleCheckinDetailCache = new Map();

async function fetchVehicleCheckinDetail(checkinId) {
    if (!checkinId) {
        return null;
    }
    if (vehicleCheckinDetailCache.has(checkinId)) {
        return vehicleCheckinDetailCache.get(checkinId);
    }

    try {
        const token = localStorage.getItem('authToken');
        const response = await fetch(`${API_BASE_URL}/VehicleCheckin/${checkinId}`, {
            headers: token ? { 'Authorization': `Bearer ${token}` } : undefined
        });

        if (!response.ok) {
            console.warn('Không thể tải chi tiết vehicle check-in:', response.status);
            vehicleCheckinDetailCache.set(checkinId, null);
            return null;
        }

        const json = await response.json();
        const detail = json && json.success ? json.data : json;
        vehicleCheckinDetailCache.set(checkinId, detail);
        return detail;
    } catch (error) {
        console.error('Lỗi khi tải chi tiết vehicle check-in:', error);
        vehicleCheckinDetailCache.set(checkinId, null);
        return null;
    }
}

async function displayBasicInfo(data) {
    const basicInfo = $('#basicInfo');
    const createdAt = new Date(data.createdDate).toLocaleDateString('vi-VN');
    const startTime = data.startTime ? new Date(data.startTime).toLocaleDateString('vi-VN') : 'Chưa bắt đầu';
    const endTime = data.endTime ? new Date(data.endTime).toLocaleDateString('vi-VN') : 'Chưa hoàn thành';
    const snapshot = data.vehicleInfo || data.vehicleSnapshot || null;
    const checkin = data.vehicleCheckin || null;
    const checkinVehicleInfo = checkin && checkin.vehicleInfo ? checkin.vehicleInfo : null;

    let manufactureYear = snapshot?.yearOfManufacture
        ?? snapshot?.manufactureYear
        ?? data.yearOfManufacture
        ?? data.manufacturingYear
        ?? data.manufactureYear
        ?? data.carManufactureYear
        ?? data.carYear
        ?? checkin?.yearOfManufacture
        ?? checkin?.manufactureYear
        ?? checkinVehicleInfo?.yearOfManufacture
        ?? checkinVehicleInfo?.manufactureYear
        ?? null;

    let vinNumber = snapshot?.vinNumber
        ?? snapshot?.vin
        ?? data.vinNumber
        ?? data.vehicleVinNumber
        ?? data.vehicleEngineNumber // fallback các hệ cũ
        ?? (data.vehicle && (data.vehicle.vinNumber || data.vehicle.vin))
        ?? (checkin && (checkin.vinNumber || checkin.vin))
        ?? (checkinVehicleInfo && (checkinVehicleInfo.vinNumber || checkinVehicleInfo.vin))
        ?? (data.car && data.car.vinNumber)
        ?? (data.checkin && data.checkin.vinNumber)
        ?? null;

    let engineNumber = snapshot?.engineNumber
        ?? snapshot?.engineNo
        ?? data.engineNumber
        ?? data.engineNo
        ?? data.vehicleEngineNumber
        ?? (data.vehicleInfo && (data.vehicleInfo.engineNumber || data.vehicleInfo.engineNo))
        ?? (data.vehicle && (data.vehicle.engineNumber || data.vehicle.engineNo))
        ?? (checkin && (checkin.engineNumber || checkin.vehicleEngineNumber))
        ?? (checkinVehicleInfo && (checkinVehicleInfo.engineNumber || checkinVehicleInfo.engineNo))
        ?? (data.car && data.car.engineNumber)
        ?? (data.checkin && data.checkin.engineNumber)
        ?? null;

    let licensePlate = snapshot?.licensePlate
        ?? data.licensePlate
        ?? (checkin && checkin.licensePlate)
        ?? (checkinVehicleInfo && checkinVehicleInfo.licensePlate)
        ?? (data.vehicle && data.vehicle.licensePlate)
        ?? null;

    let carName = snapshot?.carName
        ?? data.carName
        ?? (checkin && checkin.carName)
        ?? (checkinVehicleInfo && checkinVehicleInfo.carName)
        ?? (data.vehicle && data.vehicle.carName)
        ?? null;

    let carModel = snapshot?.carModel
        ?? data.carModel
        ?? (checkin && checkin.carModel)
        ?? (checkinVehicleInfo && checkinVehicleInfo.carModel)
        ?? (data.vehicle && data.vehicle.carModel)
        ?? null;

    if ((!vinNumber || !engineNumber || !manufactureYear || !licensePlate || !carName || !carModel) && (data.vehicleCheckinId || checkin?.id)) {
        const checkinId = data.vehicleCheckinId || checkin?.id;
        const checkinDetail = await fetchVehicleCheckinDetail(checkinId);
        if (checkinDetail) {
            vinNumber = vinNumber
                || checkinDetail.vinNumber
                || (checkinDetail.vehicle && (checkinDetail.vehicle.vinNumber || checkinDetail.vehicle.vin))
                || (checkinDetail.vehicleInfo && (checkinDetail.vehicleInfo.vinNumber || checkinDetail.vehicleInfo.vin));

            engineNumber = engineNumber
                || checkinDetail.vehicleEngineNumber
                || checkinDetail.engineNumber
                || (checkinDetail.vehicle && (checkinDetail.vehicle.engineNumber || checkinDetail.vehicle.engineNo))
                || (checkinDetail.vehicleInfo && (checkinDetail.vehicleInfo.engineNumber || checkinDetail.vehicleInfo.engineNo));

            manufactureYear = manufactureYear
                || checkinDetail.yearOfManufacture
                || checkinDetail.manufactureYear
                || (checkinDetail.vehicle && (checkinDetail.vehicle.yearOfManufacture || checkinDetail.vehicle.manufactureYear))
                || (checkinDetail.vehicleInfo && (checkinDetail.vehicleInfo.yearOfManufacture || checkinDetail.vehicleInfo.manufactureYear));

            licensePlate = licensePlate
                || checkinDetail.licensePlate
                || (checkinDetail.vehicle && checkinDetail.vehicle.licensePlate)
                || (checkinDetail.vehicleInfo && checkinDetail.vehicleInfo.licensePlate);

            carName = carName
                || checkinDetail.carName
                || (checkinDetail.vehicle && checkinDetail.vehicle.carName)
                || (checkinDetail.vehicleInfo && checkinDetail.vehicleInfo.carName);

            carModel = carModel
                || checkinDetail.carModel
                || (checkinDetail.vehicle && checkinDetail.vehicle.carModel)
                || (checkinDetail.vehicleInfo && checkinDetail.vehicleInfo.carModel);
        }
    }

    const renderRow = (label, value, options = {}) => {
        const { raw = false, valueClass = 'fw-semibold text-body' } = options;
        const hasValue = value !== undefined && value !== null && value !== '';
        const displayValue = hasValue ? value : 'N/A';
        const formattedValue = raw ? displayValue : escapeHtml(String(displayValue));
        return `
            <div class="info-row d-flex flex-column flex-sm-row align-items-sm-start mb-2">
                <span class="info-label text-dark text-sm-end me-sm-3">${escapeHtml(label)}</span>
                <span class="info-value flex-grow-1 text-start ${valueClass}">${formattedValue}</span>
            </div>
        `;
    };

    let techniciansHtml = '<div class="text-dark">Chưa gán</div>';
    if (data.technicians && data.technicians.length > 0) {
        const techItems = data.technicians.map(t => {
                    const roleBadge = t.roleInTicket === 'PRIMARY' 
                        ? '<span class="badge bg-warning text-dark ms-1">Chính</span>' 
                        : '<span class="badge bg-light text-dark ms-1">Phụ</span>';
                    const canRemove = data.statusCode === 'PENDING' || data.statusCode === 'IN_PROGRESS' || data.statusCode === 'ASSIGNED';
                    const removeBtn = canRemove 
                ? `<button type="button" class="btn btn-sm btn-link text-dark p-0" onclick="removeSingleTechnician(${data.id}, ${t.technicianId})" title="Xóa kỹ thuật viên">
                            <i class="fas fa-times"></i>
                           </button>`
                        : '';
            return `
                <div class="tech-pill">
                    <span>${escapeHtml(t.technicianName || 'N/A')} ${roleBadge}</span>
                        ${removeBtn}
        </div>
            `;
        }).join('\n');
        techniciansHtml = `<div class="tech-list">${techItems}</div>`;
    } else if (data.technicianName) {
        techniciansHtml = `
            <div class="tech-list">
                <div class="tech-pill">
                    <span>${escapeHtml(data.technicianName)}</span>
            </div>
        </div>
        `;
    }

    const descriptionHtml = data.description
        ? escapeHtml(data.description).replace(/\n/g, '<br>')
        : '<span class="text-dark">Không có mô tả</span>';

    const codeValue = data.code || `MTK-${data.id}`;

    basicInfo.html(`
        <div class="row basic-info-grid">
            <div class="col-lg-6">
                <div class="info-section mb-4">
                    <h6 class="info-section-title">Thông tin khách hàng</h6>
                    ${renderRow('Khách hàng', data.customerName)}
                    ${renderRow('Điện thoại', data.customerPhone)}
                    ${renderRow('Địa chỉ', data.customerAddress, { valueClass: 'fw-semibold text-body info-text-wrap' })}
            </div>
                <div class="info-section mb-4">
                    <h6 class="info-section-title">Thông tin xe</h6>
                    ${renderRow('Xe', carName)}
                    ${renderRow('Biển số', licensePlate)}
                    ${renderRow('Mẫu xe', carModel)}
                    ${renderRow('Số khung (VIN)', vinNumber)}
                    ${renderRow('Số máy', engineNumber)}
                    ${renderRow('Năm sản xuất', manufactureYear)}
        </div>
                <div class="info-section mb-0">
                    <h6 class="info-section-title mb-2">Mô tả</h6>
                    <div class="info-description info-text-wrap">${descriptionHtml}</div>
            </div>
        </div>
            <div class="col-lg-6">
                <div class="info-section mb-4">
                    <h6 class="info-section-title">Thông tin phiếu</h6>
                    ${renderRow('Mã phiếu', codeValue)}
                    ${renderRow('Chi nhánh', data.branchName)}
                    ${renderRow('Dịch vụ', data.serviceCategoryName || data.scheduleServiceName)}
                    ${renderRow('Mức ưu tiên', getPriorityBadge(data.priorityLevel), { raw: true, valueClass: 'd-inline-flex align-items-center gap-2' })}
                    ${renderRow('Trạng thái', getStatusBadge(data.statusCode), { raw: true, valueClass: 'd-inline-flex align-items-center gap-2' })}
                    ${renderRow('Ngày tạo', createdAt)}
                    ${renderRow('Bắt đầu', startTime)}
                    ${renderRow('Hoàn thành', endTime)}
                    ${renderRow('Tư vấn viên', data.consulterName)}
            </div>
                <div class="info-section mb-4">
                    <h6 class="info-section-title mb-2">Kỹ thuật viên</h6>
                    ${techniciansHtml}
        </div>
            </div>
        </div>
    `);
}

function displayCheckinInfo(data) {
    const checkinInfo = $('#checkinInfo');
    
    if (data.vehicleCheckinId) {
        const checkinId = data.vehicleCheckinId;
        checkinInfo.html(`
            <div class="row">
                <div class="col-md-6">
                    <strong>Mã Check-in:</strong><br>
                    <a href="/VehicleCheckins/Details/${checkinId}" 
                       class="text-decoration-none" 
                       style="color: #007bff; cursor: pointer;"
                       onmouseover="this.style.textDecoration='underline'; this.style.color='#0056b3';"
                       onmouseout="this.style.textDecoration='none'; this.style.color='#007bff';"
                       title="Xem chi tiết phiếu check-in">
                        VCI-${checkinId}
                        <i class="fas fa-external-link-alt ms-1" style="font-size: 0.8em;"></i>
                    </a>
                </div>
                <div class="col-md-6">
                    <strong>Số km:</strong><br>
                    ${data.mileage ? data.mileage.toLocaleString() + ' km' : 'N/A'}
                </div>
            </div>
        `);
    } else {
        checkinInfo.html('<p class="text-dark">Không có thông tin check-in</p>');
    }
}

function displayServicePackageInfo(data) {
    const servicePackageInfo = $('#servicePackageInfo');
    const servicePackageNameDisplay = $('#servicePackageNameDisplay');
    const servicePackagePriceDisplay = $('#servicePackagePriceDisplay');
    
    // Hỗ trợ cả PascalCase và camelCase
    const servicePackageId = data?.ServicePackageId ?? data?.servicePackageId;
    const servicePackageName = data?.ServicePackageName ?? data?.servicePackageName;
    const servicePackagePrice = data?.ServicePackagePrice ?? data?.servicePackagePrice;
    
    // Debug log
    console.log('Service Package Info Debug:', {
        servicePackageId: servicePackageId,
        servicePackageName: servicePackageName,
        servicePackagePrice: servicePackagePrice,
        data: data
    });
    
    if (servicePackageId && servicePackageName) {
        servicePackageNameDisplay.text(servicePackageName);
        if (servicePackagePrice) {
            servicePackagePriceDisplay.text(`(${formatCurrency(servicePackagePrice)})`);
        } else {
            servicePackagePriceDisplay.text('');
        }
        servicePackageInfo.show();
    } else {
        servicePackageInfo.hide();
    }
}

function displayStatusAndActions(data) {
    const statusBadge = $('#statusBadge');
    const progressBar = $('#progressBar');
    const actionButtons = $('#actionButtons');
    
    // Status badge
    statusBadge.html(getStatusBadge(data.statusCode));
    
    // Progress bar
    const progress = getProgressPercentage(data.statusCode);
    progressBar.html(`
        <div class="progress" style="height: 8px;">
            <div class="progress-bar bg-primary" role="progressbar" style="width: ${progress}%" aria-valuenow="${progress}" aria-valuemin="0" aria-valuemax="100">
            </div>
        </div>
        <small class="text-dark d-block mt-1">${progress}% hoàn thành</small>
    `);
    
    // Action buttons
    let buttons = '';
    const canCancel = data.statusCode !== 'COMPLETED' && data.statusCode !== 'CANCELLED';
    
    switch(data.statusCode) {
        case 'PENDING':
            buttons = `
                <button class="btn btn-outline-primary mb-2" id="assignTechnicianBtn">
                    <i class="fas fa-user-plus me-1"></i>
                    Gán kỹ thuật viên
                </button>
                ${canCancel ? `
                <button class="btn btn-outline-danger" onclick="cancelMaintenanceTicket(${data.id})">
                    <i class="fas fa-times-circle me-1"></i>
                    Hủy phiếu
                </button>
                ` : ''}
            `;
            break;
        case 'ASSIGNED':
            buttons = `
                <button class="btn btn-outline-primary mb-2" onclick="startMaintenance(${data.id})">
                    <i class="fas fa-play me-1"></i>
                    Bắt đầu bảo dưỡng
                </button>
                ${canCancel ? `
                <button class="btn btn-outline-danger" onclick="cancelMaintenanceTicket(${data.id})">
                    <i class="fas fa-times-circle me-1"></i>
                    Hủy phiếu
                </button>
                ` : ''}
            `;
            break;
        case 'IN_PROGRESS':
            // Kiểm tra xem có công việc nào chưa hoàn thành không
            // Sẽ được cập nhật sau khi loadServiceTasks()
            buttons = `
                <button class="btn btn-outline-primary mb-2" onclick="openAssignTechniciansModal()">
                    <i class="fas fa-user-plus me-1"></i>
                    Thêm kỹ thuật viên
                </button>
                <button class="btn btn-outline-success mb-2" id="completeMaintenanceBtn" onclick="completeMaintenance(${data.id})">
                    <i class="fas fa-check me-1"></i>
                    Hoàn thành
                </button>
                ${canCancel ? `
                <button class="btn btn-outline-danger" onclick="cancelMaintenanceTicket(${data.id})">
                    <i class="fas fa-times-circle me-1"></i>
                    Hủy phiếu
                </button>
                ` : ''}
            `;
            break;
        case 'COMPLETED':
            buttons = `
                <button class="btn btn-outline-success" disabled style="opacity: 0.7;">
                    <i class="fas fa-check-circle me-1"></i>
                    Đã hoàn thành
                </button>
            `;
            break;
        case 'CANCELLED':
            buttons = `
                <button class="btn btn-outline-danger" disabled style="opacity: 0.7;">
                    <i class="fas fa-times-circle me-1"></i>
                    Đã hủy
                </button>
            `;
            break;
    }
    
    actionButtons.html(buttons);
}

// Modal chọn kỹ thuật viên
function openAssignTechniciansModal() {
    const modalHtml = `
    <div class="modal fade" id="assignTechniciansModal" tabindex="-1">
      <div class="modal-dialog modal-lg">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="fas fa-user-plus me-2"></i>
              ${(maintenanceTicketData.technicians && maintenanceTicketData.technicians.length > 0) ? 'Thêm/Chỉnh sửa kỹ thuật viên' : 'Gán kỹ thuật viên'}
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            ${(maintenanceTicketData.technicians && maintenanceTicketData.technicians.length > 0) ? `
            <div class="alert alert-light border mb-3">
              <i class="fas fa-info-circle me-1"></i>
              <strong>Danh sách hiện tại:</strong> ${maintenanceTicketData.technicians.map(t => t.technicianName).join(', ')}
              <br><small>Bạn có thể thêm kỹ thuật viên mới hoặc bỏ chọn để xóa người không còn tham gia.</small>
            </div>
            ` : ''}
            <div class="mb-3">
              <div class="input-group">
                <span class="input-group-text"><i class="fas fa-search"></i></span>
                <input type="text" class="form-control" id="assignTechSearch" placeholder="Tìm kỹ thuật viên theo tên hoặc mã nhân viên...">
              </div>
              <small class="text-dark">Gõ để lọc nhanh.</small>
            </div>
            <div class="mb-3 d-flex justify-content-between align-items-center">
              <div class="d-flex gap-2">
                <button type="button" class="btn btn-sm btn-outline-primary" id="selectAllTechBtn">
                  <i class="fas fa-check-double me-1"></i>Chọn tất cả
                </button>
                <button type="button" class="btn btn-sm btn-outline-primary" id="deselectAllTechBtn">
                  <i class="fas fa-times me-1"></i>Bỏ chọn tất cả
                </button>
              </div>
              <div>
                <span class="badge bg-primary" id="selectedCountBadge">Đã chọn: 0</span>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label">
                <i class="fas fa-star text-dark me-1"></i>Chọn kỹ thuật viên chính
              </label>
              <select id="primaryTechSelect" class="form-select">
                <option value="">-- Chưa chọn --</option>
              </select>
              <small class="text-dark">Kỹ thuật viên chính sẽ được tự động chọn nếu bạn chọn checkbox đầu tiên</small>
            </div>
            <div id="assignTechContainer" class="row g-2" style="max-height: 400px; overflow-y: auto;"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              <i class="fas fa-times me-1"></i>Hủy
            </button>
            <button type="button" class="btn btn-primary" id="saveAssignTechBtn">
              <i class="fas fa-save me-1"></i>Lưu
            </button>
          </div>
        </div>
      </div>
    </div>`;

    $('body').append(modalHtml);
    const modal = new bootstrap.Modal(document.getElementById('assignTechniciansModal'));
    modal.show();
    
    // Focus vào search box khi modal hiển thị
    setTimeout(() => $('#assignTechSearch').focus(), 300);

    let allEmployees = [];
    let currentPrimaryId = null;
    
    // Lấy primary technician hiện tại
    if (maintenanceTicketData.technicians && maintenanceTicketData.technicians.length > 0) {
      const primaryTech = maintenanceTicketData.technicians.find(t => t.roleInTicket === 'PRIMARY');
      if (primaryTech) {
        currentPrimaryId = primaryTech.technicianId;
      }
    }

    // Tải danh sách kỹ thuật viên - chỉ lấy kỹ thuật viên cùng chi nhánh
    const branchId = maintenanceTicketData?.branchId;
    if (!branchId) {
      showAlert('Không tìm thấy thông tin chi nhánh. Vui lòng tải lại trang.', 'warning');
      bootstrap.Modal.getInstance(document.getElementById('assignTechniciansModal')).hide();
      $('#assignTechniciansModal').remove();
      return;
    }
    
    const token = localStorage.getItem('authToken');
    fetch(`${API_BASE_URL}/Employee/filter?roleId=4&branchId=${branchId}`, {
        headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        }
    })
      .then(r => {
          if (!r.ok) {
              throw new Error(`HTTP error! status: ${r.status}`);
          }
          return r.json();
      })
      .then(list => {
        allEmployees = (list || []).map(emp => ({
          id: emp.id,
          name: (`${emp.firstName || ''} ${emp.lastName || ''}`).trim() || emp.code || `#${emp.id}`,
          code: emp.code || ''
        }));

        function updateSelectedCount() {
          const count = $('.assign-tech-checkbox:checked').length;
          $('#selectedCountBadge').text(`Đã chọn: ${count}`);
        }

        function updatePrimarySelect() {
          const primarySelect = $('#primaryTechSelect');
          const checkedIds = [];
          $('.assign-tech-checkbox:checked').each(function() {
            checkedIds.push(parseInt($(this).val()));
          });
          
          primarySelect.empty();
          primarySelect.append('<option value="">-- Chưa chọn --</option>');
          
          allEmployees.forEach(emp => {
            if (checkedIds.includes(emp.id)) {
              const isPrimary = currentPrimaryId === emp.id;
              primarySelect.append(`<option value="${emp.id}" ${isPrimary ? 'selected' : ''}>${emp.name}</option>`);
            }
          });
          
          // Nếu chưa có primary và có ít nhất 1 checkbox được chọn, tự động chọn checkbox đầu tiên làm primary
          if (!currentPrimaryId && checkedIds.length > 0) {
            currentPrimaryId = checkedIds[0];
            primarySelect.val(currentPrimaryId);
          }
        }

        function render(listToRender, searchQuery = '') {
          const container = $('#assignTechContainer');
          container.empty();
          
          if (!listToRender || listToRender.length === 0) {
            container.html('<div class="text-center text-dark py-5"><i class="fas fa-user-slash fa-3x mb-3"></i><p>Không có kỹ thuật viên phù hợp</p></div>');
            updateSelectedCount();
            return;
          }
          
          // Lấy danh sách đã chọn từ checkbox hiện tại hoặc từ data ban đầu
          const checkedIds = [];
          $('.assign-tech-checkbox:checked').each(function() {
            checkedIds.push(parseInt($(this).val()));
          });
          
          // Nếu chưa có checkbox nào (lần đầu render), lấy từ maintenanceTicketData
          if (checkedIds.length === 0 && maintenanceTicketData.technicians && maintenanceTicketData.technicians.length > 0) {
            maintenanceTicketData.technicians.forEach(t => {
              if (!checkedIds.includes(t.technicianId)) {
                checkedIds.push(t.technicianId);
              }
            });
          }
          
          listToRender.forEach(emp => {
            const isChecked = checkedIds.includes(emp.id);
            const isPrimary = currentPrimaryId === emp.id;
            const highlightClass = isPrimary ? 'border-secondary bg-light' : '';
            const primaryBadge = isPrimary ? '<span class="badge bg-warning text-dark ms-2"><i class="fas fa-star me-1"></i>Chính</span>' : '';
            
            // Highlight search query
            let displayName = emp.name;
            let displayCode = emp.code;
            if (searchQuery) {
              const regex = new RegExp(`(${searchQuery.replace(/[.*+?^${}()|[\]\\]/g, '\\$&')})`, 'gi');
              displayName = displayName.replace(regex, '<mark>$1</mark>');
              displayCode = displayCode.replace(regex, '<mark>$1</mark>');
            }
            
            container.append(`
              <div class="col-md-6">
                <div class="form-check border rounded p-3 ${highlightClass} tech-card" style="transition: all 0.2s; cursor: pointer;" data-tech-id="${emp.id}">
                  <input class="form-check-input assign-tech-checkbox" type="checkbox" value="${emp.id}" id="assign_${emp.id}" ${isChecked ? 'checked' : ''} style="cursor: pointer; pointer-events: auto;">
                  <label class="form-check-label w-100" for="assign_${emp.id}" style="cursor: pointer; pointer-events: auto;">
                    <strong>${displayName}</strong>${primaryBadge}
                    <br><small class="text-dark">Mã nhân viên: ${displayCode}</small>
                  </label>
                </div>
              </div>
            `);
          });
          
          updateSelectedCount();
          updatePrimarySelect();
        }

        // Xử lý click vào card để toggle checkbox (chỉ khi click vào vùng trống, không phải checkbox/label)
        $(document).on('click', '.tech-card', function(e) {
          // Nếu click vào checkbox, để browser xử lý tự nhiên
          if ($(e.target).is('input[type="checkbox"]')) {
            return; // Cho phép default behavior của checkbox
          }
          // Nếu click vào label, để browser xử lý tự nhiên (label tự động toggle checkbox)
          if ($(e.target).is('label') || $(e.target).closest('label').length > 0) {
            return; // Cho phép default behavior của label
          }
          // Nếu click vào vùng khác của card, toggle checkbox
          e.preventDefault();
          e.stopPropagation();
          const checkbox = $(this).find('input[type="checkbox"]');
          if (checkbox.length) {
            checkbox.prop('checked', !checkbox.prop('checked'));
            checkbox.trigger('change');
          }
          return false;
        });

        // Xử lý checkbox change
        $(document).on('change', '.assign-tech-checkbox', function(e) {
          e.stopPropagation();
          const techId = parseInt($(this).val());
          const isChecked = $(this).is(':checked');
          
          // Nếu đây là checkbox đầu tiên được chọn và chưa có primary, tự động set làm primary
          if (isChecked && !currentPrimaryId && $('.assign-tech-checkbox:checked').length === 1) {
            currentPrimaryId = techId;
            $('#primaryTechSelect').val(techId);
          }
          
          // Nếu bỏ chọn primary technician, xóa primary
          if (!isChecked && currentPrimaryId === techId) {
            currentPrimaryId = null;
            $('#primaryTechSelect').val('');
          }
          
          // Cập nhật UI mà không re-render toàn bộ
          updateSelectedCount();
          updatePrimarySelect();
          
          // Cập nhật highlight cho card
          const card = $(this).closest('.tech-card');
          if (currentPrimaryId === techId) {
            card.addClass('border-secondary bg-light');
            card.find('label strong').html(function() {
              const text = $(this).text().replace(/\s*\(Chính\)\s*$/, '');
              return text + ' <span class="badge bg-warning text-dark ms-2"><i class="fas fa-star me-1"></i>Chính</span>';
            });
          } else {
            card.removeClass('border-secondary bg-light');
            card.find('label strong').html(function() {
              return $(this).text().replace(/\s*\(Chính\)\s*$/, '');
            });
          }
        });

        // Xử lý thay đổi primary select
        $(document).on('change', '#primaryTechSelect', function() {
          currentPrimaryId = $(this).val() ? parseInt($(this).val()) : null;
          // Đảm bảo checkbox của primary được chọn
          if (currentPrimaryId) {
            $(`#assign_${currentPrimaryId}`).prop('checked', true);
          }
          // Re-render để highlight
          const searchQuery = $('#assignTechSearch').val().toLowerCase();
          const filtered = searchQuery ? 
            allEmployees.filter(e => e.name.toLowerCase().includes(searchQuery) || (e.code && e.code.toLowerCase().includes(searchQuery))) :
            allEmployees;
          render(filtered, searchQuery);
        });

        // Chọn tất cả
        $(document).on('click', '#selectAllTechBtn', function() {
          const searchQuery = $('#assignTechSearch').val().toLowerCase();
          const filtered = searchQuery ? 
            allEmployees.filter(e => e.name.toLowerCase().includes(searchQuery) || (e.code && e.code.toLowerCase().includes(searchQuery))) :
            allEmployees;
          
          filtered.forEach(emp => {
            $(`#assign_${emp.id}`).prop('checked', true);
          });
          
          // Tự động chọn primary nếu chưa có
          if (!currentPrimaryId && filtered.length > 0) {
            currentPrimaryId = filtered[0].id;
            $('#primaryTechSelect').val(currentPrimaryId);
          }
          
          updateSelectedCount();
          updatePrimarySelect();
        });

        // Bỏ chọn tất cả
        $(document).on('click', '#deselectAllTechBtn', function() {
          $('.assign-tech-checkbox').prop('checked', false);
          currentPrimaryId = null;
          $('#primaryTechSelect').val('');
          updateSelectedCount();
          updatePrimarySelect();
        });

        // Lần đầu render tất cả
        render(allEmployees);

        // Lọc theo thời gian thực với debounce
        let t;
        $('#assignTechSearch').on('input', function() {
          clearTimeout(t);
          const q = $(this).val().toLowerCase();
          t = setTimeout(() => {
            if (!q) { 
              render(allEmployees); 
              return; 
            }
            const filtered = allEmployees.filter(e => 
              e.name.toLowerCase().includes(q) || (e.code && e.code.toLowerCase().includes(q))
            );
            render(filtered, q);
          }, 120);
        });
      })
      .catch(error => {
          console.error('Error loading employees:', error);
          $('#assignTechContainer').html('<div class="text-center text-danger py-5"><i class="fas fa-exclamation-triangle fa-3x mb-3"></i><p>Lỗi tải danh sách kỹ thuật viên: ' + error.message + '</p></div>');
          showAlert('Không thể tải danh sách kỹ thuật viên. Vui lòng thử lại sau.', 'danger');
      });

    $(document).on('click', '#saveAssignTechBtn', function() {
      const ids = [];
      $('.assign-tech-checkbox:checked').each(function(){ 
        ids.push(parseInt($(this).val())); 
      });
      
      const primaryIdVal = $('#primaryTechSelect').val();
      const primaryId = primaryIdVal ? parseInt(primaryIdVal) : null;
      
      if (ids.length === 0) {
        showAlert('Vui lòng chọn ít nhất một kỹ thuật viên', 'warning');
        return;
      }
      
      if (primaryId && !ids.includes(primaryId)) {
        ids.push(primaryId);
      }
      
      const submitBtn = $(this);
      const originalText = submitBtn.html();
      submitBtn.html('<i class="fas fa-spinner fa-spin me-1"></i>Đang lưu...');
      submitBtn.prop('disabled', true);
      
      const token = localStorage.getItem('authToken');
      fetch(`${API_BASE_URL}/MaintenanceTicket/${maintenanceTicketId}/technicians`, {
        method: 'PUT',
        headers: { 
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ technicianIds: ids, primaryId })
      }).then(r => r.json()).then(res => {
        if (res.success) {
          maintenanceTicketData = res.data;
          displayBasicInfo(maintenanceTicketData);
          displayStatusAndActions(maintenanceTicketData);
          
          // ✅ Gán kỹ thuật viên ở "Thao tác" chỉ để quản lý, KHÔNG tự động gán cho công việc
          // Công việc chỉ hiển thị khi được gán TRỰC TIẾP vào từng ServiceTask
          showAlert('Gán kỹ thuật viên thành công!', 'success');
          
          bootstrap.Modal.getInstance(document.getElementById('assignTechniciansModal')).hide();
          $('#assignTechniciansModal').remove();
        } else {
          showAlert(res.message || 'Gán kỹ thuật viên thất bại', 'danger');
          submitBtn.html(originalText);
          submitBtn.prop('disabled', false);
        }
      }).catch(() => {
        showAlert('Lỗi kết nối máy chủ', 'danger');
        submitBtn.html(originalText);
        submitBtn.prop('disabled', false);
      });
    });
}

function displayTimeline(data) {
    const timeline = $('#timeline');
    const events = [];
    
    // Add events based on data
    if (data.createdDate) {
        events.push({
            date: new Date(data.createdDate),
            title: 'Tạo phiếu bảo dưỡng',
            description: 'Phiếu bảo dưỡng được tạo',
            icon: 'fas fa-plus-circle',
            color: 'secondary'
        });
    }
    
    if (data.technicianName) {
        events.push({
            date: new Date(data.createdDate), // You might want to track actual assignment date
            title: 'Gán kỹ thuật viên',
            description: `Gán cho ${data.technicianName}`,
            icon: 'fas fa-user-plus',
            color: 'secondary'
        });
    }
    
    if (data.startTime) {
        events.push({
            date: new Date(data.startTime),
            title: 'Bắt đầu bảo dưỡng',
            description: 'Bắt đầu thực hiện bảo dưỡng',
            icon: 'fas fa-play',
            color: 'secondary'
        });
    }
    
    if (data.endTime) {
        events.push({
            date: new Date(data.endTime),
            title: 'Hoàn thành bảo dưỡng',
            description: 'Bảo dưỡng đã hoàn thành',
            icon: 'fas fa-check-circle',
            color: 'secondary'
        });
    }
    
    if (data.statusCode === 'CANCELLED') {
        events.push({
            date: new Date(data.createdDate), // Hoặc có thể có cancelledDate nếu có
            title: 'Hủy phiếu bảo dưỡng',
            description: 'Phiếu bảo dưỡng đã được hủy',
            icon: 'fas fa-times-circle',
            color: 'secondary'
        });
    }
    
    // Sort events by date
    events.sort((a, b) => a.date - b.date);
    
    if (events.length === 0) {
        timeline.html('<p class="text-dark">Chưa có hoạt động nào</p>');
        return;
    }
    
    let timelineHtml = '';
    events.forEach((event, index) => {
        const isLast = index === events.length - 1;
                timelineHtml += `
                    <div class="d-flex ${!isLast ? 'mb-3' : ''}">
                        <div class="flex-shrink-0">
                    <div class="bg-primary text-white rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                        <i class="${event.icon}"></i>
                            </div>
                        </div>
                        <div class="flex-grow-1 ms-3">
                    <h6 class="mb-1">${event.title}</h6>
                    <p class="mb-1 text-dark">${event.description}</p>
                    <small class="text-dark">${formatVietnamDateTime(event.date)}</small>
                        </div>
                    </div>
                    ${!isLast ? '<hr class="my-2">' : ''}
                `;
            });
            
            timeline.html(timelineHtml);
}

function displayCostSummary(data, componentTotal = 0, laborCostTotal = 0) {
    const costSummary = $('#costSummary');
    const estimatedCost = data?.totalEstimatedCost || (componentTotal + laborCostTotal);
    
    costSummary.html(`
        <div class="text-center mb-3">
            <h4 class="text-primary">${formatCurrency(estimatedCost)}</h4>
            <p class="text-dark mb-0">Tổng chi phí ước tính</p>
        </div>
        <hr>
        <div class="mb-2">
            <div class="d-flex justify-content-between mb-2">
                <span class="text-dark small">Tổng phụ tùng:</span>
                <strong>${formatCurrency(componentTotal)}</strong>
            </div>
            <div class="d-flex justify-content-between mb-2">
                <span class="text-dark small">Tổng phí nhân công:</span>
                <strong class="text-success">${formatCurrency(laborCostTotal)}</strong>
            </div>
        </div>
        <hr>
        <div class="text-center">
            <small class="text-dark">Chi phí sẽ được cập nhật tự động khi thêm/sửa phụ tùng hoặc công việc</small>
        </div>
    `);
}

function loadServiceTasks() {
    // Lấy token để authenticate
    const token = localStorage.getItem('authToken');
    
    fetch(`${API_BASE_URL}/ServiceTask/by-ticket/${maintenanceTicketId}`, {
        headers: {
            'Authorization': token ? `Bearer ${token}` : ''
        }
    })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                displayServiceTasks(data.data || []);
            } else {
                console.error('Error loading service tasks:', data.message);
                $('#serviceTasksList').html('<p class="text-dark text-danger">Lỗi tải danh sách công việc</p>');
            }
            // Update cost summary after loading service tasks
            // This ensures labor cost is included in the summary
            updateCostSummary();
        })
        .catch(error => {
            console.error('Error loading service tasks:', error);
            $('#serviceTasksList').html('<p class="text-dark text-danger">Lỗi tải danh sách công việc</p>');
            // Still try to update cost summary even if service tasks fail
            updateCostSummary();
        });
}

function displayServiceTasks(tasks) {
    const container = $('#serviceTasksList');
    
    if (!tasks || tasks.length === 0) {
        container.html('<p class="text-dark text-center py-3"><i class="fas fa-inbox me-2"></i>Chưa có công việc nào</p>');
        // Nếu không có công việc nào, vẫn cho phép hoàn thành phiếu
        updateCompleteButtonState([]);
        return;
    }
    
    const canEdit = maintenanceTicketData && (maintenanceTicketData.statusCode === 'PENDING' || maintenanceTicketData.statusCode === 'ASSIGNED' || maintenanceTicketData.statusCode === 'IN_PROGRESS');
    
    // Kiểm tra công việc chưa hoàn thành
    const incompleteTasks = tasks.filter(t => t.statusCode !== 'DONE' && t.statusCode !== 'COMPLETED');
    
    // Cập nhật trạng thái nút "Hoàn thành"
    updateCompleteButtonState(incompleteTasks);
    
    let html = '';
    tasks.forEach(task => {
        const statusBadge = getTaskStatusBadge(task.statusCode);
        const standardLaborTime = task.standardLaborTime ?? null;
        const actualLaborTime = task.actualLaborTime ?? 0;
        const laborCost = task.laborCost || 0;
        const standardLaborTimeDisplay = standardLaborTime !== null ? standardLaborTime.toFixed(2) : '0.00';
        const standardLaborTimeForModal = standardLaborTime !== null ? standardLaborTime : 'null';
        
        // Kiểm tra công việc đã hoàn thành chưa
        const isTaskCompleted = task.statusCode === 'DONE' || task.statusCode === 'COMPLETED';
        const canEditTask = canEdit && !isTaskCompleted;
        
        html += `
            <div class="card mb-2 border-start border-3 ${getTaskBorderColor(task.statusCode)}">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-start">
                        <div class="flex-grow-1">
                            <h6 class="mb-1 fw-bold">${escapeHtml(task.taskName || 'N/A')}</h6>
                            ${task.description ? `<p class="mb-1 text-dark small">${escapeHtml(task.description)}</p>` : ''}
                            ${task.note ? `<div class="mt-2"><small class="text-dark"><i class="fas fa-sticky-note me-1"></i>${escapeHtml(task.note)}</small></div>` : ''}
                            ${task.completionNote ? `<div class="mt-2"><small class="text-dark"><i class="fas fa-check-circle me-1"></i><strong>Ghi chú hoàn thành:</strong> ${escapeHtml(task.completionNote)}</small></div>` : ''}
                            
                            <!-- Technician Info -->
                            ${task.technicians && task.technicians.length > 0 ? `
                                <div class="mt-2">
                                    <small class="text-dark d-block">Kỹ thuật viên:</small>
                                    <div>
                                        ${task.technicians.map(tech => {
                                            const roleBadge = tech.roleInTask === 'PRIMARY' 
                                                ? '<span class="badge bg-warning text-dark ms-1"><i class="fas fa-star me-1"></i>Chính</span>' 
                                                : '';
                                            return `<span class="badge bg-light text-dark me-1"><i class="fas fa-user-tie me-1"></i>${escapeHtml(tech.technicianName || 'N/A')}${roleBadge}</span>`;
                                        }).join('')}
                                    </div>
                                </div>
                            ` : (task.technicianName ? `
                                <div class="mt-2">
                                    <small class="text-dark d-block">Kỹ thuật viên:</small>
                                    <strong><i class="fas fa-user-tie me-1"></i>${escapeHtml(task.technicianName)}</strong>
                                </div>
                            ` : '')}
                            
                            <!-- Time Info -->
                            ${task.startTime ? `
                                <div class="mt-1">
                                    <small class="text-dark">Bắt đầu: ${formatVietnamDateTime(task.startTime)}</small>
                                </div>
                            ` : ''}
                            ${task.endTime ? `
                                <div class="mt-1">
                                    <small class="text-dark">Kết thúc: ${formatVietnamDateTime(task.endTime)}</small>
                                </div>
                            ` : ''}
                            
                            <!-- Labor Cost Information -->
                            <div class="mt-2 row g-2">
                                <div class="col-md-4">
                                    <small class="text-dark d-block">Thời gian chuẩn:</small>
                                    <strong>${standardLaborTimeDisplay} giờ</strong>
                                    ${canEditTask && currentUserRoleId !== 4 ? `
                                        <button class="btn btn-sm btn-link p-0 ms-1" onclick="openEditStandardLaborTimeModal(${task.id})" title="Chỉnh sửa thời gian chuẩn">
                                            <i class="fas fa-edit text-dark"></i>
                                        </button>
                                    ` : ''}
                                </div>
                                <div class="col-md-4">
                                    <small class="text-dark d-block">Thời gian thực tế:</small>
                                    <strong>${actualLaborTime.toFixed(2)} giờ</strong>
                                    ${(() => {
                                        // ✅ Thời gian thực tế chỉ tính tự động, không cho chỉnh sửa
                                        // Không hiển thị nút chỉnh sửa thời gian thực tế
                                        return '';
                                    })()}
                                    ${standardLaborTime !== null && actualLaborTime > (standardLaborTime * 1.5) ? `
                                        <div class="mt-1">
                                            <span class="badge bg-warning text-dark"><i class="fas fa-exclamation-triangle me-1"></i>Vượt quá thời gian chuẩn</span>
                                        </div>
                                    ` : ''}
                                </div>
                                <div class="col-md-4">
                                    <small class="text-dark d-block">Phí nhân công:</small>
                                    <strong>${formatCurrency(laborCost)}</strong>
                                </div>
                            </div>
                        </div>
                        <div class="ms-3 text-end">
                            ${statusBadge}
                            ${canEditTask ? `
                                <button class="btn btn-link text-dark p-1 me-1" onclick="editServiceTask(${task.id})" title="Chỉnh sửa" style="font-size: 0.875rem;">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <button class="btn btn-link text-dark p-1 me-1" onclick="deleteServiceTask(${task.id})" title="Xóa" style="font-size: 0.875rem;">
                                    <i class="fas fa-trash"></i>
                                </button>
                            ` : ''}
                            ${task.statusCode === 'PENDING' ? `
                                <button class="btn btn-sm btn-outline-primary mt-2" onclick="updateTaskStatus(${task.id}, 'IN_PROGRESS')" title="Bắt đầu">
                                    <i class="fas fa-play"></i>
                                </button>
                            ` : ''}
                            ${task.statusCode === 'IN_PROGRESS' ? `
                                <button class="btn btn-sm btn-outline-success mt-2" onclick="updateTaskStatus(${task.id}, 'DONE')" title="Hoàn thành">
                                    <i class="fas fa-check"></i>
                                </button>
                            ` : ''}
                        </div>
                    </div>
                </div>
            </div>
        `;
    });
    
    container.html(html);
}

// Biến lưu taskId và newStatus để dùng trong modal
let pendingTaskStatusUpdate = null;

function updateTaskStatus(taskId, newStatus) {
    // ✅ Nếu hoàn thành (DONE), yêu cầu nhập CompletionNote qua modal
    if (newStatus === 'DONE' || newStatus === 'COMPLETED') {
        // Lưu thông tin để dùng sau khi user nhập note
        pendingTaskStatusUpdate = { taskId, newStatus };
        
        // Reset và hiển thị modal
        $('#completionNoteInput').val('');
        $('#completionNoteModal').modal('show');
    } else {
        updateTaskStatusWithNote(taskId, newStatus, null);
    }
}

// Xử lý khi user submit completion note
$(document).on('click', '#submitCompletionNoteBtn', function() {
    const completionNote = $('#completionNoteInput').val().trim();
    
    if (!completionNote) {
        showAlert('Vui lòng nhập ghi chú hoàn thành', 'warning');
        $('#completionNoteInput').focus();
        return;
    }
    
    if (!pendingTaskStatusUpdate) {
        showAlert('Có lỗi xảy ra. Vui lòng thử lại.', 'danger');
        $('#completionNoteModal').modal('hide');
        return;
    }
    
    // Disable button và hiển thị loading
    const btn = $(this);
    const originalHtml = btn.html();
    btn.html('<i class="fas fa-spinner fa-spin me-1"></i>Đang xử lý...');
    btn.prop('disabled', true);
    
    // Gọi API
    updateTaskStatusWithNote(
        pendingTaskStatusUpdate.taskId, 
        pendingTaskStatusUpdate.newStatus, 
        completionNote
    ).then(() => {
        // Đóng modal và reset
        $('#completionNoteModal').modal('hide');
        pendingTaskStatusUpdate = null;
    }).catch(() => {
        // Giữ modal mở nếu có lỗi
    }).finally(() => {
        btn.html(originalHtml);
        btn.prop('disabled', false);
    });
});

// Reset khi đóng modal
$('#completionNoteModal').on('hidden.bs.modal', function() {
    $('#completionNoteInput').val('');
    pendingTaskStatusUpdate = null;
});

function updateTaskStatusWithNote(taskId, newStatus, completionNote) {
    const token = localStorage.getItem('authToken');
    
    return fetch(`${API_BASE_URL}/ServiceTask/${taskId}/status`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': token ? `Bearer ${token}` : ''
        },
        body: JSON.stringify({ 
            statusCode: newStatus,
            completionNote: completionNote
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Cập nhật trạng thái công việc thành công!', 'success');
            loadServiceTasks(); // Reload danh sách (sẽ tự động cập nhật trạng thái nút "Hoàn thành")
            updateCostSummary(); // Update cost summary
            return Promise.resolve();
        } else {
            showAlert('Lỗi: ' + (data.message || 'Không thể cập nhật trạng thái'), 'danger');
            return Promise.reject(new Error(data.message || 'Không thể cập nhật trạng thái'));
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Có lỗi xảy ra khi cập nhật trạng thái', 'danger');
        return Promise.reject(error);
    });
}

function openEditStandardLaborTimeModal(taskId) {
    const token = localStorage.getItem('authToken');
    
    // Load task để lấy thông tin
    fetch(`${API_BASE_URL}/ServiceTask/${taskId}`, {
        headers: {
            'Authorization': token ? `Bearer ${token}` : '',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.data) {
            const task = data.data;
            
            // Set giá trị vào form
            $('#editStandardLaborTimeTaskId').val(taskId);
            if (task.standardLaborTime !== null && task.standardLaborTime !== undefined) {
                $('#editStandardLaborTime').val(task.standardLaborTime);
            } else {
                $('#editStandardLaborTime').val('');
            }
            
            // ✅ Kiểm tra quyền: Nếu là kỹ thuật viên (roleId = 4), disable StandardLaborTime
            if (currentUserRoleId === 4) {
                $('#editStandardLaborTime').prop('readonly', true).addClass('bg-light');
                $('#standardLaborTimeNote').text('(Kỹ thuật viên không được phép chỉnh sửa thời gian chuẩn)');
            } else {
                $('#editStandardLaborTime').prop('readonly', false).removeClass('bg-light');
                $('#standardLaborTimeNote').text('');
            }
            
            // Mở modal
            $('#editStandardLaborTimeModal').modal('show');
        } else {
            showAlert('Không thể tải thông tin công việc', 'danger');
        }
    })
    .catch(error => {
        console.error('Error loading task:', error);
        showAlert('Có lỗi xảy ra khi tải thông tin công việc', 'danger');
    });
}

function saveLaborTime() {
    const taskId = $('#editLaborTimeTaskId').val();
    const standardLaborTimeInput = $('#editStandardLaborTime').val();
    const actualLaborTimeInput = $('#editActualLaborTime').val();
    
    if (!taskId) {
        showAlert('Không tìm thấy ID công việc', 'warning');
        return;
    }
    
    // ✅ Kiểm tra nếu ActualLaborTime đã bị disable (đã được tính tự động)
    if ($('#editActualLaborTime').prop('readonly')) {
        showAlert('Thời gian thực tế đã được tính tự động từ thời gian bắt đầu/kết thúc, không thể chỉnh sửa!', 'warning');
        return;
    }
    
    if (!actualLaborTimeInput || actualLaborTimeInput === '') {
        showAlert('Vui lòng nhập thời gian thực tế', 'warning');
        return;
    }
    
    const actualLaborTime = parseFloat(actualLaborTimeInput);
    if (actualLaborTime < 0.01 || actualLaborTime > 999.99) {
        showAlert('Thời gian thực tế phải từ 0.01 đến 999.99 giờ', 'warning');
        return;
    }
    
    const standardLaborTime = standardLaborTimeInput && standardLaborTimeInput !== '' 
        ? parseFloat(standardLaborTimeInput) 
        : null;
    if (standardLaborTime !== null && (standardLaborTime < 0 || standardLaborTime > 999.99)) {
        showAlert('Thời gian chuẩn phải từ 0 đến 999.99 giờ', 'warning');
        return;
    }
    
    const token = localStorage.getItem('authToken');
    const btn = $('#saveLaborTimeBtn');
    const originalText = btn.html();
    btn.html('<i class="fas fa-spinner fa-spin me-1"></i>Đang lưu...');
    btn.prop('disabled', true);
    
    // Load task hiện tại để lấy đầy đủ thông tin
    fetch(`${API_BASE_URL}/ServiceTask/${taskId}`, {
        headers: {
            'Authorization': token ? `Bearer ${token}` : '',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(taskData => {
        if (!taskData.success) {
            throw new Error(taskData.message || 'Không thể tải thông tin công việc');
        }
        
        const task = taskData.data;
        
        // ✅ Kiểm tra nếu thời gian đã được tính tự động (có StartTime và EndTime)
        if (task.startTime && task.endTime) {
            btn.html(originalText);
            btn.prop('disabled', false);
            showAlert('Thời gian thực tế đã được tính tự động từ thời gian bắt đầu/kết thúc, không thể chỉnh sửa!', 'warning');
            return;
        }
        
        // ✅ Nếu là kỹ thuật viên, không cho phép thay đổi StandardLaborTime
        let finalStandardLaborTime = standardLaborTime;
        if (currentUserRoleId === 4) {
            // Kỹ thuật viên chỉ được chỉnh ActualLaborTime, giữ nguyên StandardLaborTime
            finalStandardLaborTime = task.standardLaborTime;
        }
        
        // Update task với thông tin mới
        const updateData = {
            id: parseInt(taskId),
            maintenanceTicketId: task.maintenanceTicketId,
            taskName: task.taskName,
            description: task.description || null,
            statusCode: task.statusCode,
            note: task.note || null,
            serviceCategoryId: task.serviceCategoryId || null,
            standardLaborTime: finalStandardLaborTime,
            actualLaborTime: actualLaborTime
        };
        
        // Gọi API update
        return fetch(`${API_BASE_URL}/ServiceTask/${taskId}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': token ? `Bearer ${token}` : ''
        },
            body: JSON.stringify(updateData)
        });
    })
    .then(response => response.json())
    .then(data => {
        btn.html(originalText);
        btn.prop('disabled', false);
        
        if (data.success) {
            showAlert('Cập nhật thời gian lao động thành công!', 'success');
            $('#editLaborTimeModal').modal('hide');
            loadServiceTasks(); // Reload danh sách
            updateCostSummary(); // Update cost summary
        } else {
            showAlert('Lỗi: ' + (data.message || 'Không thể cập nhật thời gian lao động'), 'danger');
        }
    })
    .catch(error => {
        btn.html(originalText);
        btn.prop('disabled', false);
        console.error('Error:', error);
        showAlert('Có lỗi xảy ra khi cập nhật thời gian lao động: ' + error.message, 'danger');
    });
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function getTaskBorderColor(statusCode) {
    // ✅ Đơn giản hóa: chỉ dùng border-secondary cho tất cả
    return 'border-secondary';
}

function loadComponents() {
    const token = localStorage.getItem('authToken');
    fetch(`${API_BASE_URL}/TicketComponent/by-maintenance-ticket/${maintenanceTicketId}`, {
        headers: {
            'Authorization': token ? `Bearer ${token}` : '',
            'Content-Type': 'application/json'
        }
    })
        .then(response => {
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            return response.json();
        })
        .then(data => {
            if (data.success) {
                displayComponents(data.data || []);
                // Update cost summary after displaying components
                // This will also load service tasks to calculate labor cost
                updateCostSummary();
            }
        })
        .catch(error => {
            console.error('Error loading components:', error);
            $('#componentsList').html('<p class="text-dark text-center py-3 text-danger">Lỗi tải danh sách phụ tùng: ' + error.message + '</p>');
            // Still try to update cost summary even if components fail
            updateCostSummary();
        });
}

function displayComponents(components) {
    const container = $('#componentsList');
    
    if (!components || components.length === 0) {
        container.html('<p class="text-dark text-center py-3"><i class="fas fa-inbox me-2"></i>Chưa sử dụng phụ tùng nào</p>');
        return;
    }
    
    let html = '<div class="table-responsive"><table class="table table-hover table-sm"><thead class="table-light"><tr><th>Phụ tùng</th><th>Loại</th><th>Số lượng ban đầu</th><th>Số lượng thực tế</th><th>Đơn giá</th><th>Thành tiền</th><th>Thao tác</th></tr></thead><tbody>';
    
    let totalCost = 0;
    components.forEach(component => {
        const actualQuantity = component.actualQuantity ?? component.quantity;
        const total = component.totalPrice || (actualQuantity * (component.unitPrice || 0));
        totalCost += total;
        const canEdit = maintenanceTicketData && (maintenanceTicketData.statusCode === 'PENDING' || maintenanceTicketData.statusCode === 'ASSIGNED' || maintenanceTicketData.statusCode === 'IN_PROGRESS');
        const quantityDisplay = component.actualQuantity !== null && component.actualQuantity !== undefined && component.actualQuantity !== component.quantity
            ? `<span>${component.quantity}</span> <small class="text-dark">→</small> <strong class="text-warning">${actualQuantity}</strong>`
            : `<span>${component.quantity}</span>`;
        html += `
            <tr>
                <td>
                    <div class="d-flex align-items-center">
                        ${component.componentImageUrl ? `<img src="${component.componentImageUrl}" alt="${component.componentName || ''}" class="me-2" style="width: 40px; height: 40px; object-fit: cover; border-radius: 4px;">` : ''}
                        <div>
                            <strong>${escapeHtml(component.componentName || 'N/A')}</strong>
                            ${component.isFromServicePackage || component.servicePackageId ? '<span class="badge bg-info text-dark ms-2"><i class="fas fa-box me-1"></i>Từ gói dịch vụ</span>' : ''}
                            ${component.componentCode ? `<br><small class="text-dark">Mã: ${escapeHtml(component.componentCode)}</small>` : ''}
                        </div>
                    </div>
                </td>
                <td>${escapeHtml(component.typeComponentName || '-')}</td>
                <td>${component.quantity}</td>
                <td>${actualQuantity.toFixed(2)}${component.actualQuantity !== null && component.actualQuantity !== undefined && component.actualQuantity !== component.quantity ? ' <span class="badge bg-info text-dark">Đã điều chỉnh</span>' : ''}</td>
                <td>${formatCurrency(component.unitPrice || 0)}</td>
                <td><strong>${formatCurrency(total)}</strong></td>
                <td>
                    ${canEdit ? `
                        <button class="btn btn-link text-dark p-1 me-1" onclick="editComponent(${component.id})" title="Chỉnh sửa" style="font-size: 0.875rem;">
                            <i class="fas fa-edit"></i>
                        </button>
                        ${component.isFromServicePackage || component.servicePackageId ? 
                            '<button class="btn btn-link text-dark p-1" disabled title="Không thể xóa phụ tùng từ gói dịch vụ" style="font-size: 0.875rem; cursor: not-allowed; opacity: 0.5;"><i class="fas fa-trash"></i></button>' :
                            `<button class="btn btn-link text-dark p-1" onclick="deleteComponent(${component.id})" title="Xóa" style="font-size: 0.875rem;">
                                <i class="fas fa-trash"></i>
                            </button>`
                        }
                    ` : '<span class="text-dark">-</span>'}
                </td>
            </tr>
        `;
    });
    
    html += `</tbody><tfoot class="table-light"><tr><th colspan="5" class="text-end">Tổng tiền phụ tùng:</th><th colspan="2">${formatCurrency(totalCost)}</th></tr></tfoot></table></div>`;
    container.html(html);
}

// Helper functions
// Helper function để chuyển đổi UTC sang giờ Việt Nam (UTC+7)
function toVietnamTime(dateInput) {
    if (!dateInput) return null;
    let date;
    if (dateInput instanceof Date) {
        date = dateInput;
    } else {
        // Nếu là string, đảm bảo parse như UTC
        // Nếu string không có timezone indicator (Z hoặc +HH:MM), thêm 'Z' để coi như UTC
        let dateStr = dateInput.toString();
        if (!dateStr.includes('Z') && !dateStr.includes('+') && !dateStr.includes('-', dateStr.indexOf('T') + 1)) {
            // Nếu không có timezone, thêm 'Z' để coi như UTC
            if (dateStr.includes('T')) {
                dateStr = dateStr.endsWith('Z') ? dateStr : dateStr + 'Z';
            }
        }
        date = new Date(dateStr);
    }
    if (isNaN(date.getTime())) return null;
    // Thêm 7 giờ để chuyển từ UTC sang giờ Việt Nam
    return new Date(date.getTime() + (7 * 60 * 60 * 1000));
}

// Helper function để format thời gian Việt Nam (giống với ServiceSchedule)
function formatVietnamDateTime(dateInput) {
    if (!dateInput) return 'Không xác định';
    
    // Parse date string, đảm bảo coi như UTC nếu không có timezone indicator
    let dateStr = dateInput.toString();
    if (typeof dateStr === 'string' && !dateStr.endsWith('Z') && !dateStr.includes('+') && !dateStr.includes('-', 10)) {
        dateStr = dateStr + 'Z';
    }
    const date = new Date(dateStr);
    
    if (isNaN(date.getTime())) return 'Không xác định';
    
    // Convert UTC to Vietnam time (UTC+7) - add 7 hours
    const vietnamTime = new Date(date.getTime() + (7 * 60 * 60 * 1000));
    
    // Format: dd/MM/yyyy HH:mm:ss (use getUTCDate/getUTCHours after conversion)
    const day = String(vietnamTime.getUTCDate()).padStart(2, '0');
    const month = String(vietnamTime.getUTCMonth() + 1).padStart(2, '0');
    const year = vietnamTime.getUTCFullYear();
    const hours = String(vietnamTime.getUTCHours()).padStart(2, '0');
    const minutes = String(vietnamTime.getUTCMinutes()).padStart(2, '0');
    const seconds = String(vietnamTime.getUTCSeconds()).padStart(2, '0');
    
    return `${day}/${month}/${year} ${hours}:${minutes}:${seconds}`;
}

function getStatusBadge(statusCode) {
    const statusMap = {
        'PENDING': { text: 'Chờ xử lý', class: 'bg-info' },
        'ASSIGNED': { text: 'Đã gán', class: 'bg-primary' },
        'IN_PROGRESS': { text: 'Đang thực hiện', class: 'bg-primary' },
        'COMPLETED': { text: 'Hoàn thành', class: 'bg-success' },
        'CANCELLED': { text: 'Đã hủy', class: 'bg-danger' }
    };
    
    const status = statusMap[statusCode] || { text: statusCode, class: 'bg-light text-dark' };
    return `<span class="badge ${status.class} fs-6">${status.text}</span>`;
}

function getPriorityBadge(priority) {
    const priorityMap = {
        'NORMAL': { text: 'Bình thường', class: 'bg-light text-dark' },
        'HIGH': { text: 'Cao', class: 'bg-warning text-dark' },
        'URGENT': { text: 'Khẩn cấp', class: 'bg-danger' }
    };
    
    const priorityInfo = priorityMap[priority] || { text: priority, class: 'bg-light text-dark' };
    return `<span class="badge ${priorityInfo.class}">${priorityInfo.text}</span>`;
}

function getProgressPercentage(statusCode) {
    const progressMap = {
        'PENDING': 25,
        'ASSIGNED': 50,
        'IN_PROGRESS': 75,
        'COMPLETED': 100,
        'CANCELLED': 0
    };
    
    return progressMap[statusCode] || 0;
}

function getTaskStatusBadge(statusCode) {
    const statusMap = {
        'PENDING': { text: 'Chờ', class: 'bg-info' },
        'IN_PROGRESS': { text: 'Đang làm', class: 'bg-primary' },
        'DONE': { text: 'Xong', class: 'bg-success' }
    };
    
    const status = statusMap[statusCode] || { text: statusCode, class: 'bg-light text-dark' };
    return `<span class="badge ${status.class}">${status.text}</span>`;
}

// Action functions
function assignTechnician(ticketId) {
    // Implementation for assigning technician
    showAlert('Chức năng gán kỹ thuật viên đang được phát triển', 'info');
}

function showConfirmModal(message, onConfirm) {
    $('#confirmModalBody').html(message);
    $('#confirmModalBtn').off('click').on('click', function() {
        $('#confirmModal').modal('hide');
        if (onConfirm) onConfirm();
    });
    $('#confirmModal').modal('show');
}

function startMaintenance(ticketId) {
    showConfirmModal(
        '<p>Bạn có chắc chắn muốn bắt đầu bảo dưỡng không?</p>',
        function() {
            executeStartMaintenance(ticketId);
        }
    );
}

function executeStartMaintenance(ticketId) {
    const token = localStorage.getItem('authToken');
    
    fetch(`${API_BASE_URL}/MaintenanceTicket/${ticketId}/start`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': token ? `Bearer ${token}` : ''
        }
    })
    .then(async response => {
        const data = await response.json();
        if (!response.ok) {
            throw new Error(data.message || 'Lỗi khi bắt đầu bảo dưỡng');
        }
        return data;
    })
    .then(data => {
        if (data.success) {
            showAlert('Bắt đầu bảo dưỡng thành công!', 'success');
            loadMaintenanceTicketDetails(); // Reload để cập nhật UI
        } else {
            showAlert('Lỗi: ' + (data.message || 'Không thể bắt đầu bảo dưỡng'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Có lỗi xảy ra: ' + error.message, 'danger');
    });
}

function completeMaintenance(ticketId) {
    // Kiểm tra lại công việc chưa hoàn thành trước khi hiển thị confirm
    const token = localStorage.getItem('authToken');
    fetch(`${API_BASE_URL}/ServiceTask/by-ticket/${maintenanceTicketId}`, {
        headers: {
            'Authorization': token ? `Bearer ${token}` : ''
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const tasks = data.data || [];
            const incompleteTasks = tasks.filter(t => t.statusCode !== 'DONE' && t.statusCode !== 'COMPLETED');
            
            if (incompleteTasks.length > 0) {
                const taskNames = incompleteTasks.slice(0, 5).map(t => t.taskName || `Task ${t.id}`).join(', ');
                const message = incompleteTasks.length > 5
                    ? `<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i><strong>Cảnh báo!</strong></div><p>Không thể hoàn thành phiếu. Còn <strong>${incompleteTasks.length} công việc</strong> chưa hoàn thành:</p><ul><li>${taskNames}</li><li>... và ${incompleteTasks.length - 5} công việc khác</li></ul><p class="mb-0">Vui lòng hoàn thành tất cả công việc trước khi hoàn thành phiếu.</p>`
                    : `<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i><strong>Cảnh báo!</strong></div><p>Không thể hoàn thành phiếu. Còn <strong>${incompleteTasks.length} công việc</strong> chưa hoàn thành:</p><ul>${incompleteTasks.map(t => `<li>${escapeHtml(t.taskName || `Task ${t.id}`)}</li>`).join('')}</ul><p class="mb-0">Vui lòng hoàn thành tất cả công việc trước khi hoàn thành phiếu.</p>`;
                
                showAlert(message, 'warning');
                return;
            }
            
            // Tất cả công việc đã hoàn thành, hiển thị confirm
            showConfirmModal(
                '<p>Bạn có chắc chắn muốn hoàn thành phiếu bảo dưỡng này không?</p>',
                function() {
                    executeCompleteMaintenance(ticketId);
                }
            );
        } else {
            // Nếu không load được danh sách công việc, vẫn cho phép thử hoàn thành (backend sẽ validate)
            showConfirmModal(
                '<p>Bạn có chắc chắn muốn hoàn thành phiếu bảo dưỡng này không?</p>',
                function() {
                    executeCompleteMaintenance(ticketId);
                }
            );
        }
    })
    .catch(error => {
        console.error('Error checking tasks:', error);
        // Nếu có lỗi, vẫn cho phép thử hoàn thành (backend sẽ validate)
        showConfirmModal(
            '<p>Bạn có chắc chắn muốn hoàn thành phiếu bảo dưỡng này không?</p>',
            function() {
                executeCompleteMaintenance(ticketId);
            }
        );
    });
}

function updateCompleteButtonState(incompleteTasks) {
    const completeBtn = $('#completeMaintenanceBtn');
    if (completeBtn.length === 0) return; // Nút chưa được render
    
    if (incompleteTasks.length > 0) {
        // Disable nút và thêm tooltip
        completeBtn.prop('disabled', true);
        completeBtn.attr('title', `Còn ${incompleteTasks.length} công việc chưa hoàn thành`);
        completeBtn.css('opacity', '0.6');
        
        // Thêm thông báo bên dưới nút
        if ($('#completeWarningMessage').length === 0) {
            completeBtn.after(`
                <div id="completeWarningMessage" class="alert alert-warning mt-2 mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <small>Còn <strong>${incompleteTasks.length}</strong> công việc chưa hoàn thành. Vui lòng hoàn thành tất cả công việc trước khi hoàn thành phiếu.</small>
                </div>
            `);
        } else {
            $('#completeWarningMessage').html(`
                <i class="fas fa-exclamation-triangle me-2"></i>
                <small>Còn <strong>${incompleteTasks.length}</strong> công việc chưa hoàn thành. Vui lòng hoàn thành tất cả công việc trước khi hoàn thành phiếu.</small>
            `);
        }
    } else {
        // Enable nút
        completeBtn.prop('disabled', false);
        completeBtn.removeAttr('title');
        completeBtn.css('opacity', '1');
        $('#completeWarningMessage').remove();
    }
}

function removeSingleTechnician(ticketId, technicianId) {
    // Tìm tên kỹ thuật viên để hiển thị trong popup
    const technician = maintenanceTicketData?.technicians?.find(t => t.technicianId === technicianId);
    const technicianName = technician ? technician.technicianName : 'kỹ thuật viên này';
    
    showConfirmModal(
        `<p>Bạn có chắc chắn muốn xóa <strong>${technicianName}</strong> khỏi phiếu bảo dưỡng?</p>`,
        function() {
            executeRemoveTechnician(ticketId, technicianId);
        }
    );
}

function executeRemoveTechnician(ticketId, technicianId) {
    if (!maintenanceTicketData || !maintenanceTicketData.technicians) {
        showAlert('Không tìm thấy dữ liệu kỹ thuật viên', 'danger');
        return;
    }

    // Lấy danh sách kỹ thuật viên còn lại (loại bỏ người được xóa)
    const remainingTechnicians = maintenanceTicketData.technicians
        .filter(t => t.technicianId !== technicianId)
        .map(t => t.technicianId);

    // Xác định primary mới (nếu người bị xóa là primary, chọn người đầu tiên còn lại)
    let primaryId = null;
    const currentPrimary = maintenanceTicketData.technicians.find(t => t.roleInTicket === 'PRIMARY');
    
    if (remainingTechnicians.length > 0) {
        // Còn kỹ thuật viên khác
        if (currentPrimary && currentPrimary.technicianId === technicianId) {
            // Nếu xóa primary, chọn người đầu tiên còn lại làm primary
            primaryId = remainingTechnicians[0];
        } else if (currentPrimary) {
            // Giữ nguyên primary hiện tại nếu không bị xóa
            primaryId = currentPrimary.technicianId;
        } else {
            // Nếu không có primary, chọn người đầu tiên
            primaryId = remainingTechnicians[0];
        }
    }
    // Nếu remainingTechnicians.length === 0, primaryId sẽ là null (không còn ai)

    const token = localStorage.getItem('authToken');
    fetch(`${API_BASE_URL}/MaintenanceTicket/${ticketId}/technicians`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${token}`
        },
        body: JSON.stringify({ 
            technicianIds: remainingTechnicians, 
            primaryId: primaryId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Xóa kỹ thuật viên thành công', 'success');
            maintenanceTicketData = data.data;
            displayBasicInfo(maintenanceTicketData);
            displayStatusAndActions(maintenanceTicketData);
        } else {
            showAlert(data.message || 'Xóa kỹ thuật viên thất bại', 'danger');
        }
    })
    .catch(error => {
        console.error('Error removing technician:', error);
        showAlert('Có lỗi xảy ra khi xóa kỹ thuật viên', 'danger');
    });
}

function executeCompleteMaintenance(ticketId) {
    const token = localStorage.getItem('authToken');
    
    fetch(`${API_BASE_URL}/MaintenanceTicket/${ticketId}/complete`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': token ? `Bearer ${token}` : ''
        }
    })
    .then(async response => {
        const data = await response.json();
        if (!response.ok) {
            throw new Error(data.message || 'Lỗi khi hoàn thành phiếu bảo dưỡng');
        }
        return data;
    })
    .then(data => {
        if (data.success) {
            showAlert('Hoàn thành phiếu bảo dưỡng thành công!', 'success');
            loadMaintenanceTicketDetails(); // Reload để cập nhật UI
        } else {
            showAlert('Lỗi: ' + (data.message || 'Không thể hoàn thành phiếu'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Có lỗi xảy ra: ' + error.message, 'danger');
    });
}

function cancelMaintenanceTicket(ticketId) {
    showConfirmModal(
        '<div class="alert alert-warning"><i class="fas fa-exclamation-triangle me-2"></i><strong>Cảnh báo!</strong></div><p>Bạn có chắc chắn muốn hủy phiếu bảo dưỡng này không? Hành động này không thể hoàn tác.</p>',
        function() {
            executeCancelMaintenanceTicket(ticketId);
        }
    );
}

function executeCancelMaintenanceTicket(ticketId) {
    const token = localStorage.getItem('authToken');
    
    fetch(`${API_BASE_URL}/MaintenanceTicket/${ticketId}/cancel`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': token ? `Bearer ${token}` : ''
        }
    })
    .then(async response => {
        const data = await response.json();
        if (!response.ok) {
            throw new Error(data.message || 'Lỗi khi hủy phiếu bảo dưỡng');
        }
        return data;
    })
    .then(data => {
        if (data.success) {
            showAlert('Hủy phiếu bảo dưỡng thành công!', 'success');
            loadMaintenanceTicketDetails(); // Reload để cập nhật UI
        } else {
            showAlert('Lỗi: ' + (data.message || 'Không thể hủy phiếu'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Có lỗi xảy ra: ' + error.message, 'danger');
    });
}

function saveServiceTask() {
    const taskName = $('#taskName').val().trim();
    const taskDescription = $('#taskDescription').val().trim();
    const taskNote = $('#taskNote').val().trim();
    const taskStandardLaborTime = $('#taskStandardLaborTime').val() ? parseFloat($('#taskStandardLaborTime').val()) : null;
    // ✅ Thời gian thực tế chỉ tính tự động, không nhập từ form
    
    if (!taskName) {
        showAlert('Vui lòng nhập tên công việc', 'warning');
        return;
    }
    
    // Validate labor time
    if (taskStandardLaborTime !== null && (taskStandardLaborTime < 0 || taskStandardLaborTime > 999.99)) {
        showAlert('Thời gian chuẩn phải từ 0 đến 999.99 giờ', 'warning');
        return;
    }
    
    // ✅ Thời gian thực tế chỉ tính tự động, không cần validate từ form
    
    const taskId = $('#taskId').val();
    const isEdit = taskId && taskId !== '';
    
    // Lấy token để authenticate
    const token = localStorage.getItem('authToken');
    
    // Show loading
    const btn = $('#saveServiceTaskBtn');
    const originalText = btn.html();
    btn.html('<i class="fas fa-spinner fa-spin me-1"></i>Đang lưu...');
    btn.prop('disabled', true);
    
    if (isEdit) {
        // Update mode: Load task hiện tại để lấy đầy đủ thông tin
        fetch(`${API_BASE_URL}/ServiceTask/${taskId}`, {
            headers: {
                'Authorization': token ? `Bearer ${token}` : '',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(taskData => {
            if (!taskData.success) {
                throw new Error(taskData.message || 'Không thể tải thông tin công việc');
            }
            
            const task = taskData.data;
            
            // ✅ Lấy danh sách technicians đã chọn (checkbox)
            const selectedTechnicianIds = [];
            $('.task-technician-checkbox:checked').each(function() {
                selectedTechnicianIds.push(parseInt($(this).val()));
            });
            const primaryTechnicianId = $('.task-technician-checkbox:checked[data-is-primary="true"]').first().val() 
                ? parseInt($('.task-technician-checkbox:checked[data-is-primary="true"]').first().val()) 
                : (selectedTechnicianIds.length > 0 ? selectedTechnicianIds[0] : null);
            
            // ✅ Nếu thời gian đã được tính tự động, không gửi actualLaborTime (giữ nguyên giá trị đã tính)
            const shouldIncludeActualLaborTime = !(task.startTime && task.endTime);
            
            const updateData = {
                id: parseInt(taskId),
                maintenanceTicketId: task.maintenanceTicketId,
                taskName: taskName,
                description: taskDescription || null,
                statusCode: task.statusCode, // Giữ nguyên status hiện tại
                note: taskNote || null,
                serviceCategoryId: task.serviceCategoryId || null,
                standardLaborTime: taskStandardLaborTime,
                // ✅ Thời gian thực tế chỉ tính tự động, không gửi từ form
                technicianId: primaryTechnicianId // Giữ lại để backward compatibility
            };
            
            // Gọi API update
            return fetch(`${API_BASE_URL}/ServiceTask/${taskId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': token ? `Bearer ${token}` : ''
                },
                body: JSON.stringify(updateData)
            }).then(response => response.json()).then(updateResult => {
                // ✅ Sau khi update task, gán technicians nếu có
                if (updateResult.success && selectedTechnicianIds.length > 0) {
                    return fetch(`${API_BASE_URL}/ServiceTask/${taskId}/technicians`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': token ? `Bearer ${token}` : ''
                        },
                        body: JSON.stringify({
                            technicianIds: selectedTechnicianIds,
                            primaryTechnicianId: primaryTechnicianId
                        })
                    }).then(response => response.json()).then(assignResult => {
                        // Trả về kết quả update task (không phải assign)
                        return updateResult;
                    });
                }
                return updateResult;
            });
        })
        .then(data => {
            btn.html(originalText);
            btn.prop('disabled', false);
            
            if (data.success) {
                showAlert('Cập nhật công việc thành công!', 'success');
                $('#addServiceTaskModal').modal('hide');
                loadServiceTasks();
                updateCostSummary();
            } else {
                showAlert('Lỗi: ' + (data.message || 'Không thể cập nhật công việc'), 'danger');
            }
        })
        .catch(error => {
            btn.html(originalText);
            btn.prop('disabled', false);
            console.error('Error:', error);
            showAlert('Có lỗi xảy ra khi cập nhật công việc: ' + error.message, 'danger');
        });
    } else {
        // Create mode
        // ✅ Lấy danh sách technicians đã chọn (checkbox)
        const selectedTechnicianIds = [];
        $('.task-technician-checkbox:checked').each(function() {
            selectedTechnicianIds.push(parseInt($(this).val()));
        });
        const primaryTechnicianId = $('.task-technician-checkbox:checked[data-is-primary="true"]').first().val() 
            ? parseInt($('.task-technician-checkbox:checked[data-is-primary="true"]').first().val()) 
            : (selectedTechnicianIds.length > 0 ? selectedTechnicianIds[0] : null);
        
        const taskData = {
            maintenanceTicketId: maintenanceTicketId,
            taskName: taskName,
            description: taskDescription || null,
            note: taskNote || null,
            statusCode: 'PENDING', // Mặc định là PENDING
            standardLaborTime: taskStandardLaborTime,
            // ✅ Thời gian thực tế chỉ tính tự động, không gửi từ form
            technicianId: primaryTechnicianId // Giữ lại để backward compatibility
        };
        
        fetch(`${API_BASE_URL}/ServiceTask`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': token ? `Bearer ${token}` : ''
            },
            body: JSON.stringify(taskData)
        })
        .then(response => response.json())
        .then(data => {
            btn.html(originalText);
            btn.prop('disabled', false);
            
            if (data.success) {
                const createdTaskId = data.data?.id;
                
                // ✅ Nếu có chọn technicians, gán cho công việc vừa tạo
                if (selectedTechnicianIds.length > 0 && createdTaskId) {
                    return fetch(`${API_BASE_URL}/ServiceTask/${createdTaskId}/technicians`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': token ? `Bearer ${token}` : ''
                        },
                        body: JSON.stringify({
                            technicianIds: selectedTechnicianIds,
                            primaryTechnicianId: primaryTechnicianId
                        })
                    }).then(response => response.json()).then(assignData => {
                        if (assignData.success) {
                            showAlert('Thêm công việc và gán kỹ thuật viên thành công!', 'success');
                        } else {
                            showAlert('Thêm công việc thành công, nhưng có lỗi khi gán kỹ thuật viên', 'warning');
                        }
                        $('#addServiceTaskModal').modal('hide');
                        loadServiceTasks();
                        updateCostSummary();
                    });
                } else {
                showAlert('Thêm công việc thành công!', 'success');
                $('#addServiceTaskModal').modal('hide');
                loadServiceTasks();
                updateCostSummary();
                }
            } else {
                showAlert('Lỗi: ' + (data.message || 'Không thể thêm công việc'), 'danger');
            }
        })
        .catch(error => {
            btn.html(originalText);
            btn.prop('disabled', false);
            console.error('Error:', error);
            showAlert('Có lỗi xảy ra khi thêm công việc', 'danger');
        });
    }
}

function editServiceTask(taskId) {
    const token = localStorage.getItem('authToken');
    
    fetch(`${API_BASE_URL}/ServiceTask/${taskId}`, {
        headers: {
            'Authorization': token ? `Bearer ${token}` : '',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.data) {
            const task = data.data;
            
            // Điền dữ liệu vào form
            $('#taskId').val(task.id);
            $('#taskName').val(task.taskName || '');
            $('#taskDescription').val(task.description || '');
            $('#taskNote').val(task.note || '');
            $('#taskStandardLaborTime').val(task.standardLaborTime || '');
            
            // Load và set technicians (checkbox)
            loadTechniciansForTask().then(() => {
                // Uncheck tất cả trước
                $('.task-technician-checkbox').prop('checked', false);
                
                // Check các technicians đã được gán
                if (task.technicians && Array.isArray(task.technicians) && task.technicians.length > 0) {
                    task.technicians.forEach(tech => {
                        $(`#taskTech_${tech.technicianId}`).prop('checked', true);
                    });
                } else if (task.technicianId) {
                    // Backward compatibility: nếu chỉ có technicianId cũ
                    $(`#taskTech_${task.technicianId}`).prop('checked', true);
                }
            });
            
            // Đổi tiêu đề modal
            $('#addServiceTaskModalLabel').text('Chỉnh sửa công việc');
            
            // Đổi title và button text
            $('#addServiceTaskModalLabel').text('Chỉnh sửa công việc');
            $('#saveServiceTaskBtn').html('Cập nhật');
            
            // Mở modal
            $('#addServiceTaskModal').modal('show');
        } else {
            showAlert('Lỗi tải thông tin công việc: ' + (data.message || 'Không tìm thấy công việc'), 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Có lỗi xảy ra khi tải thông tin công việc', 'danger');
    });
}

function loadTechniciansForTask() {
    return new Promise((resolve, reject) => {
        const container = $('#taskTechniciansContainer');
        
        // ✅ Lấy danh sách kỹ thuật viên từ maintenanceTicketData.technicians (đã được gán ở thao tác)
        if (maintenanceTicketData && maintenanceTicketData.technicians && maintenanceTicketData.technicians.length > 0) {
            let html = '';
            maintenanceTicketData.technicians.forEach(tech => {
                const techName = tech.technicianName || `Kỹ thuật viên #${tech.technicianId}`;
                const isPrimary = tech.roleInTicket === 'PRIMARY';
                const primaryBadge = isPrimary ? '<span class="badge bg-warning text-dark ms-2"><i class="fas fa-star me-1"></i>Chính</span>' : '';
                html += `
                    <div class="form-check">
                        <input class="form-check-input task-technician-checkbox" type="checkbox" 
                               value="${tech.technicianId}" 
                               id="taskTech_${tech.technicianId}"
                               ${isPrimary ? 'data-is-primary="true"' : ''}>
                        <label class="form-check-label" for="taskTech_${tech.technicianId}">
                            ${techName}${primaryBadge}
                        </label>
                    </div>
                `;
            });
            container.html(html);
            console.log('[loadTechniciansForTask] Loaded', maintenanceTicketData.technicians.length, 'technicians from maintenanceTicketData');
        } else {
            // Nếu chưa có kỹ thuật viên nào được gán, hiển thị thông báo
            container.html('<div class="text-dark text-center py-2"><small>Vui lòng gán kỹ thuật viên ở phần "Thao tác" trước</small></div>');
            console.warn('[loadTechniciansForTask] No technicians assigned to this ticket yet');
        }
        
        resolve();
    });
}

// ✅ Hàm tự động cập nhật TechnicianId cho tất cả ServiceTask hiện có
function updateAllServiceTasksWithTechnicians(technicianIds, primaryId) {
    return new Promise((resolve, reject) => {
        if (!technicianIds || technicianIds.length === 0) {
            resolve();
            return;
        }
        
        const token = localStorage.getItem('authToken');
        
        // Lấy danh sách tất cả công việc hiện có
        fetch(`${API_BASE_URL}/ServiceTask/by-ticket/${maintenanceTicketId}`, {
            headers: {
                'Authorization': token ? `Bearer ${token}` : '',
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            let tasks = [];
            if (data.success && Array.isArray(data.data)) {
                tasks = data.data;
            } else if (Array.isArray(data)) {
                tasks = data;
            }
            
            if (tasks.length === 0) {
                console.log('[updateAllServiceTasksWithTechnicians] No tasks to update');
                resolve();
                return;
            }
            
            // Cập nhật từng công việc: nếu chưa có TechnicianId, gán primaryId hoặc technicianIds[0]
            const updatePromises = tasks.map(task => {
                // Chỉ cập nhật nếu công việc chưa có TechnicianId
                if (!task.technicianId) {
                    const technicianIdToAssign = primaryId || technicianIds[0];
                    
                    // Load task đầy đủ để update
                    return fetch(`${API_BASE_URL}/ServiceTask/${task.id}`, {
                        headers: {
                            'Authorization': token ? `Bearer ${token}` : '',
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => response.json())
                    .then(taskData => {
                        if (taskData.success && taskData.data) {
                            const fullTask = taskData.data;
                            const updateData = {
                                id: fullTask.id,
                                maintenanceTicketId: fullTask.maintenanceTicketId,
                                taskName: fullTask.taskName,
                                description: fullTask.description,
                                statusCode: fullTask.statusCode,
                                note: fullTask.note,
                                serviceCategoryId: fullTask.serviceCategoryId,
                                standardLaborTime: fullTask.standardLaborTime,
                                actualLaborTime: fullTask.actualLaborTime,
                                technicianId: technicianIdToAssign,
                                displayOrder: fullTask.displayOrder
                            };
                            
                            return fetch(`${API_BASE_URL}/ServiceTask/${task.id}`, {
                                method: 'PUT',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'Authorization': token ? `Bearer ${token}` : ''
                                },
                                body: JSON.stringify(updateData)
                            });
                        }
                        return Promise.resolve();
                    });
                }
                return Promise.resolve();
            });
            
            return Promise.all(updatePromises);
        })
        .then(() => {
            console.log('[updateAllServiceTasksWithTechnicians] All tasks updated successfully');
            resolve();
        })
        .catch(error => {
            console.error('[updateAllServiceTasksWithTechnicians] Error:', error);
            reject(error);
        });
    });
}

function deleteServiceTask(taskId) {
    showConfirmModal(
        '<p>Bạn có chắc chắn muốn xóa công việc này không?</p>',
        function() {
            const token = localStorage.getItem('authToken');
            
            fetch(`${API_BASE_URL}/ServiceTask/${taskId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': token ? `Bearer ${token}` : '',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Xóa công việc thành công!', 'success');
                    loadServiceTasks();
                    updateCostSummary();
                } else {
                    showAlert('Lỗi: ' + (data.message || 'Không thể xóa công việc'), 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Có lỗi xảy ra khi xóa công việc', 'danger');
            });
        }
    );
}

function saveComponent() {
    const componentId = $('#componentSelect').val();
    const quantity = parseInt($('#componentQuantity').val());
    const unitPrice = parseFloat($('#componentUnitPrice').val()) || null;
    
    if (!componentId || !quantity || quantity <= 0) {
        showAlert('Vui lòng điền đầy đủ thông tin bắt buộc', 'warning');
        return;
    }
    
    const formData = {
        maintenanceTicketId: maintenanceTicketId,
        componentId: parseInt(componentId),
        quantity: quantity,
        unitPrice: unitPrice
    };
    
    const token = localStorage.getItem('authToken');
    const btn = $('#saveComponentBtn');
    const originalText = btn.html();
    btn.html('<i class="fas fa-spinner fa-spin me-1"></i>Đang lưu...');
    btn.prop('disabled', true);
    
    fetch(`${API_BASE_URL}/TicketComponent`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': token ? `Bearer ${token}` : ''
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        btn.html(originalText);
        btn.prop('disabled', false);
        
        if (data.success) {
            showAlert('Thêm phụ tùng thành công!', 'success');
            $('#addComponentModal').modal('hide');
            $('#componentForm')[0].reset();
            loadComponents();
            updateCostSummary(); // Update cost summary
        } else {
            showAlert('Lỗi: ' + (data.message || 'Không thể thêm phụ tùng'), 'danger');
        }
    })
    .catch(error => {
        btn.html(originalText);
        btn.prop('disabled', false);
        console.error('Error:', error);
        showAlert('Có lỗi xảy ra khi thêm phụ tùng', 'danger');
    });
}

function editComponent(componentId) {
    const token = localStorage.getItem('authToken');
    fetch(`${API_BASE_URL}/TicketComponent/${componentId}`, {
        headers: {
            'Authorization': token ? `Bearer ${token}` : ''
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const component = data.data;
            $('#editComponentId').val(component.id);
            $('#editComponentQuantity').val(component.quantity);
            $('#editComponentActualQuantity').val(component.actualQuantity || '');
            $('#editComponentUnitPrice').val(component.unitPrice || '');
            
            // Load components và set giá trị sau khi load xong
            loadComponentsForEdit().then(() => {
                $('#editComponentSelect').val(component.componentId);
            $('#editComponentModal').modal('show');
            });
        } else {
            showAlert('Lỗi tải thông tin phụ tùng: ' + data.message, 'danger');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showAlert('Có lỗi xảy ra khi tải thông tin phụ tùng', 'danger');
    });
}

function updateComponent() {
    const id = $('#editComponentId').val();
    const componentId = $('#editComponentSelect').val();
    const quantity = parseInt($('#editComponentQuantity').val());
    const actualQuantityInput = $('#editComponentActualQuantity').val();
    const actualQuantity = actualQuantityInput && actualQuantityInput !== '' ? parseFloat(actualQuantityInput) : null;
    const unitPrice = parseFloat($('#editComponentUnitPrice').val()) || null;
    
    if (!id || !componentId || !quantity || quantity <= 0) {
        showAlert('Vui lòng điền đầy đủ thông tin bắt buộc', 'warning');
        return;
    }
    
    if (actualQuantity !== null && actualQuantity < 0) {
        showAlert('Số lượng thực tế phải lớn hơn hoặc bằng 0', 'warning');
        return;
    }
    
    if (actualQuantity !== null && actualQuantity > quantity) {
        showAlert('Số lượng thực tế không thể lớn hơn số lượng ban đầu', 'warning');
        return;
    }
    
    const formData = {
        maintenanceTicketId: maintenanceTicketId,
        componentId: parseInt(componentId),
        quantity: quantity,
        actualQuantity: actualQuantity, // Gửi cả null nếu để trống
        unitPrice: unitPrice
    };
    
    const token = localStorage.getItem('authToken');
    const btn = $('#updateComponentBtn');
    const originalText = btn.html();
    btn.html('<i class="fas fa-spinner fa-spin me-1"></i>Đang cập nhật...');
    btn.prop('disabled', true);
    
    fetch(`${API_BASE_URL}/TicketComponent/${id}`, {
        method: 'PUT',
        headers: {
            'Content-Type': 'application/json',
            'Authorization': token ? `Bearer ${token}` : ''
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        btn.html(originalText);
        btn.prop('disabled', false);
        
        if (data.success) {
            showAlert('Cập nhật phụ tùng thành công!', 'success');
            $('#editComponentModal').modal('hide');
            loadComponents();
            updateCostSummary(); // Update cost summary
        } else {
            showAlert('Lỗi: ' + (data.message || 'Không thể cập nhật phụ tùng'), 'danger');
        }
    })
    .catch(error => {
        btn.html(originalText);
        btn.prop('disabled', false);
        console.error('Error:', error);
        showAlert('Có lỗi xảy ra khi cập nhật phụ tùng', 'danger');
    });
}

function deleteComponent(componentId) {
    showConfirmModal(
        '<p>Bạn có chắc chắn muốn xóa phụ tùng này khỏi phiếu bảo dưỡng?</p>',
        function() {
            const token = localStorage.getItem('authToken');
            fetch(`${API_BASE_URL}/TicketComponent/${componentId}`, {
                method: 'DELETE',
                headers: {
                    'Authorization': token ? `Bearer ${token}` : ''
                }
            })
            .then(async response => {
                const data = await response.json();
                if (!response.ok) {
                    throw new Error(data.message || 'Không thể xóa phụ tùng');
                }
                return data;
            })
            .then(data => {
                if (data.success) {
                    showAlert('Xóa phụ tùng thành công!', 'success');
                    loadComponents();
                    updateCostSummary(); // Update cost summary
                } else {
                    showAlert('Lỗi: ' + (data.message || 'Không thể xóa phụ tùng'), 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Lỗi: ' + (error.message || 'Không thể xóa phụ tùng từ gói dịch vụ'), 'danger');
            });
        }
    );
}

function loadComponentsForAdd() {
    const token = localStorage.getItem('authToken');
    const branchId = maintenanceTicketData?.branchId;
    if (!branchId) {
        showAlert('Không tìm thấy thông tin chi nhánh', 'warning');
        return;
    }
    
    // ✅ Sửa: Thêm pageSize lớn để lấy tất cả components
    fetch(`${API_BASE_URL}/Component?branchId=${branchId}&statusCode=ACTIVE&page=1&pageSize=1000`, {
        headers: {
            'Authorization': token ? `Bearer ${token}` : ''
        }
    })
    .then(response => response.json())
    .then(result => {
        // ✅ Sửa: Xử lý đúng format response {success: true, data: [...]}
        const components = (result.success && result.data && Array.isArray(result.data)) ? result.data : [];
        const select = $('#componentSelect');
        select.empty();
        select.append('<option value="">-- Chọn phụ tùng --</option>');
        if (components.length > 0) {
            components.forEach(comp => {
                select.append(`<option value="${comp.id}" data-price="${comp.unitPrice || 0}">${comp.name} - ${formatCurrency(comp.unitPrice || 0)}</option>`);
            });
        } else {
            select.append('<option value="" disabled>Không có phụ tùng nào</option>');
        }
    })
    .catch(error => {
        console.error('Error loading components:', error);
        showAlert('Lỗi tải danh sách phụ tùng', 'danger');
    });
}

function loadComponentsForEdit() {
    return new Promise((resolve, reject) => {
    const token = localStorage.getItem('authToken');
    const branchId = maintenanceTicketData?.branchId;
    if (!branchId) {
        showAlert('Không tìm thấy thông tin chi nhánh', 'warning');
            reject(new Error('Branch ID not found'));
        return;
    }
    
    // ✅ Sửa: Thêm pageSize lớn để lấy tất cả components
    fetch(`${API_BASE_URL}/Component?branchId=${branchId}&statusCode=ACTIVE&page=1&pageSize=1000`, {
        headers: {
            'Authorization': token ? `Bearer ${token}` : ''
        }
    })
    .then(response => response.json())
    .then(result => {
        // ✅ Sửa: Xử lý đúng format response {success: true, data: [...]}
        const components = (result.success && result.data && Array.isArray(result.data)) ? result.data : [];
        const select = $('#editComponentSelect');
        select.empty();
        select.append('<option value="">-- Chọn phụ tùng --</option>');
        if (components.length > 0) {
            components.forEach(comp => {
                select.append(`<option value="${comp.id}" data-price="${comp.unitPrice || 0}">${comp.name} - ${formatCurrency(comp.unitPrice || 0)}</option>`);
            });
        } else {
            select.append('<option value="" disabled>Không có phụ tùng nào</option>');
        }
            resolve();
    })
    .catch(error => {
        console.error('Error loading components:', error);
        showAlert('Lỗi tải danh sách phụ tùng', 'danger');
            reject(error);
        });
    });
}

function updateCostSummary() {
    const token = localStorage.getItem('authToken');
    
    // Load component total and labor cost total
    Promise.all([
        fetch(`${API_BASE_URL}/TicketComponent/by-maintenance-ticket/${maintenanceTicketId}/total-cost`, {
            headers: {
                'Authorization': token ? `Bearer ${token}` : ''
            }
        }).then(r => r.json()),
        fetch(`${API_BASE_URL}/ServiceTask/by-ticket/${maintenanceTicketId}`, {
            headers: {
                'Authorization': token ? `Bearer ${token}` : ''
            }
        }).then(r => r.json())
    ])
    .then(([componentData, taskData]) => {
        const componentTotal = componentData.success ? (componentData.data?.totalCost || 0) : 0;
        const laborCostTotal = taskData.success ? (taskData.data || []).reduce((sum, task) => sum + (task.laborCost || 0), 0) : 0;
        
        // Use existing maintenanceTicketData or calculate from totals
        const estimatedCost = maintenanceTicketData?.totalEstimatedCost || (componentTotal + laborCostTotal);
        const dataToDisplay = maintenanceTicketData || { totalEstimatedCost: estimatedCost };
        
        displayCostSummary(dataToDisplay, componentTotal, laborCostTotal);
    })
    .catch(error => {
        console.error('Error loading cost summary:', error);
        // Fallback: try to display with current data
        if (maintenanceTicketData) {
            displayCostSummary(maintenanceTicketData, 0, 0);
        }
    });
}

function formatCurrency(amount) {
    return new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(amount);
}

let allServicePackages = [];

function loadServicePackages() {
    const token = localStorage.getItem('authToken');
    const branchId = maintenanceTicketData?.branchId;
    if (!branchId) {
        showAlert('Không tìm thấy thông tin chi nhánh', 'warning');
        return;
    }
    
    // ✅ Sửa: Thêm pageSize lớn để lấy tất cả service packages
    fetch(`${API_BASE_URL}/ServicePackage?branchId=${branchId}&statusCode=ACTIVE&page=1&pageSize=1000`, {
        headers: {
            'Authorization': token ? `Bearer ${token}` : ''
        }
    })
    .then(response => response.json())
    .then(result => {
        // ✅ Sửa: Xử lý đúng format response {success: true, data: [...]}
        allServicePackages = (result.success && result.data && Array.isArray(result.data)) ? result.data : [];
        displayServicePackages(allServicePackages);
    })
    .catch(error => {
        console.error('Error loading service packages:', error);
        $('#servicePackageTableBody').html('<tr><td colspan="6" class="text-center text-danger">Lỗi tải danh sách gói dịch vụ</td></tr>');
        showAlert('Lỗi tải danh sách gói dịch vụ', 'danger');
    });
}

function displayServicePackages(packages) {
    const tbody = $('#servicePackageTableBody');
    
    if (!packages || packages.length === 0) {
        tbody.html('<tr><td colspan="6" class="text-center text-dark">Không có gói dịch vụ nào</td></tr>');
        return;
    }
    
    tbody.empty();
    packages.forEach(pkg => {
        const componentCount = pkg.components && Array.isArray(pkg.components) ? pkg.components.length : 0;
        const price = pkg.price ? formatCurrency(pkg.price) : 'Chưa có giá';
        
        // Store package data in a way that can be retrieved
        const row = $(`
            <tr>
                <td>
                    <input type="radio" name="servicePackageSelect" class="service-package-radio" 
                           value="${pkg.id}">
                </td>
                <td><strong>${escapeHtml(pkg.code || '-')}</strong></td>
                <td>${escapeHtml(pkg.name || '-')}</td>
                <td>${price}</td>
                <td>${componentCount} phụ tùng</td>
                <td><small class="text-dark">${escapeHtml((pkg.description || '-').substring(0, 50))}${pkg.description && pkg.description.length > 50 ? '...' : ''}</small></td>
            </tr>
        `);
        
        // Store full package data in a data attribute
        row.data('package-data', pkg);
        tbody.append(row);
    });
}

function filterServicePackages(searchTerm) {
    if (!searchTerm) {
        displayServicePackages(allServicePackages);
        return;
    }
    
    const filtered = allServicePackages.filter(pkg => {
        const name = (pkg.name || '').toLowerCase();
        const code = (pkg.code || '').toLowerCase();
        const description = (pkg.description || '').toLowerCase();
        return name.includes(searchTerm) || code.includes(searchTerm) || description.includes(searchTerm);
    });
    
    displayServicePackages(filtered);
}

function displaySelectedServicePackage(packageData) {
    const infoDiv = $('#selectedServicePackageInfo');
    const detailsDiv = $('#selectedServicePackageDetails');
    
    const componentList = packageData.components && Array.isArray(packageData.components) 
        ? packageData.components.map(c => `- ${c.name} (${formatCurrency(c.unitPrice || 0)})`).join('<br>')
        : '<p class="text-dark mb-0">Không có phụ tùng</p>';
    
    // Calculate component total
    const componentTotal = packageData.components && Array.isArray(packageData.components)
        ? packageData.components.reduce((sum, c) => sum + (c.unitPrice || 0), 0)
        : 0;
    
    // ❌ ĐÃ LOẠI BỎ: Hiển thị ServiceCategories
    // Lý do: ServiceCategory chỉ dùng cho ScheduleService (đặt lịch), không phải để tạo công việc thực tế
    // ServicePackage chỉ chứa Components (phụ tùng)
    // ServiceTasks nên được tạo thủ công bởi người dùng
    
    detailsDiv.html(`
        <p><strong>Tên gói:</strong> ${escapeHtml(packageData.name || '-')}</p>
        <p><strong>Mã gói:</strong> ${escapeHtml(packageData.code || '-')}</p>
        <p><strong>Giá:</strong> ${formatCurrency(packageData.price || 0)}</p>
        <p><strong>Mô tả:</strong> ${escapeHtml(packageData.description || '-')}</p>
        <hr>
        <p><strong>Danh sách phụ tùng (${packageData.components?.length || 0}):</strong></p>
        <div class="ms-3 mb-2">${componentList}</div>
        <p class="mb-1"><strong>Tổng phụ tùng:</strong> ${formatCurrency(componentTotal)}</p>
        <div class="alert alert-info mt-2 mb-0">
            <i class="fas fa-info-circle me-2"></i>
            <small>Các phụ tùng trong gói sẽ được thêm vào phiếu bảo dưỡng. Phụ tùng đã tồn tại sẽ được bỏ qua.</small>
        </div>
        <div class="alert alert-warning mt-2 mb-0">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <small><strong>Lưu ý:</strong> Công việc (ServiceTasks) cần được tạo thủ công bằng nút "Thêm công việc". Gói dịch vụ chỉ tự động thêm phụ tùng.</small>
        </div>
    `);
    
    infoDiv.show();
}

function applyServicePackage(servicePackageId) {
    const token = localStorage.getItem('authToken');
    const btn = $('#confirmApplyServicePackageBtn');
    const originalText = btn.html();
    btn.html('<i class="fas fa-spinner fa-spin me-1"></i>Đang áp dụng...');
    btn.prop('disabled', true);
    
    fetch(`${API_BASE_URL}/MaintenanceTicket/${maintenanceTicketId}/apply-service-package/${servicePackageId}`, {
        method: 'PUT',
        headers: {
            'Authorization': token ? `Bearer ${token}` : '',
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        btn.html(originalText);
        btn.prop('disabled', false);
        
        if (data.success) {
            showAlert('Áp dụng gói dịch vụ thành công!', 'success');
            $('#applyServicePackageModal').modal('hide');
            selectedServicePackageId = null;
            $('#confirmApplyServicePackageBtn').prop('disabled', true);
            $('#selectedServicePackageInfo').hide();
            $('.service-package-radio').prop('checked', false);
            
            // Reload components, service tasks and cost summary
            loadComponents();
            loadServiceTasks();
            loadMaintenanceTicketDetails();
            updateCostSummary(); // Update cost summary
        } else {
            showAlert('Lỗi: ' + (data.message || 'Không thể áp dụng gói dịch vụ'), 'danger');
        }
    })
    .catch(error => {
        btn.html(originalText);
        btn.prop('disabled', false);
        console.error('Error:', error);
        showAlert('Có lỗi xảy ra khi áp dụng gói dịch vụ: ' + error.message, 'danger');
    });
}

function showAlert(message, type) {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show position-fixed" 
             style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    $('body').append(alertHtml);
    
    setTimeout(() => {
        $('.alert').alert('close');
    }, 3000);
}

// Mở modal lịch sử hoạt động chi tiết
function openActivityHistoryModal() {
    const modalHtml = `
    <div class="modal fade" id="activityHistoryModal" tabindex="-1">
      <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">
              <i class="fas fa-history me-2"></i>
              Lịch sử hoạt động chi tiết
            </h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div id="activityHistoryContent">
              <div class="text-center py-5">
                <div class="spinner-border text-primary" role="status">
                  <span class="visually-hidden">Đang tải...</span>
                </div>
                <p class="mt-3 text-dark">Đang tải lịch sử hoạt động...</p>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
              <i class="fas fa-times me-1"></i>Đóng
            </button>
          </div>
        </div>
      </div>
    </div>`;

    // Xóa modal cũ nếu có
    $('#activityHistoryModal').remove();
    
    $('body').append(modalHtml);
    const modal = new bootstrap.Modal(document.getElementById('activityHistoryModal'));
    modal.show();
    
    // Load history logs
    loadActivityHistory();
}

// Load lịch sử hoạt động từ API
function loadActivityHistory() {
    const token = localStorage.getItem('authToken');
    const content = $('#activityHistoryContent');
    
    fetch(`${API_BASE_URL}/MaintenanceTicket/${maintenanceTicketId}/history`, {
        headers: {
            'Authorization': `Bearer ${token}`,
            'Content-Type': 'application/json'
        }
    })
    .then(response => {
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        return response.json();
    })
    .then(data => {
        if (data.success && data.data) {
            displayActivityHistory(data.data);
        } else {
            content.html(`
                <div class="text-center py-5">
                    <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                    <p class="text-dark">Không có dữ liệu lịch sử hoạt động</p>
                </div>
            `);
        }
    })
    .catch(error => {
        console.error('Error loading activity history:', error);
        content.html(`
            <div class="text-center py-5">
                <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                <p class="text-danger">Lỗi tải lịch sử hoạt động: ${error.message}</p>
                <button class="btn btn-primary mt-3" onclick="loadActivityHistory()">
                    <i class="fas fa-redo me-1"></i>Thử lại
                </button>
            </div>
        `);
    });
}

// Hiển thị lịch sử hoạt động
function displayActivityHistory(historyLogs) {
    const content = $('#activityHistoryContent');
    
    if (!historyLogs || historyLogs.length === 0) {
        content.html(`
            <div class="text-center py-5">
                <i class="fas fa-history fa-3x text-dark mb-3"></i>
                <p class="text-dark">Chưa có hoạt động nào</p>
            </div>
        `);
        return;
    }
    
    // Sắp xếp theo thời gian (mới nhất trước)
    const sortedLogs = [...historyLogs].sort((a, b) => {
        const dateA = a.createdAt ? new Date(a.createdAt) : new Date(0);
        const dateB = b.createdAt ? new Date(b.createdAt) : new Date(0);
        return dateB - dateA;
    });
    
    let html = '<div class="timeline-vertical">';
    
    sortedLogs.forEach((log, index) => {
        const isLast = index === sortedLogs.length - 1;
        const actionInfo = getActionInfo(log.action);
        const userName = log.userName || 'Hệ thống';
        // Chuyển đổi từ UTC sang giờ Việt Nam (UTC+7)
        const dateStr = formatVietnamDateTime(log.createdAt);
        
        html += `
            <div class="timeline-item ${!isLast ? 'mb-4' : ''}">
                <div class="d-flex">
                    <div class="flex-shrink-0">
                        <div class="timeline-icon bg-${actionInfo.color} text-white rounded-circle d-flex align-items-center justify-content-center" 
                             style="width: 48px; height: 48px;">
                            <i class="${actionInfo.icon}"></i>
                        </div>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <div class="card border-0 shadow-sm">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="mb-0 fw-bold">${actionInfo.title}</h6>
                                    <small class="text-dark">${dateStr}</small>
                                </div>
                                <div class="mb-2">
                                    <span class="badge bg-light text-dark">
                                        <i class="fas fa-user me-1"></i>
                                        ${escapeHtml(userName)}
                                    </span>
                                </div>
                                ${log.newData ? `
                                    <div class="mt-2">
                                        <small class="text-dark d-block mb-1">Chi tiết:</small>
                                        <div class="bg-light p-2 rounded">
                                            <pre class="mb-0" style="white-space: pre-wrap; font-size: 0.85rem;">${escapeHtml(log.newData)}</pre>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
                ${!isLast ? '<div class="timeline-line ms-5" style="width: 2px; height: 20px; background: #dee2e6; margin-left: 24px;"></div>' : ''}
            </div>
        `;
    });
    
    html += '</div>';
    content.html(html);
}

// Lấy thông tin icon và màu sắc dựa trên action
function getActionInfo(action) {
    if (!action) {
        return { title: 'Hoạt động', icon: 'fas fa-circle', color: 'secondary' };
    }
    
    const actionLower = action.toLowerCase();
    
    if (actionLower.includes('tạo') || actionLower.includes('create')) {
        return { title: 'Tạo phiếu bảo dưỡng', icon: 'fas fa-plus-circle', color: 'primary' };
    }
    if (actionLower.includes('gán') || actionLower.includes('assign') || actionLower.includes('technician')) {
        return { title: 'Gán kỹ thuật viên', icon: 'fas fa-user-plus', color: 'info' };
    }
    if (actionLower.includes('xóa') || actionLower.includes('remove') || actionLower.includes('delete')) {
        if (actionLower.includes('technician')) {
            return { title: 'Xóa kỹ thuật viên', icon: 'fas fa-user-minus', color: 'warning' };
        }
        return { title: 'Xóa', icon: 'fas fa-trash', color: 'danger' };
    }
    if (actionLower.includes('thêm') || actionLower.includes('add') || actionLower.includes('component')) {
        return { title: 'Thêm phụ tùng', icon: 'fas fa-plus', color: 'success' };
    }
    if (actionLower.includes('sửa') || actionLower.includes('update') || actionLower.includes('edit')) {
        return { title: 'Cập nhật', icon: 'fas fa-edit', color: 'warning' };
    }
    if (actionLower.includes('bắt đầu') || actionLower.includes('start')) {
        return { title: 'Bắt đầu bảo dưỡng', icon: 'fas fa-play', color: 'warning' };
    }
    if (actionLower.includes('hoàn thành') || actionLower.includes('complete') || actionLower.includes('finish')) {
        return { title: 'Hoàn thành bảo dưỡng', icon: 'fas fa-check-circle', color: 'success' };
    }
    if (actionLower.includes('hủy') || actionLower.includes('cancel')) {
        return { title: 'Hủy phiếu bảo dưỡng', icon: 'fas fa-times-circle', color: 'danger' };
    }
    if (actionLower.includes('công việc') || actionLower.includes('task') || actionLower.includes('service')) {
        if (actionLower.includes('thêm') || actionLower.includes('add') || actionLower.includes('add_service_task')) {
            return { title: 'Thêm công việc', icon: 'fas fa-tasks', color: 'info' };
        }
        if (actionLower.includes('bắt đầu') || actionLower.includes('start') || actionLower.includes('start_service_task')) {
            return { title: 'Bắt đầu công việc', icon: 'fas fa-play-circle', color: 'warning' };
        }
        if (actionLower.includes('hoàn thành') || actionLower.includes('complete') || actionLower.includes('complete_service_task')) {
            return { title: 'Hoàn thành công việc', icon: 'fas fa-check-circle', color: 'success' };
        }
        return { title: 'Cập nhật công việc', icon: 'fas fa-tasks', color: 'warning' };
    }
    if (actionLower.includes('phụ tùng') || actionLower.includes('component') || actionLower.includes('add_component')) {
        return { title: 'Thêm phụ tùng', icon: 'fas fa-cog', color: 'success' };
    }
    
    return { title: action, icon: 'fas fa-circle', color: 'secondary' };
}
</script>
