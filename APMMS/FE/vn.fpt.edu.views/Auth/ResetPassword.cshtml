@{
    ViewData["Title"] = "Đặt lại mật khẩu";
    var token = Context.Request.Query["token"].ToString();
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6 col-lg-5">
            <div class="card shadow-lg border-0">
                <div class="card-body p-5">
                    <div class="text-center mb-4">
                        <div class="logo-container mb-3">
                            <div class="logo-icon mx-auto">
                                <i class="fas fa-lock"></i>
                            </div>
                        </div>
                        <h2 class="fw-bold text-primary">Đặt lại mật khẩu</h2>
                        <p class="text-muted">Nhập mật khẩu mới cho tài khoản của bạn</p>
                    </div>

                    @if (string.IsNullOrEmpty(token))
                    {
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            Token không hợp lệ hoặc đã hết hạn. Vui lòng yêu cầu đặt lại mật khẩu mới.
                        </div>
                        <div class="text-center mt-3">
                            <a href="/Auth/ForgotPassword" class="btn btn-primary">
                                <i class="fas fa-redo me-2"></i>Yêu cầu đặt lại mật khẩu
                            </a>
                        </div>
                    }
                    else
                    {
                        <form id="resetPasswordForm">
                            <input type="hidden" id="token" value="@token">
                            
                            <div class="mb-3">
                                <label for="newPassword" class="form-label">
                                    <i class="fas fa-lock me-2"></i>Mật khẩu mới
                                </label>
                                <input type="password" class="form-control" id="newPassword" name="newPassword" 
                                       placeholder="Nhập mật khẩu mới (tối thiểu 9 ký tự, gồm chữ hoa và số)" required minlength="9">
                                <div class="form-text">Mật khẩu phải có ít nhất 9 ký tự, gồm chữ hoa và chữ số</div>
                                <div class="invalid-feedback"></div>
                            </div>

                            <div class="mb-3">
                                <label for="confirmPassword" class="form-label">
                                    <i class="fas fa-lock me-2"></i>Xác nhận mật khẩu
                                </label>
                                <input type="password" class="form-control" id="confirmPassword" name="confirmPassword" 
                                       placeholder="Nhập lại mật khẩu mới" required>
                                <div class="invalid-feedback"></div>
                            </div>

                            <button type="submit" class="btn btn-primary w-100 mb-3" id="submitBtn">
                                <i class="fas fa-check me-2"></i>Đặt lại mật khẩu
                            </button>

                            <div class="text-center">
                                <a href="/" class="text-decoration-none">
                                    <i class="fas fa-arrow-left me-2"></i>Quay lại trang chủ
                                </a>
                            </div>
                        </form>

                        <div id="successMessage" class="alert alert-success d-none mt-3">
                            <i class="fas fa-check-circle me-2"></i>
                            <span id="successText"></span>
                            <div class="mt-2">
                                <a href="/" class="btn btn-sm btn-success">
                                    <i class="fas fa-sign-in-alt me-2"></i>Đăng nhập ngay
                                </a>
                            </div>
                        </div>

                        <div id="errorMessage" class="alert alert-danger d-none mt-3">
                            <i class="fas fa-exclamation-circle me-2"></i>
                            <span id="errorText"></span>
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const API_BASE_URL = '@ViewBag.ApiBaseUrl' || 'https://localhost:7102/api';
        const PASSWORD_REGEX = /^(?=.*[A-Z])(?=.*\d).{9,}$/;

        $(document).ready(function() {
            $('#resetPasswordForm').on('submit', function(e) {
                e.preventDefault();
                
                const token = $('#token').val();
                const newPassword = $('#newPassword').val();
                const confirmPassword = $('#confirmPassword').val();
                
                // Validation
                if (!newPassword || newPassword.length < 9) {
                    showError('Mật khẩu phải có ít nhất 9 ký tự');
                    return;
                }

                if (!PASSWORD_REGEX.test(newPassword)) {
                    showError('Mật khẩu phải gồm chữ hoa và số');
                    return;
                }

                if (newPassword !== confirmPassword) {
                    showError('Mật khẩu xác nhận không khớp');
                    return;
                }

                const submitBtn = $('#submitBtn');
                const originalText = submitBtn.html();
                submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Đang xử lý...');

                // Hide previous messages
                $('#successMessage').addClass('d-none');
                $('#errorMessage').addClass('d-none');

                $.ajax({
                    url: `${API_BASE_URL}/Auth/reset-password`,
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ 
                        token: token,
                        newPassword: newPassword,
                        confirmPassword: confirmPassword
                    }),
                    success: function(response) {
                        if (response.success) {
                            showSuccess(response.message || 'Đặt lại mật khẩu thành công. Bạn có thể đăng nhập với mật khẩu mới.');
                            $('#resetPasswordForm')[0].reset();
                        } else {
                            showError(response.message || 'Có lỗi xảy ra. Vui lòng thử lại.');
                        }
                    },
                    error: function(xhr) {
                        const errorMsg = xhr.responseJSON?.message || 'Token không hợp lệ hoặc đã hết hạn. Vui lòng yêu cầu đặt lại mật khẩu mới.';
                        showError(errorMsg);
                    },
                    complete: function() {
                        submitBtn.prop('disabled', false).html(originalText);
                    }
                });
            });
        });

        function showSuccess(message) {
            $('#successText').text(message);
            $('#successMessage').removeClass('d-none');
            $('#errorMessage').addClass('d-none');
            $('#resetPasswordForm').hide();
        }

        function showError(message) {
            $('#errorText').text(message);
            $('#errorMessage').removeClass('d-none');
            $('#successMessage').addClass('d-none');
        }
    </script>
}

