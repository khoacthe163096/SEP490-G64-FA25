@{
    ViewData["Title"] = "Quên mật khẩu";
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-6 col-lg-5">
            <div class="card shadow-lg border-0">
                <div class="card-body p-5">
                    <div class="text-center mb-4">
                        <div class="logo-container mb-3">
                            <div class="logo-icon mx-auto">
                                <i class="fas fa-car"></i>
                            </div>
                        </div>
                        <h2 class="fw-bold text-primary">Quên mật khẩu?</h2>
                        <p class="text-muted">Nhập email hoặc tên đăng nhập của bạn để nhận link đặt lại mật khẩu</p>
                    </div>

                    <form id="forgotPasswordForm">
                        <div class="mb-3">
                            <label for="emailOrUsername" class="form-label">
                                <i class="fas fa-envelope me-2"></i>Email hoặc Tên đăng nhập
                            </label>
                            <input type="text" class="form-control" id="emailOrUsername" name="emailOrUsername" 
                                   placeholder="Nhập email hoặc tên đăng nhập" required autofocus>
                            <div class="invalid-feedback"></div>
                        </div>

                        <button type="submit" class="btn btn-primary w-100 mb-3" id="submitBtn">
                            <i class="fas fa-paper-plane me-2"></i>Gửi yêu cầu
                        </button>

                        <div class="text-center">
                            <a href="/" class="text-decoration-none">
                                <i class="fas fa-arrow-left me-2"></i>Quay lại trang chủ
                            </a>
                        </div>
                    </form>

                    <div id="successMessage" class="alert alert-success d-none mt-3">
                        <i class="fas fa-check-circle me-2"></i>
                        <span id="successText"></span>
                    </div>

                    <div id="errorMessage" class="alert alert-danger d-none mt-3">
                        <i class="fas fa-exclamation-circle me-2"></i>
                        <span id="errorText"></span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const API_BASE_URL = '@ViewBag.ApiBaseUrl' || 'https://localhost:7173/api';

        $(document).ready(function() {
            $('#forgotPasswordForm').on('submit', function(e) {
                e.preventDefault();
                
                const emailOrUsername = $('#emailOrUsername').val().trim();
                
                if (!emailOrUsername) {
                    showError('Vui lòng nhập email hoặc tên đăng nhập');
                    return;
                }

                const submitBtn = $('#submitBtn');
                const originalText = submitBtn.html();
                submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-2"></i>Đang xử lý...');

                // Hide previous messages
                $('#successMessage').addClass('d-none');
                $('#errorMessage').addClass('d-none');

                $.ajax({
                    url: `${API_BASE_URL}/Auth/forgot-password`,
                    type: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ emailOrUsername: emailOrUsername }),
                    success: function(response) {
                        if (response.success) {
                            showSuccess(response.message || 'Email hướng dẫn đặt lại mật khẩu đã được gửi. Vui lòng kiểm tra hộp thư của bạn.');
                            $('#forgotPasswordForm')[0].reset();
                        } else {
                            showError(response.message || 'Có lỗi xảy ra. Vui lòng thử lại.');
                        }
                    },
                    error: function(xhr) {
                        const errorMsg = xhr.responseJSON?.message || 'Không thể kết nối đến server. Vui lòng thử lại sau.';
                        showError(errorMsg);
                    },
                    complete: function() {
                        submitBtn.prop('disabled', false).html(originalText);
                    }
                });
            });
        });

        function showSuccess(message) {
            $('#successText').text(message);
            $('#successMessage').removeClass('d-none');
            $('#errorMessage').addClass('d-none');
        }

        function showError(message) {
            $('#errorText').text(message);
            $('#errorMessage').removeClass('d-none');
            $('#successMessage').addClass('d-none');
        }
    </script>
}

