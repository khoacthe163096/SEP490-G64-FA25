@model FE.vn.fpt.edu.viewmodels.TypeComponentIndexViewModel
@{
    ViewData["Title"] = "Danh sách loại linh kiện";
    Layout = "~/vn.fpt.edu.views/Shared/_DashboardLayout.cshtml";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Danh sách loại linh kiện</h4>
                    <a href="@Url.Action("Create", "TypeComponent")" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Thêm loại mới
                    </a>
                </div>

                <div class="card-body">
                    <!-- Search and Filter -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="searchInput" placeholder="Tìm kiếm loại linh kiện..." value="@Model.Search">
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="statusFilter">
                                <option value="">Tất cả trạng thái</option>
                                <option value="ACTIVE" selected="@(Model.StatusCode == "ACTIVE")">Hoạt động</option>
                                <option value="INACTIVE" selected="@(Model.StatusCode == "INACTIVE")">Không hoạt động</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-outline-secondary" id="filterBtn">
                                <i class="fas fa-filter"></i> Lọc
                            </button>
                        </div>
                    </div>

                    <!-- Table -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover align-middle">
                            <thead class="table-dark">
                                <tr>
                                    <th><input type="checkbox" id="selectAll"></th>
                                    <th>Mã loại</th>
                                    <th>Tên loại</th>
                                    <th>Mô tả</th>
                                    <th>Chi nhánh</th>
                                    <th>Trạng thái</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody id="typeComponentsTable">
                                @if (Model.Items.Any())
                                {
                                    foreach (var item in Model.Items)
                                    {
                                        var statusClass = item.StatusCode == "ACTIVE" ? "bg-success" : "bg-secondary";
                                        var statusText = item.StatusCode == "ACTIVE" ? "Hoạt động" : "Không hoạt động";
                                        <tr data-id="@item.Id">
                                            <td><input type="checkbox" /></td>
                                            <td>@item.Id</td>
                                            <td>@item.Name</td>
                                            <td>@item.Description</td>
                                            <td>@item.BranchId</td>
                                            <td><span class="badge @statusClass">@statusText</span></td>
                                            <td>
                                                <a href="@Url.Action("Details", "TypeComponent", new { id = item.Id })" class="btn btn-sm btn-outline-info">
                                                    <i class="fas fa-eye"></i>
                                                </a>
                                                <a href="@Url.Action("Edit", "TypeComponent", new { id = item.Id })" class="btn btn-sm btn-outline-primary">
                                                    <i class="fas fa-edit"></i>
                                                </a>
                                                <button class="btn btn-sm btn-outline-warning toggle-status" data-id="@item.Id" data-status="@item.StatusCode">
                                                    <i class="fas fa-toggle-on"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger" onclick="deleteTypeComponent(@item.Id)">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </td>
                                        </tr>
                                    }
                                }
                                else
                                {
                                    <tr><td colspan="7" class="text-center text-muted">Không có dữ liệu</td></tr>
                                }
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination placeholder -->
                    <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-center">
                            <li class="page-item disabled">
                                <a class="page-link" href="#" tabindex="-1">Trước</a>
                            </li>
                            <li class="page-item active"><a class="page-link" href="#">1</a></li>
                            <li class="page-item"><a class="page-link" href="#">2</a></li>
                            <li class="page-item"><a class="page-link" href="#">3</a></li>
                            <li class="page-item"><a class="page-link" href="#">Sau</a></li>
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Filter + Search
        $('#filterBtn').click(function () {
            const search = $('#searchInput').val();
            const status = $('#statusFilter').val();
            const query = [];
            if (search) query.push('search=' + encodeURIComponent(search));
            if (status) query.push('statusCode=' + encodeURIComponent(status));
            const url = '@Url.Action("Index", "TypeComponent")' + (query.length ? '?' + query.join('&') : '');
            window.location.href = url;
        });

        // Toggle Status
        $('.toggle-status').click(function () {
            const id = $(this).data('id');
            const current = $(this).data('status');
            const next = current === 'ACTIVE' ? 'INACTIVE' : 'ACTIVE';
            if (!confirm(`Xác nhận chuyển sang trạng thái "${next}"?`)) return;

            $.post('@Url.Action("ToggleStatus", "TypeComponent")', { id: id, statusCode: next })
                .done(res => {
                    if (res.success) location.reload();
                    else alert('Không thể cập nhật trạng thái!');
                })
                .fail(() => alert('Lỗi khi gọi API!'));
        });

        // Delete action (need endpoint del if BE sup)
        function deleteTypeComponent(id) {
            if (!confirm('Bạn có chắc chắn muốn xóa loại linh kiện này?')) return;
            $.ajax({
                url: '@Url.Content("~/api/TypeComponent/")' + id,
                type: 'DELETE',
                success: function () {
                    location.reload();
                },
                error: function () {
                    alert('Không thể xóa loại linh kiện!');
                }
            });
        }
    </script>
}