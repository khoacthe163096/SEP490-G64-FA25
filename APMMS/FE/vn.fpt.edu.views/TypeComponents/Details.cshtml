@{
    ViewData["Title"] = "Chi tiết loại linh kiện";
    Layout = "~/vn.fpt.edu.views/Shared/_DashboardLayout.cshtml";
}

@inject IConfiguration Configuration
@{
    var apiBaseUrl = Configuration["ApiSettings:BaseUrl"] ?? "https://localhost:7173/api";
}

<div class="container-fluid">
    <!-- Breadcrumb -->
    <nav aria-label="breadcrumb" class="mb-3">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/TypeComponents">Danh sách các loại linh kiện</a></li>
            <li class="breadcrumb-item active" id="breadcrumbName" aria-current="page">-</li>
        </ol>
    </nav>

    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h2 class="mb-0 fw-bold" style="font-size: 1.75rem; color: #212529;">Thông tin chi tiết loại linh kiện</h2>
        </div>
    </div>

    <!-- Main Content -->
    <div class="row">
        <!-- Left Panel: Type Component Name -->
        <div class="col-lg-4 mb-4">
            <div class="card shadow-sm h-100 border-0">
                <div class="card-body d-flex align-items-center justify-content-center" style="min-height: 350px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
                    <h1 class="text-center fw-bold text-white" id="typeComponentNameLarge" style="font-size: 3rem; letter-spacing: 1px; text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">
                        <div class="spinner-border text-white" role="status">
                            <span class="visually-hidden">Đang tải...</span>
                        </div>
                    </h1>
                </div>
            </div>
        </div>
                    
        <!-- Right Panel: Tabs -->
        <div class="col-lg-8">
            <div class="card shadow-sm">
                <div class="card-body">
                    <!-- Tabs Navigation -->
                    <ul class="nav nav-tabs mb-4" id="typeComponentTabs" role="tablist" style="border-bottom: 2px solid #dee2e6;">
                        <li class="nav-item" role="presentation">
                            <button class="nav-link active fw-semibold" id="intro-tab" data-bs-toggle="tab" data-bs-target="#intro" type="button" role="tab" aria-controls="intro" aria-selected="true" style="font-size: 1rem; padding: 12px 20px;">
                                Giới thiệu
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link fw-semibold" id="components-tab" data-bs-toggle="tab" data-bs-target="#components" type="button" role="tab" aria-controls="components" aria-selected="false" style="font-size: 1rem; padding: 12px 20px;">
                                Danh sách các linh kiện
                            </button>
                        </li>
                        <li class="nav-item" role="presentation">
                            <button class="nav-link fw-semibold" id="settings-tab" data-bs-toggle="tab" data-bs-target="#settings" type="button" role="tab" aria-controls="settings" aria-selected="false" style="font-size: 1rem; padding: 12px 20px;">
                                Cài đặt
                            </button>
                        </li>
                    </ul>

                    <!-- Tabs Content -->
                    <div class="tab-content" id="typeComponentTabContent">
                        <!-- Tab: Giới thiệu -->
                        <div class="tab-pane fade show active" id="intro" role="tabpanel" aria-labelledby="intro-tab">
                            <div id="introLoading" class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Đang tải...</span>
                                </div>
                            </div>
                            <div id="introContent" style="display: none;">
                                <dl class="row mb-0" style="font-size: 1.05rem;">
                                    <dt class="col-sm-4 fw-bold text-muted mb-3" style="font-size: 1rem; color: #6c757d !important;">ID</dt>
                                    <dd class="col-sm-8 mb-3 fw-semibold" id="typeComponentId" style="font-size: 1.1rem; color: #212529;">-</dd>

                                    <dt class="col-sm-4 fw-bold text-muted mb-3" style="font-size: 1rem; color: #6c757d !important;">Tên loại</dt>
                                    <dd class="col-sm-8 mb-3 fw-semibold" id="typeComponentName" style="font-size: 1.1rem; color: #212529;">-</dd>

                                    <dt class="col-sm-4 fw-bold text-muted mb-3" style="font-size: 1rem; color: #6c757d !important;">Mô tả</dt>
                                    <dd class="col-sm-8 mb-3" id="typeComponentDescription" style="font-size: 1.05rem; color: #495057; line-height: 1.6;">-</dd>

                                    <dt class="col-sm-4 fw-bold text-muted mb-3" style="font-size: 1rem; color: #6c757d !important;">Chi nhánh</dt>
                                    <dd class="col-sm-8 mb-3 fw-semibold" id="typeComponentBranch" style="font-size: 1.1rem; color: #212529;">-</dd>

                                    <dt class="col-sm-4 fw-bold text-muted mb-3" style="font-size: 1rem; color: #6c757d !important;">Trạng thái</dt>
                                    <dd class="col-sm-8 mb-3" id="typeComponentStatus" style="font-size: 1.1rem;">-</dd>
                                </dl>
                            </div>
                        </div>

                        <!-- Tab: Danh sách các linh kiện -->
                        <div class="tab-pane fade" id="components" role="tabpanel" aria-labelledby="components-tab">
                            <div id="componentsLoading" class="text-center">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Đang tải...</span>
                                </div>
                            </div>
                            <div id="componentsContent" style="display: none;">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h5 class="mb-0 fw-bold" style="font-size: 1.2rem; color: #212529;">Danh sách linh kiện</h5>
                                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#createComponentModal">
                                        <i class="fas fa-plus me-2"></i>Thêm mới linh kiện
                                    </button>
                                </div>
                                <div class="table-responsive">
                                    <table class="table table-striped table-hover align-middle">
                                        <thead class="table-dark">
                                            <tr>
                                                <th style="font-size: 1rem; font-weight: 600; padding: 14px;">Mã</th>
                                                <th style="font-size: 1rem; font-weight: 600; padding: 14px;">Tên linh kiện</th>
                                                <th style="font-size: 1rem; font-weight: 600; padding: 14px;">Số lượng</th>
                                                <th style="font-size: 1rem; font-weight: 600; padding: 14px;">Giá</th>
                                                <th style="font-size: 1rem; font-weight: 600; padding: 14px;">Trạng thái</th>
                                                <th style="font-size: 1rem; font-weight: 600; padding: 14px;">Thao tác</th>
                                            </tr>
                                        </thead>
                                        <tbody id="componentsTableBody" style="font-size: 1rem;">
                                            <!-- Components will be loaded here -->
                                        </tbody>
                                    </table>
                                </div>
                                <div id="componentsEmpty" class="text-center text-muted py-5" style="display: none;">
                                    <p class="mb-0" style="font-size: 1.1rem;">Không có linh kiện nào trong loại này.</p>
                                </div>
                            </div>
                        </div>
                    
                        <!-- Tab: Cài đặt -->
                        <div class="tab-pane fade" id="settings" role="tabpanel" aria-labelledby="settings-tab">
                            <div class="mb-3">
                                <label class="form-label fw-bold mb-3" style="font-size: 1.1rem; color: #212529;">Thông tin</label>
                                <div>
                                    <a href="#" id="editButton" class="btn btn-primary btn-lg" style="font-size: 1rem; padding: 12px 24px;">
                                        <i class="fas fa-user-edit me-2"></i>Chỉnh sửa thông tin
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Error Message -->
    <div id="errorMessage" class="alert alert-danger mt-3" style="display: none;"></div>
</div>

<!-- Modal: Thêm mới linh kiện -->
<div class="modal fade" id="createComponentModal" tabindex="-1" aria-labelledby="createComponentModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title fw-bold" id="createComponentModalLabel">
                    <i class="fas fa-plus-circle me-2"></i>Thêm mới linh kiện
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="createComponentForm">
                <div class="modal-body">
                    <input type="hidden" id="createComponentTypeComponentId" name="typeComponentId">
                    <input type="hidden" id="createComponentBranchId" name="branchId">
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="createComponentName" class="form-label fw-semibold">Tên linh kiện <span class="text-danger">*</span></label>
                            <input type="text" class="form-control" id="createComponentName" name="name" required>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="createComponentCode" class="form-label fw-semibold">Mã linh kiện</label>
                            <input type="text" class="form-control" id="createComponentCode" name="code">
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <label for="createComponentPurchasePrice" class="form-label fw-semibold mb-0 me-3" style="min-width: 120px;">Giá nhập</label>
                                <input type="number" class="form-control" id="createComponentPurchasePrice" name="purchasePrice" step="0.01" min="0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <label for="createComponentUnitPrice" class="form-label fw-semibold mb-0 me-3" style="min-width: 120px;">Giá xuất <span class="text-danger">*</span></label>
                                <input type="number" class="form-control" id="createComponentUnitPrice" name="unitPrice" step="0.01" min="0" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <label for="createComponentQuantityStock" class="form-label fw-semibold mb-0 me-3" style="min-width: 120px;">Số lượng tồn kho</label>
                                <input type="number" class="form-control" id="createComponentQuantityStock" name="quantityStock" min="0" value="0">
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="d-flex align-items-center">
                                <label for="createComponentStatusCode" class="form-label fw-semibold mb-0 me-3" style="min-width: 120px;">Trạng thái</label>
                                <select class="form-select" id="createComponentStatusCode" name="statusCode">
                                    <option value="ACTIVE">Có sẵn</option>
                                    <option value="OUT_OF_STOCK">Hết hàng</option>
                                    <option value="DISCONTINUED">Ngừng sản xuất</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-3">
                        <div class="col-12">
                            <div class="d-flex align-items-center">
                                <label for="createComponentImageFile" class="form-label fw-semibold mb-0 me-3" style="min-width: 120px;">Hình ảnh</label>
                                <input type="file" class="form-control" id="createComponentImageFile" name="imageFile" accept="image/*">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row mb-3" id="imagePreviewRow" style="display: none;">
                        <div class="col-12">
                            <div class="d-flex align-items-center">
                                <label class="form-label fw-semibold mb-0 me-3" style="min-width: 120px;">Xem trước</label>
                                <div class="flex-grow-1">
                                    <img id="imagePreview" src="" alt="Preview" style="max-width: 200px; max-height: 200px; border: 1px solid #dee2e6; border-radius: 4px; padding: 5px;">
                                    <input type="hidden" id="createComponentImageUrl" name="imageUrl">
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>Hủy
                    </button>
                    <button type="submit" class="btn btn-primary" id="createComponentSubmitBtn">
                        <i class="fas fa-save me-1"></i>Lưu
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <style>
        /* Cải thiện tab navigation */
        .nav-tabs .nav-link {
            color: #6c757d;
            border: none;
            border-bottom: 3px solid transparent;
        }
        .nav-tabs .nav-link:hover {
            color: #495057;
            border-bottom-color: #dee2e6;
        }
        .nav-tabs .nav-link.active {
            color: #0d6efd;
            font-weight: 600;
            border-bottom-color: #0d6efd;
            background-color: transparent;
        }
        
        /* Cải thiện breadcrumb */
        .breadcrumb {
            font-size: 1rem;
        }
        .breadcrumb-item a {
            color: #0d6efd;
            text-decoration: none;
        }
        .breadcrumb-item.active {
            color: #6c757d;
            font-weight: 500;
        }
        
        /* Cải thiện table */
        .table tbody tr:hover {
            background-color: #f8f9fa;
        }
        
        /* Cải thiện card */
        .card {
            border: 1px solid #e9ecef;
        }
    </style>
    <script>
        const apiBaseUrl = '@apiBaseUrl';
        let currentTypeComponentId = null;
        let currentTypeComponentData = null;

        document.addEventListener('DOMContentLoaded', function() {
            currentTypeComponentId = getTypeComponentIdFromUrl();
            if (currentTypeComponentId) {
                loadTypeComponentDetails(currentTypeComponentId);
                
                // Load components when components tab is shown
                document.getElementById('components-tab').addEventListener('shown.bs.tab', function() {
                    if (currentTypeComponentId) {
                        loadComponents(currentTypeComponentId);
                    }
                });
                
                // Setup create component modal
                setupCreateComponentModal();
            } else {
                showError('Không tìm thấy ID loại linh kiện');
            }
        });

        function getTypeComponentIdFromUrl() {
            const path = window.location.pathname;
            const segments = path.split('/');
            return segments[segments.length - 1];
        }

        async function loadTypeComponentDetails(id) {
            try {
                const response = await fetch(`/TypeComponents/GetDetails/${id}`);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                const data = await response.json();
                    
                    if (data.success && data.data) {
                    currentTypeComponentData = data.data;
                        displayTypeComponentDetails(data.data);
                    } else {
                        showError('Lỗi khi tải thông tin: ' + (data.message || 'Không có dữ liệu'));
                    }
            } catch (error) {
                    console.error('Error:', error);
                    showError('Có lỗi xảy ra khi tải thông tin loại linh kiện: ' + error.message);
            }
        }

        function displayTypeComponentDetails(typeComponent) {
            // Update breadcrumb
            document.getElementById('breadcrumbName').textContent = typeComponent.name || '-';
            
            // Update left panel - large name
            const nameElement = document.getElementById('typeComponentNameLarge');
            nameElement.innerHTML = typeComponent.name || '-';
            
            // Update intro tab
            document.getElementById('typeComponentId').textContent = typeComponent.id || '-';
            document.getElementById('typeComponentName').textContent = typeComponent.name || '-';
            document.getElementById('typeComponentDescription').textContent = typeComponent.description || 'Không có mô tả';
            document.getElementById('typeComponentBranch').textContent = typeComponent.branchName || typeComponent.branchId || '-';
            
            const statusBadge = typeComponent.statusCode === 'ACTIVE' 
                ? '<span class="badge bg-success">Hoạt động</span>' 
                : '<span class="badge bg-secondary">Không hoạt động</span>';
            document.getElementById('typeComponentStatus').innerHTML = statusBadge;
            
            // Hide loading, show content
            document.getElementById('introLoading').style.display = 'none';
            document.getElementById('introContent').style.display = 'block';
            
            // Set edit button link
            if (typeComponent.id) {
                const editButton = document.getElementById('editButton');
                editButton.href = `/TypeComponents/Edit/${typeComponent.id}`;
            }
        }

        async function loadComponents(typeComponentId) {
            const loadingEl = document.getElementById('componentsLoading');
            const contentEl = document.getElementById('componentsContent');
            const emptyEl = document.getElementById('componentsEmpty');
            const tableBody = document.getElementById('componentsTableBody');
            
            loadingEl.style.display = 'block';
            contentEl.style.display = 'none';
            emptyEl.style.display = 'none';
            
            try {
                const token = localStorage.getItem('authToken');
                if (!token) {
                    throw new Error('No auth token found');
                }
                
                // Call BE API directly with typeComponentId
                const response = await fetch(`${apiBaseUrl}/Component?typeComponentId=${typeComponentId}&page=1&pageSize=1000`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                loadingEl.style.display = 'none';
                
                if (data.success && data.data && data.data.length > 0) {
                    renderComponentsTable(data.data);
                    contentEl.style.display = 'block';
                } else {
                    emptyEl.style.display = 'block';
                    contentEl.style.display = 'block';
                }
            } catch (error) {
                console.error('Error loading components:', error);
                loadingEl.style.display = 'none';
                tableBody.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Lỗi tải dữ liệu: ' + error.message + '</td></tr>';
                contentEl.style.display = 'block';
            }
        }

        function renderComponentsTable(components) {
            const tbody = document.getElementById('componentsTableBody');
            tbody.innerHTML = '';
            
            components.forEach(function(component) {
                let statusClass = 'bg-secondary';
                let statusText = 'Không xác định';
                if (component.statusCode === 'ACTIVE') {
                    statusClass = 'bg-success';
                    statusText = 'Có sẵn';
                } else if (component.statusCode === 'OUT_OF_STOCK') {
                    statusClass = 'bg-warning';
                    statusText = 'Hết hàng';
                } else if (component.statusCode === 'DISCONTINUED') {
                    statusClass = 'bg-danger';
                    statusText = 'Ngừng sản xuất';
                }
                
                const unitPrice = component.unitPrice 
                    ? new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(component.unitPrice) 
                    : 'N/A';
                
                const row = document.createElement('tr');
                row.style.fontSize = '1rem';
                row.innerHTML = `
                    <td style="padding: 14px; font-weight: 600; color: #212529;">${component.code || component.id || '-'}</td>
                    <td style="padding: 14px; color: #495057;">${component.name || '-'}</td>
                    <td style="padding: 14px; color: #212529; font-weight: 500;">${component.quantityStock || 0}</td>
                    <td style="padding: 14px; color: #28a745; font-weight: 600;">${unitPrice}</td>
                    <td style="padding: 14px;"><span class="badge ${statusClass}" style="font-size: 0.9rem; padding: 6px 12px;">${statusText}</span></td>
                    <td style="padding: 14px;">
                        <a href="/Components/Details/${component.id}" class="btn btn-sm btn-outline-info me-1" title="Xem chi tiết" style="font-size: 0.95rem; padding: 6px 12px;">
                            <i class="fas fa-eye"></i>
                        </a>
                        <a href="/Components/Edit/${component.id}" class="btn btn-sm btn-outline-primary" title="Chỉnh sửa" style="font-size: 0.95rem; padding: 6px 12px;">
                            <i class="fas fa-edit"></i>
                        </a>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function showError(message) {
            document.getElementById('errorMessage').textContent = message;
            document.getElementById('errorMessage').style.display = 'block';
        }

        function setupCreateComponentModal() {
            const modalElement = document.getElementById('createComponentModal');
            const form = document.getElementById('createComponentForm');
            
            // Khi modal sắp mở
            modalElement.addEventListener('show.bs.modal', function() {
                // Reset form
                form.reset();
                document.getElementById('createComponentTypeComponentId').value = currentTypeComponentId || '';
                document.getElementById('createComponentBranchId').value = '';
                document.getElementById('createComponentStatusCode').value = 'ACTIVE';
                document.getElementById('createComponentQuantityStock').value = '0';
                document.getElementById('createComponentImageUrl').value = '';
                document.getElementById('imagePreviewRow').style.display = 'none';
                document.getElementById('imagePreview').src = '';
                
                // Reset button
                const submitBtn = document.getElementById('createComponentSubmitBtn');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fas fa-save me-1"></i>Lưu';
            });
            
            // Handle image file change
            document.getElementById('createComponentImageFile').addEventListener('change', function(e) {
                const file = e.target.files[0];
                if (file) {
                    uploadImageToCloudinary(file);
                } else {
                    document.getElementById('imagePreviewRow').style.display = 'none';
                    document.getElementById('createComponentImageUrl').value = '';
                }
            });
            
            // Khi modal đã hiển thị hoàn toàn
            modalElement.addEventListener('shown.bs.modal', function() {
                // Load branchId sau khi modal đã hiển thị
                loadBranchIdForCreateComponent();
            });
            
            // Khi modal đã đóng
            modalElement.addEventListener('hidden.bs.modal', function() {
                cleanupModalBackdrop();
            });
            
            // Xử lý submit form
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                await submitCreateComponent();
            });
        }

        async function loadBranchIdForCreateComponent() {
            const token = localStorage.getItem('authToken');
            if (!token) {
                console.warn('No auth token found');
                return;
            }
            
            try {
                const response = await fetch(`${apiBaseUrl}/Employee/me`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                if (data.success && data.data) {
                    const employee = data.data;
                    if (employee.branchId) {
                        document.getElementById('createComponentBranchId').value = employee.branchId;
                        console.log('Loaded branchId for create component:', employee.branchId);
                    }
                } else {
                    console.warn('Employee/me API response not successful:', data);
                }
            } catch (error) {
                console.error('Error loading branchId from Employee/me:', error);
            }
        }

        async function submitCreateComponent() {
            const form = document.getElementById('createComponentForm');
            const submitBtn = document.getElementById('createComponentSubmitBtn');
            const originalText = submitBtn.innerHTML;
            
            // Validate
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            // Get branchId - nếu chưa có thì load lại
            let branchId = document.getElementById('createComponentBranchId').value;
            if (!branchId) {
                await loadBranchIdForCreateComponent();
                branchId = document.getElementById('createComponentBranchId').value;
            }
            
            if (!branchId) {
                alert('Không thể xác định chi nhánh. Vui lòng thử lại.');
                return;
            }
            
            // Disable button
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span>Đang lưu...';
            
            try {
                // Prepare payload
                const payload = {
                    name: document.getElementById('createComponentName').value.trim(),
                    code: document.getElementById('createComponentCode').value.trim() || null,
                    unitPrice: parseFloat(document.getElementById('createComponentUnitPrice').value) || 0,
                    purchasePrice: document.getElementById('createComponentPurchasePrice').value ? parseFloat(document.getElementById('createComponentPurchasePrice').value) : null,
                    quantityStock: parseInt(document.getElementById('createComponentQuantityStock').value) || 0,
                    statusCode: document.getElementById('createComponentStatusCode').value,
                    imageUrl: document.getElementById('createComponentImageUrl').value.trim() || null,
                    typeComponentId: parseInt(document.getElementById('createComponentTypeComponentId').value),
                    branchId: parseInt(branchId)
                };
                
                const token = localStorage.getItem('authToken');
                if (!token) {
                    throw new Error('No auth token found');
                }
                
                // Call BE API
                const response = await fetch(`${apiBaseUrl}/Component`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(payload)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Reset button state
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = originalText;
                    
                    // Close modal
                    const modalElement = document.getElementById('createComponentModal');
                    const modal = bootstrap.Modal.getInstance(modalElement);
                    if (modal) {
                        modal.hide();
                    }
                    
                    // Cleanup backdrop
                    setTimeout(() => {
                        cleanupModalBackdrop();
                    }, 100);
                    
                    // Show success message
                    alert('Tạo linh kiện thành công!');
                    
                    // Reload components list
                    if (currentTypeComponentId) {
                        loadComponents(currentTypeComponentId);
                    }
                } else {
                    throw new Error(data.message || 'Không thể tạo linh kiện');
                }
            } catch (error) {
                console.error('Error creating component:', error);
                alert('Lỗi: ' + error.message);
                
                // Reset button
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        }

        async function uploadImageToCloudinary(file) {
            const token = localStorage.getItem('authToken');
            if (!token) {
                alert('Vui lòng đăng nhập lại');
                return;
            }
            
            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('Kích thước file không được vượt quá 5MB');
                document.getElementById('createComponentImageFile').value = '';
                return;
            }
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert('Vui lòng chọn file ảnh');
                document.getElementById('createComponentImageFile').value = '';
                return;
            }
            
            // Show preview
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById('imagePreview').src = e.target.result;
                document.getElementById('imagePreviewRow').style.display = 'block';
            };
            reader.readAsDataURL(file);
            
            // Upload to Cloudinary
            try {
                const formData = new FormData();
                formData.append('file', file);
                formData.append('folder', 'component-images');
                
                const response = await fetch(`${apiBaseUrl}/Image/upload-temp`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                
                const data = await response.json();
                
                if (data.success && data.data && data.data.url) {
                    document.getElementById('createComponentImageUrl').value = data.data.url;
                    console.log('Image uploaded to Cloudinary:', data.data.url);
                } else {
                    throw new Error(data.message || 'Không thể upload ảnh');
                }
            } catch (error) {
                console.error('Error uploading image:', error);
                alert('Lỗi upload ảnh: ' + error.message);
                document.getElementById('createComponentImageFile').value = '';
                document.getElementById('imagePreviewRow').style.display = 'none';
                document.getElementById('createComponentImageUrl').value = '';
            }
        }

        function cleanupModalBackdrop() {
            // Remove all modal backdrops
            const backdrops = document.querySelectorAll('.modal-backdrop');
            backdrops.forEach(backdrop => backdrop.remove());
            
            // Reset body styles
            document.body.classList.remove('modal-open');
            document.body.style.overflow = '';
            document.body.style.paddingRight = '';
        }
    </script>
}
