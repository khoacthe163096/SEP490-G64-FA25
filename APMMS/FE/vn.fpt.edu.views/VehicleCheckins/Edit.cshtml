@{
    ViewData["Title"] = "Sửa thông tin check-in xe";
    Layout = "~/vn.fpt.edu.views/Shared/_DashboardLayout.cshtml";
    var apiBaseUrl = ViewBag.ApiBaseUrl ?? "https://localhost:7173/api";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">
                            <i class="fas fa-edit me-2"></i>
                            Sửa thông tin check-in xe
                        </h4>
                        <div class="badge bg-white text-primary fs-6 shadow-sm" id="statusBadge">
                            <i class="fas fa-clock me-1"></i>
                            Đang tải...
                        </div>
                    </div>
                </div>
                <div class="card-body" style="background-color: #f8f9fa;">
                    <form id="checkinForm" enctype="multipart/form-data">
                        <input type="hidden" id="checkinId" name="id">
                        
                        <!-- Thông tin xe -->
                        <div class="card mb-4 border-0 shadow-sm">
                            <div class="card-header" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #2c3e50;">
                                <h5 class="mb-0">
                                    <i class="fas fa-car me-2"></i>
                                    Thông tin xe
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="licensePlate" class="form-label">
                                                <i class="fas fa-id-card me-1"></i>
                                                Biển số xe <span class="text-danger">*</span>
                                            </label>
                                            <input type="text" class="form-control" id="licensePlate" name="licensePlate" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="mileage" class="form-label">
                                                <i class="fas fa-tachometer-alt me-1"></i>
                                                Số km
                                            </label>
                                            <input type="number" class="form-control" id="mileage" name="mileage" min="0">
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="vinNumber" class="form-label">
                                                <i class="fas fa-barcode me-1"></i>
                                                Số khung (VIN)
                                            </label>
                                            <input type="text" class="form-control" id="vinNumber" name="vinNumber">
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="vehicleEngineNumber" class="form-label">
                                                <i class="fas fa-cog me-1"></i>
                                                Số máy
                                            </label>
                                            <input type="text" class="form-control" id="vehicleEngineNumber" name="vehicleEngineNumber">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Thông tin khách hàng -->
                        <div class="card mb-4 border-0 shadow-sm">
                            <div class="card-header" style="background: linear-gradient(135deg, #d299c2 0%, #fef9d7 100%); color: #2c3e50;">
                                <h5 class="mb-0">
                                    <i class="fas fa-user me-2"></i>
                                    Thông tin khách hàng
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="customerName" class="form-label">
                                                <i class="fas fa-user-tag me-1"></i>
                                                Tên khách hàng <span class="text-danger">*</span>
                                            </label>
                                            <input type="text" class="form-control" id="customerName" name="customerName" required>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="customerPhone" class="form-label">
                                                <i class="fas fa-phone me-1"></i>
                                                Số điện thoại
                                            </label>
                                            <input type="tel" class="form-control" id="customerPhone" name="customerPhone">
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Thông tin check-in -->
                        <div class="card mb-4 border-0 shadow-sm">
                            <div class="card-header" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); color: #2c3e50;">
                                <h5 class="mb-0">
                                    <i class="fas fa-clipboard-check me-2"></i>
                                    Thông tin check-in
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="branchId" class="form-label">
                                                <i class="fas fa-building me-1"></i>
                                                Chi nhánh <span class="text-danger">*</span>
                                            </label>
                                            <input type="text" class="form-control" id="branchName" name="branchName" readonly>
                                            <input type="hidden" id="branchId" name="branchId">
                                            <div class="form-text">Chi nhánh của nhân viên hiện tại</div>
                                        </div>
                                    </div>
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="checkinDate" class="form-label">
                                                <i class="fas fa-calendar-alt me-1"></i>
                                                Ngày check-in <span class="text-danger">*</span>
                                            </label>
                                            <input type="datetime-local" class="form-control" id="checkinDate" name="checkinDate" required>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-6">
                                        <div class="mb-3">
                                            <label for="statusCode" class="form-label">
                                                <i class="fas fa-flag me-1"></i>
                                                Trạng thái <span class="text-danger">*</span>
                                            </label>
                                            <select class="form-select" id="statusCode" name="statusCode" required>
                                                <option value="">Chọn trạng thái</option>
                                                <!-- Will be loaded dynamically -->
                                            </select>
                                        </div>
                                    </div>
                                </div>
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="mb-3">
                                            <label for="notes" class="form-label">
                                                <i class="fas fa-sticky-note me-1"></i>
                                                Ghi chú
                                            </label>
                                            <textarea class="form-control" id="notes" name="notes" rows="3" placeholder="Mô tả tình trạng xe, vấn đề cần sửa chữa..."></textarea>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Hình ảnh -->
                        <div class="card mb-4 border-0 shadow-sm">
                            <div class="card-header" style="background: linear-gradient(135deg, #e0c3fc 0%, #9bb5ff 100%); color: #2c3e50;">
                                <h5 class="mb-0">
                                    <i class="fas fa-images me-2"></i>
                                    Hình ảnh xe
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="mb-3">
                                    <label for="images" class="form-label">
                                        <i class="fas fa-upload me-1"></i>
                                        Thêm hình ảnh mới
                                    </label>
                                    <input type="file" class="form-control" id="images" name="images" multiple accept="image/*">
                                    <div class="form-text">Chọn hình ảnh mới để thêm vào (ảnh cũ sẽ được giữ lại). Sau khi upload, nhập mô tả và phân loại cho ảnh mới, rồi click "Cập nhật" để lưu.</div>
                                </div>

                                <!-- Current Images -->
                                <div id="currentImagesSection" style="display: none;">
                                    <div class="mb-3">
                                        <label class="form-label">
                                            <i class="fas fa-image me-1"></i>
                                            Hình ảnh hiện tại
                                        </label>
                                        <div id="currentImages" class="row">
                                            <!-- Current images will be displayed here -->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
    
                        <!-- Action Buttons -->
                        <div class="card border-0 shadow-sm">
                            <div class="card-body" style="background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="text-muted">
                                        <i class="fas fa-info-circle me-1"></i>
                                        Vui lòng kiểm tra thông tin trước khi cập nhật
                                    </div>
                                    <div class="btn-group">
                                        <a href="/VehicleCheckins" class="btn btn-outline-secondary">
                                            <i class="fas fa-arrow-left me-1"></i> 
                                            Quay lại
                                        </a>
                                        <button type="submit" class="btn" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none;">
                                            <i class="fas fa-save me-1"></i> 
                                            Cập nhật
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const checkinId = getCheckinIdFromUrl();
            if (checkinId) {
                loadCheckin(checkinId);
                loadCurrentUserBranch();
                loadStatuses();
            }
            
            document.getElementById('checkinForm').addEventListener('submit', function(e) {
                e.preventDefault();
                updateCheckin();
            });

            // Xử lý upload ảnh
            document.getElementById('images').addEventListener('change', function(e) {
                const files = e.target.files;
                if (files.length > 0) {
                    uploadImages(files);
                }
            });
        });

        function getCheckinIdFromUrl() {
            const path = window.location.pathname;
            const segments = path.split('/');
            return segments[segments.length - 1];
        }

        function loadCheckin(id) {
            fetch(`/VehicleCheckins/GetDetails/${id}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    const checkin = data.data;
                    console.log('Loaded checkin data:', checkin); // Debug log
                    
                    document.getElementById('checkinId').value = checkin.id;
                    document.getElementById('licensePlate').value = checkin.licensePlate || '';
                    document.getElementById('customerName').value = checkin.customerName || '';
                    document.getElementById('customerPhone').value = checkin.customerPhone || '';
                    document.getElementById('vinNumber').value = checkin.vinNumber || '';
                    document.getElementById('vehicleEngineNumber').value = checkin.vehicleEngineNumber || '';
                    document.getElementById('mileage').value = checkin.mileage || '';
                    // Set branch từ dữ liệu checkin
                    if (checkin.branchName) {
                        document.getElementById('branchName').value = checkin.branchName;
                    }
                    if (checkin.branchId) {
                        document.getElementById('branchId').value = checkin.branchId;
                    }
                    document.getElementById('statusCode').value = checkin.statusCode || '';
                    document.getElementById('notes').value = checkin.notes || '';
                    
                    // Cập nhật status badge
                    updateStatusBadge(checkin.statusCode);
                    
                    // Kiểm tra trạng thái - nếu đã CONFIRMED thì không cho phép chỉnh sửa
                    if (checkin.statusCode === 'CONFIRMED') {
                        showAlert('Vehicle check-in đã được xác nhận, không thể chỉnh sửa!', 'warning');
                        // Disable tất cả input fields
                        disableForm();
                        // Chuyển hướng về trang danh sách sau 3 giây
                        setTimeout(() => {
                            window.location.href = '/VehicleCheckins';
                        }, 3000);
                        return;
                    }
                    
                    // Set checkin date - sử dụng createdAt thay vì checkinDate
                    if (checkin.createdAt) {
                        const date = new Date(checkin.createdAt);
                        const year = date.getFullYear();
                        const month = String(date.getMonth() + 1).padStart(2, '0');
                        const day = String(date.getDate()).padStart(2, '0');
                        const hours = String(date.getHours()).padStart(2, '0');
                        const minutes = String(date.getMinutes()).padStart(2, '0');
                        document.getElementById('checkinDate').value = `${year}-${month}-${day}T${hours}:${minutes}`;
                    }
                    
            // Lưu images data để dùng khi update
            window.currentCheckinImages = checkin.images || [];
            // Khởi tạo mảng lưu ID ảnh đã xóa
            window.deletedImageIds = [];
            // Display current images
            displayCurrentImages(window.currentCheckinImages);
                } else {
                    showAlert('Lỗi khi tải thông tin check-in: ' + data.message, 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Có lỗi xảy ra khi tải thông tin check-in: ' + error.message, 'danger');
            });
        }

        function loadCurrentUserBranch() {
            // Lấy dữ liệu chi nhánh thật từ database có sẵn
            console.log('Loading branches from API...');
            
            fetch('@apiBaseUrl/Branch')
                .then(response => {
                    console.log('Response status:', response.status);
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    console.log('API Response:', data);
                    if (data.success && data.data && data.data.length > 0) {
                        // Lấy chi nhánh đầu tiên từ database
                        const firstBranch = data.data[0];
                        document.getElementById('branchName').value = firstBranch.name;
                        document.getElementById('branchId').value = firstBranch.id;
                        console.log('Loaded branch from database:', firstBranch.name, 'ID:', firstBranch.id);
                    } else {
                        console.error('No branch data found in database');
                        document.getElementById('branchName').value = 'Không có chi nhánh';
                    }
                })
                .catch(error => {
                    console.error('Error loading branches from database:', error);
                    document.getElementById('branchName').value = 'Lỗi tải chi nhánh: ' + error.message;
                });
        }

        function loadStatuses() {
            // Chỉ hiển thị 2 trạng thái cho VehicleCheckin
            console.log('Loading VehicleCheckin statuses...');
            
            const statusSelect = document.getElementById('statusCode');
            // Xóa option mặc định trừ "Chọn trạng thái"
            statusSelect.innerHTML = '<option value="">Chọn trạng thái</option>';
            
            // Chỉ thêm 2 trạng thái cho VehicleCheckin
            const vehicleCheckinStatuses = [
                { code: 'PENDING', name: 'Chờ xử lý' },
                { code: 'CONFIRMED', name: 'Đã xác nhận' }
            ];
            
            vehicleCheckinStatuses.forEach(status => {
                const option = document.createElement('option');
                option.value = status.code;
                option.textContent = status.name;
                statusSelect.appendChild(option);
            });
            
            console.log('Loaded VehicleCheckin statuses:', vehicleCheckinStatuses.length, 'statuses');
        }

        function displayCurrentImages(images) {
            const container = document.getElementById('currentImages');
            const section = document.getElementById('currentImagesSection');
            
            if (images.length === 0) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            container.innerHTML = '';
            
            images.forEach((image, index) => {
                const col = document.createElement('div');
                col.className = 'col-md-6 mb-3';
                const imageId = image.id || index;
                const imageUrl = image.imageUrl || image.url || '';
                const description = image.description || '';
                const category = image.category || '';
                
                col.innerHTML = `
                    <div class="card" data-image-id="${imageId}" id="image-card-${imageId}">
                        <div class="card-body position-relative">
                            <button type="button" class="btn btn-danger btn-sm position-absolute top-0 end-0 m-2" 
                                    style="z-index: 10; width: 30px; height: 30px; padding: 0; border-radius: 50%;"
                                    onclick="removeImage(${imageId}, '${imageUrl}')"
                                    title="Xóa ảnh này">
                                <i class="fas fa-times"></i>
                            </button>
                            <div class="row">
                                <div class="col-md-4">
                                    <img src="${imageUrl}" class="img-thumbnail" style="width: 100%; max-height: 150px; object-fit: cover; cursor: pointer;" 
                                         alt="Hình ${index + 1}"
                                         onclick="openImageModal('${imageUrl}')"
                                         title="Click để xem ảnh lớn">
                                </div>
                                <div class="col-md-8">
                                    <div class="mb-2">
                                        <label class="form-label small">Mô tả ảnh ${index + 1} <span class="text-muted">(tùy chọn)</span></label>
                                        <input type="text" class="form-control form-control-sm image-description-edit" 
                                               placeholder="VD: Cửa trái - vết xước dài 20cm" 
                                               value="${description}"
                                               data-image-id="${imageId}">
                                    </div>
                                    <div class="mb-2">
                                        <label class="form-label small">Phân loại <span class="text-muted">(tùy chọn)</span></label>
                                        <select class="form-select form-select-sm image-category-edit" data-image-id="${imageId}">
                                            <option value="">-- Chọn phân loại --</option>
                                            <option value="Exterior" ${category === 'Exterior' ? 'selected' : ''}>Ngoại thất</option>
                                            <option value="Interior" ${category === 'Interior' ? 'selected' : ''}>Nội thất</option>
                                            <option value="Damage" ${category === 'Damage' ? 'selected' : ''}>Hư hỏng</option>
                                            <option value="Engine" ${category === 'Engine' ? 'selected' : ''}>Động cơ</option>
                                            <option value="Tire" ${category === 'Tire' ? 'selected' : ''}>Lốp xe</option>
                                            <option value="Other" ${category === 'Other' ? 'selected' : ''}>Khác</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.appendChild(col);
            });
        }

        async function updateCheckin() {
            const checkinId = document.getElementById('checkinId').value;
            const mileage = document.getElementById('mileage').value;
            const notes = document.getElementById('notes').value;

            // Lấy thông tin ảnh hiện tại và descriptions/categories đã sửa
            const imageDescriptions = [];
            const imageCategories = [];
            const imageUrls = [];
            
            // Lấy imageUrls từ dữ liệu đã load (bao gồm cả ảnh cũ và ảnh mới đã upload)
            // Loại bỏ những ảnh đã bị đánh dấu xóa
            // Đồng thời lấy descriptions và categories tương ứng
            if (window.currentCheckinImages && window.currentCheckinImages.length > 0) {
                window.currentCheckinImages.forEach(img => {
                    const imageId = img.id;
                    // Chỉ thêm ảnh nếu chưa bị đánh dấu xóa
                    if (!window.deletedImageIds || !window.deletedImageIds.includes(imageId)) {
                        const imageUrl = img.imageUrl || img.url || '';
                        if (imageUrl) {
                            imageUrls.push(imageUrl);
                            
                            // Lấy description và category từ form (nếu có) hoặc từ dữ liệu gốc
                            const descriptionInput = document.querySelector(`.image-description-edit[data-image-id="${imageId}"]`);
                            const categorySelect = document.querySelector(`.image-category-edit[data-image-id="${imageId}"]`);
                            
                            if (descriptionInput && !descriptionInput.disabled) {
                                imageDescriptions.push(descriptionInput.value.trim() || null);
                            } else {
                                imageDescriptions.push(img.description || null);
                            }
                            
                            if (categorySelect && !categorySelect.disabled) {
                                imageCategories.push(categorySelect.value || null);
                            } else {
                                imageCategories.push(img.category || null);
                            }
                        }
                    }
                });
            }

            const updateData = {
                id: parseInt(checkinId),
                mileage: parseInt(mileage) || 0,
                notes: notes || null
            };

            // Chỉ gửi imageUrls nếu có ảnh (để update descriptions/categories)
            // Nếu không có ảnh, không gửi imageUrls để không xóa ảnh cũ
            if (imageUrls.length > 0) {
                updateData.imageUrls = imageUrls;
                updateData.imageDescriptions = imageDescriptions.length > 0 && imageDescriptions.some(d => d !== null) ? imageDescriptions : null;
                updateData.imageCategories = imageCategories.length > 0 && imageCategories.some(c => c !== null) ? imageCategories : null;
            }

            console.log('Updating checkin:', checkinId);
            console.log('Update data:', updateData);

            try {
                const response = await fetch(`@apiBaseUrl/VehicleCheckin/${checkinId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(updateData)
                });

                const data = await response.json();
                
                if (!response.ok) {
                    console.error('Error response:', data);
                    throw new Error(data.message || `HTTP error! status: ${response.status}`);
                }

                if (data.success) {
                    showAlert('Cập nhật check-in thành công!', 'success');
                    setTimeout(() => {
                        window.location.href = '/VehicleCheckins';
                    }, 1500);
                } else {
                    showAlert('Lỗi: ' + (data.message || 'Không thể cập nhật'), 'danger');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('Có lỗi xảy ra khi cập nhật check-in: ' + error.message, 'danger');
            }
        }

        async function uploadImages(files) {
            const checkinId = document.getElementById('checkinId').value;
            if (!checkinId) {
                showAlert('Không tìm thấy ID check-in', 'danger');
                return;
            }

            // Upload all files at once using the multiple upload endpoint
            const formData = new FormData();
            Array.from(files).forEach((file, index) => {
                formData.append('files', file);
            });

            try {
                const response = await fetch(`@apiBaseUrl/Image/upload-multiple-cloudinary?vehicleCheckinId=${checkinId}`, {
                    method: 'POST',
                    body: formData
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                console.log('Upload result:', result);
                
                if (result.success) {
                    console.log('Images uploaded successfully:', result.data);
                    
                    showAlert(`Upload thành công ${result.data.length} ảnh! Đang tải lại danh sách ảnh...`, 'success');
                    
                    // Reload để hiển thị ảnh mới (endpoint upload đã tự động lưu vào DB)
                    // Sau khi reload, window.currentCheckinImages sẽ bao gồm cả ảnh mới
                    loadCheckin(checkinId);
                    
                    // Reset file input
                    document.getElementById('images').value = '';
                } else {
                    console.error('Upload failed:', result.message);
                    showAlert('Lỗi upload ảnh: ' + result.message, 'danger');
                }
            } catch (error) {
                console.error('Upload error:', error);
                showAlert('Lỗi upload ảnh: ' + error.message, 'danger');
            }
        }

        function updateStatusBadge(statusCode) {
            const statusBadge = document.getElementById('statusBadge');
            if (statusCode === 'PENDING') {
                statusBadge.innerHTML = '<i class="fas fa-clock me-1"></i>Chờ xử lý';
                statusBadge.style.cssText = 'background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); color: #2c3e50; border: none;';
            } else if (statusCode === 'CONFIRMED') {
                statusBadge.innerHTML = '<i class="fas fa-check-circle me-1"></i>Đã xác nhận';
                statusBadge.style.cssText = 'background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #2c3e50; border: none;';
            } else {
                statusBadge.innerHTML = '<i class="fas fa-question-circle me-1"></i>Không xác định';
                statusBadge.style.cssText = 'background: linear-gradient(135deg, #e0c3fc 0%, #9bb5ff 100%); color: #2c3e50; border: none;';
            }
        }

        function disableForm() {
            // Disable tất cả input fields trong form
            const form = document.getElementById('checkinForm');
            const inputs = form.querySelectorAll('input, textarea, select, button');
            inputs.forEach(input => {
                input.disabled = true;
            });
        }

        function removeImage(imageId, imageUrl) {
            // Xóa modal cũ nếu có
            const existingModal = document.getElementById('deleteImageModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Tạo modal xác nhận xóa
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.setAttribute('tabindex', '-1');
            modal.setAttribute('id', 'deleteImageModal');
            const uniqueId = 'confirmDeleteImageBtn_' + imageId;
            modal.innerHTML = `
                <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header bg-danger text-white">
                            <h5 class="modal-title">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                Xác nhận xóa ảnh
                            </h5>
                            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body">
                            <div class="text-center mb-3">
                                <i class="fas fa-image fa-3x text-danger mb-3"></i>
                                <p class="mb-2"><strong>Bạn có chắc chắn muốn xóa ảnh này?</strong></p>
                                <p class="text-muted small mb-0">Ảnh sẽ bị xóa khi bạn click "Cập nhật".</p>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                <i class="fas fa-times me-1"></i>
                                Hủy
                            </button>
                            <button type="button" class="btn btn-danger" id="${uniqueId}">
                                <i class="fas fa-trash me-1"></i>
                                Xóa ảnh
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            // Xử lý khi click nút xác nhận
            document.getElementById(uniqueId).addEventListener('click', function() {
                bsModal.hide();
                
                // Thêm vào danh sách ảnh đã xóa
                window.deletedImageIds = window.deletedImageIds || [];
                if (!window.deletedImageIds.includes(imageId)) {
                    window.deletedImageIds.push(imageId);
                }
                
                // Đánh dấu card ảnh để xóa
                const imageCard = document.getElementById(`image-card-${imageId}`);
                if (imageCard) {
                    imageCard.style.opacity = '0.5';
                    imageCard.style.backgroundColor = '#ffebee';
                    imageCard.style.border = '2px dashed #dc3545';
                    
                    // Thêm alert warning
                    const cardBody = imageCard.querySelector('.card-body');
                    const existingAlert = cardBody.querySelector('.delete-alert');
                    if (!existingAlert) {
                        const alertDiv = document.createElement('div');
                        alertDiv.className = 'alert alert-warning mb-0 mt-2 py-1 delete-alert';
                        alertDiv.style.fontSize = '0.85rem';
                        alertDiv.innerHTML = `
                            <i class="fas fa-exclamation-triangle me-1"></i>
                            Ảnh này sẽ bị xóa khi bạn click "Cập nhật"
                        `;
                        cardBody.appendChild(alertDiv);
                    }
                    
                    // Disable các input trong card
                    const inputs = imageCard.querySelectorAll('input, select');
                    inputs.forEach(input => input.disabled = true);
                }
                
                showAlert('Ảnh đã được đánh dấu để xóa. Click "Cập nhật" để xác nhận xóa.', 'info');
            });
            
            // Xóa modal khi đóng
            modal.addEventListener('hidden.bs.modal', function() {
                if (document.body.contains(modal)) {
                    document.body.removeChild(modal);
                }
            });
        }

        function openImageModal(imageUrl) {
            // Simple image modal - giống trang Details
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.setAttribute('tabindex', '-1');
            modal.innerHTML = `
                <div class="modal-dialog modal-lg modal-dialog-centered">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">
                                <i class="fas fa-image me-2"></i>
                                Hình ảnh xe
                            </h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                        </div>
                        <div class="modal-body text-center p-0" style="background-color: #f8f9fa;">
                            <img src="${imageUrl}" class="img-fluid" alt="Hình ảnh xe" 
                                 style="max-height: 70vh; width: auto;"
                                 onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjRjVGNUY1Ii8+Cjx0ZXh0IHg9IjEwMCIgeT0iMTAwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM5OTk5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5Lb8O0bmcgY8O0IGjDsm5oIMSR4b5uPC90ZXh0Pgo8L3N2Zz4K'; this.alt='Không thể tải hình ảnh';">
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                <i class="fas fa-times me-1"></i>
                                Đóng
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            // Xóa modal khi đóng
            modal.addEventListener('hidden.bs.modal', function() {
                document.body.removeChild(modal);
            });
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.card-body').insertBefore(alertDiv, document.querySelector('form'));
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }
    </script>
}

