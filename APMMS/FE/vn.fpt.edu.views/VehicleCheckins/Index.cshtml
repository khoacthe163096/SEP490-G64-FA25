@{
    ViewData["Title"] = "Danh sách check-in xe";
    Layout = "~/vn.fpt.edu.views/Shared/_DashboardLayout.cshtml";
    var apiBaseUrl = ViewBag.ApiBaseUrl ?? "https://localhost:7173/api";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Danh sách check-in xe</h4>
                    <a href="/VehicleCheckins/Create" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Check-in xe mới
                    </a>
                </div>
                <div class="card-body">
                    <!-- Search and Filter -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <input type="text" class="form-control" id="searchInput" placeholder="Tìm kiếm theo tên khách hàng, biển số xe, VIN...">
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="statusFilter">
                                <option value="">Tất cả trạng thái</option>
                                <option value="PENDING">Chờ xử lý</option>
                                <option value="CONFIRMED">Đã xác nhận</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <input type="date" class="form-control" id="fromDateFilter" placeholder="Từ ngày">
                        </div>
                        <div class="col-md-2">
                            <input type="date" class="form-control" id="toDateFilter" placeholder="Đến ngày">
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-outline-secondary w-100" onclick="resetFilters()">
                                <i class="fas fa-refresh"></i> Reset
                            </button>
                        </div>
                        <div class="col-md-1">
                            <button class="btn btn-success w-100" onclick="exportToExcel()">
                                <i class="fas fa-file-excel"></i> Export
                            </button>
                        </div>
                    </div>

                    <!-- Table -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>Mã</th>
                                    <th>Biển số xe</th>
                                    <th>Chủ xe</th>
                                    <th>Loại xe</th>
                                    <th>Trạng thái</th>
                                    <th>Ngày check-in</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody id="checkinsTableBody">
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination Info and Controls -->
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div class="text-muted" id="paginationInfo">
                            Hiển thị <span id="showingFrom">0</span> - <span id="showingTo">0</span> của <span id="totalRecords">0</span> kết quả
                        </div>
                        <nav aria-label="Page navigation">
                            <ul class="pagination mb-0" id="pagination">
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const API_BASE_URL = '@apiBaseUrl';
        let currentPage = 1;
        const pageSize = 10;
        let allCheckins = []; // Lưu tất cả checkins để phân trang client-side
        let filteredCheckins = []; // Lưu checkins sau khi filter
        let totalRecords = 0;

        $(document).ready(function() {
            loadCheckins();
            
            // Search functionality với debounce
            let searchTimeout;
            $('#searchInput').on('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    currentPage = 1;
                    applyFilters();
                }, 500);
            });

            $('#searchInput').on('keypress', function(e) {
                if (e.which === 13) {
                    clearTimeout(searchTimeout);
                    currentPage = 1;
                    applyFilters();
                }
            });

            // Filter events
            $('#statusFilter, #fromDateFilter, #toDateFilter').on('change', function() {
                currentPage = 1;
                applyFilters();
            });
        });

        function loadCheckins() {
            const token = localStorage.getItem('authToken');
            
            // Load tất cả checkins với pageSize lớn (client-side pagination)
            // Tương tự như ServiceSchedules và MaintenanceTickets
            const url = `${API_BASE_URL}/VehicleCheckin?page=1&pageSize=500`;

            // Show loading
            $('#checkinsTableBody').html(`
                <tr>
                    <td colspan="7" class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </td>
                </tr>
            `);

            fetch(url, {
                headers: {
                    'Authorization': token ? `Bearer ${token}` : '',
                    'Content-Type': 'application/json'
                }
            })
            .then(async response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return response.json();
            })
            .then(result => {
                if (result.success && result.data) {
                    allCheckins = result.data;
                    applyFilters();
                } else {
                    allCheckins = [];
                    filteredCheckins = [];
                    totalRecords = 0;
                    renderCheckinsTable([]);
                    updatePagination();
                }
            })
            .catch(error => {
                console.error('Error loading checkins:', error);
                $('#checkinsTableBody').html('<tr><td colspan="7" class="text-center text-danger">Lỗi tải dữ liệu: ' + error.message + '</td></tr>');
                allCheckins = [];
                filteredCheckins = [];
                totalRecords = 0;
                updatePagination();
            });
        }

        function applyFilters() {
            const status = $('#statusFilter').val();
            const search = $('#searchInput').val().trim().toLowerCase();
            const fromDate = $('#fromDateFilter').val();
            const toDate = $('#toDateFilter').val();

            // Bắt đầu với tất cả checkins
            filteredCheckins = [...allCheckins];

            // Filter by status
            if (status) {
                filteredCheckins = filteredCheckins.filter(c => c.statusCode === status);
            }

            // Filter by date range
            if (fromDate) {
                const filterDateFrom = new Date(fromDate);
                filterDateFrom.setHours(0, 0, 0, 0);
                filteredCheckins = filteredCheckins.filter(c => {
                    if (!c.createdAt) return false;
                    const checkinDate = new Date(c.createdAt);
                    checkinDate.setHours(0, 0, 0, 0);
                    return checkinDate >= filterDateFrom;
                });
            }

            if (toDate) {
                const filterDateTo = new Date(toDate);
                filterDateTo.setHours(23, 59, 59, 999);
                filteredCheckins = filteredCheckins.filter(c => {
                    if (!c.createdAt) return false;
                    const checkinDate = new Date(c.createdAt);
                    checkinDate.setHours(0, 0, 0, 0);
                    return checkinDate <= filterDateTo;
                });
            }

            // Filter by search
            if (search) {
                filteredCheckins = filteredCheckins.filter(c => 
                    (c.code && c.code.toLowerCase().includes(search)) ||
                    (c.licensePlate && c.licensePlate.toLowerCase().includes(search)) ||
                    (c.customerName && c.customerName.toLowerCase().includes(search)) ||
                    (c.carName && c.carName.toLowerCase().includes(search)) ||
                    (c.vinNumber && c.vinNumber.toLowerCase().includes(search))
                );
            }

            // Sort by createdAt (newest first)
            filteredCheckins.sort((a, b) => {
                const dateA = a.createdAt ? new Date(a.createdAt) : new Date(0);
                const dateB = b.createdAt ? new Date(b.createdAt) : new Date(0);
                return dateB - dateA;
            });

            totalRecords = filteredCheckins.length;
            currentPage = Math.min(currentPage, Math.ceil(totalRecords / pageSize) || 1);

            // Paginate
            const startIndex = (currentPage - 1) * pageSize;
            const endIndex = startIndex + pageSize;
            const paginatedCheckins = filteredCheckins.slice(startIndex, endIndex);

            renderCheckinsTable(paginatedCheckins);
            updatePagination();
        }


        function renderCheckinsTable(checkins) {
            const tbody = $('#checkinsTableBody');
            tbody.empty();

            if (!checkins || checkins.length === 0) {
                tbody.html('<tr><td colspan="7" class="text-center text-muted">Không có dữ liệu</td></tr>');
                return;
            }

            checkins.forEach((checkin, index) => {
                const statusBadge = getStatusBadge(checkin.statusCode);
                const createdAt = checkin.createdAt ? new Date(checkin.createdAt).toLocaleString('vi-VN') : '-';
                
                const confirmButton = checkin.statusCode === 'PENDING' 
                    ? `<button class="btn btn-sm btn-success" onclick="confirmCheckin(${checkin.id})" title="Xác nhận">
                            <i class="fas fa-check"></i>
                       </button>`
                    : '';
                
                const createMaintenanceButton = checkin.statusCode === 'CONFIRMED'
                    ? `<button class="btn btn-sm btn-primary" onclick="createMaintenanceTicket(${checkin.id})" title="Tạo phiếu bảo dưỡng">
                            <i class="fas fa-wrench"></i>
                       </button>`
                    : '';

                tbody.append(`
                    <tr>
                        <td><strong>${checkin.code || 'VCI-' + checkin.id}</strong></td>
                        <td><strong>${checkin.licensePlate || '-'}</strong></td>
                        <td>${checkin.customerName || '-'}</td>
                        <td><span class="badge bg-info">${checkin.carName || '-'}</span></td>
                        <td>${statusBadge}</td>
                        <td>${createdAt}</td>
                        <td>
                            <div class="btn-group" role="group">
                                <a href="/VehicleCheckins/Details/${checkin.id}" class="btn btn-sm btn-outline-info" title="Xem chi tiết">
                                    <i class="fas fa-eye"></i>
                                </a>
                                ${confirmButton}
                                ${createMaintenanceButton}
                            </div>
                        </td>
                    </tr>
                `);
            });
        }

        function getStatusBadge(statusCode) {
            const statusMap = {
                'PENDING': { class: 'bg-warning', text: 'Chờ xử lý' },
                'CONFIRMED': { class: 'bg-success', text: 'Đã xác nhận' }
            };
            
            const status = statusMap[statusCode] || { class: 'bg-secondary', text: statusCode };
            return `<span class="badge ${status.class}">${status.text}</span>`;
        }

        function updatePagination() {
            const totalPages = Math.ceil(totalRecords / pageSize) || 1;
            const pagination = $('#pagination');
            pagination.empty();

            if (totalPages <= 1) {
                pagination.html('<li class="page-item disabled"><span class="page-link">Trang 1 / 1</span></li>');
                updatePaginationInfo();
                return;
            }

            // Previous button
            const prevDisabled = currentPage === 1 ? 'disabled' : '';
            pagination.append(`
                <li class="page-item ${prevDisabled}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;">
                        <i class="fas fa-chevron-left"></i> Trước
                    </a>
                </li>
            `);

            // Page numbers
            const maxPagesToShow = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
            let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);

            if (endPage - startPage < maxPagesToShow - 1) {
                startPage = Math.max(1, endPage - maxPagesToShow + 1);
            }

            // First page
            if (startPage > 1) {
                pagination.append(`
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="changePage(1); return false;">1</a>
                    </li>
                `);
                if (startPage > 2) {
                    pagination.append('<li class="page-item disabled"><span class="page-link">...</span></li>');
                }
            }

            // Page numbers
            for (let i = startPage; i <= endPage; i++) {
                const active = i === currentPage ? 'active' : '';
                pagination.append(`
                    <li class="page-item ${active}">
                        <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>
                    </li>
                `);
            }

            // Last page
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    pagination.append('<li class="page-item disabled"><span class="page-link">...</span></li>');
                }
                pagination.append(`
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="changePage(${totalPages}); return false;">${totalPages}</a>
                    </li>
                `);
            }

            // Next button
            const nextDisabled = currentPage === totalPages ? 'disabled' : '';
            pagination.append(`
                <li class="page-item ${nextDisabled}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;">
                        Sau <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
            `);

            updatePaginationInfo();
        }

        function updatePaginationInfo() {
            const startIndex = totalRecords === 0 ? 0 : (currentPage - 1) * pageSize + 1;
            const endIndex = Math.min(currentPage * pageSize, totalRecords);
            
            $('#showingFrom').text(startIndex);
            $('#showingTo').text(endIndex);
            $('#totalRecords').text(totalRecords);
        }

        function changePage(page) {
            const totalPages = Math.ceil(totalRecords / pageSize) || 1;
            if (page >= 1 && page <= totalPages) {
                currentPage = page;
                applyFilters();
                // Scroll to top of table
                $('html, body').animate({
                    scrollTop: $('.card').offset().top - 20
                }, 300);
            }
        }

        // Expose changePage to global scope for onclick handlers
        window.changePage = changePage;

        function createMaintenanceTicket(checkinId) {
            // Store checkinId for later use
            window.currentCheckinId = checkinId;
            
            // Show custom modal instead of browser confirm
            $('#createMaintenanceModal').modal('show');
        }

        function confirmCreateMaintenanceTicket() {
            const checkinId = window.currentCheckinId;
            if (!checkinId) return;
            
            // Get consulter ID from token
            const token = localStorage.getItem('authToken');
            let consulterId = 18; // Default fallback
            
            if (token) {
                try {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    consulterId = parseInt(payload['http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier']) || 18;
                } catch (e) {
                    console.log('Could not get consulter ID from token, using default');
                }
            }
            
            // Create maintenance ticket via API
            fetch(`${API_BASE_URL}/MaintenanceTicket/create-from-checkin`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': token ? `Bearer ${token}` : '',
                },
                body: JSON.stringify({
                    vehicleCheckinId: checkinId,
                    consulterId: consulterId, // Get from token or use default
                    technicianId: null,
                    branchId: 1, // Default branch ID - should be from session
                    scheduleServiceId: null,
                    statusCode: 'PENDING',
                    description: 'Tạo từ vehicle check-in'
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Tạo phiếu bảo dưỡng thành công!', 'success');
                    // Optionally redirect to maintenance tickets list
                    setTimeout(() => {
                        window.location.href = '/MaintenanceTickets';
                    }, 1500);
                } else {
                    showAlert('Lỗi tạo phiếu bảo dưỡng: ' + data.message, 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Có lỗi xảy ra khi tạo phiếu bảo dưỡng', 'danger');
            })
            .finally(() => {
                $('#createMaintenanceModal').modal('hide');
            });
        }

        function deleteCheckin(id) {
            if (confirm('Bạn có chắc chắn muốn xóa check-in này?')) {
                fetch(`/api/VehicleCheckin/${id}`, {
                    method: 'DELETE'
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        showAlert('Xóa check-in thành công', 'success');
                        loadCheckins();
                    } else {
                        showAlert('Lỗi khi xóa: ' + data.message, 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('Có lỗi xảy ra khi xóa', 'danger');
                });
            }
        }

        function exportToExcel() {
            const search = $('#searchInput').val();
            const status = $('#statusFilter').val();
            const fromDate = $('#fromDateFilter').val();
            const toDate = $('#toDateFilter').val();
            
            const params = new URLSearchParams({
                searchTerm: search,
                statusCode: status,
                fromDate: fromDate,
                toDate: toDate,
                export: 'excel'
            });
            
            window.open(`${API_BASE_URL}/VehicleCheckin/export?${params.toString()}`, '_blank');
        }

        function resetFilters() {
            $('#searchInput').val('');
            $('#statusFilter').val('');
            $('#fromDateFilter').val('');
            $('#toDateFilter').val('');
            currentPage = 1;
            applyFilters();
        }

        function confirmCheckin(id) {
            // Lưu ID để sử dụng trong modal
            window.pendingCheckinId = id;
            // Hiển thị modal xác nhận
            $('#confirmCheckinModal').modal('show');
        }

        function confirmCheckinAction() {
            // Lấy ID đã lưu và thực hiện cập nhật
            const id = window.pendingCheckinId;
            if (id) {
                updateCheckinStatus(id, 'CONFIRMED');
                // Đóng modal
                $('#confirmCheckinModal').modal('hide');
            }
        }

        async function updateCheckinStatus(id, status) {
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE_URL}/VehicleCheckin/${id}/status`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': token ? `Bearer ${token}` : '',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ statusCode: status })
                });

                const data = await response.json();
                
                if (data.success) {
                    showAlert('Cập nhật trạng thái thành công!', 'success');
                    loadCheckins(); // Reload danh sách
                } else {
                    showAlert('Lỗi: ' + data.message, 'danger');
                }
            } catch (error) {
                console.error('Error:', error);
                showAlert('Có lỗi xảy ra khi cập nhật trạng thái', 'danger');
            }
        }

        function showAlert(message, type) {
            const alertHtml = `
                <div class="alert alert-${type} alert-dismissible fade show position-fixed" 
                     style="top: 20px; right: 20px; z-index: 9999; min-width: 300px;" role="alert">
                    ${message}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            `;
            
            $('body').append(alertHtml);
            
            setTimeout(() => {
                $('.alert').alert('close');
            }, 3000);
        }
    </script>
}

<!-- Custom Modal for Creating Maintenance Ticket -->
<div class="modal fade" id="createMaintenanceModal" tabindex="-1" aria-labelledby="createMaintenanceModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="createMaintenanceModalLabel">
                    <i class="fas fa-wrench me-2"></i>
                    Tạo Phiếu Bảo Dưỡng
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div class="mb-4">
                    <i class="fas fa-question-circle fa-3x text-primary mb-3"></i>
                    <h5>Xác nhận tạo phiếu bảo dưỡng</h5>
                    <p class="text-muted mb-0">
                        Bạn có muốn tạo phiếu bảo dưỡng từ vehicle check-in này không?
                    </p>
                </div>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Lưu ý:</strong> Sau khi tạo phiếu bảo dưỡng, bạn sẽ được chuyển hướng đến trang quản lý phiếu bảo dưỡng.
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>
                    Hủy
                </button>
                <button type="button" class="btn btn-primary" onclick="confirmCreateMaintenanceTicket()">
                    <i class="fas fa-check me-1"></i>
                    Tạo phiếu bảo dưỡng
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Modal xác nhận VehicleCheckin -->
<div class="modal fade" id="confirmCheckinModal" tabindex="-1" aria-labelledby="confirmCheckinModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="confirmCheckinModalLabel">
                    <i class="fas fa-check-circle me-2"></i>
                    Xác nhận Vehicle Check-in
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div class="mb-4">
                    <i class="fas fa-question-circle fa-3x text-success mb-3"></i>
                    <h5>Xác nhận trạng thái</h5>
                    <p class="text-muted mb-0">
                        Bạn có chắc chắn muốn xác nhận vehicle check-in này không?
                    </p>
                </div>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Lưu ý:</strong> Sau khi xác nhận, trạng thái sẽ chuyển từ "Chờ xử lý" thành "Đã xác nhận".
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>
                    Hủy
                </button>
                <button type="button" class="btn btn-success" onclick="confirmCheckinAction()">
                    <i class="fas fa-check me-1"></i>
                    Xác nhận
                </button>
            </div>
        </div>
    </div>
</div>
