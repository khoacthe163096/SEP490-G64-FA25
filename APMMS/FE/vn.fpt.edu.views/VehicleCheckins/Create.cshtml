@{
    ViewData["Title"] = "Check-in xe mới";
    Layout = "~/vn.fpt.edu.views/Shared/_DashboardLayout.cshtml";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">Check-in xe mới</h4>
                </div>
                <div class="card-body">
                    <!-- Search Vehicle Section -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="mb-0">Tìm kiếm xe</h5>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-8">
                                    <div class="mb-3">
                                        <label for="searchTerm" class="form-label">Nhập biển số hoặc số khung <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="searchTerm" placeholder="VD: 30A-12345 hoặc 1HGBH41JXMN109186">
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="mb-3">
                                        <label class="form-label">&nbsp;</label>
                                        <button type="button" class="btn btn-primary w-100" onclick="searchVehicle()">
                                            <i class="fas fa-search"></i> Tìm kiếm
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Search Results -->
                            <div id="searchResults" style="display: none;">
                                <div class="alert alert-success">
                                    <h6><i class="fas fa-check-circle"></i> Tìm thấy xe trong hệ thống</h6>
                                    <div id="vehicleInfo"></div>
                                </div>
                            </div>
                            
                            <div id="noResults" style="display: none;">
                                <div class="alert alert-warning">
                                    <h6><i class="fas fa-exclamation-triangle"></i> Không tìm thấy xe</h6>
                                    <p>Xe chưa có trong hệ thống. Vui lòng nhập thông tin xe mới bên dưới.</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <form id="checkinForm" enctype="multipart/form-data">
                        <!-- Hidden field for carId -->
                        <input type="hidden" id="carId" name="carId">
                        
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="licensePlate" class="form-label">Biển số xe <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="licensePlate" name="licensePlate" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="vinNumber" class="form-label">Số khung (VIN)</label>
                                    <input type="text" class="form-control" id="vinNumber" name="vinNumber">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="carName" class="form-label">Tên xe <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="carName" name="carName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="carModel" class="form-label">Model xe</label>
                                    <input type="text" class="form-control" id="carModel" name="carModel">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="customerName" class="form-label">Tên khách hàng <span class="text-danger">*</span></label>
                                    <input type="text" class="form-control" id="customerName" name="customerName" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="customerPhone" class="form-label">Số điện thoại khách hàng</label>
                                    <input type="tel" class="form-control" id="customerPhone" name="customerPhone">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="mileage" class="form-label">Số km hiện tại <span class="text-danger">*</span></label>
                                    <input type="number" class="form-control" id="mileage" name="mileage" min="0" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="yearOfManufacture" class="form-label">Năm sản xuất</label>
                                    <input type="number" class="form-control" id="yearOfManufacture" name="yearOfManufacture" min="1900" max="2030">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="branchId" class="form-label">Chi nhánh <span class="text-danger">*</span></label>
                                    <select class="form-select" id="branchId" name="branchId" required>
                                        <option value="">Chọn chi nhánh</option>
                                        <!-- Will be loaded dynamically -->
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="checkinDate" class="form-label">Ngày check-in <span class="text-danger">*</span></label>
                                    <input type="datetime-local" class="form-control" id="checkinDate" name="checkinDate" required>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label for="notes" class="form-label">Ghi chú</label>
                                    <textarea class="form-control" id="notes" name="notes" rows="3" placeholder="Mô tả tình trạng xe, vấn đề cần sửa chữa..."></textarea>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-12">
                                <div class="mb-3">
                                    <label for="images" class="form-label">Hình ảnh xe</label>
                                    <input type="file" class="form-control" id="images" name="images" multiple accept="image/*" onchange="previewImages()">
                                    <div class="form-text">Có thể chọn nhiều hình ảnh (JPG, PNG, GIF)</div>
                                    <div id="imagePreview" class="mt-2"></div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="hasMaintenanceRequest" name="hasMaintenanceRequest">
                                    <label class="form-check-label" for="hasMaintenanceRequest">
                                        Có yêu cầu bảo dưỡng
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Maintenance Request Section (hidden by default) -->
                        <div id="maintenanceRequestSection" style="display: none;">
                            <hr>
                            <h5>Thông tin yêu cầu bảo dưỡng</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="maintenanceType" class="form-label">Loại bảo dưỡng</label>
                                        <select class="form-select" id="maintenanceType" name="maintenanceType">
                                            <option value="">Chọn loại bảo dưỡng</option>
                                            <option value="ROUTINE">Bảo dưỡng định kỳ</option>
                                            <option value="REPAIR">Sửa chữa</option>
                                            <option value="INSPECTION">Kiểm tra</option>
                                            <option value="EMERGENCY">Khẩn cấp</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="priority" class="form-label">Mức độ ưu tiên</label>
                                        <select class="form-select" id="priority" name="priority">
                                            <option value="LOW">Thấp</option>
                                            <option value="MEDIUM" selected>Trung bình</option>
                                            <option value="HIGH">Cao</option>
                                            <option value="URGENT">Khẩn cấp</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <div class="mb-3">
                                        <label for="maintenanceDescription" class="form-label">Mô tả chi tiết vấn đề</label>
                                        <textarea class="form-control" id="maintenanceDescription" name="maintenanceDescription" rows="3" placeholder="Mô tả chi tiết vấn đề cần sửa chữa..."></textarea>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex justify-content-end gap-2">
                            <a href="/VehicleCheckins" class="btn btn-secondary">
                                <i class="fas fa-arrow-left"></i> Quay lại
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save"></i> Lưu check-in
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            loadBranches();
            setCurrentDateTime();
            
            // Toggle maintenance request section
            document.getElementById('hasMaintenanceRequest').addEventListener('change', function() {
                const section = document.getElementById('maintenanceRequestSection');
                section.style.display = this.checked ? 'block' : 'none';
            });
            
            document.getElementById('checkinForm').addEventListener('submit', function(e) {
                e.preventDefault();
                createCheckin();
            });
        });

        function setCurrentDateTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            
            const dateTimeString = `${year}-${month}-${day}T${hours}:${minutes}`;
            document.getElementById('checkinDate').value = dateTimeString;
        }

        function loadBranches() {
            fetch('https://localhost:7173/api/Branch')
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const select = document.getElementById('branchId');
                        data.data.forEach(branch => {
                            const option = document.createElement('option');
                            option.value = branch.id;
                            option.textContent = branch.name;
                            select.appendChild(option);
                        });
                        
                        // Tự động chọn chi nhánh của Consulter
                        selectBranchForConsulter();
                    }
                })
                .catch(error => {
                    console.error('Error loading branches:', error);
                });
        }
        
        function selectBranchForConsulter() {
            console.log('selectBranchForConsulter called');
            // Lấy thông tin user từ token
            const token = localStorage.getItem('authToken');
            console.log('Token found:', token ? 'Yes' : 'No');
            if (!token) return;
            
            try {
                // Decode token để lấy thông tin user
                const payload = JSON.parse(atob(token.split('.')[1]));
                const userId = payload['http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier'];
                const roleId = payload['RoleId'];
                console.log('User ID:', userId, 'Role ID:', roleId);
                
                // Nếu là Consulter (roleId = 6), tự động chọn chi nhánh
                if (roleId === '6') {
                    console.log('User is Consulter, getting branch info...');
                    // Gọi API để lấy thông tin chi nhánh của Consulter
                    fetch(`https://localhost:7173/api/Employee/${userId}`)
                        .then(response => response.json())
                        .then(data => {
                            console.log('Employee data:', data);
                            if (data.branchName) {
                                // Tìm chi nhánh theo tên
                                const select = document.getElementById('branchId');
                                for (let i = 0; i < select.options.length; i++) {
                                    if (select.options[i].textContent === data.branchName) {
                                        select.value = select.options[i].value;
                                        console.log('Auto-selected branch for Consulter:', data.branchName, 'ID:', select.options[i].value);
                                        break;
                                    }
                                }
                            }
                        })
                        .catch(error => {
                            console.error('Error getting Consulter branch:', error);
                            // Fallback: chọn chi nhánh đầu tiên
                            const select = document.getElementById('branchId');
                            if (select.options.length > 1) {
                                select.selectedIndex = 1; // Skip "Chọn chi nhánh" option
                            }
                        });
                }
            } catch (e) {
                console.error('Error decoding token:', e);
            }
        }

        function searchVehicle() {
            const searchTerm = document.getElementById('searchTerm').value.trim();
            if (!searchTerm) {
                showAlert('Vui lòng nhập biển số hoặc số khung', 'warning');
                return;
            }

            fetch(`https://localhost:7173/api/VehicleCheckin/search-vehicle?searchTerm=${encodeURIComponent(searchTerm)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.data.found) {
                        // Xe đã tồn tại - tự động điền thông tin
                        const car = data.data.car;
                        document.getElementById('carId').value = car.id;
                        document.getElementById('licensePlate').value = car.licensePlate || '';
                        document.getElementById('vinNumber').value = car.vinNumber || '';
                        document.getElementById('carName').value = car.carName || '';
                        document.getElementById('carModel').value = car.carModel || '';
                        document.getElementById('customerName').value = car.customerName || '';
                        document.getElementById('customerPhone').value = car.customerPhone || '';
                        document.getElementById('yearOfManufacture').value = car.yearOfManufacture || '';
                        
                        // Hiển thị thông tin xe tìm thấy
                        document.getElementById('vehicleInfo').innerHTML = `
                            <div class="row">
                                <div class="col-md-6">
                                    <strong>Biển số:</strong> ${car.licensePlate || '-'}<br>
                                    <strong>Số khung:</strong> ${car.vinNumber || '-'}<br>
                                    <strong>Xe:</strong> ${car.carName || '-'} ${car.carModel || ''}
                                </div>
                                <div class="col-md-6">
                                    <strong>Chủ xe:</strong> ${car.customerName || '-'}<br>
                                    <strong>SĐT:</strong> ${car.customerPhone || '-'}<br>
                                    <strong>Năm SX:</strong> ${car.yearOfManufacture || '-'}
                                </div>
                            </div>
                        `;
                        
                        document.getElementById('searchResults').style.display = 'block';
                        document.getElementById('noResults').style.display = 'none';
                        
                        showAlert('Tìm thấy xe trong hệ thống! Thông tin đã được tự động điền.', 'success');
                    } else {
                        // Xe chưa tồn tại - cho phép nhập thông tin mới
                        document.getElementById('carId').value = '';
                        document.getElementById('searchResults').style.display = 'none';
                        document.getElementById('noResults').style.display = 'block';
                        showAlert('Xe chưa có trong hệ thống. Vui lòng nhập thông tin xe mới.', 'info');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('Có lỗi xảy ra khi tìm kiếm xe', 'danger');
                });
        }

        async function createCheckin() {
            const carId = document.getElementById('carId').value;
            if (!carId) {
                showAlert('Vui lòng tìm kiếm xe trước khi tạo check-in', 'warning');
                return;
            }

            // Upload ảnh trước
            const imageUrls = await uploadImages();
            if (imageUrls === null) {
                showAlert('Có lỗi xảy ra khi upload ảnh', 'danger');
                return;
            }

            const formData = {
                carId: parseInt(carId),
                maintenanceRequestId: null,
                mileage: parseInt(document.getElementById('mileage').value),
                notes: document.getElementById('notes').value,
                imageUrls: imageUrls,
                branchId: parseInt(document.getElementById('branchId').value)
            };

            fetch('https://localhost:7173/api/VehicleCheckin', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Check-in xe thành công!', 'success');
                    setTimeout(() => {
                        window.location.href = '/VehicleCheckins';
                    }, 1500);
                } else {
                    showAlert('Lỗi: ' + data.message, 'danger');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('Có lỗi xảy ra khi check-in xe', 'danger');
            });
        }

        function previewImages() {
            const fileInput = document.getElementById('images');
            const preview = document.getElementById('imagePreview');
            const files = fileInput.files;
            
            preview.innerHTML = '';
            
            if (files.length > 0) {
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    if (file.type.startsWith('image/')) {
                        const reader = new FileReader();
                        reader.onload = function(e) {
                            const img = document.createElement('img');
                            img.src = e.target.result;
                            img.style.width = '100px';
                            img.style.height = '100px';
                            img.style.objectFit = 'cover';
                            img.style.margin = '5px';
                            img.style.border = '1px solid #ddd';
                            img.style.borderRadius = '5px';
                            preview.appendChild(img);
                        };
                        reader.readAsDataURL(file);
                    }
                }
            }
        }

        async function uploadImages() {
            const fileInput = document.getElementById('images');
            const files = fileInput.files;
            
            if (files.length === 0) {
                return []; // Không có ảnh nào
            }

            const imageUrls = [];
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                const formData = new FormData();
                formData.append('file', file);
                formData.append('folder', 'vehicle-checkins');

                try {
                    const response = await fetch('https://localhost:7173/api/Image/upload-temp', {
                        method: 'POST',
                        body: formData
                    });

                    if (response.ok) {
                        const result = await response.json();
                        if (result.success) {
                            imageUrls.push(result.data.url);
                        } else {
                            console.error('Upload failed:', result.message);
                            return null;
                        }
                    } else {
                        console.error('Upload failed with status:', response.status);
                        return null;
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                    return null;
                }
            }
            
            return imageUrls;
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.card-body').insertBefore(alertDiv, document.querySelector('form'));
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }
    </script>
}
