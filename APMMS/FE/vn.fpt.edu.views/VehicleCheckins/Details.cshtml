@{
    ViewData["Title"] = "Chi tiết check-in xe";
    Layout = "~/vn.fpt.edu.views/Shared/_DashboardLayout.cshtml";
    var apiBaseUrl = ViewBag.ApiBaseUrl ?? "https://localhost:7173/api";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                    <div class="d-flex justify-content-between align-items-center">
                        <h4 class="mb-0">
                            <i class="fas fa-eye me-2"></i>
                            Chi tiết check-in xe
                        </h4>
                        <div>
                            <a href="/VehicleCheckins/Edit/@ViewBag.CheckinId" class="btn btn-outline-light" id="editButton" style="display: none;">
                                <i class="fas fa-edit me-1"></i> Sửa
                            </a>
                            <button class="btn btn-light" onclick="createMaintenanceTicket()" id="createMaintenanceButton" style="display: none;">
                                <i class="fas fa-wrench me-1"></i> Tạo phiếu bảo dưỡng
                            </button>
                            <a href="/VehicleCheckins" class="btn btn-outline-light">
                                <i class="fas fa-arrow-left me-1"></i> Quay lại
                            </a>
                        </div>
                    </div>
                </div>
                <div class="card-body" style="background-color: #f8f9fa;">
                    <div id="loadingSpinner" class="text-center">
                        <div class="spinner-border" role="status">
                            <span class="visually-hidden">Đang tải...</span>
                        </div>
                    </div>
                    
                    <div id="checkinDetails" style="display: none;">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="card mb-4 border-0 shadow-sm">
                                    <div class="card-header" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: #2c3e50;">
                                        <h5 class="mb-0">
                                            <i class="fas fa-car me-2"></i>
                                            Thông tin xe
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                    <div class="row mb-2">
                                        <div class="col-sm-4"><strong>Mã:</strong></div>
                                        <div class="col-sm-8" id="checkinCode">-</div>
                                    </div>
                                    <div class="row mb-2">
                                        <div class="col-sm-4"><strong>Biển số:</strong></div>
                                        <div class="col-sm-8" id="licensePlate">-</div>
                                    </div>
                                    <div class="row mb-2">
                                        <div class="col-sm-4"><strong>Loại xe:</strong></div>
                                        <div class="col-sm-8" id="vehicleType">-</div>
                                    </div>
                                    <div class="row mb-2">
                                        <div class="col-sm-4"><strong>Chủ xe:</strong></div>
                                        <div class="col-sm-8" id="customerName">-</div>
                                    </div>
                                    <div class="row mb-2">
                                        <div class="col-sm-4"><strong>SĐT:</strong></div>
                                        <div class="col-sm-8" id="customerPhone">-</div>
                                    </div>
                                    <div class="row mb-2">
                                        <div class="col-sm-4"><strong>Số khung:</strong></div>
                                        <div class="col-sm-8" id="vinNumber">-</div>
                                    </div>
                                    <div class="row mb-2">
                                        <div class="col-sm-4"><strong>Số máy:</strong></div>
                                        <div class="col-sm-8" id="engineNumber">-</div>
                                    </div>
                                    <div class="row mb-2">
                                        <div class="col-sm-4"><strong>Màu xe:</strong></div>
                                        <div class="col-sm-8" id="carColor">-</div>
                                    </div>
                                    <div class="row mb-2">
                                        <div class="col-sm-4"><strong>Số km:</strong></div>
                                        <div class="col-sm-8" id="mileage">-</div>
                                    </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card mb-4 border-0 shadow-sm">
                                    <div class="card-header" style="background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%); color: #2c3e50;">
                                        <h5 class="mb-0">
                                            <i class="fas fa-clipboard-check me-2"></i>
                                            Thông tin check-in
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                    <div class="row mb-2">
                                        <div class="col-sm-4"><strong>Chi nhánh:</strong></div>
                                        <div class="col-sm-8" id="branchName">-</div>
                                    </div>
                                    <div class="row mb-2">
                                        <div class="col-sm-4"><strong>Trạng thái:</strong></div>
                                        <div class="col-sm-8" id="status">-</div>
                                    </div>
                                    <div class="row mb-2">
                                        <div class="col-sm-4"><strong>Ngày check-in:</strong></div>
                                        <div class="col-sm-8" id="checkinDate">-</div>
                                    </div>
                                    <div class="row mb-2">
                                        <div class="col-sm-4"><strong>Ngày tạo:</strong></div>
                                        <div class="col-sm-8" id="createdDate">-</div>
                                    </div>
                                    <div class="row mb-2">
                                        <div class="col-sm-4"><strong>Người tạo:</strong></div>
                                        <div class="col-sm-8" id="consulterName">-</div>
                                    </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Images Section -->
                        <div class="card mb-4 border-0 shadow-sm">
                            <div class="card-header" style="background: linear-gradient(135deg, #e0c3fc 0%, #9bb5ff 100%); color: #2c3e50;">
                                <h5 class="mb-0">
                                    <i class="fas fa-images me-2"></i>
                                    Hình ảnh xe
                                </h5>
                            </div>
                            <div class="card-body">
                                <div id="imagesContainer" class="row">
                                    <!-- Images will be loaded here -->
                                </div>
                            </div>
                        </div>

                        <!-- Notes Section -->
                        <div class="card mb-4 border-0 shadow-sm">
                            <div class="card-header" style="background: linear-gradient(135deg, #d299c2 0%, #fef9d7 100%); color: #2c3e50;">
                                <h5 class="mb-0">
                                    <i class="fas fa-sticky-note me-2"></i>
                                    Ghi chú
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="bg-light p-3 rounded">
                                    <p id="notes" class="mb-0">-</p>
                                </div>
                            </div>
                        </div>

                        <!-- Maintenance Request Section -->
                        <div id="maintenanceRequestSection" style="display: none;">
                            <div class="card mb-4 border-0 shadow-sm">
                                <div class="card-header" style="background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); color: #2c3e50;">
                                    <h5 class="mb-0">
                                        <i class="fas fa-tools me-2"></i>
                                        Yêu cầu bảo dưỡng
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="row mb-2">
                                                <div class="col-sm-4"><strong>Loại:</strong></div>
                                                <div class="col-sm-8" id="maintenanceType">-</div>
                                            </div>
                                            <div class="row mb-2">
                                                <div class="col-sm-4"><strong>Ưu tiên:</strong></div>
                                                <div class="col-sm-8" id="priority">-</div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="row mb-2">
                                                <div class="col-sm-4"><strong>Mô tả:</strong></div>
                                                <div class="col-sm-8" id="maintenanceDescription">-</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="errorMessage" class="alert alert-danger" style="display: none;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span id="errorText">Có lỗi xảy ra khi tải thông tin check-in</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let checkinData = null;

        document.addEventListener('DOMContentLoaded', function() {
            const checkinId = getCheckinIdFromUrl();
            if (checkinId) {
                loadCheckinDetails(checkinId);
            } else {
                showError('Không tìm thấy ID check-in');
            }
        });

        function getCheckinIdFromUrl() {
            const path = window.location.pathname;
            const segments = path.split('/');
            return segments[segments.length - 1];
        }

        function loadCheckinDetails(id) {
            fetch(`@apiBaseUrl/VehicleCheckin/${id}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                document.getElementById('loadingSpinner').style.display = 'none';
                
                if (data.success) {
                    checkinData = data.data;
                    displayCheckinDetails(data.data);
                } else {
                    showError('Lỗi khi tải thông tin: ' + data.message);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('loadingSpinner').style.display = 'none';
                showError('Có lỗi xảy ra khi tải thông tin check-in: ' + error.message);
            });
        }

        function displayCheckinDetails(checkin) {
            console.log('Displaying checkin details:', checkin); // Debug log
            console.log('BranchName from API:', checkin.branchName); // Debug branch name
            console.log('ConsulterName from API:', checkin.consulterName); // Debug consulter name
            
            document.getElementById('checkinCode').textContent = checkin.code || 'VCI-' + checkin.id;
            document.getElementById('licensePlate').textContent = checkin.licensePlate || '-';
            document.getElementById('vehicleType').textContent = checkin.carName || '-'; // Sử dụng carName thay vì vehicleType
            document.getElementById('customerName').textContent = checkin.customerName || '-';
            document.getElementById('customerPhone').textContent = checkin.customerPhone || '-';
            const vinNumber = checkin.vinNumber || '-';
            const engineNumber = checkin.vehicleEngineNumber || '-';
            document.getElementById('vinNumber').textContent = vinNumber;
            document.getElementById('engineNumber').textContent = engineNumber;
            // Chỉ hiển thị màu đỏ nếu không có giá trị
            if (vinNumber === '-') {
                document.getElementById('vinNumber').style.color = '#dc3545';
            }
            if (engineNumber === '-') {
                document.getElementById('engineNumber').style.color = '#dc3545';
            }
            document.getElementById('carColor').textContent = checkin.carColor || checkin.color || '-';
            document.getElementById('mileage').textContent = checkin.mileage ? checkin.mileage + ' km' : '-';
            document.getElementById('branchName').textContent = checkin.branchName || '-';
            document.getElementById('status').innerHTML = getStatusBadge(checkin.statusCode);
            document.getElementById('checkinDate').textContent = checkin.createdAt ? 
                new Date(checkin.createdAt).toLocaleString('vi-VN') : '-'; // Sử dụng createdAt thay vì checkinDate
            document.getElementById('createdDate').textContent = checkin.createdAt ? 
                new Date(checkin.createdAt).toLocaleString('vi-VN') : '-';
            document.getElementById('consulterName').textContent = checkin.consulterName || '-';
            document.getElementById('notes').textContent = checkin.notes || 'Không có ghi chú';

            // Hiển thị/ẩn nút Sửa dựa trên trạng thái
            const editButton = document.getElementById('editButton');
            if (checkin.statusCode === 'PENDING') {
                editButton.style.display = 'inline-block'; // Hiển thị nút Sửa
            } else {
                editButton.style.display = 'none'; // Ẩn nút Sửa
            }

            // Hiển thị/ẩn nút Tạo phiếu bảo dưỡng dựa trên trạng thái
            const createMaintenanceButton = document.getElementById('createMaintenanceButton');
            if (checkin.statusCode === 'CONFIRMED') {
                createMaintenanceButton.style.display = 'inline-block'; // Hiển thị nút Tạo phiếu bảo dưỡng
            } else {
                createMaintenanceButton.style.display = 'none'; // Ẩn nút Tạo phiếu bảo dưỡng
            }

            // Display images
            displayImages(checkin.images || []);

            // Display maintenance request if exists
            if (checkin.maintenanceRequest) {
                document.getElementById('maintenanceRequestSection').style.display = 'block';
                document.getElementById('maintenanceType').textContent = getMaintenanceTypeText(checkin.maintenanceRequest.type) || '-';
                document.getElementById('priority').innerHTML = getPriorityBadge(checkin.maintenanceRequest.priority);
                document.getElementById('maintenanceDescription').textContent = checkin.maintenanceRequest.description || '-';
            }
            
            document.getElementById('checkinDetails').style.display = 'block';
        }

        function displayImages(images) {
            console.log('Displaying images:', images); // Debug log
            const container = document.getElementById('imagesContainer');
            container.innerHTML = '';

            if (!images || images.length === 0) {
                console.log('No images found, showing placeholder');
                container.innerHTML = '<div class="col-12"><p class="text-muted">Không có hình ảnh</p></div>';
                return;
            }

            console.log(`Found ${images.length} images`);
            images.forEach((image, index) => {
                console.log(`Image ${index + 1}:`, image); // Debug log
                const col = document.createElement('div');
                col.className = 'col-md-3 mb-3';
                
                // Kiểm tra URL hình ảnh
                const imageUrl = image.imageUrl || image.url || image.src;
                const description = image.description || '';
                const category = image.category || '';
                console.log(`Image URL for ${index + 1}:`, imageUrl); // Debug log
                
                // Tạo badge cho category
                let categoryBadge = '';
                if (category) {
                    const categoryLabels = {
                        'Exterior': 'Ngoại thất',
                        'Interior': 'Nội thất',
                        'Damage': 'Hư hỏng',
                        'Engine': 'Động cơ',
                        'Tire': 'Lốp xe',
                        'Other': 'Khác'
                    };
                    const categoryLabel = categoryLabels[category] || category;
                    categoryBadge = `<span class="badge bg-info mb-1">${categoryLabel}</span>`;
                }
                
                col.innerHTML = `
                    <div class="card h-100">
                        <img src="${imageUrl}" class="card-img-top" style="height: 200px; object-fit: cover; cursor: pointer;" 
                             alt="Hình ảnh xe ${index + 1}" 
                             onerror="this.src='data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjAwIiBoZWlnaHQ9IjIwMCIgdmlld0JveD0iMCAwIDIwMCAyMDAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+CjxyZWN0IHdpZHRoPSIyMDAiIGhlaWdodD0iMjAwIiBmaWxsPSIjRjVGNUY1Ii8+Cjx0ZXh0IHg9IjEwMCIgeT0iMTAwIiBmb250LWZhbWlseT0iQXJpYWwiIGZvbnQtc2l6ZT0iMTQiIGZpbGw9IiM5OTk5OTkiIHRleHQtYW5jaG9yPSJtaWRkbGUiIGR5PSIuM2VtIj5Lb8O0bmcgY8O0IGjDsm5oIMSR4b5uPC90ZXh0Pgo8L3N2Zz4K'; this.alt='Không thể tải hình ảnh';"
                             onclick="openImageModal('${imageUrl}')">
                        <div class="card-body p-2">
                            ${categoryBadge}
                            ${description ? `<p class="card-text small mb-1" style="font-size: 0.85rem;">${description}</p>` : ''}
                            <small class="text-muted">Hình ${index + 1}</small>
                        </div>
                    </div>
                `;
                container.appendChild(col);
            });
        }

        function getVehicleTypeText(type) {
            switch(type) {
                case 'CAR': return 'Ô tô';
                case 'MOTORBIKE': return 'Xe máy';
                case 'TRUCK': return 'Xe tải';
                case 'BUS': return 'Xe bus';
                default: return type;
            }
        }

        function getStatusBadge(status) {
            switch(status) {
                case 'PENDING': return '<span class="badge bg-warning">Chờ xử lý</span>';
                case 'CONFIRMED': return '<span class="badge bg-success">Đã xác nhận</span>';
                default: return `<span class="badge bg-secondary">${status}</span>`;
            }
        }

        function getMaintenanceTypeText(type) {
            switch(type) {
                case 'ROUTINE': return 'Bảo dưỡng định kỳ';
                case 'REPAIR': return 'Sửa chữa';
                case 'INSPECTION': return 'Kiểm tra';
                case 'EMERGENCY': return 'Khẩn cấp';
                default: return type;
            }
        }

        function getPriorityBadge(priority) {
            switch(priority) {
                case 'LOW': return '<span class="badge bg-success">Thấp</span>';
                case 'MEDIUM': return '<span class="badge bg-warning">Trung bình</span>';
                case 'HIGH': return '<span class="badge bg-danger">Cao</span>';
                case 'URGENT': return '<span class="badge bg-dark">Khẩn cấp</span>';
                default: return `<span class="badge bg-secondary">${priority}</span>`;
            }
        }

        function createMaintenanceTicket() {
            if (checkinData) {
                if (confirm('Bạn có muốn tạo phiếu bảo dưỡng từ check-in này?')) {
                    window.location.href = `/MaintenanceTickets/CreateFromCheckin/${checkinData.id}`;
                }
            }
        }

        function openImageModal(imageUrl) {
            // Simple image modal
            const modal = document.createElement('div');
            modal.className = 'modal fade';
            modal.innerHTML = `
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h5 class="modal-title">Hình ảnh xe</h5>
                            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                        </div>
                        <div class="modal-body text-center">
                            <img src="${imageUrl}" class="img-fluid" alt="Hình ảnh xe">
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
            const bsModal = new bootstrap.Modal(modal);
            bsModal.show();
            
            modal.addEventListener('hidden.bs.modal', function() {
                document.body.removeChild(modal);
            });
        }

        function showError(message) {
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorMessage').style.display = 'block';
        }
    </script>
}
