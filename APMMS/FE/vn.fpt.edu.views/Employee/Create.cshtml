@{
    ViewData["Title"] = "T·∫°o nh√¢n vi√™n";
    Layout = "~/vn.fpt.edu.views/Shared/_DashboardLayout.cshtml";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">T·∫°o nh√¢n vi√™n</h4>
                    <button type="button" class="btn-close" onclick="window.location.href='/Employees'" aria-label="Close"></button>
                </div>
                <div class="card-body">
                    <div class="row">
                        <!-- Left Section: Avatar -->
                        <div class="col-md-4 text-center">
                            <div class="mb-3">
                                <img id="avatarPreview" 
                                     src="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='150' height='150'%3E%3Crect width='150' height='150' fill='%23e0e0e0'/%3E%3Ctext x='50%25' y='50%25' text-anchor='middle' dy='.3em' fill='%23999' font-size='60'%3Eüë§%3C/text%3E%3C/svg%3E" 
                                     alt="Avatar" 
                                     class="rounded-circle" 
                                     style="width: 150px; height: 150px; object-fit: cover; background-color: #e0e0e0; border: 3px solid #dee2e6;" />
                            </div>
                            <button type="button" class="btn btn-primary" onclick="document.getElementById('avatarUpload').click()">
                                <i class="fas fa-upload"></i> T·∫£i ·∫£nh l√™n
                            </button>
                            <input type="file" id="avatarUpload" accept="image/*" style="display: none;" onchange="previewAvatar(this)" />
                        </div>

                        <!-- Right Section: Form -->
                        <div class="col-md-8">
                            <h6 class="mb-3">Th√¥ng tin nh√¢n vi√™n</h6>
                            <form id="employeeForm">
                                <div class="row mb-2">
                                    <div class="col-md-4">
                                        <label for="username" class="form-label">T√†i kho·∫£n<span class="text-danger">*</span></label>
                                    </div>
                                    <div class="col-md-8">
                                        <input type="text" class="form-control" id="username" name="username" placeholder="VD: employee" required="required">
                                    </div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-md-4">
                                        <label for="password" class="form-label">M·∫≠t kh·∫©u<span class="text-danger">*</span></label>
                                    </div>
                                    <div class="col-md-8">
                                        <input type="password" class="form-control" id="password" name="password" required="required" placeholder="VD: Employee123">
                                    </div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-md-4">
                                        <label for="fullName" class="form-label">H·ªç v√† t√™n<span class="text-danger">*</span></label>
                                    </div>
                                    <div class="col-md-8">
                                        <input type="text" class="form-control" id="fullName" name="fullName" placeholder="VD: Nguy·ªÖn Nh√¢n Vi√™n" required="required">
                                    </div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-md-4">
                                        <label for="age" class="form-label">Tu·ªïi<span class="text-danger">*</span></label>
                                    </div>
                                    <div class="col-md-8">
                                        <input type="number" class="form-control" id="age" name="age" placeholder="VD: 22" min="1" max="150" required="required">
                                    </div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-md-4">
                                        <label for="gender" class="form-label">Gi·ªõi t√≠nh</label>
                                    </div>
                                    <div class="col-md-8">
                                        <select class="form-select" id="gender" name="gender">
                                            <option value="">Gi·ªõi t√≠nh</option>
                                            <option value="Nam">Nam</option>
                                            <option value="N·ªØ">N·ªØ</option>
                                            <option value="Kh√°c">Kh√°c</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-md-4">
                                        <label for="phone" class="form-label">ƒêi·ªán tho·∫°i<span class="text-danger">*</span></label>
                                    </div>
                                    <div class="col-md-8">
                                        <input type="tel" class="form-control" id="phone" name="phone" placeholder="VD: 0396xxxxxx" required="required">
                                    </div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-md-4">
                                        <label for="email" class="form-label">Email<span class="text-danger">*</span></label>
                                    </div>
                                    <div class="col-md-8">
                                        <input type="email" class="form-control" id="email" name="email" placeholder="VD: employee@gmail.com" required="required">
                                    </div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-md-4">
                                        <label for="citizenId" class="form-label">CMT/CCCD<span class="text-danger">*</span></label>
                                    </div>
                                    <div class="col-md-8">
                                        <input type="text" class="form-control" id="citizenId" name="citizenId" placeholder="VD: xxxxxxxxxx (12 s·ªë)" maxlength="12" required="required">
                                    </div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-md-4">
                                        <label for="address" class="form-label">ƒê·ªãa ch·ªâ<span class="text-danger">*</span></label>
                                    </div>
                                    <div class="col-md-8">
                                        <textarea class="form-control" id="address" name="address" rows="3" placeholder="VD: 11 Ng√µ ABC, ƒê∆∞·ªùng DEF, Huy·ªán GHI, T·ªânh KLM, Th√†nh ph·ªë NOU" required="required"></textarea>
                                    </div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-md-4">
                                        <label for="taxCode" class="form-label">M√£ s·ªë thu·∫ø<span class="text-danger">*</span></label>
                                    </div>
                                    <div class="col-md-8">
                                        <input type="text" class="form-control" id="taxCode" name="taxCode" placeholder="VD: xxxxxxxxxx (10 s·ªë)" maxlength="10" required="required">
                                    </div>
                                </div>
                                <div class="row mb-2">
                                    <div class="col-md-4">
                                        <label for="roleId" class="form-label">Ch·ª©c v·ª•<span class="text-danger">*</span></label>
                                    </div>
                                    <div class="col-md-8">
                                        <select class="form-select" id="roleId" name="roleId" required="required">
                                            <option value="">Ch·ª©c v·ª•</option>
                                            <option value="3">Accountant</option>
                                            <option value="4">Technician</option>
                                            <option value="5">Warehouse Keeper</option>
                                            <option value="6">Consulter</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="row mt-4">
                                    <div class="col-md-12 d-flex justify-content-end gap-2">
                                        <a href="/Employees" class="btn btn-secondary">ƒê√≥ng</a>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="fas fa-plus"></i> T·∫°o nh√¢n vi√™n
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('employeeForm').addEventListener('submit', function(e) {
                e.preventDefault();
                createEmployee();
            });
        });

        // Avatar preview function
        function previewAvatar(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('avatarPreview').src = e.target.result;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }

        function createEmployee() {
            const form = document.getElementById('employeeForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            // Split full name into first and last name
            const fullName = document.getElementById('fullName').value.trim();
            const nameParts = fullName.split(' ');
            const firstName = nameParts[0] || '';
            const lastName = nameParts.slice(1).join(' ') || '';

            const formData = {
                username: document.getElementById('username').value,
                password: document.getElementById('password').value,
                firstName: firstName,
                lastName: lastName,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                gender: document.getElementById('gender').value || null,
                roleId: parseInt(document.getElementById('roleId').value),
                taxCode: document.getElementById('taxCode').value,
                image: '', // Will be handled separately if needed
                branchId: null // Can be set from current user context if needed
            };

            // Handle image upload if file is selected
            const imageFile = document.getElementById('avatarUpload').files[0];
            if (imageFile) {
                // TODO: Upload image to server first, then get URL
                // For now, we'll create without image
                alert('T√≠nh nƒÉng upload ·∫£nh ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn. Nh√¢n vi√™n s·∫Ω ƒë∆∞·ª£c t·∫°o kh√¥ng c√≥ ·∫£nh.');
            }

            fetch('https://localhost:7173/api/Employee', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${localStorage.getItem('token')}`
                },
                body: JSON.stringify(formData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.message || `HTTP error! status: ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                // Show success message
                showAlert('T·∫°o nh√¢n vi√™n th√†nh c√¥ng!', 'success');

                // Redirect to employee list after 1.5 seconds
                setTimeout(() => {
                    window.location.href = '/Employees';
                }, 1500);
            })
            .catch(error => {
                console.error('Error:', error);
                showAlert('C√≥ l·ªói x·∫£y ra khi t·∫°o nh√¢n vi√™n: ' + error.message, 'danger');
            });
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.card-body').insertBefore(alertDiv, document.querySelector('.row'));
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }
    </script>
}
