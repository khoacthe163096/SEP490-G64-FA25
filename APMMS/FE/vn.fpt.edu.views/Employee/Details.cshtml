@{
    ViewData["Title"] = "Th√¥ng tin chi ti·∫øt nh√¢n vi√™n";
    Layout = "~/vn.fpt.edu.views/Shared/_DashboardLayout.cshtml";
}

<!-- Breadcrumb -->
<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/Employees">Danh s√°ch nh√¢n vi√™n</a></li>
        <li class="breadcrumb-item active" id="employeeNameBreadcrumb">-</li>
    </ol>
</nav>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div id="loadingSpinner" class="text-center p-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">ƒêang t·∫£i...</span>
                    </div>
                </div>
                
                <div id="employeeDetails" style="display: none;">
                    <div class="row">
                        <!-- Left Section: Avatar and Name -->
                        <div class="col-md-3 text-center" style="background-color: #f8f9fa; padding: 40px 20px;">
                            <div class="mb-4">
                                <img id="employeeAvatar" src="" alt="Avatar" 
                                     class="rounded-circle" 
                                     style="width: 150px; height: 150px; object-fit: cover; background-color: #e0e0e0; border: 3px solid #dee2e6;"
                                     onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'150\' height=\'150\'%3E%3Crect width=\'150\' height=\'150\' fill=\'%23e0e0e0\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'%23999\' font-size=\'60\'%3Eüë§%3C/text%3E%3C/svg%3E';">
                            </div>
                            <h4 id="employeeFullName" class="mb-0" style="font-weight: 600;">-</h4>
                        </div>

                        <!-- Right Section: Tabs and Details -->
                        <div class="col-md-9">
                            <!-- Tabs -->
                            <ul class="nav nav-tabs mb-3" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="personal-tab" data-bs-toggle="tab" 
                                            data-bs-target="#personal" type="button" role="tab" 
                                            aria-controls="personal" aria-selected="true">
                                        Th√¥ng tin c√° nh√¢n
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="edit-tab" data-bs-toggle="tab" 
                                            data-bs-target="#edit" type="button" role="tab" 
                                            aria-controls="edit" aria-selected="false">
                                        Ch·ªânh s·ª≠a th√¥ng tin
                                    </button>
                                </li>
                            </ul>

                            <!-- Tab Content -->
                            <div class="tab-content">
                                <!-- Personal Information Tab -->
                                <div class="tab-pane fade show active" id="personal" role="tabpanel" aria-labelledby="personal-tab">
                                    <h5 class="mb-4">Th√¥ng tin chi ti·∫øt</h5>
                                    
                                    <div class="row mb-3">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">M√£:</label>
                                                <div id="employeeCode" class="text-muted">-</div>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">T√™n nh√¢n vi√™n:</label>
                                                <div id="employeeName" class="text-muted">-</div>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">Tu·ªïi:</label>
                                                <div id="employeeAge" class="text-muted">-</div>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">Gi·ªõi t√≠nh:</label>
                                                <div id="employeeGender" class="text-muted">-</div>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">S·ªë ƒëi·ªán tho·∫°i:</label>
                                                <div id="employeePhone" class="text-muted">-</div>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">Email:</label>
                                                <div id="employeeEmail" class="text-muted">-</div>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">ƒê·ªãa ch·ªâ:</label>
                                                <div id="employeeAddress" class="text-muted">-</div>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">CMT/CCCD:</label>
                                                <div id="employeeCitizenId" class="text-muted">-</div>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">M√£ s·ªë thu·∫ø:</label>
                                                <div id="employeeTaxCode" class="text-muted">-</div>
                                            </div>
                                            <div class="mb-3">
                                                <label class="form-label fw-bold">T√¨nh tr·∫°ng:</label>
                                                <div id="employeeStatus">-</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Edit Tab -->
                                <div class="tab-pane fade" id="edit" role="tabpanel" aria-labelledby="edit-tab">
                                    <form id="editEmployeeForm">
                                        <div class="row mb-3">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="editFirstName" class="form-label fw-bold">H·ªç v√† t√™n:</label>
                                                    <input type="text" class="form-control" id="editFirstName" required>
                                                    <small class="text-muted">Nh·∫≠p ƒë·∫ßy ƒë·ªß h·ªç v√† t√™n</small>
                                                </div>
                                                <div class="mb-3">
                                                    <label for="editAge" class="form-label fw-bold">Tu·ªïi:</label>
                                                    <input type="number" class="form-control" id="editAge" min="1" max="150">
                                                </div>
                                                <div class="mb-3">
                                                    <label for="editPhone" class="form-label fw-bold">S·ªë ƒëi·ªán tho·∫°i:</label>
                                                    <input type="tel" class="form-control" id="editPhone">
                                                </div>
                                                <div class="mb-3">
                                                    <label for="editGender" class="form-label fw-bold">Gi·ªõi t√≠nh:</label>
                                                    <select class="form-select" id="editGender">
                                                        <option value="">-- Ch·ªçn gi·ªõi t√≠nh --</option>
                                                        <option value="Nam">Nam</option>
                                                        <option value="N·ªØ">N·ªØ</option>
                                                        <option value="Kh√°c">Kh√°c</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="editEmail" class="form-label fw-bold">Email:</label>
                                                    <input type="email" class="form-control" id="editEmail">
                                                </div>
                                                <div class="mb-3">
                                                    <label for="editAddress" class="form-label fw-bold">ƒê·ªãa ch·ªâ:</label>
                                                    <input type="text" class="form-control" id="editAddress">
                                                </div>
                                                <div class="mb-3">
                                                    <label for="editTaxCode" class="form-label fw-bold">M√£ s·ªë thu·∫ø:</label>
                                                    <input type="text" class="form-control" id="editTaxCode">
                                                </div>
                                                <div class="mb-3">
                                                    <label for="editCitizenId" class="form-label fw-bold">CMT/CCCD:</label>
                                                    <input type="text" class="form-control" id="editCitizenId">
                                                </div>
                                                <div class="mb-3">
                                                    <label for="editImage" class="form-label fw-bold">H√¨nh ·∫£nh:</label>
                                                    <input type="file" class="form-control" id="editImage" accept="image/*">
                                                    <small class="text-muted">Ch·ªçn file h√¨nh ·∫£nh m·ªõi (n·∫øu c·∫ßn)</small>
                                                    <div id="currentImagePreview" class="mt-2"></div>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="d-flex justify-content-end">
                                            <button type="button" class="btn btn-secondary me-2" onclick="resetEditForm()">H·ªßy</button>
                                            <button type="submit" class="btn btn-primary">
                                                <i class="fas fa-save"></i> L∆∞u th√¥ng tin
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="errorMessage" class="alert alert-danger m-3" style="display: none;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span id="errorText">C√≥ l·ªói x·∫£y ra khi t·∫£i th√¥ng tin nh√¢n vi√™n</span>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const employeeId = getEmployeeIdFromUrl();
            if (employeeId) {
                loadEmployeeDetails(employeeId);
            } else {
                showError('Kh√¥ng t√¨m th·∫•y ID nh√¢n vi√™n');
            }
        });

        function getEmployeeIdFromUrl() {
            const path = window.location.pathname;
            const segments = path.split('/');
            return segments[segments.length - 1];
        }

        function loadEmployeeDetails(id) {
            const token = localStorage.getItem('authToken');
            fetch(`https://localhost:7173/api/Employee/${id}`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                document.getElementById('loadingSpinner').style.display = 'none';
                
                // API tr·∫£ v·ªÅ tr·ª±c ti·∫øp EmployeeResponseDto
                if (data && data.id) {
                    displayEmployeeDetails(data);
                } else if (data && data.success && data.data) {
                    displayEmployeeDetails(data.data);
                } else {
                    showError('Kh√¥ng t√¨m th·∫•y th√¥ng tin nh√¢n vi√™n');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                document.getElementById('loadingSpinner').style.display = 'none';
                showError('C√≥ l·ªói x·∫£y ra khi t·∫£i th√¥ng tin nh√¢n vi√™n: ' + error.message);
            });
        }

        let currentEmployee = null;
        let originalFormData = null;

        function displayEmployeeDetails(employee) {
            currentEmployee = employee;
            const fullName = `${(employee.firstName || '')} ${(employee.lastName || '')}`.trim() || '-';
            
            // Breadcrumb
            document.getElementById('employeeNameBreadcrumb').textContent = fullName;
            
            // Avatar
            const avatar = document.getElementById('employeeAvatar');
            if (employee.image) {
                avatar.src = employee.image;
            }
            
            // Left section
            document.getElementById('employeeFullName').textContent = fullName;
            
            // Details
            document.getElementById('employeeCode').textContent = employee.code || '-';
            document.getElementById('employeeName').textContent = fullName;
            document.getElementById('employeeAge').textContent = employee.age ? employee.age + ' tu·ªïi' : '-';
            document.getElementById('employeeGender').textContent = 
                employee.gender === 'Male' || employee.gender === 'Nam' ? 'Nam' :
                employee.gender === 'Female' || employee.gender === 'N·ªØ' ? 'N·ªØ' : 
                employee.gender || '-';
            document.getElementById('employeePhone').textContent = employee.phone || '-';
            document.getElementById('employeeEmail').textContent = employee.email || '-';
            document.getElementById('employeeAddress').textContent = employee.fullAddress || '-';
            document.getElementById('employeeCitizenId').textContent = employee.citizenId || '-';
            document.getElementById('employeeTaxCode').textContent = employee.taxCode || '-';
            
            // Status
            const isActive = !employee.isDelete;
            const statusDiv = document.getElementById('employeeStatus');
            statusDiv.innerHTML = isActive 
                ? '<span class="badge bg-success" style="padding: 5px 10px;">C√≥ hi·ªáu l·ª±c</span>'
                : '<span class="badge bg-secondary" style="padding: 5px 10px;">Kh√¥ng hi·ªáu l·ª±c</span>';
            
            // Load data into edit form
            loadEditForm(employee);
            
            document.getElementById('employeeDetails').style.display = 'block';
        }

        function loadEditForm(employee) {
            // Combine first and last name for display
            const fullName = `${(employee.firstName || '')} ${(employee.lastName || '')}`.trim();

            document.getElementById('editFirstName').value = fullName;
            document.getElementById('editAge').value = employee.age || '';
            document.getElementById('editPhone').value = employee.phone || '';
            document.getElementById('editGender').value = 
                employee.gender === 'Male' || employee.gender === 'Nam' ? 'Nam' :
                employee.gender === 'Female' || employee.gender === 'N·ªØ' ? 'N·ªØ' : 
                employee.gender || '';
            document.getElementById('editEmail').value = employee.email || '';
            document.getElementById('editAddress').value = employee.fullAddress || '';
            document.getElementById('editTaxCode').value = employee.taxCode || '';
            document.getElementById('editCitizenId').value = employee.citizenId || '';

            // Image preview
            const imagePreview = document.getElementById('currentImagePreview');
            if (employee.image) {
                imagePreview.innerHTML = `
                    <img src="${employee.image}" alt="Current image" 
                         style="max-width: 150px; max-height: 150px; border-radius: 5px;">
                `;
            } else {
                imagePreview.innerHTML = '<span class="text-muted">Ch∆∞a c√≥ h√¨nh ·∫£nh</span>';
            }

            // Store original data
            originalFormData = {
                firstName: fullName,
                age: employee.age || '',
                phone: employee.phone || '',
                gender: document.getElementById('editGender').value,
                email: employee.email || '',
                address: employee.fullAddress || '',
                taxCode: employee.taxCode || '',
                citizenId: employee.citizenId || ''
            };
        }

        function resetEditForm() {
            if (originalFormData) {
                document.getElementById('editFirstName').value = originalFormData.firstName;
                document.getElementById('editAge').value = originalFormData.age;
                document.getElementById('editPhone').value = originalFormData.phone;
                document.getElementById('editGender').value = originalFormData.gender;
                document.getElementById('editEmail').value = originalFormData.email;
                document.getElementById('editAddress').value = originalFormData.address;
                document.getElementById('editTaxCode').value = originalFormData.taxCode;
                document.getElementById('editCitizenId').value = originalFormData.citizenId;
                document.getElementById('editImage').value = '';
            }
        }

        function showError(message) {
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorMessage').style.display = 'block';
        }

        // Handle edit form submission
        document.getElementById('editEmployeeForm')?.addEventListener('submit', function(e) {
            e.preventDefault();
            saveEmployeeChanges();
        });

        function saveEmployeeChanges() {
            if (!currentEmployee) {
                showError('Kh√¥ng t√¨m th·∫•y th√¥ng tin nh√¢n vi√™n');
                return;
            }

            // Split full name into first and last name
            const fullNameInput = document.getElementById('editFirstName').value.trim();
            const nameParts = fullNameInput.split(' ');
            const firstName = nameParts[0] || '';
            const lastName = nameParts.slice(1).join(' ') || '';

            const formData = {
                username: currentEmployee.username || '',
                password: '', // Don't update password if empty - backend should handle this
                firstName: firstName,
                lastName: lastName,
                email: document.getElementById('editEmail').value,
                phone: document.getElementById('editPhone').value,
                gender: document.getElementById('editGender').value,
                image: currentEmployee.image || '', // Will be updated if new image is uploaded
                roleId: currentEmployee.roleId || null,
                branchId: currentEmployee.branchId || null,
                taxCode: document.getElementById('editTaxCode').value
            };

            // Handle image upload if file is selected
            const imageFile = document.getElementById('editImage').files[0];
            if (imageFile) {
                // TODO: Upload image to server first, then get URL
                // For now, we'll skip image upload and keep existing image
                alert('T√≠nh nƒÉng upload ·∫£nh ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn. Vui l√≤ng s·ª≠ d·ª•ng API ri√™ng ƒë·ªÉ upload ·∫£nh.');
            }

            const token = localStorage.getItem('authToken');
            fetch(`https://localhost:7173/api/Employee/${currentEmployee.id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(formData)
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(err => {
                        throw new Error(err.message || `HTTP error! status: ${response.status}`);
                    });
                }
                return response.json();
            })
            .then(data => {
                // Reload employee details
                loadEmployeeDetails(currentEmployee.id);
                
                // Show success message
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show';
                alertDiv.innerHTML = `
                    <i class="fas fa-check-circle"></i> C·∫≠p nh·∫≠t th√¥ng tin th√†nh c√¥ng!
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                document.querySelector('.card-body').insertBefore(alertDiv, document.querySelector('.tab-content'));
                
                // Switch to personal info tab
                const personalTab = document.getElementById('personal-tab');
                if (personalTab) {
                    personalTab.click();
                }

                setTimeout(() => {
                    alertDiv.remove();
                }, 3000);
            })
            .catch(error => {
                console.error('Error:', error);
                showError('C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t th√¥ng tin: ' + error.message);
            });
        }
    </script>
}
