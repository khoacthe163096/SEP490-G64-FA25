@{
    ViewData["Title"] = "Chỉnh sửa lịch hẹn";
    Layout = "~/vn.fpt.edu.views/Shared/_DashboardLayout.cshtml";
    var apiBaseUrl = ViewBag.ApiBaseUrl ?? "https://localhost:7173/api";
    var scheduleId = ViewBag.ServiceScheduleId;
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-edit me-2"></i>
                        Chỉnh sửa lịch hẹn
                    </h4>
                </div>
                <div class="card-body">
                    <div id="loadingSpinner" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                    <form id="scheduleForm" style="display: none;">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Khách hàng</label>
                                    <input type="text" class="form-control" id="userName" readonly>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Xe</label>
                                    <input type="text" class="form-control" id="carInfo" readonly>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Chi nhánh</label>
                                    <input type="text" class="form-control" id="branchName" readonly>
                                    <input type="hidden" id="branchId">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="scheduledDate" class="form-label">Ngày và giờ hẹn <span class="text-danger">*</span></label>
                                    <input type="datetime-local" class="form-control" id="scheduledDate" required>
                                </div>
                            </div>
                        </div>


                        <div class="alert alert-warning">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Lưu ý:</strong> Không thể chỉnh sửa lịch hẹn đã hủy hoặc đã hoàn thành.
                        </div>

                        <div class="d-flex justify-content-between">
                            <a href="/ServiceSchedules/Details/@scheduleId" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-1"></i>
                                Quay lại
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i>
                                Lưu thay đổi
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const API_BASE_URL = '@apiBaseUrl';
        const scheduleId = @scheduleId;

        $(document).ready(function() {
            loadScheduleDetails();

            $('#scheduleForm').on('submit', function(e) {
                e.preventDefault();
                updateSchedule();
            });
        });

        function loadScheduleDetails() {
            const token = localStorage.getItem('authToken');
            fetch(`${API_BASE_URL}/ServiceSchedule/${scheduleId}`, {
                headers: {
                    'Authorization': token ? `Bearer ${token}` : '',
                    'Content-Type': 'application/json'
                }
            })
            .then(async response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return response.json();
            })
            .then(result => {
                if (result.success && result.data) {
                    const schedule = result.data;
                    
                    if (schedule.statusCode === 'CANCELLED' || schedule.statusCode === 'COMPLETED' || schedule.statusCode === 'CONFIRMED') {
                        showToast('Không thể chỉnh sửa lịch hẹn đã hủy hoặc đã hoàn thành', 'error');
                        setTimeout(() => {
                        window.location.href = '/ServiceSchedules/Details/' + scheduleId;
                        }, 2000);
                        return;
                    }

                    $('#userName').val(schedule.userName || '');
                    $('#carInfo').val(`${schedule.carName || ''} - ${schedule.licensePlate || ''}`);
                    
                    // Lấy chi nhánh từ consulter (nếu đã nhận đơn) hoặc từ schedule
                    const branchId = schedule.consultantBranchId || schedule.branchId;
                    const branchName = schedule.consultantBranchName || schedule.branchName || 'Chưa xác định';
                    $('#branchId').val(branchId || '');
                    $('#branchName').val(branchName);
                    
                    // Xử lý timezone - backend trả về UTC, cần convert sang local time cho datetime-local input
                    let scheduleDateStr = schedule.scheduledDate;
                    if (typeof scheduleDateStr === 'string' && !scheduleDateStr.endsWith('Z') && !scheduleDateStr.includes('+') && !scheduleDateStr.includes('-', 10)) {
                        scheduleDateStr = scheduleDateStr + 'Z';
                    }
                    const date = new Date(scheduleDateStr);
                    
                    // Convert sang format datetime-local (YYYY-MM-DDTHH:mm)
                    const year = date.getFullYear();
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const day = String(date.getDate()).padStart(2, '0');
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    const dateTimeLocal = `${year}-${month}-${day}T${hours}:${minutes}`;
                    $('#scheduledDate').val(dateTimeLocal);
                    
                    // Set min date to now (cho phép chọn từ bây giờ)
                    const now = new Date();
                    const minDate = now.toISOString().slice(0, 16);
                    $('#scheduledDate').attr('min', minDate);

                    $('#loadingSpinner').hide();
                    $('#scheduleForm').show();
                } else {
                    showToast('Không tìm thấy lịch hẹn', 'error');
                }
            })
            .catch(error => {
                console.error('Error loading schedule:', error);
                $('#loadingSpinner').html('<p class="text-danger">Lỗi tải dữ liệu: ' + error.message + '</p>');
            });
        }


        function updateSchedule() {
            // Validation
            const branchId = $('#branchId').val();
            const scheduledDate = $('#scheduledDate').val();
            
            if (!branchId) {
                showToast('Không tìm thấy chi nhánh', 'error');
                return;
            }
            
            if (!scheduledDate) {
                showToast('Vui lòng chọn ngày và giờ hẹn', 'error');
                return;
            }
            
            // Kiểm tra ngày hẹn phải trong tương lai
            const selectedDate = new Date(scheduledDate);
            const now = new Date();
            if (selectedDate <= now) {
                showToast('Ngày và giờ hẹn phải trong tương lai', 'error');
                return;
            }

            const token = localStorage.getItem('authToken');
            // datetime-local input trả về local time, cần convert sang UTC để gửi lên server
            const scheduledDateObj = new Date(scheduledDate);

            const payload = {
                branchId: parseInt(branchId),
                scheduledDate: scheduledDateObj.toISOString(), // Convert local time sang UTC
                statusCode: 'IN_PROGRESS' // Tự động set status thành "Đang xử lý" khi chỉnh sửa
            };

            // Disable button và hiển thị loading
            const submitBtn = $('#scheduleForm button[type="submit"]');
            const originalText = submitBtn.html();
            submitBtn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin me-1"></i> Đang lưu...');

            fetch(`${API_BASE_URL}/ServiceSchedule/${scheduleId}`, {
                method: 'PUT',
                headers: {
                    'Authorization': token ? `Bearer ${token}` : '',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
            .then(async response => {
                const result = await response.json();
                if (result.success) {
                    showToast('Cập nhật lịch hẹn thành công!', 'success');
                    setTimeout(() => {
                    window.location.href = '/ServiceSchedules/Details/' + scheduleId;
                    }, 1500);
                } else {
                    showToast('Lỗi: ' + (result.message || 'Không thể cập nhật lịch hẹn'), 'error');
                }
            })
            .catch(error => {
                console.error('Error updating schedule:', error);
                showToast('Lỗi khi cập nhật lịch hẹn. Vui lòng thử lại.', 'error');
            })
            .finally(() => {
                submitBtn.prop('disabled', false).html(originalText);
            });
        }

        function showToast(message, type) {
            const bgColor = type === 'success' ? '#28a745' : '#dc3545';
            const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
            
            const toast = $(`
                <div class="toast-notification" style="
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background-color: ${bgColor};
                    color: white;
                    padding: 12px 20px;
                    border-radius: 4px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                    z-index: 9999;
                    min-width: 250px;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                ">
                    <i class="fas ${icon}"></i>
                    <span>${message}</span>
                </div>
            `);
            
            $('body').append(toast);
            
            setTimeout(() => {
                toast.fadeOut(300, function() {
                    $(this).remove();
                });
            }, 3000);
        }
    </script>
}

