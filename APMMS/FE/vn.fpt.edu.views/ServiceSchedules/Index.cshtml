@{
    ViewData["Title"] = "Danh sách đặt lịch";
    Layout = "~/vn.fpt.edu.views/Shared/_DashboardLayout.cshtml";
    var apiBaseUrl = ViewBag.ApiBaseUrl ?? "https://localhost:7173/api";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="fas fa-calendar-alt me-2"></i>
                        Danh sách đặt lịch hẹn
                    </h4>
                    <a href="/ServiceSchedules/Create" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Đặt lịch mới
                    </a>
                </div>
                <div class="card-body">
                    <!-- Search and Filter -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label for="searchInput" class="form-label">Tìm kiếm</label>
                            <input type="text" class="form-control" id="searchInput" placeholder="Tìm theo tên, biển số...">
                        </div>
                        <div class="col-md-2">
                            <label for="dateFilter" class="form-label">Ngày hẹn</label>
                            <input type="date" class="form-control" id="dateFilter">
                        </div>
                        <div class="col-md-2">
                            <label for="statusFilter" class="form-label">Trạng thái</label>
                            <select class="form-select" id="statusFilter">
                                <option value="">Tất cả trạng thái</option>
                                <option value="PENDING">Chờ xử lý</option>
                                <option value="CONFIRMED">Đã xác nhận</option>
                                <option value="CANCELLED">Đã hủy</option>
                                <option value="COMPLETED">Hoàn thành</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <button class="btn btn-outline-secondary w-100" id="filterBtn">
                                <i class="fas fa-filter"></i> Lọc
                            </button>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <button class="btn btn-outline-secondary w-100" id="resetBtn">
                                <i class="fas fa-redo"></i> Làm mới
                            </button>
                        </div>
                    </div>

                    <!-- Table -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>STT</th>
                                    <th>Khách hàng</th>
                                    <th>Xe</th>
                                    <th>Biển số</th>
                                    <th>Chi nhánh</th>
                                    <th>Ngày hẹn</th>
                                    <th>Giờ hẹn</th>
                                    <th>Trạng thái</th>
                                    <th>Người xử lý</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody id="serviceSchedulesTableBody">
                                <tr>
                                    <td colspan="10" class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-center" id="pagination">
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const API_BASE_URL = '@apiBaseUrl';
        let currentPage = 1;
        const pageSize = 10;

        $(document).ready(function() {
            loadServiceSchedules();

            $('#filterBtn').on('click', function() {
                currentPage = 1;
                loadServiceSchedules();
            });

            $('#resetBtn').on('click', function() {
                $('#searchInput').val('');
                $('#dateFilter').val('');
                $('#statusFilter').val('');
                currentPage = 1;
                loadServiceSchedules();
            });

            $('#searchInput').on('keypress', function(e) {
                if (e.which === 13) {
                    currentPage = 1;
                    loadServiceSchedules();
                }
            });
        });

        function loadServiceSchedules() {
            const token = localStorage.getItem('authToken');
            const status = $('#statusFilter').val();
            const date = $('#dateFilter').val();
            const search = $('#searchInput').val();

            // Lấy branchId từ userInfo hoặc JWT token
            let userBranchId = null;
            try {
                const userInfoStr = localStorage.getItem('userInfo');
                if (userInfoStr) {
                    const userInfo = JSON.parse(userInfoStr);
                    userBranchId = userInfo.branchId || userInfo.BranchId;
                }
                
                // Nếu không có trong userInfo, thử decode từ JWT token
                if (!userBranchId && token) {
                    try {
                        const payload = JSON.parse(atob(token.split('.')[1]));
                        userBranchId = payload['BranchId'] || payload['branchId'] || payload['http://schemas.xmlsoap.org/ws/2005/05/identity/claims/branchid'];
                        if (userBranchId) {
                            userBranchId = parseInt(userBranchId, 10);
                        }
                    } catch (e) {
                        console.warn('Could not get branchId from token:', e);
                    }
                }
            } catch (error) {
                console.warn('Error getting branchId:', error);
            }

            let url = `${API_BASE_URL}/ServiceSchedule?page=${currentPage}&pageSize=${pageSize}`;
            
            // Thêm branchId vào query nếu có
            if (userBranchId) {
                url += `&branchId=${userBranchId}`;
            }
            
            if (status) {
                url = `${API_BASE_URL}/ServiceSchedule/by-status/${status}`;
                if (userBranchId) {
                    url += `?branchId=${userBranchId}`;
                }
            } else if (date) {
                const startDate = new Date(date);
                const endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + 1);
                url = `${API_BASE_URL}/ServiceSchedule/by-date-range?startDate=${startDate.toISOString().split('T')[0]}&endDate=${endDate.toISOString().split('T')[0]}`;
                if (userBranchId) {
                    url += `&branchId=${userBranchId}`;
                }
            }

            fetch(url, {
                headers: {
                    'Authorization': token ? `Bearer ${token}` : '',
                    'Content-Type': 'application/json'
                }
            })
            .then(async response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return response.json();
            })
            .then(result => {
                if (result.success && result.data) {
                    let schedules = result.data;
                    
                    // Filter by search if needed
                    if (search) {
                        const searchLower = search.toLowerCase();
                        schedules = schedules.filter(s => 
                            (s.userName && s.userName.toLowerCase().includes(searchLower)) ||
                            (s.licensePlate && s.licensePlate.toLowerCase().includes(searchLower)) ||
                            (s.carName && s.carName.toLowerCase().includes(searchLower))
                        );
                    }

                    displayServiceSchedules(schedules);
                } else {
                    $('#serviceSchedulesTableBody').html('<tr><td colspan="10" class="text-center text-muted">Không có dữ liệu</td></tr>');
                }
            })
            .catch(error => {
                console.error('Error loading schedules:', error);
                $('#serviceSchedulesTableBody').html('<tr><td colspan="10" class="text-center text-danger">Lỗi tải dữ liệu: ' + error.message + '</td></tr>');
            });
        }

        function displayServiceSchedules(schedules) {
            const tbody = $('#serviceSchedulesTableBody');
            tbody.empty();

            if (schedules.length === 0) {
                tbody.html('<tr><td colspan="10" class="text-center text-muted">Không có lịch hẹn nào</td></tr>');
                return;
            }

            let currentUserId = null;
            try {
                const userInfoStr = localStorage.getItem('userInfo');
                if (userInfoStr) {
                    const userInfo = JSON.parse(userInfoStr);
                    currentUserId = Number(userInfo.userId || userInfo.id || userInfo.UserId);
                }
            } catch (err) {
                console.warn('Không thể đọc thông tin người dùng hiện tại:', err);
            }

            schedules.forEach((schedule, index) => {
                const date = new Date(schedule.scheduledDate);
                const formattedDate = date.toLocaleDateString('vi-VN');
                const formattedTime = date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });
                const acceptedAt = schedule.acceptedAt ? new Date(schedule.acceptedAt).toLocaleString('vi-VN') : null;

                let statusBadge = '';
                switch(schedule.statusCode) {
                    case 'PENDING':
                        statusBadge = '<span class="badge bg-warning">Chờ xử lý</span>';
                        break;
                    case 'IN_PROGRESS':
                        statusBadge = '<span class="badge bg-primary">Đang xử lý</span>';
                        break;
                    case 'CONFIRMED':
                        statusBadge = '<span class="badge bg-info">Đã xác nhận</span>';
                        break;
                    case 'CANCELLED':
                        statusBadge = '<span class="badge bg-danger">Đã hủy</span>';
                        break;
                    case 'COMPLETED':
                        statusBadge = '<span class="badge bg-success">Hoàn thành</span>';
                        break;
                    default:
                        statusBadge = '<span class="badge bg-secondary">' + (schedule.statusName || schedule.statusCode) + '</span>';
                }

                const acceptedInfo = schedule.acceptedByName
                    ? `<div><strong>${schedule.acceptedByName}</strong>${acceptedAt ? `<br><small class="text-muted">${acceptedAt}</small>` : ''}${schedule.acceptNote ? `<br><small class="text-muted">${schedule.acceptNote}</small>` : ''}</div>`
                    : '<span class="text-muted">Chưa nhận</span>';

                const actionsDisabled = schedule.statusCode === 'CANCELLED' || schedule.statusCode === 'COMPLETED' || schedule.statusCode === 'CONFIRMED';
                const acceptButtonHtml = (!schedule.acceptedById && !actionsDisabled)
                    ? `<button class="btn btn-sm btn-outline-success me-1" onclick="acceptSchedule(${schedule.id})" title="Nhận đơn">
                            <i class="fas fa-handshake"></i>
                       </button>`
                    : '';

                const acceptedLabelHtml = (schedule.acceptedById && Number(schedule.acceptedById) === currentUserId)
                    ? '<span class="badge bg-success text-white me-1">Bạn đã nhận</span>'
                    : '';

                const viewButtonHtml = `<a href="/ServiceSchedules/Details/${schedule.id}" class="btn btn-sm btn-outline-info me-1" title="Xem chi tiết">
                                <i class="fas fa-eye"></i>
                            </a>`;

                const editAndCancelButtons = !actionsDisabled ? `
                                <a href="/ServiceSchedules/Edit/${schedule.id}" class="btn btn-sm btn-outline-primary me-1" title="Chỉnh sửa">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <button class="btn btn-sm btn-outline-danger" onclick="cancelSchedule(${schedule.id})" title="Hủy lịch">
                                    <i class="fas fa-times"></i>
                                </button>
                            ` : '';

                // Badge phân biệt khách đặt lịch công khai và khách có tài khoản
                const bookingTypeBadge = schedule.isPublicBooking 
                    ? '<span class="badge bg-info text-white me-1" title="Khách đặt lịch công khai (không có tài khoản)">Khách mới</span>'
                    : '<span class="badge bg-secondary text-white me-1" title="Khách đã có tài khoản">Khách cũ</span>';

                const row = `
                    <tr>
                        <td>${(currentPage - 1) * pageSize + index + 1}</td>
                        <td>${schedule.userName || 'N/A'} ${bookingTypeBadge}</td>
                        <td>${schedule.carName || 'N/A'}</td>
                        <td>${schedule.licensePlate || 'N/A'}</td>
                        <td>${schedule.branchName || 'N/A'}</td>
                        <td>${formattedDate}</td>
                        <td>${formattedTime}</td>
                        <td>${statusBadge}</td>
                        <td>${acceptedInfo}</td>
                        <td>
                            ${acceptButtonHtml}
                            ${acceptedLabelHtml}
                            ${viewButtonHtml}
                            ${schedule.acceptedById && Number(schedule.acceptedById) !== currentUserId ? '<span class="badge bg-success-subtle text-success me-1">Đã nhận</span>' : ''}
                            ${editAndCancelButtons}
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });
        }

        function cancelSchedule(id) {
            if (confirm('Bạn có chắc chắn muốn hủy lịch hẹn này?')) {
                const token = localStorage.getItem('authToken');
                fetch(`${API_BASE_URL}/ServiceSchedule/${id}/cancel`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': token ? `Bearer ${token}` : '',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                })
                .then(async response => {
                    const result = await response.json();
                    if (result.success) {
                        alert('Hủy lịch hẹn thành công!');
                        loadServiceSchedules();
                    } else {
                        alert('Lỗi: ' + (result.message || 'Không thể hủy lịch hẹn'));
                    }
                })
                .catch(error => {
                    console.error('Error cancelling schedule:', error);
                    alert('Lỗi khi hủy lịch hẹn');
                });
            }
        }

        function showToast(message, type = 'success') {
            const bgColor = type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#ffc107';
            const icon = type === 'success' ? 'fa-check-circle' : type === 'error' ? 'fa-exclamation-circle' : 'fa-info-circle';
            
            const toast = $(`
                <div class="toast-notification" style="
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background-color: ${bgColor};
                    color: white;
                    padding: 15px 25px;
                    border-radius: 8px;
                    box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                    z-index: 9999;
                    min-width: 300px;
                    display: flex;
                    align-items: center;
                    gap: 12px;
                    font-size: 16px;
                    animation: slideInRight 0.3s ease-out;
                ">
                    <i class="fas ${icon}" style="font-size: 20px;"></i>
                    <span>${message}</span>
                </div>
            `);
            
            // Thêm animation CSS nếu chưa có
            if (!$('#toast-animation-style').length) {
                $('head').append(`
                    <style id="toast-animation-style">
                        @@keyframes slideInRight {
                            from {
                                transform: translateX(100%);
                                opacity: 0;
                            }
                            to {
                                transform: translateX(0);
                                opacity: 1;
                            }
                        }
                    </style>
                `);
            }
            
            $('body').append(toast);
            
            setTimeout(() => {
                toast.fadeOut(300, function() {
                    $(this).remove();
                });
            }, 3000);
        }

        async function acceptSchedule(id) {
            const token = localStorage.getItem('authToken');
            
            if (!token) {
                showToast('Vui lòng đăng nhập bằng tài khoản tư vấn viên để nhận đơn.', 'error');
                return;
            }

            // Lấy userInfo từ localStorage hoặc từ API
            let userInfo = null;
            const userInfoStr = localStorage.getItem('userInfo');
            
            if (userInfoStr) {
                try {
                    userInfo = JSON.parse(userInfoStr);
                } catch (error) {
                    console.error('Không thể phân tích thông tin người dùng:', error);
                }
            }

            // Nếu không có roleId trong localStorage, lấy từ API
            if (!userInfo || !userInfo.roleId) {
                try {
                    const response = await fetch('/Auth/GetUserInfo', {
                        method: 'GET',
                        headers: { 'Content-Type': 'application/json' }
                    });
                    const result = await response.json();
                    
                    if (result.isLoggedIn) {
                        userInfo = {
                            ...userInfo,
                            roleId: result.roleId || 0,
                            userId: result.userId || userInfo?.userId || userInfo?.id || null,
                            id: result.userId || userInfo?.userId || userInfo?.id || null
                        };
                        // Cập nhật lại localStorage
                        localStorage.setItem('userInfo', JSON.stringify(userInfo));
                    }
                } catch (error) {
                    console.error('Lỗi khi lấy thông tin người dùng:', error);
                }
            }

            if (!userInfo) {
                showToast('Không thể xác định thông tin người dùng. Vui lòng đăng nhập lại.', 'error');
                return;
            }

            // Debug: log userInfo để kiểm tra
            console.log('UserInfo:', userInfo);
            console.log('RoleId:', userInfo.roleId, 'Type:', typeof userInfo.roleId);

            // Kiểm tra roleId - có thể là number hoặc string
            const roleId = Number(userInfo.roleId);
            if (isNaN(roleId) || roleId !== 6) {
                console.error('RoleId không hợp lệ hoặc không phải consulter. RoleId:', roleId);
                showToast('Chỉ tài khoản tư vấn viên mới có thể nhận đơn. Vui lòng đăng nhập lại.', 'error');
                return;
            }

            // Lấy userId từ userInfo hoặc decode từ token
            let consultantId = Number(userInfo.userId || userInfo.id || userInfo.UserId);
            
            // Nếu không có userId, decode từ JWT token
            if (!consultantId && token) {
                try {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    consultantId = Number(
                        payload['http://schemas.xmlsoap.org/ws/2005/05/identity/claims/nameidentifier'] ||
                        payload['UserId'] ||
                        payload['nameid'] ||
                        payload['sub']
                    );
                    
                    if (consultantId) {
                        // Cập nhật lại userInfo với userId
                        userInfo.userId = consultantId;
                        userInfo.id = consultantId;
                        localStorage.setItem('userInfo', JSON.stringify(userInfo));
                        console.log('Đã lấy userId từ token:', consultantId);
                    }
                } catch (error) {
                    console.error('Lỗi khi decode token:', error);
                }
            }

            if (!consultantId || isNaN(consultantId)) {
                console.error('Không thể lấy userId. UserInfo:', userInfo);
                showToast('Không tìm thấy thông tin người dùng. Vui lòng đăng nhập lại.', 'error');
                return;
            }

            const payload = {
                consultantId,
                note: `${userInfo.fullName || userInfo.username || 'Tư vấn viên'} đã nhận đơn`
            };

            fetch(`${API_BASE_URL}/ServiceSchedule/${id}/accept`, {
                method: 'PUT',
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
            .then(async response => {
                const result = await response.json();
                if (response.ok && result.success) {
                    showToast('Nhận đơn thành công!', 'success');
                    loadServiceSchedules();
                } else {
                    const errorMessage = result.message || `Không thể nhận đơn (HTTP ${response.status})`;
                    showToast(errorMessage, 'error');
                }
            })
            .catch(error => {
                console.error('Error accepting schedule:', error);
                showToast('Lỗi khi nhận đơn. Vui lòng thử lại.', 'error');
            });
        }
    </script>
}
