@{
    ViewData["Title"] = "Danh sách đặt lịch";
    Layout = "~/vn.fpt.edu.views/Shared/_DashboardLayout.cshtml";
    var apiBaseUrl = ViewBag.ApiBaseUrl ?? "https://localhost:7173/api";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="fas fa-calendar-alt me-2"></i>
                        Danh sách đặt lịch hẹn
                    </h4>
                    <a href="/ServiceSchedules/Create" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Đặt lịch mới
                    </a>
                </div>
                <div class="card-body">
                    <!-- Search and Filter -->
                    <div class="row mb-3">
                        <div class="col-md-3">
                            <label for="searchInput" class="form-label">Tìm kiếm</label>
                            <input type="text" class="form-control" id="searchInput" placeholder="Tìm theo tên, biển số...">
                        </div>
                        <div class="col-md-2">
                            <label for="dateFilter" class="form-label">Ngày hẹn</label>
                            <input type="date" class="form-control" id="dateFilter">
                        </div>
                        <div class="col-md-2">
                            <label for="statusFilter" class="form-label">Trạng thái</label>
                            <select class="form-select" id="statusFilter">
                                <option value="">Tất cả trạng thái</option>
                                <option value="PENDING">Chờ xử lý</option>
                                <option value="CONFIRMED">Đã xác nhận</option>
                                <option value="CANCELLED">Đã hủy</option>
                                <option value="COMPLETED">Hoàn thành</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <button class="btn btn-outline-secondary w-100" id="filterBtn">
                                <i class="fas fa-filter"></i> Lọc
                            </button>
                        </div>
                        <div class="col-md-2">
                            <label class="form-label">&nbsp;</label>
                            <button class="btn btn-outline-secondary w-100" id="resetBtn">
                                <i class="fas fa-redo"></i> Làm mới
                            </button>
                        </div>
                    </div>

                    <!-- Table -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>STT</th>
                                    <th>Khách hàng</th>
                                    <th>Xe</th>
                                    <th>Biển số</th>
                                    <th>Chi nhánh</th>
                                    <th>Ngày hẹn</th>
                                    <th>Giờ hẹn</th>
                                    <th>Trạng thái</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody id="serviceSchedulesTableBody">
                                <tr>
                                    <td colspan="9" class="text-center">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination -->
                    <nav aria-label="Page navigation">
                        <ul class="pagination justify-content-center" id="pagination">
                        </ul>
                    </nav>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const API_BASE_URL = '@apiBaseUrl';
        let currentPage = 1;
        const pageSize = 10;

        $(document).ready(function() {
            loadServiceSchedules();

            $('#filterBtn').on('click', function() {
                currentPage = 1;
                loadServiceSchedules();
            });

            $('#resetBtn').on('click', function() {
                $('#searchInput').val('');
                $('#dateFilter').val('');
                $('#statusFilter').val('');
                currentPage = 1;
                loadServiceSchedules();
            });

            $('#searchInput').on('keypress', function(e) {
                if (e.which === 13) {
                    currentPage = 1;
                    loadServiceSchedules();
                }
            });
        });

        function loadServiceSchedules() {
            const token = localStorage.getItem('authToken');
            const status = $('#statusFilter').val();
            const date = $('#dateFilter').val();
            const search = $('#searchInput').val();

            let url = `${API_BASE_URL}/ServiceSchedule?page=${currentPage}&pageSize=${pageSize}`;
            
            if (status) {
                url = `${API_BASE_URL}/ServiceSchedule/by-status/${status}`;
            } else if (date) {
                const startDate = new Date(date);
                const endDate = new Date(startDate);
                endDate.setDate(endDate.getDate() + 1);
                url = `${API_BASE_URL}/ServiceSchedule/by-date-range?startDate=${startDate.toISOString().split('T')[0]}&endDate=${endDate.toISOString().split('T')[0]}`;
            }

            fetch(url, {
                headers: {
                    'Authorization': token ? `Bearer ${token}` : '',
                    'Content-Type': 'application/json'
                }
            })
            .then(async response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return response.json();
            })
            .then(result => {
                if (result.success && result.data) {
                    let schedules = result.data;
                    
                    // Filter by search if needed
                    if (search) {
                        const searchLower = search.toLowerCase();
                        schedules = schedules.filter(s => 
                            (s.userName && s.userName.toLowerCase().includes(searchLower)) ||
                            (s.licensePlate && s.licensePlate.toLowerCase().includes(searchLower)) ||
                            (s.carName && s.carName.toLowerCase().includes(searchLower))
                        );
                    }

                    displayServiceSchedules(schedules);
                } else {
                    $('#serviceSchedulesTableBody').html('<tr><td colspan="9" class="text-center text-muted">Không có dữ liệu</td></tr>');
                }
            })
            .catch(error => {
                console.error('Error loading schedules:', error);
                $('#serviceSchedulesTableBody').html('<tr><td colspan="9" class="text-center text-danger">Lỗi tải dữ liệu: ' + error.message + '</td></tr>');
            });
        }

        function displayServiceSchedules(schedules) {
            const tbody = $('#serviceSchedulesTableBody');
            tbody.empty();

            if (schedules.length === 0) {
                tbody.html('<tr><td colspan="9" class="text-center text-muted">Không có lịch hẹn nào</td></tr>');
                return;
            }

            schedules.forEach((schedule, index) => {
                const date = new Date(schedule.scheduledDate);
                const formattedDate = date.toLocaleDateString('vi-VN');
                const formattedTime = date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' });

                let statusBadge = '';
                switch(schedule.statusCode) {
                    case 'PENDING':
                        statusBadge = '<span class="badge bg-warning">Chờ xử lý</span>';
                        break;
                    case 'CONFIRMED':
                        statusBadge = '<span class="badge bg-info">Đã xác nhận</span>';
                        break;
                    case 'CANCELLED':
                        statusBadge = '<span class="badge bg-danger">Đã hủy</span>';
                        break;
                    case 'COMPLETED':
                        statusBadge = '<span class="badge bg-success">Hoàn thành</span>';
                        break;
                    default:
                        statusBadge = '<span class="badge bg-secondary">' + (schedule.statusName || schedule.statusCode) + '</span>';
                }

                const row = `
                    <tr>
                        <td>${(currentPage - 1) * pageSize + index + 1}</td>
                        <td>${schedule.userName || 'N/A'}</td>
                        <td>${schedule.carName || 'N/A'}</td>
                        <td>${schedule.licensePlate || 'N/A'}</td>
                        <td>${schedule.branchName || 'N/A'}</td>
                        <td>${formattedDate}</td>
                        <td>${formattedTime}</td>
                        <td>${statusBadge}</td>
                        <td>
                            <a href="/ServiceSchedules/Details/${schedule.id}" class="btn btn-sm btn-outline-info" title="Xem chi tiết">
                                <i class="fas fa-eye"></i>
                            </a>
                            ${schedule.statusCode !== 'CANCELLED' && schedule.statusCode !== 'COMPLETED' ? `
                                <a href="/ServiceSchedules/Edit/${schedule.id}" class="btn btn-sm btn-outline-primary" title="Chỉnh sửa">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <button class="btn btn-sm btn-outline-danger" onclick="cancelSchedule(${schedule.id})" title="Hủy lịch">
                                    <i class="fas fa-times"></i>
                                </button>
                            ` : ''}
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });
        }

        function cancelSchedule(id) {
            if (confirm('Bạn có chắc chắn muốn hủy lịch hẹn này?')) {
                const token = localStorage.getItem('authToken');
                fetch(`${API_BASE_URL}/ServiceSchedule/${id}/cancel`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': token ? `Bearer ${token}` : '',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                })
                .then(async response => {
                    const result = await response.json();
                    if (result.success) {
                        alert('Hủy lịch hẹn thành công!');
                        loadServiceSchedules();
                    } else {
                        alert('Lỗi: ' + (result.message || 'Không thể hủy lịch hẹn'));
                    }
                })
                .catch(error => {
                    console.error('Error cancelling schedule:', error);
                    alert('Lỗi khi hủy lịch hẹn');
                });
            }
        }
    </script>
}
