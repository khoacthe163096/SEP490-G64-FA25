@{
    ViewData["Title"] = "ƒê·∫∑t l·ªãch h·∫πn m·ªõi";
    Layout = "~/vn.fpt.edu.views/Shared/_DashboardLayout.cshtml";
    var apiBaseUrl = ViewBag.ApiBaseUrl ?? "https://localhost:7173/api";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h4 class="mb-0">
                        <i class="fas fa-calendar-plus me-2"></i>
                        ƒê·∫∑t l·ªãch h·∫πn m·ªõi
                    </h4>
                </div>
                <div class="card-body">
                    <form id="scheduleForm">
                        <!-- Ch·ªçn lo·∫°i kh√°ch h√†ng -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card border-primary">
                                    <div class="card-body">
                                        <label class="form-label fw-bold mb-3">Lo·∫°i kh√°ch h√†ng <span class="text-danger">*</span></label>
                                        <div class="form-check mb-2">
                                            <input class="form-check-input" type="radio" name="customerType" id="existingCustomer" value="existing" checked>
                                            <label class="form-check-label" for="existingCustomer">
                                                <i class="fas fa-user me-2"></i>Kh√°ch h√†ng c√≥ s·∫µn
                                            </label>
                                        </div>
                                        <div class="form-check">
                                            <input class="form-check-input" type="radio" name="customerType" id="newCustomer" value="new">
                                            <label class="form-check-label" for="newCustomer">
                                                <i class="fas fa-user-plus me-2"></i>Kh√°ch h√†ng m·ªõi (g·ªçi ƒëi·ªán ƒë·∫∑t l·ªãch)
                                            </label>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Form cho kh√°ch h√†ng c√≥ s·∫µn -->
                        <div id="existingCustomerForm">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="customerSearch" class="form-label">Kh√°ch h√†ng <span class="text-danger">*</span></label>
                                        <div class="position-relative">
                                            <input type="text" 
                                                   class="form-control" 
                                                   id="customerSearch" 
                                                   placeholder="T√¨m ki·∫øm kh√°ch h√†ng (nh·∫≠p t√™n, email, s·ªë ƒëi·ªán tho·∫°i)..."
                                                   autocomplete="off">
                                            <input type="hidden" id="userId" value="">
                                            <div id="customerDropdown" class="customer-dropdown" style="display: none;">
                                                <div id="customerList" class="customer-list"></div>
                                            </div>
                                        </div>
                                        <small class="form-text text-muted">T√¨m ki·∫øm v√† ch·ªçn kh√°ch h√†ng ƒë·∫∑t l·ªãch</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="carId" class="form-label">Xe <span class="text-danger">*</span></label>
                                        <select class="form-select" id="carId">
                                            <option value="">Ch·ªçn xe (ch·ªçn kh√°ch h√†ng tr∆∞·ªõc)</option>
                                        </select>
                                        <small class="form-text text-muted">Ch·ªçn xe c·∫ßn b·∫£o d∆∞·ª°ng</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Form cho kh√°ch h√†ng m·ªõi -->
                        <div id="newCustomerForm" style="display: none;">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="guestName" class="form-label">H·ªç v√† t√™n <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="guestName" placeholder="Nh·∫≠p h·ªç v√† t√™n kh√°ch h√†ng">
                                        <small class="form-text text-muted">T√™n ƒë·∫ßy ƒë·ªß c·ªßa kh√°ch h√†ng</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="guestPhone" class="form-label">S·ªë ƒëi·ªán tho·∫°i <span class="text-danger">*</span></label>
                                        <input type="tel" class="form-control" id="guestPhone" placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i">
                                        <small class="form-text text-muted">S·ªë ƒëi·ªán tho·∫°i li√™n h·ªá</small>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="guestEmail" class="form-label">Email</label>
                                        <input type="email" class="form-control" id="guestEmail" placeholder="Nh·∫≠p email (t√πy ch·ªçn)">
                                        <small class="form-text text-muted">Email c·ªßa kh√°ch h√†ng (n·∫øu c√≥)</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="guestCarName" class="form-label">T√™n xe <span class="text-danger">*</span></label>
                                        <input type="text" class="form-control" id="guestCarName" placeholder="V√≠ d·ª•: Honda Civic">
                                        <small class="form-text text-muted">T√™n xe c·∫ßn b·∫£o d∆∞·ª°ng</small>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="guestCarModel" class="form-label">Model xe</label>
                                        <input type="text" class="form-control" id="guestCarModel" placeholder="V√≠ d·ª•: 2020">
                                        <small class="form-text text-muted">Model/nƒÉm s·∫£n xu·∫•t</small>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="guestLicensePlate" class="form-label">Bi·ªÉn s·ªë xe</label>
                                        <input type="text" class="form-control" id="guestLicensePlate" placeholder="V√≠ d·ª•: 30A-12345">
                                        <small class="form-text text-muted">Bi·ªÉn s·ªë xe (n·∫øu c√≥)</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="serviceCategoryId" class="form-label">D·ªãch v·ª• <span class="text-danger">*</span></label>
                                    <select class="form-select" id="serviceCategoryId" required>
                                        <option value="">Ch·ªçn d·ªãch v·ª•</option>
                                    </select>
                                    <small class="form-text text-muted">Ch·ªçn lo·∫°i d·ªãch v·ª• c·∫ßn ƒë·∫∑t l·ªãch</small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="branchId" class="form-label">Chi nh√°nh <span class="text-danger">*</span></label>
                                    <select class="form-select" id="branchId" required>
                                        <option value="">Ch·ªçn chi nh√°nh</option>
                                    </select>
                                    <input type="hidden" id="branchIdHidden" value="">
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label">Ng√†y v√† gi·ªù h·∫πn <span class="text-danger">*</span></label>
                                    <div class="row g-2">
                                        <div class="col-5">
                                            <input type="date" class="form-control" id="scheduledDate" required>
                                        </div>
                                        <div class="col-3">
                                            <select class="form-select" id="scheduledHour" required>
                                                <option value="">Gi·ªù</option>
                                            </select>
                                        </div>
                                        <div class="col-4">
                                            <select class="form-select" id="scheduledMinute" required>
                                                <option value="">Ph√∫t</option>
                                            </select>
                                    </div>
                                    </div>
                                    <small class="form-text text-muted">Ch·ªçn ng√†y, gi·ªù v√† ph√∫t mu·ªën ƒë·∫∑t l·ªãch (Gi·ªù l√†m vi·ªác: 7:00 - 17:00)</small>
                                </div>
                            </div>
                        </div>

                        <div class="alert alert-info">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>L∆∞u √Ω:</strong> L·ªãch h·∫πn ph·∫£i ƒë∆∞·ª£c ƒë·∫∑t √≠t nh·∫•t 1 ng√†y tr∆∞·ªõc th·ªùi ƒëi·ªÉm h·∫πn.
                        </div>

                        <div class="d-flex justify-content-between">
                            <a href="/ServiceSchedules" class="btn btn-secondary">
                                <i class="fas fa-arrow-left me-1"></i>
                                Quay l·∫°i
                            </a>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i>
                                ƒê·∫∑t l·ªãch
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <style>
        .customer-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #ced4da;
            border-radius: 0.375rem;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
            z-index: 1000;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 2px;
        }
        
        .customer-list {
            padding: 0;
        }
        
        .customer-item {
            padding: 10px 15px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
            transition: background-color 0.2s;
        }
        
        .customer-item:hover {
            background-color: #f8f9fa;
        }
        
        .customer-item:last-child {
            border-bottom: none;
        }
        
        .customer-item.selected {
            background-color: #e7f3ff;
        }
        
        .customer-name {
            font-weight: 500;
            color: #212529;
            margin-bottom: 2px;
        }
        
        .customer-email {
            font-size: 0.875rem;
            color: #6c757d;
        }
        
        .customer-phone {
            font-size: 0.875rem;
            color: #6c757d;
        }
        
        .no-results {
            padding: 15px;
            text-align: center;
            color: #6c757d;
            font-style: italic;
        }
    </style>
    <script>
        // ƒê·∫£m b·∫£o API_BASE_URL ƒë∆∞·ª£c ƒë·ªãnh nghƒ©a global
        window.API_BASE_URL = '@apiBaseUrl';
        const API_BASE_URL = window.API_BASE_URL;
        
        // L∆∞u danh s√°ch users ƒë·ªÉ search
        let allUsers = [];
        
        console.log('üìã Script section loaded, API_BASE_URL:', API_BASE_URL);

        // ƒê·ªãnh nghƒ©a h√†m loadServiceCategories trong global scope NGAY L·∫¨P T·ª®C
        window.loadServiceCategories = function loadServiceCategories() {
            console.log('üîÑ [loadServiceCategories] Function called');
            const token = localStorage.getItem('authToken');
            const select = $('#serviceCategoryId');
            
            console.log('üîç [loadServiceCategories] Looking for #serviceCategoryId, found:', select.length);
            
            if (!select.length) {
                console.error('‚ùå [loadServiceCategories] Service category select element not found! Retrying in 500ms...');
                setTimeout(function() {
                    window.loadServiceCategories();
                }, 500);
                return;
            }
            
            console.log('üîÑ [loadServiceCategories] Loading service categories...');
            console.log('üì° [loadServiceCategories] API_BASE_URL:', API_BASE_URL);
            console.log('üì° [loadServiceCategories] Full URL:', `${API_BASE_URL}/ServiceCategory`);
            
            select.prop('disabled', false);
            select.prop('required', true);
            select.html('<option value="">-- ƒêang t·∫£i danh s√°ch d·ªãch v·ª• --</option>');
            
            const url = `${API_BASE_URL}/ServiceCategory`;
            console.log('üåê [loadServiceCategories] Making fetch request to:', url);
            
            fetch(url, {
                method: 'GET',
                headers: {
                    'Authorization': token ? `Bearer ${token}` : '',
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                }
            })
            .then(async response => {
                console.log('üì• [loadServiceCategories] Response status:', response.status, response.statusText);
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå [loadServiceCategories] HTTP error:', response.status, errorText);
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }
                return response.json();
            })
            .then(result => {
                console.log('üì¶ [loadServiceCategories] Response data:', result);
                const categories = result.success && Array.isArray(result.data) ? result.data : (Array.isArray(result) ? result : []);
                console.log('‚úÖ [loadServiceCategories] Categories found:', categories.length);
                console.log('üìã [loadServiceCategories] Categories array:', categories);
                
                // Clear v√† th√™m option m·∫∑c ƒë·ªãnh
                select.empty();
                select.append('<option value="">-- Ch·ªçn d·ªãch v·ª• --</option>');
                
                if (!categories.length) {
                    console.warn('‚ö†Ô∏è [loadServiceCategories] No categories found');
                    select.append('<option value="">-- Kh√¥ng c√≥ d·ªãch v·ª• n√†o --</option>');
                    return;
                }
                
                // Th√™m t·ª´ng option
                categories.forEach((category, index) => {
                    // Ch·ªâ hi·ªÉn th·ªã t√™n d·ªãch v·ª•, kh√¥ng hi·ªÉn th·ªã description
                    const optionText = category.name || 'N/A';
                    const optionValue = category.id;
                    console.log(`  [${index}] Adding option: value="${optionValue}", text="${optionText}"`);
                    const option = $('<option></option>').attr('value', optionValue).text(optionText);
                    select.append(option);
                });
                
                const totalOptions = select.find('option').length;
                console.log('‚úÖ [loadServiceCategories] Service categories loaded successfully!');
                console.log('üìä [loadServiceCategories] Total options in select:', totalOptions);
                console.log('üìã [loadServiceCategories] Select element:', select[0]);
                console.log('üìã [loadServiceCategories] Select HTML length:', select.html().length);
                
                // Force trigger change event ƒë·ªÉ ƒë·∫£m b·∫£o UI update
                select.trigger('change');
            })
            .catch(error => {
                console.error('‚ùå [loadServiceCategories] Error:', error);
                console.error('‚ùå [loadServiceCategories] Error stack:', error.stack);
                select.empty();
                select.append('<option value="">-- L·ªói t·∫£i danh s√°ch d·ªãch v·ª• --</option>');
            });
        };
        
        console.log('‚úÖ loadServiceCategories function defined, type:', typeof window.loadServiceCategories);

        // ƒê·∫£m b·∫£o h√†m ƒë∆∞·ª£c g·ªçi ngay c·∫£ khi document ready ch∆∞a ch·∫°y
        function initializeForm() {
            console.log('üìã Initialize form, API_BASE_URL:', API_BASE_URL);
            console.log('üîç Checking for #serviceCategoryId...');
            const testSelect = $('#serviceCategoryId');
            console.log('  Found:', testSelect.length, 'element(s)');
            if (testSelect.length) {
                console.log('  Element exists:', testSelect[0]);
            }
            
            loadUsers();
            loadEmployeeBranch(); // Load branch c·ªßa nh√¢n vi√™n ƒëang ƒëƒÉng nh·∫≠p
            window.loadServiceCategories(); // G·ªçi ngay l·∫≠p t·ª©c
        }

        $(document).ready(function() {
            console.log('üìã Document ready, initializing form...');
            initializeForm();
            
            // ƒê·∫£m b·∫£o ph·∫ßn ch·ªçn lo·∫°i kh√°ch h√†ng lu√¥n hi·ªÉn th·ªã
            $('input[name="customerType"]').closest('.card').show();
            
            // Set min date to tomorrow
            const tomorrow = new Date();
            tomorrow.setDate(tomorrow.getDate() + 1);
            const minDateStr = tomorrow.toISOString().split('T')[0];
            $('#scheduledDate').attr('min', minDateStr);
            
            // Populate gi·ªù l√†m vi·ªác t·ª´ 7 ƒë·∫øn 17
            const hourSelect = $('#scheduledHour');
            for (let hour = 7; hour <= 17; hour++) {
                const hourStr = hour.toString().padStart(2, '0');
                hourSelect.append(`<option value="${hourStr}">${hourStr}</option>`);
            }
            
            // Populate ph√∫t: 00, 15, 30, 45
            const minuteSelect = $('#scheduledMinute');
            const minutes = ['00', '15', '30', '45'];
            minutes.forEach(minute => {
                minuteSelect.append(`<option value="${minute}">${minute}</option>`);
            });

            // Kh·ªüi t·∫°o tr·∫°ng th√°i ban ƒë·∫ßu
            const initialCustomerType = $('input[name="customerType"]:checked').val();
            if (initialCustomerType === 'existing') {
                $('#existingCustomerForm').show();
                $('#newCustomerForm').hide();
                $('#customerSearch').prop('required', true);
                $('#carId').prop('required', true);
            } else {
                $('#existingCustomerForm').hide();
                $('#newCustomerForm').show();
                $('#guestName').prop('required', true);
                $('#guestPhone').prop('required', true);
                $('#guestCarName').prop('required', true);
            }

            // Toggle gi·ªØa form kh√°ch h√†ng c√≥ s·∫µn v√† kh√°ch h√†ng m·ªõi
            $('input[name="customerType"]').on('change', function() {
                const customerType = $(this).val();
                console.log('Customer type changed to:', customerType);
                if (customerType === 'existing') {
                    $('#existingCustomerForm').show();
                    $('#newCustomerForm').hide();
                    // Set required cho form kh√°ch h√†ng c√≥ s·∫µn
                    $('#customerSearch').prop('required', true);
                    $('#carId').prop('required', true);
                    // Remove required cho form kh√°ch h√†ng m·ªõi
                    $('#guestName').prop('required', false);
                    $('#guestPhone').prop('required', false);
                    $('#guestCarName').prop('required', false);
                } else {
                    $('#existingCustomerForm').hide();
                    $('#newCustomerForm').show();
                    // Remove required cho form kh√°ch h√†ng c√≥ s·∫µn
                    $('#customerSearch').prop('required', false);
                    $('#carId').prop('required', false);
                    // Set required cho form kh√°ch h√†ng m·ªõi
                    $('#guestName').prop('required', true);
                    $('#guestPhone').prop('required', true);
                    $('#guestCarName').prop('required', true);
                }
            });

            // X·ª≠ l√Ω t√¨m ki·∫øm kh√°ch h√†ng
            let searchTimeout;
            $('#customerSearch').on('input', function() {
                const query = $(this).val();
                
                // Clear timeout tr∆∞·ªõc ƒë√≥
                clearTimeout(searchTimeout);
                
                // N·∫øu x√≥a h·∫øt text, reset selection
                if (!query || query.trim() === '') {
                    $('#userId').val('');
                    $('#customerDropdown').hide();
                    $('#carId').html('<option value="">Ch·ªçn xe (ch·ªçn kh√°ch h√†ng tr∆∞·ªõc)</option>');
                    return;
                }
                
                // Debounce search ƒë·ªÉ tr√°nh search qu√° nhi·ªÅu l·∫ßn
                searchTimeout = setTimeout(function() {
                    const results = searchCustomers(query);
                    displayCustomerResults(results);
                }, 300);
            });
            
            // Hi·ªÉn th·ªã dropdown khi focus v√†o input
            $('#customerSearch').on('focus', function() {
                const query = $(this).val();
                if (query && query.trim() !== '') {
                    const results = searchCustomers(query);
                    displayCustomerResults(results);
                }
            });
            
            // ƒê√≥ng dropdown khi click outside
            $(document).on('click', function(e) {
                if (!$(e.target).closest('#customerSearch, #customerDropdown').length) {
                    $('#customerDropdown').hide();
                }
            });
            
            // X·ª≠ l√Ω khi x√≥a selection
            $('#customerSearch').on('keydown', function(e) {
                // N·∫øu nh·∫•n Escape, ƒë√≥ng dropdown
                if (e.key === 'Escape') {
                    $('#customerDropdown').hide();
                }
                // N·∫øu x√≥a h·∫øt v√† nh·∫•n Backspace/Delete, reset
                if ((e.key === 'Backspace' || e.key === 'Delete') && $(this).val() === '') {
                    $('#userId').val('');
                    $('#carId').html('<option value="">Ch·ªçn xe (ch·ªçn kh√°ch h√†ng tr∆∞·ªõc)</option>');
                }
            });

            $('#scheduleForm').on('submit', function(e) {
                e.preventDefault();
                createSchedule();
            });
        });

        function loadUsers() {
            const token = localStorage.getItem('authToken');
            // Load t·∫•t c·∫£ users v·ªõi pageSize l·ªõn ƒë·ªÉ c√≥ ƒë·ªß d·ªØ li·ªáu cho search
            fetch(`${API_BASE_URL}/AutoOwner?page=1&pageSize=10000`, {
                headers: {
                    'Authorization': token ? `Bearer ${token}` : '',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(result => {
                if (result.success && result.data) {
                    allUsers = result.data.map(user => ({
                        id: user.id,
                        firstName: user.firstName || '',
                        lastName: user.lastName || '',
                        email: user.email || '',
                        phone: user.phone || ''
                    }));
                    console.log('Loaded users:', allUsers.length);
                }
            })
            .catch(error => {
                console.error('Error loading users:', error);
            });
        }
        
        // H√†m t√¨m ki·∫øm kh√°ch h√†ng
        function searchCustomers(query) {
            if (!query || query.trim() === '') {
                return [];
            }
            
            const searchTerm = query.toLowerCase().trim();
            return allUsers.filter(user => {
                const fullName = `${user.firstName} ${user.lastName}`.toLowerCase();
                const email = (user.email || '').toLowerCase();
                const phone = (user.phone || '').toLowerCase();
                
                return fullName.includes(searchTerm) || 
                       email.includes(searchTerm) || 
                       phone.includes(searchTerm);
            });
        }
        
        // Hi·ªÉn th·ªã dropdown v·ªõi k·∫øt qu·∫£ t√¨m ki·∫øm
        function displayCustomerResults(results) {
            const dropdown = $('#customerDropdown');
            const list = $('#customerList');
            
            list.empty();
            
            if (results.length === 0) {
                list.html('<div class="no-results">Kh√¥ng t√¨m th·∫•y kh√°ch h√†ng n√†o</div>');
                dropdown.show();
                return;
            }
            
            results.forEach(user => {
                const fullName = `${user.firstName} ${user.lastName}`.trim() || 'N/A';
                const item = $(`
                    <div class="customer-item" data-user-id="${user.id}">
                        <div class="customer-name">${fullName}</div>
                        ${user.email ? `<div class="customer-email">üìß ${user.email}</div>` : ''}
                        ${user.phone ? `<div class="customer-phone">üìû ${user.phone}</div>` : ''}
                    </div>
                `);
                
                item.on('click', function() {
                    selectCustomer(user);
                });
                
                list.append(item);
            });
            
            dropdown.show();
        }
        
        // Ch·ªçn kh√°ch h√†ng
        function selectCustomer(user) {
            const fullName = `${user.firstName} ${user.lastName}`.trim() || user.email || 'N/A';
            $('#customerSearch').val(fullName);
            $('#userId').val(user.id);
            $('#customerDropdown').hide();
            
            // Load cars cho user ƒë√£ ch·ªçn
            if (user.id) {
                loadCarsByUserId(user.id);
            }
        }

        function loadCarsByUserId(userId) {
            const token = localStorage.getItem('authToken');
            console.log('Loading cars for userId:', userId);
            
            fetch(`${API_BASE_URL}/CarOfAutoOwner/user/${userId}`, {
                headers: {
                    'Authorization': token ? `Bearer ${token}` : '',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                console.log('Cars response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(result => {
                console.log('Cars response data:', result);
                const select = $('#carId');
                select.html('<option value="">Ch·ªçn xe</option>');
                
                // X·ª≠ l√Ω response c√≥ th·ªÉ l√† array tr·ª±c ti·∫øp ho·∫∑c object c√≥ data
                let cars = [];
                if (Array.isArray(result)) {
                    cars = result;
                } else if (result.success && Array.isArray(result.data)) {
                    cars = result.data;
                } else if (result.data && Array.isArray(result.data)) {
                    cars = result.data;
                }
                
                if (cars.length > 0) {
                    cars.forEach(car => {
                        const label = `${car.carName || 'N/A'} - ${car.licensePlate || 'N/A'}`;
                        select.append(`<option value="${car.id}">${label}</option>`);
                    });
                    console.log(`Loaded ${cars.length} cars`);
                } else {
                    console.log('No cars found for this user');
                    select.append('<option value="">Kh√¥ng c√≥ xe n√†o</option>');
                }
            })
            .catch(error => {
                console.error('Error loading cars:', error);
                const select = $('#carId');
                select.html('<option value="">L·ªói khi t·∫£i danh s√°ch xe</option>');
            });
        }

        // Load branch c·ªßa nh√¢n vi√™n ƒëang ƒëƒÉng nh·∫≠p v√† set v√†o dropdown
        function loadEmployeeBranch() {
            const token = localStorage.getItem('authToken');
            if (!token) {
                console.error('No token found');
                return;
            }
            
            // L·∫•y th√¥ng tin nh√¢n vi√™n hi·ªán t·∫°i
            fetch(`${API_BASE_URL}/EmployeeProfile/my-profile`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(result => {
                console.log('Employee profile response:', result);
                // X·ª≠ l√Ω response c√≥ th·ªÉ l√† object tr·ª±c ti·∫øp ho·∫∑c wrap trong success/data
                const employee = result.data || result;
                const branchId = employee.branchId || employee.BranchId;
                
                if (branchId) {
                    // Load t·∫•t c·∫£ branches ƒë·ªÉ t√¨m branch name
                    fetch(`${API_BASE_URL}/Branch`, {
                        headers: {
                            'Authorization': `Bearer ${token}`,
                            'Content-Type': 'application/json'
                        }
                    })
                    .then(response => response.json())
                    .then(result => {
                        const select = $('#branchId');
                        select.empty();
                        
                        if (result.success && result.data) {
                            // T√¨m branch c·ªßa nh√¢n vi√™n
                            const employeeBranch = result.data.find(b => b.id === branchId);
                            
                            if (employeeBranch) {
                                // Th√™m option cho branch c·ªßa nh√¢n vi√™n
                                select.append(`<option value="${employeeBranch.id}">${employeeBranch.name || 'N/A'}</option>`);
                                select.val(branchId);
                                
                                // L∆∞u branchId v√†o hidden input ƒë·ªÉ ƒë·∫£m b·∫£o gi√° tr·ªã ƒë∆∞·ª£c g·ª≠i ƒëi
                                $('#branchIdHidden').val(branchId);
                                
                                // Disable dropdown ƒë·ªÉ kh√¥ng cho ch·ªânh s·ª≠a
                                select.prop('disabled', true);
                                select.css('background-color', '#e9ecef');
                                select.css('cursor', 'not-allowed');
                                
                                console.log('Branch set to:', employeeBranch.name, 'and disabled');
                            } else {
                                console.warn('Branch not found in list');
                                select.append('<option value="">Kh√¥ng t√¨m th·∫•y chi nh√°nh</option>');
                            }
                        }
                    })
                    .catch(error => {
                        console.error('Error loading branches:', error);
                    });
                } else {
                    console.warn('Employee has no branch assigned');
                    const select = $('#branchId');
                    select.append('<option value="">Nh√¢n vi√™n ch∆∞a ƒë∆∞·ª£c g√°n chi nh√°nh</option>');
                    select.prop('disabled', true);
                }
            })
            .catch(error => {
                console.error('Error loading employee profile:', error);
                // Fallback: load t·∫•t c·∫£ branches n·∫øu kh√¥ng l·∫•y ƒë∆∞·ª£c profile
                loadBranches();
            });
        }
        
        // H√†m load t·∫•t c·∫£ branches (fallback)
        function loadBranches() {
            const token = localStorage.getItem('authToken');
            fetch(`${API_BASE_URL}/Branch`, {
                headers: {
                    'Authorization': token ? `Bearer ${token}` : '',
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(result => {
                if (result.success && result.data) {
                    const select = $('#branchId');
                    result.data.forEach(branch => {
                        select.append(`<option value="${branch.id}">${branch.name || 'N/A'}</option>`);
                    });
                }
            })
            .catch(error => {
                console.error('Error loading branches:', error);
            });
        }

        function loadServiceCategories() {
            console.log('üîÑ [loadServiceCategories] Function called');
            const token = localStorage.getItem('authToken');
            const select = $('#serviceCategoryId');
            
            console.log('üîç [loadServiceCategories] Looking for #serviceCategoryId, found:', select.length);
            
            if (!select.length) {
                console.error('‚ùå [loadServiceCategories] Service category select element not found! Retrying in 500ms...');
                setTimeout(function() {
                    loadServiceCategories();
                }, 500);
                return;
            }
            
            console.log('üîÑ [loadServiceCategories] Loading service categories...');
            console.log('üì° [loadServiceCategories] API_BASE_URL:', API_BASE_URL);
            console.log('üì° [loadServiceCategories] Full URL:', `${API_BASE_URL}/ServiceCategory`);
            
            select.prop('disabled', false);
            select.prop('required', true);
            select.html('<option value="">-- ƒêang t·∫£i danh s√°ch d·ªãch v·ª• --</option>');
            
            const url = `${API_BASE_URL}/ServiceCategory`;
            console.log('üåê [loadServiceCategories] Making fetch request to:', url);
            
            fetch(url, {
                method: 'GET',
                headers: {
                    'Authorization': token ? `Bearer ${token}` : '',
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                }
            })
            .then(async response => {
                console.log('üì• [loadServiceCategories] Response status:', response.status, response.statusText);
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('‚ùå [loadServiceCategories] HTTP error:', response.status, errorText);
                    throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                }
                return response.json();
            })
            .then(result => {
                console.log('üì¶ [loadServiceCategories] Response data:', result);
                const categories = result.success && Array.isArray(result.data) ? result.data : (Array.isArray(result) ? result : []);
                console.log('‚úÖ [loadServiceCategories] Categories found:', categories.length);
                console.log('üìã [loadServiceCategories] Categories array:', categories);
                
                // Clear v√† th√™m option m·∫∑c ƒë·ªãnh
                select.empty();
                select.append('<option value="">-- Ch·ªçn d·ªãch v·ª• --</option>');
                
                if (!categories.length) {
                    console.warn('‚ö†Ô∏è [loadServiceCategories] No categories found');
                    select.append('<option value="">-- Kh√¥ng c√≥ d·ªãch v·ª• n√†o --</option>');
                    return;
                }
                
                // Th√™m t·ª´ng option
                categories.forEach((category, index) => {
                    // Ch·ªâ hi·ªÉn th·ªã t√™n d·ªãch v·ª•, kh√¥ng hi·ªÉn th·ªã description
                    const optionText = category.name || 'N/A';
                    const optionValue = category.id;
                    console.log(`  [${index}] Adding option: value="${optionValue}", text="${optionText}"`);
                    const option = $('<option></option>').attr('value', optionValue).text(optionText);
                    select.append(option);
                });
                
                const totalOptions = select.find('option').length;
                console.log('‚úÖ [loadServiceCategories] Service categories loaded successfully!');
                console.log('üìä [loadServiceCategories] Total options in select:', totalOptions);
                console.log('üìã [loadServiceCategories] Select element:', select[0]);
                console.log('üìã [loadServiceCategories] Select HTML length:', select.html().length);
                
                // Force trigger change event ƒë·ªÉ ƒë·∫£m b·∫£o UI update
                select.trigger('change');
            })
            .catch(error => {
                console.error('‚ùå [loadServiceCategories] Error:', error);
                console.error('‚ùå [loadServiceCategories] Error stack:', error.stack);
                select.empty();
                select.append('<option value="">-- L·ªói t·∫£i danh s√°ch d·ªãch v·ª• --</option>');
            });
        }

        function createSchedule() {
            const token = localStorage.getItem('authToken');
            const customerType = $('input[name="customerType"]:checked').val();
            const serviceCategoryId = $('#serviceCategoryId').val();
            // L·∫•y branchId t·ª´ hidden input ho·∫∑c t·ª´ select (n·∫øu kh√¥ng disabled)
            const branchId = parseInt($('#branchIdHidden').val() || $('#branchId').val());

            // Validation
            if (!branchId) {
                showToast('Vui l√≤ng ch·ªçn chi nh√°nh', 'error');
                return;
            }

            const scheduledDateStr = $('#scheduledDate').val();
            const scheduledHour = $('#scheduledHour').val();
            const scheduledMinute = $('#scheduledMinute').val();
            
            if (!scheduledDateStr) {
                showToast('Vui l√≤ng ch·ªçn ng√†y h·∫πn', 'error');
                return;
            }

            if (!scheduledHour) {
                showToast('Vui l√≤ng ch·ªçn gi·ªù h·∫πn', 'error');
                return;
            }

            if (!scheduledMinute) {
                showToast('Vui l√≤ng ch·ªçn ph√∫t h·∫πn', 'error');
                return;
            }

            // Combine date, hour v√† minute
            const [year, month, day] = scheduledDateStr.split('-');
            const scheduledDate = new Date(year, month - 1, day, parseInt(scheduledHour), parseInt(scheduledMinute), 0);
            
            if (isNaN(scheduledDate.getTime())) {
                showToast('Ng√†y v√† gi·ªù h·∫πn kh√¥ng h·ª£p l·ªá', 'error');
                return;
            }

            // Ki·ªÉm tra ng√†y h·∫πn ph·∫£i l√† t∆∞∆°ng lai (√≠t nh·∫•t 1 ng√†y)
            const now = new Date();
            const minDate = new Date(now);
            minDate.setDate(minDate.getDate() + 1);
            minDate.setHours(0, 0, 0, 0);
            
            if (scheduledDate < minDate) {
                showToast('L·ªãch h·∫πn ph·∫£i ƒë∆∞·ª£c ƒë·∫∑t √≠t nh·∫•t 1 ng√†y tr∆∞·ªõc th·ªùi ƒëi·ªÉm h·∫πn', 'error');
                return;
            }

            if (!serviceCategoryId) {
                showToast('Vui l√≤ng ch·ªçn d·ªãch v·ª•', 'error');
                return;
            }

            let payload;
            let endpoint;

            if (customerType === 'existing') {
                // Kh√°ch h√†ng c√≥ s·∫µn - d√πng API b√¨nh th∆∞·ªùng
                const userId = parseInt($('#userId').val());
                const carId = parseInt($('#carId').val());

                if (!userId || !carId) {
                    showToast('Vui l√≤ng ch·ªçn kh√°ch h√†ng v√† xe', 'error');
                    return;
                }

                payload = {
                    userId: userId,
                    carId: carId,
                    branchId: branchId,
                scheduledDate: scheduledDate.toISOString(),
                statusCode: 'PENDING'
            };

                if (serviceCategoryId) {
                    payload.serviceCategoryId = parseInt(serviceCategoryId);
                }

                endpoint = `${API_BASE_URL}/ServiceSchedule`;
            } else {
                // Kh√°ch h√†ng m·ªõi - d√πng API public-booking
                const guestName = $('#guestName').val().trim();
                const guestPhone = $('#guestPhone').val().trim();
                const guestEmail = $('#guestEmail').val().trim();
                const guestCarName = $('#guestCarName').val().trim();
                const guestCarModel = $('#guestCarModel').val().trim();
                const guestLicensePlate = $('#guestLicensePlate').val().trim();

                if (!guestName || !guestPhone || !guestCarName) {
                    showToast('Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin kh√°ch h√†ng (H·ªç t√™n, S·ªë ƒëi·ªán tho·∫°i, T√™n xe)', 'error');
                    return;
                }

                payload = {
                    fullName: guestName,
                    phone: guestPhone,
                    email: guestEmail || null,
                    carName: guestCarName,
                    carModel: guestCarModel || null,
                    licensePlate: guestLicensePlate || null,
                    branchId: branchId,
                    scheduledDate: scheduledDate.toISOString()
                };

                if (serviceCategoryId) {
                    payload.serviceCategoryId = parseInt(serviceCategoryId);
                }

                endpoint = `${API_BASE_URL}/ServiceSchedule/public-booking`;
            }

            // Show loading
            const submitBtn = $('button[type="submit"]');
            const originalText = submitBtn.html();
            submitBtn.html('<i class="fas fa-spinner fa-spin me-1"></i>ƒêang x·ª≠ l√Ω...');
            submitBtn.prop('disabled', true);

            fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Authorization': token ? `Bearer ${token}` : '',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            })
            .then(async response => {
                const result = await response.json();
                if (result.success) {
                    showToast('ƒê·∫∑t l·ªãch h·∫πn th√†nh c√¥ng!', 'success');
                    setTimeout(() => {
                    window.location.href = '/ServiceSchedules';
                    }, 1500);
                } else {
                    showToast('L·ªói: ' + (result.message || 'Kh√¥ng th·ªÉ ƒë·∫∑t l·ªãch h·∫πn'), 'error');
                    submitBtn.html(originalText);
                    submitBtn.prop('disabled', false);
                }
            })
            .catch(error => {
                console.error('Error creating schedule:', error);
                showToast('L·ªói khi ƒë·∫∑t l·ªãch h·∫πn: ' + error.message, 'error');
                submitBtn.html(originalText);
                submitBtn.prop('disabled', false);
            });
        }

        function showToast(message, type = 'success') {
            const bgColor = type === 'success' ? '#28a745' : '#dc3545';
            const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
            
            const toast = $(`
                <div class="toast-notification" style="
                    position: fixed;
                    top: 20px;
                    right: 20px;
                    background-color: ${bgColor};
                    color: white;
                    padding: 12px 20px;
                    border-radius: 4px;
                    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
                    z-index: 9999;
                    min-width: 250px;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                    animation: slideInRight 0.3s ease-out;
                ">
                    <i class="fas ${icon}"></i>
                    <span>${message}</span>
                </div>
            `);
            
            // Th√™m animation style n·∫øu ch∆∞a c√≥
            if (!$('#toast-animation-style').length) {
                $('head').append(`
                    <style id="toast-animation-style">
                        @@keyframes slideInRight {
                            from {
                                transform: translateX(100%);
                                opacity: 0;
                            }
                            to {
                                transform: translateX(0);
                                opacity: 1;
                            }
                        }
                    </style>
                `);
            }
            
            $('body').append(toast);
            
            setTimeout(() => {
                toast.fadeOut(300, function() {
                    $(this).remove();
                });
            }, 3000);
        }
    </script>
}

