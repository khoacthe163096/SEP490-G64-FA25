@{
    ViewData["Title"] = "Chi tiết lịch hẹn";
    Layout = "~/vn.fpt.edu.views/Shared/_DashboardLayout.cshtml";
    var apiBaseUrl = ViewBag.ApiBaseUrl ?? "https://localhost:7173/api";
    var scheduleId = ViewBag.ServiceScheduleId;
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="fas fa-calendar-check me-2"></i>
                        Chi tiết lịch hẹn
                    </h4>
                    <div>
                        <a href="/ServiceSchedules" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-1"></i>
                            Quay lại
                        </a>
                        <a href="/ServiceSchedules/Edit/@scheduleId" class="btn btn-primary" id="editBtn" style="display: none;">
                            <i class="fas fa-edit me-1"></i>
                            Chỉnh sửa
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div id="loadingSpinner" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>
                    <div id="scheduleDetails" style="display: none;">
                        <div class="row">
                            <div class="col-md-6">
                                <h5 class="mb-3">Thông tin khách hàng</h5>
                                <table class="table table-bordered">
                                    <tr>
                                        <th width="40%">Tên khách hàng:</th>
                                        <td id="userName">-</td>
                                    </tr>
                                    <tr>
                                        <th>Email:</th>
                                        <td id="userEmail">-</td>
                                    </tr>
                                    <tr>
                                        <th>Điện thoại:</th>
                                        <td id="userPhone">-</td>
                                    </tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <h5 class="mb-3">Thông tin xe</h5>
                                <table class="table table-bordered">
                                    <tr>
                                        <th width="40%">Tên xe:</th>
                                        <td id="carName">-</td>
                                    </tr>
                                    <tr>
                                        <th>Biển số:</th>
                                        <td id="licensePlate">-</td>
                                    </tr>
                                    <tr>
                                        <th>Model:</th>
                                        <td id="carModel">-</td>
                                    </tr>
                                </table>
                            </div>
                        </div>

                        <hr>

                        <div class="row">
                            <div class="col-md-6">
                                <h5 class="mb-3">Thông tin lịch hẹn</h5>
                                <table class="table table-bordered">
                                    <tr>
                                        <th width="40%">Ngày hẹn:</th>
                                        <td id="scheduledDate">-</td>
                                    </tr>
                                    <tr>
                                        <th>Giờ hẹn:</th>
                                        <td id="scheduledTime">-</td>
                                    </tr>
                                    <tr>
                                        <th>Chi nhánh:</th>
                                        <td id="branchName">-</td>
                                    </tr>
                                    <tr>
                                        <th>Điện thoại chi nhánh:</th>
                                        <td id="branchPhone">-</td>
                                    </tr>
                                    <tr>
                                        <th>Trạng thái:</th>
                                        <td id="statusBadge">-</td>
                                    </tr>
                                </table>
                            </div>
                        </div>

                        <div class="mt-3" id="actionButtons">
                            <button class="btn btn-danger" id="cancelBtn" style="display: none;" onclick="cancelSchedule()">
                                <i class="fas fa-times me-1"></i>
                                Hủy lịch hẹn
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const API_BASE_URL = '@apiBaseUrl';
        const scheduleId = @scheduleId;

        $(document).ready(function() {
            loadScheduleDetails();
        });

        function loadScheduleDetails() {
            const token = localStorage.getItem('authToken');
            fetch(`${API_BASE_URL}/ServiceSchedule/${scheduleId}`, {
                headers: {
                    'Authorization': token ? `Bearer ${token}` : '',
                    'Content-Type': 'application/json'
                }
            })
            .then(async response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}`);
                }
                return response.json();
            })
            .then(result => {
                if (result.success && result.data) {
                    const schedule = result.data;
                    displayScheduleDetails(schedule);
                } else {
                    alert('Không tìm thấy lịch hẹn');
                }
            })
            .catch(error => {
                console.error('Error loading schedule:', error);
                $('#loadingSpinner').html('<p class="text-danger">Lỗi tải dữ liệu: ' + error.message + '</p>');
            });
        }

        function displayScheduleDetails(schedule) {
            $('#userName').text(schedule.userName || '-');
            $('#userEmail').text(schedule.userEmail || '-');
            $('#userPhone').text(schedule.userPhone || '-');
            $('#carName').text(schedule.carName || '-');
            $('#licensePlate').text(schedule.licensePlate || '-');
            $('#carModel').text(schedule.carModel || '-');
            
            const date = new Date(schedule.scheduledDate);
            $('#scheduledDate').text(date.toLocaleDateString('vi-VN'));
            $('#scheduledTime').text(date.toLocaleTimeString('vi-VN', { hour: '2-digit', minute: '2-digit' }));
            
            $('#branchName').text(schedule.branchName || '-');
            $('#branchPhone').text(schedule.branchPhone || '-');

            let statusBadge = '';
            switch(schedule.statusCode) {
                case 'PENDING':
                    statusBadge = '<span class="badge bg-warning">Chờ xử lý</span>';
                    break;
                case 'CONFIRMED':
                    statusBadge = '<span class="badge bg-info">Đã xác nhận</span>';
                    break;
                case 'CANCELLED':
                    statusBadge = '<span class="badge bg-danger">Đã hủy</span>';
                    break;
                case 'COMPLETED':
                    statusBadge = '<span class="badge bg-success">Hoàn thành</span>';
                    break;
                default:
                    statusBadge = '<span class="badge bg-secondary">' + (schedule.statusName || schedule.statusCode) + '</span>';
            }
            $('#statusBadge').html(statusBadge);

            // Show/hide action buttons based on status
            if (schedule.statusCode !== 'CANCELLED' && schedule.statusCode !== 'COMPLETED') {
                $('#editBtn').show();
                $('#cancelBtn').show();
            }

            $('#loadingSpinner').hide();
            $('#scheduleDetails').show();
        }

        function cancelSchedule() {
            if (confirm('Bạn có chắc chắn muốn hủy lịch hẹn này?')) {
                const token = localStorage.getItem('authToken');
                fetch(`${API_BASE_URL}/ServiceSchedule/${scheduleId}/cancel`, {
                    method: 'PUT',
                    headers: {
                        'Authorization': token ? `Bearer ${token}` : '',
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({})
                })
                .then(async response => {
                    const result = await response.json();
                    if (result.success) {
                        alert('Hủy lịch hẹn thành công!');
                        loadScheduleDetails();
                    } else {
                        alert('Lỗi: ' + (result.message || 'Không thể hủy lịch hẹn'));
                    }
                })
                .catch(error => {
                    console.error('Error cancelling schedule:', error);
                    alert('Lỗi khi hủy lịch hẹn');
                });
            }
        }
    </script>
}

