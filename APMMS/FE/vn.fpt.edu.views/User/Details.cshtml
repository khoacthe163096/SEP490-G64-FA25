@{
    ViewData["Title"] = "Th√¥ng tin chi ti·∫øt ng∆∞·ªùi d√πng";
    Layout = "~/vn.fpt.edu.views/Shared/_DashboardLayout.cshtml";
}

<style>
    .user-profile-container {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 0;
    }
    
    .user-avatar-section {
        background: #f8f9fa;
        padding: 40px 30px;
        text-align: center;
        border-right: 1px solid #dee2e6;
    }
    
    /* Scope user-avatar to only profile section, not top bar */
    .user-profile-container .user-avatar-section .user-avatar {
        width: 250px;
        height: 250px;
        border-radius: 50%;
        object-fit: cover;
        border: 4px solid #dee2e6;
        background: #e9ecef;
    }
    
    .user-name {
        font-size: 1.3rem;
        font-weight: 600;
        margin-top: 20px;
        color: #212529;
    }
    
    .user-details-section {
        background: white;
        padding: 30px;
    }
    
    .info-tabs {
        border-bottom: 1px solid #dee2e6;
        margin-bottom: 30px;
    }
    
    .info-tabs .nav-link {
        color: #6c757d;
        padding: 12px 20px;
        border: none;
        border-bottom: 2px solid transparent;
    }
    
    .info-tabs .nav-link:hover {
        color: #495057;
    }
    
    .info-tabs .nav-link.active {
        color: #212529;
        border-bottom-color: #212529;
        font-weight: 500;
    }
    
    .info-field {
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 1px solid #f1f3f5;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .info-field:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }
    
    .info-label {
        font-size: 0.875rem;
        color: #6c757d;
        font-weight: 500;
        flex: 0 0 200px;
    }
    
    .info-value {
        font-size: 1rem;
        color: #212529;
        font-weight: 400;
        flex: 1;
        text-align: left;
    }
    
    /* Custom Notification Popup */
    .custom-notification {
        position: fixed;
        top: 20px;
        right: 20px;
        min-width: 350px;
        max-width: 500px;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        z-index: 10000;
        animation: slideInRight 0.3s ease-out;
        border-left: 4px solid #28a745;
    }
    
    .custom-notification.error {
        border-left-color: #dc3545;
    }
    
    .custom-notification.warning {
        border-left-color: #ffc107;
    }
    
    .custom-notification.info {
        border-left-color: #17a2b8;
    }
    
    @@keyframes slideInRight {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @@keyframes slideOutRight {
        from {
            transform: translateX(0);
            opacity: 1;
        }
        to {
            transform: translateX(100%);
            opacity: 0;
        }
    }
    
    .custom-notification.hide {
        animation: slideOutRight 0.3s ease-out forwards;
    }
    
    .notification-header {
        display: flex;
        align-items: center;
        padding: 16px 20px;
        border-bottom: 1px solid #e9ecef;
    }
    
    .notification-icon {
        width: 24px;
        height: 24px;
        margin-right: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 50%;
        flex-shrink: 0;
    }
    
    .notification-icon.success {
        background: #d4edda;
        color: #28a745;
    }
    
    .notification-icon.error {
        background: #f8d7da;
        color: #dc3545;
    }
    
    .notification-icon.warning {
        background: #fff3cd;
        color: #856404;
    }
    
    .notification-icon.info {
        background: #d1ecf1;
        color: #0c5460;
    }
    
    .notification-title {
        font-size: 1rem;
        font-weight: 600;
        color: #212529;
        margin: 0;
        flex: 1;
    }
    
    .notification-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: #6c757d;
        cursor: pointer;
        padding: 0;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        line-height: 1;
        transition: color 0.2s;
    }
    
    .notification-close:hover {
        color: #212529;
    }
    
    .notification-body {
        padding: 16px 20px;
        color: #495057;
        font-size: 0.9375rem;
        line-height: 1.5;
    }
    
    .form-section {
        background: #f8f9fa;
        border-radius: 4px;
        padding: 25px;
        margin-bottom: 20px;
    }
    
    .form-field {
        margin-bottom: 0;
        padding-bottom: 8px;
        padding-top: 8px;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        align-items: center;
        min-height: 40px;
    }
    
    .form-field:first-child {
        padding-top: 0;
    }
    
    .form-field:last-child {
        border-bottom: none;
        padding-bottom: 0;
    }
    
    .form-label {
        font-weight: 500;
        color: #6c757d;
        flex: 0 0 140px;
        margin-bottom: 0;
        font-size: 0.875rem;
        margin-right: 15px;
    }
    
    .form-label i {
        margin-right: 6px;
        color: #6c757d;
    }
    
    .form-control, .form-select {
        border: 1px solid #ced4da;
        border-radius: 4px;
        padding: 6px 12px;
        flex: 1;
        max-width: 350px;
        background-color: #f8f9fa;
        font-size: 0.9rem;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #80bdff;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
        background-color: #fff;
    }
    
    .btn-save {
        background: #007bff;
        border: none;
        padding: 10px 25px;
        border-radius: 4px;
        font-weight: 500;
        color: white;
    }
    
    .btn-save:hover {
        background: #0056b3;
        color: white;
    }
    
    .btn-cancel {
        background: #6c757d;
        border: none;
        padding: 10px 25px;
        border-radius: 4px;
        font-weight: 500;
        color: white;
    }
    
    .btn-cancel:hover {
        background: #5a6268;
        color: white;
    }
    
    .status-badge {
        display: inline-block;
        padding: 5px 12px;
        border-radius: 4px;
        font-weight: 500;
        font-size: 0.875rem;
    }
    
    .status-badge.active {
        background: #28a745;
        color: white;
    }
    
    .status-badge.inactive {
        background: #6c757d;
        color: white;
    }
    
    .image-preview-container {
        margin-top: 15px;
        padding: 15px;
        background: white;
        border-radius: 4px;
        border: 1px dashed #ced4da;
    }
    
    .image-preview-container img {
        border-radius: 4px;
    }
    
    /* Ensure top bar is not affected by any styles in this page */
    body.dashboard-body .top-bar {
        height: auto !important;
        min-height: auto !important;
        max-height: none !important;
        padding: 15px 30px !important;
        line-height: normal !important;
    }
    
    /* Ensure top bar avatar is not affected */
    body.dashboard-body .top-bar .user-avatar,
    body.dashboard-body .top-bar .user-avatar .avatar-btn {
        width: 40px !important;
        height: 40px !important;
    }
    
    /* Ensure top bar h2 is not affected */
    body.dashboard-body .top-bar h2 {
        margin: 0 !important;
        font-size: 1.5rem !important;
        line-height: 1.2 !important;
    }
</style>

<!-- Breadcrumb -->
<nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/Users"><i class="fas fa-users me-1"></i>Danh s√°ch ng∆∞·ªùi d√πng</a></li>
        <li class="breadcrumb-item active" id="userNameBreadcrumb">-</li>
    </ol>
</nav>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="user-profile-container">
                <div id="loadingSpinner" class="text-center p-5" style="background: white; min-height: 400px; display: flex; align-items: center; justify-content: center;">
                    <div>
                        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                            <span class="visually-hidden">ƒêang t·∫£i...</span>
                        </div>
                        <p class="mt-3 text-muted">ƒêang t·∫£i th√¥ng tin ng∆∞·ªùi d√πng...</p>
                    </div>
                </div>

                <div id="userDetails" style="display: none;">
                    <div class="row g-0">
                        <!-- Left Section: Avatar and Name -->
                        <div class="col-md-3 user-avatar-section">
                            <div class="mb-4">
                                <img id="userAvatar" src="" alt="Avatar" 
                                     class="user-avatar"
                                     onerror="this.src='data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'250\' height=\'250\'%3E%3Crect width=\'250\' height=\'250\' fill=\'%23f093fb\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'white\' font-size=\'120\'%3Eüë§%3C/text%3E%3C/svg%3E';">
                        </div>
                            <h4 id="userFullName" class="user-name">-</h4>
                    </div>

                        <!-- Right Section: Tabs and Details -->
                        <div class="col-md-9 user-details-section">
                            <!-- Tabs -->
                            <ul class="nav nav-tabs info-tabs" role="tablist">
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link active" id="personal-tab" data-bs-toggle="tab" 
                                            data-bs-target="#personal" type="button" role="tab" 
                                            aria-controls="personal" aria-selected="true">
                                        <i class="fas fa-user me-2"></i>Th√¥ng tin c√° nh√¢n
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="edit-tab" data-bs-toggle="tab" 
                                            data-bs-target="#edit" type="button" role="tab" 
                                            aria-controls="edit" aria-selected="false">
                                        <i class="fas fa-edit me-2"></i>Ch·ªânh s·ª≠a th√¥ng tin
                                    </button>
                                </li>
                                <li class="nav-item" role="presentation">
                                    <button class="nav-link" id="cars-tab" data-bs-toggle="tab" 
                                            data-bs-target="#cars" type="button" role="tab" 
                                            aria-controls="cars" aria-selected="false">
                                        <i class="fas fa-car me-2"></i>Danh s√°ch ph∆∞∆°ng ti·ªán kh√°ch h√†ng
                                    </button>
                                </li>
                            </ul>

                            <!-- Tab Content -->
                            <div class="tab-content">
                                <!-- Personal Information Tab -->
                                <div class="tab-pane fade show active" id="personal" role="tabpanel" aria-labelledby="personal-tab">
                                    <h5 class="mb-4" style="color: #212529; font-weight: 600;">Th√¥ng tin chi ti·∫øt</h5>
                        <div class="row">
                                        <div class="col-md-12">
                                            <div class="info-field">
                                                <div class="info-label">M√£ ng∆∞·ªùi d√πng</div>
                                                <div class="info-value" id="userCode">-</div>
                                            </div>
                                            
                                            <div class="info-field">
                                                <div class="info-label">H·ªç v√† t√™n</div>
                                                <div class="info-value" id="userName">-</div>
                                </div>

                                            <div class="info-field">
                                                <div class="info-label">Gi·ªõi t√≠nh</div>
                                                <div class="info-value" id="userGender">-</div>
                            </div>

                                            <div class="info-field">
                                                <div class="info-label">Ng√†y sinh</div>
                                                <div class="info-value" id="userDob">-</div>
                                            </div>
                                            
                                            <div class="info-field">
                                                <div class="info-label">ƒê·ªãa ch·ªâ</div>
                                                <div class="info-value" id="userAddress">-</div>
                            </div>
                                            
                                            <div class="info-field">
                                                <div class="info-label">CMT/CCCD</div>
                                                <div class="info-value" id="userCitizenId">-</div>
                        </div>
                                            
                                            <div class="info-field">
                                                <div class="info-label">S·ªë ƒëi·ªán tho·∫°i</div>
                                                <div class="info-value" id="userPhone">-</div>
                    </div>

                                            <div class="info-field">
                                                <div class="info-label">Email</div>
                                                <div class="info-value" id="userEmail">-</div>
                                            </div>
                                            
                                            <div class="info-field">
                                                <div class="info-label">M√£ s·ªë thu·∫ø</div>
                                                <div class="info-value" id="userTaxCode">-</div>
                                            </div>
                                            
                                            <div class="info-field">
                                                <div class="info-label">Ng√†y t·∫°o</div>
                                                <div class="info-value" id="userCreatedDate">-</div>
                                            </div>
                                            
                                            <div class="info-field">
                                                <div class="info-label">Ng∆∞·ªùi t·∫°o</div>
                                                <div class="info-value" id="userCreatedBy">-</div>
                                            </div>
                                            
                                            <div class="info-field">
                                                <div class="info-label">T√¨nh tr·∫°ng</div>
                                                <div class="info-value" id="userStatus">-</div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Edit Tab -->
                                <div class="tab-pane fade" id="edit" role="tabpanel" aria-labelledby="edit-tab">
                                    <form id="editUserForm">
                                        <div class="form-field">
                                            <label for="editFullName" class="form-label">
                                                <i class="fas fa-user"></i> H·ªç v√† t√™n
                                            </label>
                                            <input type="text" class="form-control" id="editFullName">
                                        </div>
                                        
                                        <div class="form-field">
                                            <label for="editPhone" class="form-label">
                                                <i class="fas fa-phone"></i> S·ªë ƒëi·ªán tho·∫°i
                                            </label>
                                            <input type="tel" class="form-control" id="editPhone">
                                        </div>
                                        
                                        <div class="form-field">
                                            <label for="editGender" class="form-label">
                                                <i class="fas fa-venus-mars"></i> Gi·ªõi t√≠nh
                                            </label>
                                            <select class="form-select" id="editGender">
                                                <option value="">-- Ch·ªçn gi·ªõi t√≠nh --</option>
                                                <option value="Nam">Nam</option>
                                                <option value="N·ªØ">N·ªØ</option>
                                                <option value="Kh√°c">Kh√°c</option>
                                            </select>
                                        </div>
                                        
                                        <div class="form-field">
                                            <label for="editDob" class="form-label">
                                                <i class="fas fa-calendar-alt"></i> Ng√†y sinh
                                            </label>
                                            <input type="date" class="form-control" id="editDob">
                                        </div>
                                        
                                        <div class="form-field">
                                            <label for="editEmail" class="form-label">
                                                <i class="fas fa-envelope"></i> Email
                                            </label>
                                            <input type="email" class="form-control" id="editEmail">
                                        </div>
                                        
                                        <div class="form-field">
                                            <label for="editAddress" class="form-label">
                                                <i class="fas fa-map-marker-alt"></i> ƒê·ªãa ch·ªâ
                                            </label>
                                            <input type="text" class="form-control" id="editAddress">
                                        </div>
                                        
                                        <div class="form-field">
                                            <label for="editCitizenId" class="form-label">
                                                <i class="fas fa-id-badge"></i> CMT/CCCD
                                            </label>
                                            <input type="text" class="form-control" id="editCitizenId">
                                        </div>
                                        
                                        <div class="form-field">
                                            <label for="editTaxCode" class="form-label">
                                                <i class="fas fa-receipt"></i> M√£ s·ªë thu·∫ø
                                            </label>
                                            <input type="text" class="form-control" id="editTaxCode">
                                        </div>
                                        
                                        <div class="form-field">
                                            <label for="userImageInput" class="form-label">
                                                <i class="fas fa-image"></i> ·∫¢nh ƒë·∫°i di·ªán
                                            </label>
                                            <input type="file" class="form-control" id="userImageInput" accept="image/*" style="max-width: 350px;">
                                        </div>
                                        
                                        <div class="d-flex justify-content-end mt-4">
                                            <button type="submit" class="btn btn-save text-white">
                                                <i class="fas fa-save me-1"></i> L∆∞u th√¥ng tin
                                            </button>
                                        </div>
                                    </form>
                                </div>

                                <!-- Cars Tab -->
                                <div class="tab-pane fade" id="cars" role="tabpanel" aria-labelledby="cars-tab">
                                    <div class="car-table">
                                        <div class="d-flex justify-content-between align-items-center mb-3">
                                            <h5 class="mb-0">Danh s√°ch ph∆∞∆°ng ti·ªán kh√°ch h√†ng</h5>
                                            <div class="d-flex gap-2">
                                                <input type="text" class="form-control form-control-sm" id="carSearchInput" placeholder="T√¨m theo ph∆∞∆°ng ti·ªán" style="width: 200px;">
                                                <button class="btn btn-primary btn-sm" onclick="loadUserCars()">
                                                    <i class="fas fa-sync-alt me-1"></i>L√†m m·ªõi
                                                </button>
                                            </div>
                                        </div>
                                        <div class="d-flex justify-content-start mb-3">
                                            <button class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addCarModal">
                                                <i class="fas fa-plus me-1"></i>Th√™m m·ªõi
                                            </button>
                                        </div>
                                        <div class="table-responsive">
                                            <table class="table table-striped table-hover">
                                                <thead class="table-dark">
                                                    <tr>
                                                        <th>T√™n ph∆∞∆°ng ti·ªán</th>
                                                        <th>Lo·∫°i ph∆∞∆°ng ti·ªán</th>
                                                        <th>Ng√†y t·∫°o</th>
                                                    </tr>
                                                </thead>
                                                <tbody id="carsTableBody">
                                                    <tr>
                                                        <td colspan="3" class="text-center text-muted">
                                                            <div class="spinner-border spinner-border-sm" role="status">
                                                                <span class="visually-hidden">ƒêang t·∫£i...</span>
                                                            </div>
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                        <div id="carsEmptyMessage" class="alert alert-info mt-3" style="display: none;">
                                            <i class="fas fa-info-circle me-2"></i>Ng∆∞·ªùi d√πng n√†y ch∆∞a c√≥ xe n√†o.
                                        </div>
                                    </div>
                                </div>
                            </div>
                            </div>
                        </div>
                    </div>

                <div id="errorMessage" class="alert alert-danger m-3" style="display: none; border-radius: 10px;">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span id="errorText">C√≥ l·ªói x·∫£y ra khi t·∫£i th√¥ng tin ng∆∞·ªùi d√πng</span>
                    </div>
                </div>
            </div>
        </div>
    </div>

<!-- Modal Th√™m xe cho kh√°ch h√†ng -->
<div class="modal fade" id="addCarModal" tabindex="-1" aria-labelledby="addCarModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addCarModalLabel">Th√™m xe cho kh√°ch h√†ng</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Tabs -->
                <ul class="nav nav-tabs mb-3" id="carFormTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="vehicleInfo-tab" data-bs-toggle="tab" data-bs-target="#vehicleInfo" type="button" role="tab" aria-controls="vehicleInfo" aria-selected="true">Th√¥ng tin ph∆∞∆°ng ti·ªán</button>
                    </li>
                </ul>
                
                <!-- Tab Content -->
                <div class="tab-content" id="carFormTabContent">
                    <div class="tab-pane fade show active" id="vehicleInfo" role="tabpanel" aria-labelledby="vehicleInfo-tab">
                        <form id="addCarForm">
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="carName" class="form-label">
                                        T√™n ph∆∞∆°ng ti·ªán <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="carName" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="carModel" class="form-label">
                                        Model <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="carModel" required>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="vehicleTypeId" class="form-label">
                                        Lo·∫°i ph∆∞∆°ng ti·ªán <span class="text-danger">*</span>
                                    </label>
                                    <select class="form-select" id="vehicleTypeId" required>
                                        <option value="">-- Ch·ªçn lo·∫°i ph∆∞∆°ng ti·ªán --</option>
                                    </select>
                                </div>
                                <div class="col-md-6">
                                    <label for="carColor" class="form-label">
                                        M√†u xe <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="carColor" required>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="yearOfManufacture" class="form-label">
                                        NƒÉm s·∫£n xu·∫•t <span class="text-danger">*</span>
                                    </label>
                                    <input type="number" class="form-control" id="yearOfManufacture" min="1900" max="2100" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="vinNumber" class="form-label">
                                        S·ªë khung(VIN) <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="vinNumber" required>
                                </div>
                            </div>
                            
                            <div class="row mb-3">
                                <div class="col-md-6">
                                    <label for="vehicleEngineNumber" class="form-label">
                                        S·ªë m√°y <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="vehicleEngineNumber" required>
                                </div>
                                <div class="col-md-6">
                                    <label for="licensePlate" class="form-label">
                                        Bi·ªÉn s·ªë xe <span class="text-danger">*</span>
                                    </label>
                                    <input type="text" class="form-control" id="licensePlate" required>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                <button type="button" class="btn btn-primary" onclick="submitAddCarForm()">Th√™m</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const API_BASE_URL = '@(ViewBag.ApiBaseUrl ?? "https://localhost:7173/api")';
        let currentUser = null;
        let originalFormData = null;

        // Custom Notification Function
        function showNotification(message, type = 'success') {
            // Remove existing notifications
            const existingNotifications = document.querySelectorAll('.custom-notification');
            existingNotifications.forEach(notif => {
                notif.classList.add('hide');
                setTimeout(() => notif.remove(), 300);
            });

            // Create notification element
            const notification = document.createElement('div');
            notification.className = `custom-notification ${type}`;
            
            const icons = {
                success: '<svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M13.854 3.646a.5.5 0 0 1 0 .708l-7 7a.5.5 0 0 1-.708 0l-3.5-3.5a.5.5 0 1 1 .708-.708L6.5 10.293l6.646-6.647a.5.5 0 0 1 .708 0z"/></svg>',
                error: '<svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293 5.354 4.646z"/></svg>',
                warning: '<svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M8.982 1.566a1.13 1.13 0 0 0-1.96 0L.165 13.233c-.457.778.091 1.767.98 1.767h13.713c.889 0 1.438-.99.98-1.767L8.982 1.566zM8 5c.535 0 .954.462.9.995l-.35 3.507a.552.552 0 0 1-1.1 0L7.1 5.995A.905.905 0 0 1 8 5zm.002 6a1 1 0 1 1 0 2 1 1 0 0 1 0-2z"/></svg>',
                info: '<svg width="16" height="16" viewBox="0 0 16 16" fill="currentColor"><path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451.081.082.381 1.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/></svg>'
            };
            
            const titles = {
                success: 'Th√†nh c√¥ng',
                error: 'L·ªói',
                warning: 'C·∫£nh b√°o',
                info: 'Th√¥ng tin'
            };
            
            notification.innerHTML = `
                <div class="notification-header">
                    <div class="notification-icon ${type}">
                        ${icons[type] || icons.info}
                    </div>
                    <h6 class="notification-title">${titles[type] || titles.info}</h6>
                    <button type="button" class="notification-close" onclick="this.closest('.custom-notification').classList.add('hide'); setTimeout(() => this.closest('.custom-notification').remove(), 300);">&times;</button>
                </div>
                <div class="notification-body">
                    ${message}
                </div>
            `;
            
            // Append to body
            document.body.appendChild(notification);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                notification.classList.add('hide');
                setTimeout(() => notification.remove(), 300);
            }, 5000);
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Initialize image preview handler
            initializeImagePreview();
            
            const userId = getUserIdFromUrl();
            if (userId) {
                loadUserDetails(userId);
                // Load cars when cars tab is clicked
                document.getElementById('cars-tab').addEventListener('shown.bs.tab', function() {
                    loadUserCars();
                });
            } else {
                showNotification('Kh√¥ng t√¨m th·∫•y ID ng∆∞·ªùi d√πng', 'error');
            }
            
            // Th√™m event listener cho √¥ t√¨m ki·∫øm ph∆∞∆°ng ti·ªán
            const carSearchInput = document.getElementById('carSearchInput');
            if (carSearchInput) {
                let searchTimeout;
                carSearchInput.addEventListener('input', function() {
                    clearTimeout(searchTimeout);
                    searchTimeout = setTimeout(function() {
                        loadUserCars();
                    }, 300);
                });
            }
            
            // Load vehicle types when modal is opened
            const addCarModal = document.getElementById('addCarModal');
            if (addCarModal) {
                addCarModal.addEventListener('show.bs.modal', function() {
                    loadVehicleTypes();
                });
                addCarModal.addEventListener('hidden.bs.modal', function() {
                    resetAddCarForm();
                });
            }
        });
        
        function initializeImagePreview() {
            // Handle user image input (edit form)
            const userImageInput = document.getElementById('userImageInput');
            if (userImageInput) {
                userImageInput.addEventListener('change', function(e) {
                    const file = e.target.files[0];
                    
                    if (file) {
                        // Validate file type
                        if (!file.type.startsWith('image/')) {
                            showNotification('Vui l√≤ng ch·ªçn file h√¨nh ·∫£nh h·ª£p l·ªá', 'warning');
                            e.target.value = '';
                            return;
                        }
                        
                        // Validate file size (max 5MB)
                        if (file.size > 5 * 1024 * 1024) {
                            showNotification('K√≠ch th∆∞·ªõc file kh√¥ng ƒë∆∞·ª£c v∆∞·ª£t qu√° 5MB', 'warning');
                            e.target.value = '';
                            return;
                        }
                        
                        // Create preview and update avatar
                        const reader = new FileReader();
                        reader.onload = function(event) {
                            const imageDataUrl = event.target.result;
                            
                            // Update avatar (left sidebar) - preview only
                            const userAvatar = document.getElementById('userAvatar');
                            if (userAvatar) {
                                userAvatar.src = imageDataUrl;
                            }
                        };
                        reader.onerror = function() {
                            showNotification('C√≥ l·ªói x·∫£y ra khi ƒë·ªçc file', 'error');
                            e.target.value = '';
                        };
                        reader.readAsDataURL(file);
                    } else {
                        // No file selected - restore original avatar
                        const userAvatar = document.getElementById('userAvatar');
                        if (userAvatar && currentUser) {
                            if (currentUser.image) {
                                userAvatar.src = currentUser.image;
                            } else {
                                // Reset to default placeholder
                                userAvatar.src = 'data:image/svg+xml,%3Csvg xmlns=\'http://www.w3.org/2000/svg\' width=\'250\' height=\'250\'%3E%3Crect width=\'250\' height=\'250\' fill=\'%23f093fb\'/%3E%3Ctext x=\'50%25\' y=\'50%25\' text-anchor=\'middle\' dy=\'.3em\' fill=\'white\' font-size=\'120\'%3Eüë§%3C/text%3E%3C/svg%3E';
                            }
                        }
                    }
                });
            }
        }

        function getUserIdFromUrl() {
            const path = window.location.pathname;
            const segments = path.split('/');
            return segments[segments.length - 1];
        }

        function loadUserDetails(id) {
            fetch(`${API_BASE_URL}/AutoOwner/${id}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    document.getElementById('loadingSpinner').style.display = 'none';
                    
                    // API tr·∫£ v·ªÅ tr·ª±c ti·∫øp ResponseDto
                    if (data && data.id) {
                        displayUserDetails(data);
                    } else if (data && data.success && data.data) {
                        displayUserDetails(data.data);
                    } else {
                        showError('Kh√¥ng t√¨m th·∫•y th√¥ng tin ng∆∞·ªùi d√πng');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    document.getElementById('loadingSpinner').style.display = 'none';
                    showError('C√≥ l·ªói x·∫£y ra khi t·∫£i th√¥ng tin ng∆∞·ªùi d√πng: ' + error.message);
                });
        }

        function displayUserDetails(user) {
            currentUser = user;
            
            const fullName = `${(user.firstName || '')} ${(user.lastName || '')}`.trim() || '-';
            
            // Breadcrumb
            document.getElementById('userNameBreadcrumb').textContent = fullName;
            
            // Avatar
            const avatar = document.getElementById('userAvatar');
            if (user.image) {
                avatar.src = user.image;
            }
            
            // Left section - only name
            document.getElementById('userFullName').textContent = fullName;
            
            // Details
            document.getElementById('userCode').textContent = user.code || '-';
            document.getElementById('userName').textContent = fullName;
            document.getElementById('userGender').textContent = 
                user.gender === 'Male' || user.gender === 'Nam' ? 'Nam' :
                user.gender === 'Female' || user.gender === 'N·ªØ' ? 'N·ªØ' : 
                user.gender || '-';
            
            // Display date of birth
            const dobElement = document.getElementById('userDob');
            if (dobElement) {
                const dobValue = user.dob;
                if (dobValue) {
                    try {
                        // Handle DateOnly format (YYYY-MM-DD) or Date object
                        let dob;
                        if (typeof dobValue === 'string') {
                            dob = new Date(dobValue);
            } else {
                            dob = new Date(dobValue);
                        }
                        if (!isNaN(dob.getTime())) {
                            const formattedDate = dob.toLocaleDateString('vi-VN', {
                                year: 'numeric',
                                month: '2-digit',
                                day: '2-digit'
                            });
                            dobElement.textContent = formattedDate;
                        } else {
                            dobElement.textContent = '-';
                        }
                    } catch (e) {
                        console.error('Error parsing date:', e, dobValue);
                        dobElement.textContent = '-';
                    }
            } else {
                    dobElement.textContent = '-';
                }
            }
            
            document.getElementById('userPhone').textContent = user.phone || '-';
            document.getElementById('userEmail').textContent = user.email || '-';
            document.getElementById('userAddress').textContent = user.address || '-';
            document.getElementById('userCitizenId').textContent = user.citizenId || '-';
            document.getElementById('userTaxCode').textContent = user.taxCode || '-';
            
            // Ng√†y t·∫°o
            const createdDateElement = document.getElementById('userCreatedDate');
            if (createdDateElement && user.createdDate) {
                try {
                    const createdDate = new Date(user.createdDate);
                    if (!isNaN(createdDate.getTime())) {
                        createdDateElement.textContent = createdDate.toLocaleDateString('vi-VN', {
                            year: 'numeric',
                            month: '2-digit',
                            day: '2-digit'
                        });
                    } else {
                        createdDateElement.textContent = '-';
                    }
                } catch (e) {
                    createdDateElement.textContent = '-';
                }
            } else if (createdDateElement) {
                createdDateElement.textContent = '-';
            }
            
            // Ng∆∞·ªùi t·∫°o (n·∫øu c√≥)
            const createdByElement = document.getElementById('userCreatedBy');
            if (createdByElement) {
                createdByElement.textContent = '-'; // Ch∆∞a c√≥ th√¥ng tin ng∆∞·ªùi t·∫°o trong DTO
            }
            
            // Status - ƒë·ªïi th√†nh "C√≥ hi·ªáu l·ª±c" / "Kh√¥ng hi·ªáu l·ª±c"
            const isActive = user.statusCode === 'ACTIVE';
            const statusDiv = document.getElementById('userStatus');
            statusDiv.innerHTML = isActive 
                ? '<span class="status-badge active">C√≥ hi·ªáu l·ª±c</span>'
                : '<span class="status-badge inactive">Kh√¥ng hi·ªáu l·ª±c</span>';
            
            // Load data into edit form
            loadEditForm(user);
            
            document.getElementById('userDetails').style.display = 'block';
        }

        function loadEditForm(user) {
            // G·ªôp firstName v√† lastName th√†nh fullName
            const fullName = `${(user.firstName || '')} ${(user.lastName || '')}`.trim();
            document.getElementById('editFullName').value = fullName || '';
            
            document.getElementById('editPhone').value = user.phone || '';
            document.getElementById('editGender').value = 
                user.gender === 'Male' || user.gender === 'Nam' ? 'Nam' :
                user.gender === 'Female' || user.gender === 'N·ªØ' ? 'N·ªØ' : 
                user.gender || '';
            
            // Load date of birth
            const dobInput = document.getElementById('editDob');
            if (dobInput) {
                const dobValue = user.dob;
                if (dobValue) {
                    try {
                        let dob;
                        if (typeof dobValue === 'string') {
                            dob = new Date(dobValue);
                        } else {
                            dob = new Date(dobValue);
                        }
                        if (!isNaN(dob.getTime())) {
                            // Format to YYYY-MM-DD for date input
                            const year = dob.getFullYear();
                            const month = String(dob.getMonth() + 1).padStart(2, '0');
                            const day = String(dob.getDate()).padStart(2, '0');
                            dobInput.value = `${year}-${month}-${day}`;
                        } else {
                            dobInput.value = '';
                        }
                    } catch (e) {
                        console.error('Error parsing date for input:', e);
                        dobInput.value = '';
                    }
                } else {
                    dobInput.value = '';
                }
            }
            
            document.getElementById('editEmail').value = user.email || '';
            document.getElementById('editAddress').value = user.address || '';
            document.getElementById('editTaxCode').value = user.taxCode || '';
            document.getElementById('editCitizenId').value = user.citizenId || '';

            // Store original data
            originalFormData = {
                fullName: fullName || '',
                phone: user.phone || '',
                gender: document.getElementById('editGender').value,
                dob: dobInput ? dobInput.value : '',
                email: user.email || '',
                address: user.address || '',
                taxCode: user.taxCode || '',
                citizenId: user.citizenId || ''
            };
        }

        function resetEditForm() {
            if (originalFormData) {
                document.getElementById('editFullName').value = originalFormData.fullName || '';
                document.getElementById('editPhone').value = originalFormData.phone;
                document.getElementById('editGender').value = originalFormData.gender;
                const dobInput = document.getElementById('editDob');
                if (dobInput) {
                    dobInput.value = originalFormData.dob || '';
                }
                document.getElementById('editEmail').value = originalFormData.email;
                document.getElementById('editAddress').value = originalFormData.address;
                document.getElementById('editTaxCode').value = originalFormData.taxCode;
                document.getElementById('editCitizenId').value = originalFormData.citizenId;
                document.getElementById('userImageInput').value = '';
                
                // Restore original avatar image when resetting
                const userAvatar = document.getElementById('userAvatar');
                if (userAvatar && currentUser && currentUser.image) {
                    userAvatar.src = currentUser.image;
                }
            }
        }

        function showError(message) {
            showNotification(message, 'error');
        }

        // Handle edit form submission
        document.getElementById('editUserForm')?.addEventListener('submit', function(e) {
            e.preventDefault();
            saveUserChanges();
        });

        function saveUserChanges() {
            if (!currentUser) {
                showError('Kh√¥ng t√¨m th·∫•y th√¥ng tin ng∆∞·ªùi d√πng');
                return;
            }

            // Format date of birth from input (format: YYYY-MM-DD for backend DateOnly)
            let dobFormatted = null;
            const dobInput = document.getElementById('editDob');
            if (dobInput && dobInput.value) {
                try {
                    const dobDate = new Date(dobInput.value);
                    if (!isNaN(dobDate.getTime())) {
                        // Format as YYYY-MM-DD for DateOnly
                        const year = dobDate.getFullYear();
                        const month = String(dobDate.getMonth() + 1).padStart(2, '0');
                        const day = String(dobDate.getDate()).padStart(2, '0');
                        dobFormatted = `${year}-${month}-${day}`;
                    }
                } catch (e) {
                    console.error('Error formatting date of birth:', e);
                }
            }

            // Validate required fields
            if (!currentUser.username) {
                showError('Kh√¥ng t√¨m th·∫•y th√¥ng tin username c·ªßa ng∆∞·ªùi d√πng');
                return;
            }
            
            if (!currentUser.id) {
                showError('Kh√¥ng t√¨m th·∫•y ID ng∆∞·ªùi d√πng. Vui l√≤ng l√†m m·ªõi trang v√† th·ª≠ l·∫°i.');
                return;
            }

            // Split fullName th√†nh firstName v√† lastName
            const fullNameInput = document.getElementById('editFullName').value.trim();
            const nameParts = fullNameInput.split(' ');
            const firstName = nameParts[0] || '';
            const lastName = nameParts.slice(1).join(' ') || '';

            const formData = {
                username: currentUser.username,
                password: '', // Empty password - backend should preserve existing password
                firstName: firstName || null,
                lastName: lastName || null,
                email: document.getElementById('editEmail').value || null,
                phone: document.getElementById('editPhone').value || null,
                gender: document.getElementById('editGender').value || null,
                image: currentUser.image || null,
                taxCode: document.getElementById('editTaxCode').value || null,
                address: document.getElementById('editAddress').value || null,
                citizenId: document.getElementById('editCitizenId').value || null,
                dob: dobFormatted,
                branchId: currentUser.branchId || null
            };
            
            // Remove null/empty values except username and password (they are required by DTO)
            Object.keys(formData).forEach(key => {
                if (key !== 'username' && key !== 'password' && key !== 'branchId' && (formData[key] === null || formData[key] === '')) {
                    delete formData[key];
                }
            });
            
            console.log('Sending update request with data:', formData);
            console.log('User ID being updated:', currentUser.id);

            const token = localStorage.getItem('authToken');

            // Handle image upload if file is selected
            const imageFile = document.getElementById('userImageInput').files[0];
            
            // Function to update user
            const updateUser = (imageUrl = null) => {
                // N·∫øu c√≥ imageUrl t·ª´ upload, c·∫≠p nh·∫≠t v√†o formData
                if (imageUrl) {
                    formData.image = imageUrl;
                }
                
                return fetch(`${API_BASE_URL}/AutoOwner/${currentUser.id}`, {
                method: 'PUT',
                headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(formData)
                });
            };

            // Upload ·∫£nh tr∆∞·ªõc n·∫øu c√≥ file ƒë∆∞·ª£c ch·ªçn
            if (imageFile) {
                // Hi·ªÉn th·ªã loading state
                const submitButton = document.querySelector('button[type="submit"]');
                const originalButtonText = submitButton.innerHTML;
                submitButton.disabled = true;
                submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> ƒêang upload ·∫£nh...';

                // Upload ·∫£nh l√™n Cloudinary
                const uploadFormData = new FormData();
                uploadFormData.append('file', imageFile);

                fetch(`${API_BASE_URL}/AutoOwner/${currentUser.id}/upload-avatar`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: uploadFormData
            })
            .then(async response => {
                if (!response.ok) {
                        let errorMessage = `Upload ·∫£nh th·∫•t b·∫°i. Status: ${response.status}`;
                        try {
                            const errorData = await response.json();
                            errorMessage = errorData.message || errorData.error || errorMessage;
                        } catch (e) {
                            if (response.status === 401) {
                                errorMessage = 'Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.';
                            } else if (response.status === 400) {
                                errorMessage = 'File ·∫£nh kh√¥ng h·ª£p l·ªá. Vui l√≤ng ch·ªçn file kh√°c.';
                            } else if (response.status === 403) {
                                errorMessage = 'B·∫°n kh√¥ng c√≥ quy·ªÅn th·ª±c hi·ªán thao t√°c n√†y.';
                            }
                        }
                        throw new Error(errorMessage);
                    }
                    return response.json();
                })
                .then(uploadData => {
                    // Upload th√†nh c√¥ng, l·∫•y URL ·∫£nh
                    const imageUrl = uploadData.data?.imageUrl || uploadData.data?.url;
                    if (!imageUrl) {
                        throw new Error('Kh√¥ng nh·∫≠n ƒë∆∞·ª£c URL ·∫£nh t·ª´ server');
                    }

                    // C·∫≠p nh·∫≠t avatar preview ngay l·∫≠p t·ª©c
                    const userAvatar = document.getElementById('userAvatar');
                    if (userAvatar) {
                        userAvatar.src = imageUrl;
                    }

                    // C·∫≠p nh·∫≠t currentUser.image ƒë·ªÉ gi·ªØ ƒë·ªìng b·ªô
                    if (currentUser) {
                        currentUser.image = imageUrl;
                    }

                    // Update button text
                    submitButton.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> ƒêang l∆∞u th√¥ng tin...';

                    // Ti·∫øp t·ª•c c·∫≠p nh·∫≠t user (·∫£nh ƒë√£ ƒë∆∞·ª£c l∆∞u v√†o DB khi upload, kh√¥ng c·∫ßn g·ª≠i l·∫°i)
                    // B·ªè image kh·ªèi formData v√¨ ƒë√£ ƒë∆∞·ª£c l∆∞u
                    delete formData.image;
                    return updateUser();
                })
                .then(async response => {
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalButtonText;

                    if (!response.ok) {
                    let errorMessage = `HTTP error! status: ${response.status}`;
                    try {
                        const errorData = await response.json();
                        errorMessage = errorData.message || errorData.error || errorMessage;
                    } catch (e) {
                        if (response.status === 404) {
                            errorMessage = 'Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng v·ªõi ID n√†y. Vui l√≤ng l√†m m·ªõi trang v√† th·ª≠ l·∫°i.';
                        } else if (response.status === 401) {
                            errorMessage = 'Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.';
                        } else if (response.status === 403) {
                            errorMessage = 'B·∫°n kh√¥ng c√≥ quy·ªÅn th·ª±c hi·ªán thao t√°c n√†y.';
                        }
                    }
                    throw new Error(errorMessage);
                }
                return response.json();
            })
            .then(data => {
                // Reload user details
                loadUserDetails(currentUser.id);
                
                // Show success message
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-success alert-dismissible fade show';
                alertDiv.style.borderRadius = '10px';
                alertDiv.innerHTML = `
                        <i class="fas fa-check-circle me-2"></i> C·∫≠p nh·∫≠t th√¥ng tin v√† ·∫£nh ƒë·∫°i di·ªán th√†nh c√¥ng!
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                const detailsSection = document.querySelector('.user-details-section');
                if (detailsSection) {
                    detailsSection.insertBefore(alertDiv, detailsSection.querySelector('.info-tabs'));
                }
                
                // Switch to personal info tab
                const personalTab = document.getElementById('personal-tab');
                if (personalTab) {
                    personalTab.click();
                }

                    // Reset image input
                    document.getElementById('userImageInput').value = '';

                setTimeout(() => {
                    alertDiv.remove();
                }, 3000);
            })
            .catch(error => {
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalButtonText;
                console.error('Error:', error);
                    showError('C√≥ l·ªói x·∫£y ra: ' + error.message);
                });
            } else {
                // Kh√¥ng c√≥ ·∫£nh m·ªõi, ch·ªâ c·∫≠p nh·∫≠t user th√¥i
                updateUser()
                .then(async response => {
                    if (!response.ok) {
                        let errorMessage = `HTTP error! status: ${response.status}`;
                        try {
                            const errorData = await response.json();
                            errorMessage = errorData.message || errorData.error || errorMessage;
                        } catch (e) {
                            if (response.status === 404) {
                                errorMessage = 'Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng v·ªõi ID n√†y. Vui l√≤ng l√†m m·ªõi trang v√† th·ª≠ l·∫°i.';
                            } else if (response.status === 401) {
                                errorMessage = 'Phi√™n ƒëƒÉng nh·∫≠p ƒë√£ h·∫øt h·∫°n. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.';
                            } else if (response.status === 403) {
                                errorMessage = 'B·∫°n kh√¥ng c√≥ quy·ªÅn th·ª±c hi·ªán thao t√°c n√†y.';
                            }
                        }
                        throw new Error(errorMessage);
                    }
                    return response.json();
                })
                .then(data => {
                    // Reload user details
                    loadUserDetails(currentUser.id);
                    
                    // Show success message
                    showNotification('C·∫≠p nh·∫≠t th√¥ng tin th√†nh c√¥ng!', 'success');
                    
                    // Switch to personal info tab
                    const personalTab = document.getElementById('personal-tab');
                    if (personalTab) {
                        personalTab.click();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showNotification('C√≥ l·ªói x·∫£y ra khi c·∫≠p nh·∫≠t th√¥ng tin: ' + error.message, 'error');
                });
            }
        }

        function loadUserCars() {
            if (!currentUser || !currentUser.id) {
                document.getElementById('carsTableBody').innerHTML = 
                    '<tr><td colspan="3" class="text-center text-danger">Kh√¥ng t√¨m th·∫•y ID ng∆∞·ªùi d√πng</td></tr>';
                return;
            }

            const tbody = document.getElementById('carsTableBody');
            tbody.innerHTML = `
                <tr>
                    <td colspan="3" class="text-center text-muted">
                        <div class="spinner-border spinner-border-sm" role="status">
                            <span class="visually-hidden">ƒêang t·∫£i...</span>
                        </div>
                    </td>
                </tr>
            `;

            fetch(`${API_BASE_URL}/CarOfAutoOwner/user/${currentUser.id}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(cars => {
                    tbody.innerHTML = '';
                    
                    if (!cars || cars.length === 0) {
                        document.getElementById('carsEmptyMessage').style.display = 'block';
                        tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">Kh√¥ng c√≥ d·ªØ li·ªáu</td></tr>';
                        return;
                    }

                    document.getElementById('carsEmptyMessage').style.display = 'none';
                    
                    // L·ªçc theo t·ª´ kh√≥a t√¨m ki·∫øm n·∫øu c√≥
                    const searchInput = document.getElementById('carSearchInput');
                    const searchTerm = searchInput ? searchInput.value.toLowerCase().trim() : '';
                    let filteredCars = cars;
                    
                    if (searchTerm) {
                        filteredCars = cars.filter(car => {
                            const carName = (car.carName || '').toLowerCase();
                            const carModel = (car.carModel || '').toLowerCase();
                            return carName.includes(searchTerm) || carModel.includes(searchTerm);
                        });
                    }
                    
                    if (filteredCars.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="3" class="text-center text-muted">Kh√¥ng t√¨m th·∫•y ph∆∞∆°ng ti·ªán n√†o</td></tr>';
                        return;
                    }
                    
                    filteredCars.forEach(car => {
                        const row = document.createElement('tr');
                        const createdDate = car.createdDate 
                            ? new Date(car.createdDate).toLocaleDateString('vi-VN', {
                                day: '2-digit',
                                month: '2-digit',
                                year: 'numeric'
                            })
                            : '-';
                        
                        row.innerHTML = `
                            <td><a href="/Users/CarDetail/${car.id}" style="color: #007bff; text-decoration: none; cursor: pointer;">${car.carName || '-'}</a></td>
                            <td>${car.carModel || '-'}</td>
                            <td>${createdDate}</td>
                        `;
                        tbody.appendChild(row);
                    });
                })
                .catch(error => {
                    console.error('Error loading cars:', error);
                    tbody.innerHTML = '<tr><td colspan="3" class="text-center text-danger">L·ªói khi t·∫£i danh s√°ch xe: ' + error.message + '</td></tr>';
                    document.getElementById('carsEmptyMessage').style.display = 'none';
                });
        }
        
        // Load vehicle types for dropdown
        function loadVehicleTypes() {
            fetch(`${API_BASE_URL}/VehicleType`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(vehicleTypes => {
                    const select = document.getElementById('vehicleTypeId');
                    if (select) {
                        select.innerHTML = '<option value="">-- Ch·ªçn lo·∫°i ph∆∞∆°ng ti·ªán --</option>';
                        if (vehicleTypes && Array.isArray(vehicleTypes)) {
                            vehicleTypes.forEach(vt => {
                                const option = document.createElement('option');
                                option.value = vt.id;
                                option.textContent = vt.name;
                                select.appendChild(option);
                            });
                        }
                    }
                })
                .catch(error => {
                    console.error('Error loading vehicle types:', error);
                });
        }
        
        // Submit add car form
        function submitAddCarForm() {
            if (!currentUser || !currentUser.id) {
                showNotification('Kh√¥ng t√¨m th·∫•y th√¥ng tin ng∆∞·ªùi d√πng', 'error');
                return;
            }
            
            const form = document.getElementById('addCarForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }
            
            const formData = {
                userId: currentUser.id,
                carName: document.getElementById('carName').value,
                carModel: document.getElementById('carModel').value,
                vehicleTypeId: parseInt(document.getElementById('vehicleTypeId').value),
                color: document.getElementById('carColor').value,
                yearOfManufacture: parseInt(document.getElementById('yearOfManufacture').value),
                vinNumber: document.getElementById('vinNumber').value,
                vehicleEngineNumber: document.getElementById('vehicleEngineNumber').value,
                licensePlate: document.getElementById('licensePlate').value
                // Kh√¥ng g·ª≠i branchId v√¨ xe c·ªßa kh√°ch h√†ng kh√¥ng c·∫ßn chi nh√°nh
            };
            
            // L·∫•y token t·ª´ localStorage - th·ª≠ nhi·ªÅu key c√≥ th·ªÉ
            let token = localStorage.getItem('authToken') || localStorage.getItem('token');
            
            // N·∫øu v·∫´n kh√¥ng c√≥, th·ª≠ l·∫•y t·ª´ userInfo
            if (!token) {
                const userInfo = localStorage.getItem('userInfo');
                if (userInfo) {
                    try {
                        const userInfoObj = JSON.parse(userInfo);
                        token = userInfoObj.token;
                    } catch (e) {
                        console.error('Error parsing userInfo:', e);
                    }
                }
            }
            
            if (!token) {
                showNotification('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ th·ª±c hi·ªán thao t√°c n√†y. Vui l√≤ng ƒëƒÉng nh·∫≠p l·∫°i.', 'warning');
                console.error('Token not found in localStorage. Available keys:', Object.keys(localStorage));
                return;
            }
            
            // Show loading state
            const submitBtn = document.querySelector('#addCarModal .btn-primary');
            if (!submitBtn) {
                showNotification('Kh√¥ng t√¨m th·∫•y n√∫t submit', 'error');
                return;
            }
            const originalText = submitBtn.innerHTML;
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>ƒêang th√™m...';
            
            console.log('Submitting car data:', formData);
            console.log('Using token:', token ? 'Token exists' : 'No token');
            
            fetch(`${API_BASE_URL}/CarOfAutoOwner`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${token}`
                },
                body: JSON.stringify(formData)
            })
            .then(async response => {
                console.log('Response status:', response.status);
                const responseData = await response.json().catch(() => ({}));
                
                if (!response.ok) {
                    // Extract error message from response
                    let errorMessage = 'ƒê√£ x·∫£y ra l·ªói khi th√™m xe.';
                    
                    if (responseData.message) {
                        errorMessage = responseData.message;
                    } else if (responseData.error) {
                        errorMessage = responseData.error;
                    } else if (response.status === 400) {
                        errorMessage = 'D·ªØ li·ªáu kh√¥ng h·ª£p l·ªá. Vui l√≤ng ki·ªÉm tra l·∫°i th√¥ng tin.';
                    } else if (response.status === 500) {
                        errorMessage = 'L·ªói server. Vui l√≤ng th·ª≠ l·∫°i sau.';
                    }
                    
                    console.error('Error response:', responseData);
                    throw new Error(errorMessage);
                }
                
                return responseData;
            })
            .then(data => {
                showNotification('Th√™m xe th√†nh c√¥ng!', 'success');
                // Close modal
                const modal = bootstrap.Modal.getInstance(document.getElementById('addCarModal'));
                if (modal) {
                    modal.hide();
                }
                // Reset form
                document.getElementById('addCarForm').reset();
                // Reload cars list
                loadUserCars();
            })
            .catch(error => {
                console.error('Error adding car:', error);
                showNotification('L·ªói khi th√™m xe: ' + error.message, 'error');
            })
            .finally(() => {
                if (submitBtn) {
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
                }
            });
        }
        
        // Reset add car form
        function resetAddCarForm() {
            const form = document.getElementById('addCarForm');
            if (form) {
                form.reset();
            }
        }
    </script>
}
