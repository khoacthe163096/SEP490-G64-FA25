@{
    ViewData["Title"] = "Danh sách xe của người dùng";
    Layout = "~/vn.fpt.edu.views/Shared/_DashboardLayout.cshtml";
}

<div class="container-fluid">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h4 class="mb-0">🚗 Danh sách xe của người dùng</h4>
            <a href="/Users/Details/@ViewBag.UserId" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Quay lại người dùng
            </a>
        </div>
        <div class="card-body">
            <table class="table table-bordered table-hover" id="carTable">
                <thead class="table-light">
                    <tr>
                        <th>ID</th>
                        <th>Tên phương tiện</th>
                        <th>Model</th>
                        <th>Biển số</th>
                        <th>Ngày tạo</th>
                        <th>Hành động</th>
                    </tr>
                </thead>
                <tbody id="carTableBody">
                    <tr><td colspan="6" class="text-center">Đang tải...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const API_BASE = "https://localhost:7173/api";
        const ownerId = window.location.pathname.split("/").pop();

        document.addEventListener("DOMContentLoaded", loadCars);

        function loadCars() {
            fetch(`${API_BASE}/CarOfAutoOwner/user/${ownerId}`)
                .then(res => res.json())
                .then(cars => {
                    const tbody = document.getElementById("carTableBody");
                    tbody.innerHTML = "";

                    if (cars.length === 0) {
                        tbody.innerHTML = `<tr><td colspan="6" class="text-center text-muted">Không có xe nào</td></tr>`;
                        return;
                    }

                    cars.forEach(car => {
                        const row = `
                                <tr>
                                    <td>${car.id}</td>
                                            <td>${car.carName || '-'}</td>
                                            <td>${car.carModel || '-'}</td>
                                            <td>${car.licensePlate || '-'}</td>
                                    <td>${car.createdDate ? new Date(car.createdDate).toLocaleString('vi-VN') : '-'}</td>
                                    <td>
                                        <button class="btn btn-sm btn-warning" onclick="editCar(${car.id})">
                                            <i class="fas fa-edit"></i>
                                        </button>
                                        <button class="btn btn-sm btn-danger" onclick="deleteCar(${car.id})">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>`;
                        tbody.innerHTML += row;
                    });
                })
                .catch(err => {
                    console.error("Lỗi:", err);
                    document.getElementById("carTableBody").innerHTML =
                        `<tr><td colspan="6" class="text-center text-danger">Lỗi khi tải dữ liệu</td></tr>`;
                });
        }

        function deleteCar(id) {
            if (!confirm("Xóa xe này?")) return;
            fetch(`${API_BASE}/CarOfAutoOwner/${id}`, { method: "DELETE" })
                .then(res => {
                    if (!res.ok) throw new Error("Xóa thất bại");
                    loadCars();
                })
                .catch(err => alert(err.message));
        }

        function editCar(id) {
            window.location.href = `/Users/EditCar/${id}`;
        }
    </script>
}
