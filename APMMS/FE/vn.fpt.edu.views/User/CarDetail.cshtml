@{
    ViewData["Title"] = "Chi tiết phương tiện";
    Layout = "~/vn.fpt.edu.views/Shared/_DashboardLayout.cshtml";
}

<style>
    .car-detail-container {
        background: white;
        border: 1px solid #dee2e6;
        border-radius: 8px;
        padding: 0;
    }
    
    .car-info-section {
        background: white;
        padding: 30px;
    }
    
    .info-tabs {
        border-bottom: 1px solid #dee2e6;
        margin-bottom: 30px;
    }
    
    .info-tabs .nav-link {
        color: #6c757d;
        padding: 12px 20px;
        border: none;
        border-bottom: 2px solid transparent;
    }
    
    .info-tabs .nav-link:hover {
        color: #495057;
    }
    
    .info-tabs .nav-link.active {
        color: #212529;
        border-bottom-color: #212529;
        font-weight: 500;
    }
    
    .info-field {
        margin-bottom: 10px;
        padding-bottom: 10px;
        border-bottom: 1px solid #f1f3f5;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .info-field:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }
    
    .info-label {
        font-size: 0.875rem;
        color: #6c757d;
        font-weight: 500;
        flex: 0 0 200px;
    }
    
    .info-value {
        font-size: 1rem;
        color: #212529;
        font-weight: 400;
        flex: 1;
        text-align: left;
    }
    
    .form-field {
        margin-bottom: 0;
        padding-bottom: 6px;
        padding-top: 6px;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        align-items: center;
        min-height: 40px;
    }
    
    .form-field:first-child {
        padding-top: 0;
    }
    
    .form-field:last-child {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }
    
    .form-label {
        font-weight: 500;
        color: #6c757d;
        flex: 0 0 140px;
        margin-bottom: 0;
        font-size: 0.875rem;
        margin-right: 15px;
    }
    
    .form-control, .form-select {
        border: 1px solid #ced4da;
        border-radius: 4px;
        padding: 6px 12px;
        flex: 1;
        max-width: 350px;
        background-color: #f8f9fa;
        font-size: 0.9rem;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #80bdff;
        box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25);
        background-color: #fff;
    }
    
    .btn-save {
        background: #007bff;
        border: none;
        padding: 10px 25px;
        border-radius: 4px;
        font-weight: 500;
        color: white;
    }
    
    .btn-save:hover {
        background: #0056b3;
        color: white;
    }
    
    .history-section {
        background: white;
        padding: 30px;
        border-left: 1px solid #dee2e6;
    }
    
    .history-table {
        margin-top: 20px;
    }
    
    .history-table thead th {
        background-color: #f8f9fa;
        border-bottom: 2px solid #dee2e6;
        font-weight: 600;
        color: #212529;
        padding: 12px;
        cursor: pointer;
    }
    
    .history-table tbody td {
        padding: 12px;
        vertical-align: middle;
    }
    
    .empty-history {
        text-align: center;
        padding: 40px;
        color: #6c757d;
    }
</style>

<!-- Breadcrumb -->
<nav aria-label="breadcrumb" class="mb-4">
    <ol class="breadcrumb">
        <li class="breadcrumb-item"><a href="/Users"><i class="fas fa-users me-1"></i>Danh sách người dùng</a></li>
        <li class="breadcrumb-item active" id="carNameBreadcrumb">-</li>
    </ol>
</nav>

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="car-detail-container">
                <div id="loadingSpinner" class="text-center p-5" style="background: white; min-height: 400px; display: flex; align-items: center; justify-content: center;">
                    <div>
                        <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;">
                            <span class="visually-hidden">Đang tải...</span>
                        </div>
                        <p class="mt-3 text-muted">Đang tải thông tin phương tiện...</p>
                    </div>
                </div>
                
                <div id="carDetails" style="display: none;">
                    <div class="row g-0">
                        <!-- Left Section: Car Information -->
                        <div class="col-md-7">
                            <div class="car-info-section">
                                <ul class="nav nav-tabs info-tabs" id="carInfoTabs" role="tablist">
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link" id="detail-tab" data-bs-toggle="tab" data-bs-target="#detail" type="button" role="tab" aria-controls="detail" aria-selected="false">
                                            <i class="fas fa-info-circle me-2"></i>Thông tin chi tiết
                                        </button>
                                    </li>
                                    <li class="nav-item" role="presentation">
                                        <button class="nav-link active" id="edit-tab" data-bs-toggle="tab" data-bs-target="#edit" type="button" role="tab" aria-controls="edit" aria-selected="true">
                                            <i class="fas fa-edit me-2"></i>Chỉnh sửa thông tin
                                        </button>
                                    </li>
                                </ul>
                                
                                <div class="tab-content" id="carInfoTabContent">
                                    <!-- Detail Tab -->
                                    <div class="tab-pane fade" id="detail" role="tabpanel" aria-labelledby="detail-tab">
                                        <div class="col-md-12">
                                            <div class="info-field">
                                                <div class="info-label">Tên phương tiện</div>
                                                <div class="info-value" id="carName">-</div>
                                            </div>
                                            <div class="info-field">
                                                <div class="info-label">Model</div>
                                                <div class="info-value" id="carModel">-</div>
                                            </div>
                                            <div class="info-field">
                                                <div class="info-label">Loại phương tiện</div>
                                                <div class="info-value" id="vehicleType">-</div>
                                            </div>
                                            <div class="info-field">
                                                <div class="info-label">Màu xe</div>
                                                <div class="info-value" id="carColor">-</div>
                                            </div>
                                            <div class="info-field">
                                                <div class="info-label">Năm sản xuất</div>
                                                <div class="info-value" id="yearOfManufacture">-</div>
                                            </div>
                                            <div class="info-field">
                                                <div class="info-label">Số khung(VIN)</div>
                                                <div class="info-value" id="vinNumber">-</div>
                                            </div>
                                            <div class="info-field">
                                                <div class="info-label">Số máy</div>
                                                <div class="info-value" id="vehicleEngineNumber">-</div>
                                            </div>
                                            <div class="info-field">
                                                <div class="info-label">Biển số xe</div>
                                                <div class="info-value" id="licensePlate">-</div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Edit Tab -->
                                    <div class="tab-pane fade show active" id="edit" role="tabpanel" aria-labelledby="edit-tab">
                                        <form id="editCarForm">
                                            <div class="form-field">
                                                <label for="editCarName" class="form-label">Tên phương tiện</label>
                                                <input type="text" class="form-control" id="editCarName">
                                            </div>
                                            <div class="form-field">
                                                <label for="editCarModel" class="form-label">Model</label>
                                                <input type="text" class="form-control" id="editCarModel">
                                            </div>
                                            <div class="form-field">
                                                <label for="editVehicleTypeId" class="form-label">Loại phương tiện</label>
                                                <select class="form-select" id="editVehicleTypeId">
                                                    <option value="">-- Chọn loại phương tiện --</option>
                                                </select>
                                            </div>
                                            <div class="form-field">
                                                <label for="editCarColor" class="form-label">Màu xe</label>
                                                <input type="text" class="form-control" id="editCarColor">
                                            </div>
                                            <div class="form-field">
                                                <label for="editYearOfManufacture" class="form-label">Năm sản xuất</label>
                                                <input type="number" class="form-control" id="editYearOfManufacture" min="1900" max="2100">
                                            </div>
                                            <div class="form-field">
                                                <label for="editVinNumber" class="form-label">Số khung(VIN)</label>
                                                <input type="text" class="form-control" id="editVinNumber">
                                            </div>
                                            <div class="form-field">
                                                <label for="editVehicleEngineNumber" class="form-label">Số máy</label>
                                                <input type="text" class="form-control" id="editVehicleEngineNumber">
                                            </div>
                                            <div class="form-field">
                                                <label for="editLicensePlate" class="form-label">Biển số xe</label>
                                                <input type="text" class="form-control" id="editLicensePlate">
                                            </div>
                                            <div class="d-flex justify-content-end mt-4">
                                                <button type="submit" class="btn btn-save text-white">
                                                    <i class="fas fa-save me-1"></i> Lưu thông tin
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Right Section: Maintenance History -->
                        <div class="col-md-5">
                            <div class="history-section">
                                <h5 class="mb-3">Lịch sử bảo dưỡng và sửa chữa</h5>
                                <h6 class="text-muted mb-3">Danh sách</h6>
                                <div class="table-responsive history-table">
                                    <table class="table table-hover">
                                        <thead>
                                            <tr>
                                                <th>Ngày thanh toán <i class="fas fa-sort"></i></th>
                                                <th>Mã phiếu bảo dưỡng <i class="fas fa-sort"></i></th>
                                                <th>Tổng phụ (Subtotal) <i class="fas fa-sort"></i></th>
                                                <th>Thuế VAT <i class="fas fa-sort"></i></th>
                                                <th>Phụ thu <i class="fas fa-sort"></i></th>
                                                <th>Giảm giá <i class="fas fa-sort"></i></th>
                                                <th>Tổng thanh toán <i class="fas fa-sort"></i></th>
                                            </tr>
                                        </thead>
                                        <tbody id="maintenanceHistoryBody">
                                            <tr>
                                                <td colspan="7" class="empty-history">Xe không có dịch vụ nào từng được thực hiện!</td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="errorMessage" class="alert alert-danger m-3" style="display: none; border-radius: 10px;">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span id="errorText">Có lỗi xảy ra khi tải thông tin phương tiện</span>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        const API_BASE_URL = '@ViewBag.ApiBaseUrl' || 'https://localhost:7173/api';
        let currentCar = null;
        
        document.addEventListener('DOMContentLoaded', function() {
            const carId = getCarIdFromUrl();
            if (carId) {
                loadCarDetails(carId);
                loadMaintenanceHistory(carId);
                loadVehicleTypes();
            } else {
                showError('Không tìm thấy ID phương tiện');
            }
            
            // Handle form submission
            document.getElementById('editCarForm')?.addEventListener('submit', function(e) {
                e.preventDefault();
                saveCarChanges();
            });
        });
        
        function getCarIdFromUrl() {
            const path = window.location.pathname;
            const parts = path.split('/');
            const carDetailIndex = parts.indexOf('CarDetail');
            if (carDetailIndex !== -1 && parts[carDetailIndex + 1]) {
                return parseInt(parts[carDetailIndex + 1]);
            }
            return null;
        }
        
        function loadCarDetails(carId) {
            fetch(`${API_BASE_URL}/CarOfAutoOwner/${carId}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(car => {
                    currentCar = car;
                    displayCarDetails(car);
                    loadEditForm(car);
                    document.getElementById('carNameBreadcrumb').textContent = car.carName || 'Phương tiện';
                    document.getElementById('loadingSpinner').style.display = 'none';
                    document.getElementById('carDetails').style.display = 'block';
                })
                .catch(error => {
                    console.error('Error loading car details:', error);
                    showError('Có lỗi xảy ra khi tải thông tin phương tiện: ' + error.message);
                    document.getElementById('loadingSpinner').style.display = 'none';
                });
        }
        
        let vehicleTypesMap = {};
        
        function displayCarDetails(car) {
            document.getElementById('carName').textContent = car.carName || '-';
            document.getElementById('carModel').textContent = car.carModel || '-';
            // Get vehicle type name from map
            const vehicleTypeName = car.vehicleTypeId && vehicleTypesMap[car.vehicleTypeId] 
                ? vehicleTypesMap[car.vehicleTypeId] 
                : '-';
            document.getElementById('vehicleType').textContent = vehicleTypeName;
            document.getElementById('carColor').textContent = car.color || '-';
            document.getElementById('yearOfManufacture').textContent = car.yearOfManufacture || '-';
            document.getElementById('vinNumber').textContent = car.vinNumber || '-';
            document.getElementById('vehicleEngineNumber').textContent = car.vehicleEngineNumber || '-';
            document.getElementById('licensePlate').textContent = car.licensePlate || '-';
        }
        
        function loadEditForm(car) {
            document.getElementById('editCarName').value = car.carName || '';
            document.getElementById('editCarModel').value = car.carModel || '';
            document.getElementById('editVehicleTypeId').value = car.vehicleTypeId || '';
            document.getElementById('editCarColor').value = car.color || '';
            document.getElementById('editYearOfManufacture').value = car.yearOfManufacture || '';
            document.getElementById('editVinNumber').value = car.vinNumber || '';
            document.getElementById('editVehicleEngineNumber').value = car.vehicleEngineNumber || '';
            document.getElementById('editLicensePlate').value = car.licensePlate || '';
        }
        
        function loadVehicleTypes() {
            fetch(`${API_BASE_URL}/VehicleType`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(vehicleTypes => {
                    // Build map for quick lookup
                    vehicleTypesMap = {};
                    if (vehicleTypes && Array.isArray(vehicleTypes)) {
                        vehicleTypes.forEach(vt => {
                            vehicleTypesMap[vt.id] = vt.name;
                        });
                    }
                    
                    const select = document.getElementById('editVehicleTypeId');
                    if (select) {
                        const currentValue = select.value;
                        select.innerHTML = '<option value="">-- Chọn loại phương tiện --</option>';
                        if (vehicleTypes && Array.isArray(vehicleTypes)) {
                            vehicleTypes.forEach(vt => {
                                const option = document.createElement('option');
                                option.value = vt.id;
                                option.textContent = vt.name;
                                select.appendChild(option);
                            });
                        }
                        if (currentValue) {
                            select.value = currentValue;
                        }
                    }
                    
                    // Refresh car details display if car is already loaded
                    if (currentCar) {
                        displayCarDetails(currentCar);
                    }
                })
                .catch(error => {
                    console.error('Error loading vehicle types:', error);
                });
        }
        
        function loadMaintenanceHistory(carId) {
            // Lấy hóa đơn đã thanh toán (PAID) - lấy nhiều trang để đảm bảo có đủ dữ liệu
            const token = localStorage.getItem('authToken') || localStorage.getItem('token');
            fetch(`${API_BASE_URL}/TotalReceipt?page=1&pageSize=100&statusCode=PAID`, {
                headers: {
                    'Authorization': token ? `Bearer ${token}` : '',
                    'Content-Type': 'application/json'
                }
            })
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success && data.data && data.data.items) {
                        // Filter theo carId
                        const receipts = data.data.items.filter(receipt => 
                            (receipt.carId || receipt.CarId) === carId
                        );
                        displayMaintenanceHistory(receipts);
                    } else {
                        displayMaintenanceHistory([]);
                    }
                })
                .catch(error => {
                    console.error('Error loading maintenance history:', error);
                    // Show empty message if error
                    document.getElementById('maintenanceHistoryBody').innerHTML = 
                        '<tr><td colspan="7" class="empty-history">Xe không có dịch vụ nào từng được thực hiện!</td></tr>';
                });
        }
        
        function displayMaintenanceHistory(receipts) {
            const tbody = document.getElementById('maintenanceHistoryBody');
            if (!receipts || receipts.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="empty-history">Chưa có lịch sử bảo dưỡng đã thanh toán!</td></tr>';
                return;
            }
            
            // Sắp xếp theo ngày tạo (mới nhất trước)
            receipts.sort((a, b) => {
                const dateA = new Date(a.createdAt || a.CreatedAt || 0);
                const dateB = new Date(b.createdAt || b.CreatedAt || 0);
                return dateB - dateA;
            });
            
            tbody.innerHTML = '';
            receipts.forEach(receipt => {
                const row = document.createElement('tr');
                const receiptDate = receipt.createdAt || receipt.CreatedAt;
                const serviceDate = receiptDate 
                    ? new Date(receiptDate).toLocaleDateString('vi-VN', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    })
                    : '-';
                
                // Lấy thông tin từ hóa đơn
                const serviceType = receipt.maintenanceTicketCode || receipt.MaintenanceTicketCode || 'Bảo dưỡng';
                const subtotal = receipt.subtotal || receipt.Subtotal || 0;
                const vatAmount = receipt.vatAmount || receipt.VatAmount || 0;
                const surchargeAmount = receipt.surchargeAmount || receipt.SurchargeAmount || 0;
                const discountAmount = receipt.discountAmount || receipt.DiscountAmount || 0;
                const finalAmount = receipt.finalAmount || receipt.FinalAmount || receipt.amount || receipt.Amount || 0;
                
                row.innerHTML = `
                    <td>${serviceDate}</td>
                    <td>${serviceType}</td>
                    <td>${formatCurrency(subtotal)}</td>
                    <td>${formatCurrency(vatAmount)}</td>
                    <td>${formatCurrency(surchargeAmount)}</td>
                    <td>${formatCurrency(discountAmount)}</td>
                    <td>${formatCurrency(finalAmount)}</td>
                `;
                tbody.appendChild(row);
            });
        }
        
        function formatCurrency(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        }
        
        function saveCarChanges() {
            if (!currentCar || !currentCar.id) {
                showError('Không tìm thấy thông tin phương tiện');
                return;
            }
            
            const formData = {
                userId: currentCar.userId,
                carName: document.getElementById('editCarName').value || null,
                carModel: document.getElementById('editCarModel').value || null,
                vehicleTypeId: document.getElementById('editVehicleTypeId').value ? parseInt(document.getElementById('editVehicleTypeId').value) : null,
                color: document.getElementById('editCarColor').value || null,
                yearOfManufacture: document.getElementById('editYearOfManufacture').value ? parseInt(document.getElementById('editYearOfManufacture').value) : null,
                vinNumber: document.getElementById('editVinNumber').value || null,
                vehicleEngineNumber: document.getElementById('editVehicleEngineNumber').value || null,
                licensePlate: document.getElementById('editLicensePlate').value || null,
                branchId: currentCar.branchId || null
            };
            
            const token = localStorage.getItem('token');
            
            fetch(`${API_BASE_URL}/CarOfAutoOwner/${currentCar.id}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': token ? `Bearer ${token}` : ''
                },
                body: JSON.stringify(formData)
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                showSuccessAlert('Cập nhật thông tin phương tiện thành công!');
                loadCarDetails(currentCar.id);
                loadMaintenanceHistory(currentCar.id);
            })
            .catch(error => {
                console.error('Error saving car changes:', error);
                showError('Có lỗi xảy ra khi cập nhật thông tin: ' + error.message);
            });
        }
        
        function showError(message) {
            document.getElementById('errorText').textContent = message;
            document.getElementById('errorMessage').style.display = 'block';
            document.getElementById('loadingSpinner').style.display = 'none';
        }
        
        function showSuccessAlert(message) {
            const alertDiv = document.createElement('div');
            alertDiv.className = 'alert alert-success alert-dismissible fade show position-fixed';
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);';
            alertDiv.innerHTML = `
                <i class="fas fa-check-circle me-2"></i>${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            document.body.appendChild(alertDiv);
            
            // Auto remove after 3 seconds
            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 3000);
        }
    </script>
}

