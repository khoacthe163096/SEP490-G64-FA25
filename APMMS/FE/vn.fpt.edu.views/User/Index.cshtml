 @{
    ViewData["Title"] = "Danh sách người dùng";
    Layout = "~/vn.fpt.edu.views/Shared/_DashboardLayout.cshtml";
    var apiBaseUrl = ViewBag.ApiBaseUrl ?? "https://localhost:7173/api";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Danh sách người dùng</h4>
                    <a href="/Users/Create" class="btn btn-primary" id="btnCreateUser">
                        <i class="fas fa-plus"></i> Thêm người dùng
                    </a>
                </div>
                <div class="card-body">
                    <!-- Search and Filter -->
                    <div class="row mb-3 align-items-center">
                        <div class="col-md-6 d-flex gap-2 align-items-center">
                            <button class="btn btn-secondary btn-sm" id="btnEditUserStatus" onclick="editSelectedStatus()">
                                <i class="fas fa-edit"></i> Sửa trạng thái
                            </button>
                            <select class="form-select" id="statusFilter" style="width: 180px;">
                                <option value="">Chọn trạng thái</option>
                                <option value="ACTIVE">Hoạt động</option>
                                <option value="INACTIVE">Không hoạt động</option>
                            </select>
                        </div>
                        <div class="col-md-6 d-flex justify-content-end align-items-center">
                            <input type="text" class="form-control" id="searchInput" placeholder="Tìm kiếm người dùng" style="max-width: 300px;">
                        </div>
                    </div>

                    <!-- Table -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th style="width: 40px;">
                                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                                    </th>
                                    <th style="width: 60px;">STT</th>
                                    <th>Tên khách hàng</th>
                                    <th>Mã khách hàng</th>
                                    <th>Email</th>
                                    <th>Số điện thoại</th>
                                    <th>Tình trạng</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination Info and Controls -->
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div class="text-muted" id="paginationInfo">
                            Hiển thị <span id="showingFrom">0</span> - <span id="showingTo">0</span> của <span id="totalRecords">0</span> kết quả
                        </div>
                        <nav aria-label="Page navigation">
                            <ul class="pagination mb-0" id="pagination">
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let currentPage = 1;
        const pageSize = 10;
        let totalRecords = 0;
        const selectedUsers = new Set();

        document.addEventListener('DOMContentLoaded', function() {
            applyRoleBasedUiForUsers();
            loadUsers();
            
            // Search functionality
            document.getElementById('searchInput').addEventListener('input', debounce(function() {
                currentPage = 1;
                loadUsers();
            }, 500));
            document.getElementById('statusFilter').addEventListener('change', function() {
                currentPage = 1;
                loadUsers();
            });
        });

        const API_BASE_URL = '@apiBaseUrl';

        // Ẩn/hiện nút theo role: Admin (1) & Branch Manager (2) chỉ xem, Consulter (6) được sửa
        function applyRoleBasedUiForUsers() {
            try {
                const userInfoStr = localStorage.getItem('userInfo');
                if (!userInfoStr) return;

                const userInfo = JSON.parse(userInfoStr);
                const roleId = userInfo.roleId || userInfo.role || userInfo.RoleId;
                const roleName = (userInfo.roleName || userInfo.role || '').toString().toUpperCase();

                const isConsulter = roleId === 6 || roleName === 'CONSULTER';

                const btnCreate = document.getElementById('btnCreateUser');
                const btnEditStatus = document.getElementById('btnEditUserStatus');

                if (!isConsulter) {
                    if (btnCreate) btnCreate.style.display = 'none';
                    if (btnEditStatus) btnEditStatus.style.display = 'none';
                }
            } catch (error) {
                console.error('Error applying role-based UI for users:', error);
            }
        }
        
        function loadUsers() {
            const search = document.getElementById('searchInput').value;
            const status = document.getElementById('statusFilter').value;

            // Show loading
            document.getElementById('usersTableBody').innerHTML = `
                <tr>
                    <td colspan="7" class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </td>
                </tr>
            `;

            const token = localStorage.getItem('authToken');
            if (!token) {
                console.error('No auth token found when loading users');
                showAlert('Vui lòng đăng nhập lại để xem danh sách khách hàng.', 'danger');
                document.getElementById('usersTableBody').innerHTML = '<tr><td colspan="7" class="text-center text-danger">Không thể tải dữ liệu</td></tr>';
                return;
            }

            fetch(`${API_BASE_URL}/AutoOwner?page=${currentPage}&pageSize=${pageSize}&search=${encodeURIComponent(search || '')}&status=${encodeURIComponent(status || '')}&role=7`, {
                headers: {
                    'Authorization': `Bearer ${token}`,
                    'Content-Type': 'application/json'
                }
            })
                .then(async response => {
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ message: `HTTP ${response.status}: ${response.statusText}` }));
                        throw new Error(errorData.message || 'Lỗi khi tải dữ liệu');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        totalRecords = data.totalCount || 0;
                        renderUsersTable(data.data || []);
                        renderPagination(data.totalPages || 1, data.currentPage || currentPage);
                        updatePaginationInfo();
                    } else {
                        showAlert('Lỗi khi tải dữ liệu: ' + (data.message || 'Unknown error'), 'danger');
                        totalRecords = 0;
                        updatePaginationInfo();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('Có lỗi xảy ra khi tải dữ liệu: ' + error.message, 'danger');
                    // Hiển thị empty table
                    document.getElementById('usersTableBody').innerHTML = '<tr><td colspan="7" class="text-center text-danger">Không thể tải dữ liệu</td></tr>';
                    totalRecords = 0;
                    updatePaginationInfo();
                });
        }

        function renderUsersTable(users) {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';

            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">Không có dữ liệu</td></tr>';
                return;
            }

            users.forEach((user, index) => {
                const row = document.createElement('tr');
                const fullName = `${user.firstName || ''} ${user.lastName || ''}`.trim() || user.username || '-';
                const isActive = user.statusCode === 'ACTIVE' || (user.statusCode == null && !user.isDelete);
                const stt = (currentPage - 1) * pageSize + index + 1;
                row.innerHTML = `
                    <td>
                        <input type="checkbox" class="user-checkbox" value="${user.id}" onchange="toggleUserSelection(${user.id})">
                    </td>
                    <td>${stt}</td>
                    <td>
                        <a href="/Users/Details/${user.id}" style="text-decoration: none; color: inherit;">
                            ${fullName}
                        </a>
                    </td>
                    <td>${user.code || '-'}</td>
                    <td>${user.email || '-'}</td>
                    <td>${user.phone || '-'}</td>
                    <td><span class="badge ${isActive ? 'bg-success' : 'bg-secondary'}">${isActive ? 'Hoạt động' : 'Không hoạt động'}</span></td>
                `;
                tbody.appendChild(row);
            });
            
            updateSelectAllCheckbox();
        }

        function renderPagination(totalPages, currentPageParam) {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            // Update currentPage if provided
            if (currentPageParam) {
                currentPage = currentPageParam;
            }

            if (totalPages <= 1) {
                pagination.innerHTML = '<li class="page-item disabled"><span class="page-link">Trang 1 / 1</span></li>';
                updatePaginationInfo();
                return;
            }

            // Previous button
            const prevDisabled = currentPage === 1 ? 'disabled' : '';
            pagination.innerHTML = `
                <li class="page-item ${prevDisabled}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;">
                        <i class="fas fa-chevron-left"></i> Trước
                    </a>
                </li>
            `;

            // Page numbers (show max 5 pages around current)
            const maxPagesToShow = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
            let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);

            if (endPage - startPage < maxPagesToShow - 1) {
                startPage = Math.max(1, endPage - maxPagesToShow + 1);
            }

            // First page
            if (startPage > 1) {
                pagination.innerHTML += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="changePage(1); return false;">1</a>
                    </li>
                `;
                if (startPage > 2) {
                    pagination.innerHTML += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                }
            }

            // Page numbers
            for (let i = startPage; i <= endPage; i++) {
                const active = i === currentPage ? 'active' : '';
                pagination.innerHTML += `
                    <li class="page-item ${active}">
                        <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>
                    </li>
                `;
            }

            // Last page
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    pagination.innerHTML += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                }
                pagination.innerHTML += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="changePage(${totalPages}); return false;">${totalPages}</a>
                    </li>
                `;
            }

            // Next button
            const nextDisabled = currentPage === totalPages ? 'disabled' : '';
            pagination.innerHTML += `
                <li class="page-item ${nextDisabled}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;">
                        Sau <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
            `;

            updatePaginationInfo();
        }

        function updatePaginationInfo() {
            const startIndex = totalRecords === 0 ? 0 : (currentPage - 1) * pageSize + 1;
            const endIndex = Math.min(currentPage * pageSize, totalRecords);
            
            document.getElementById('showingFrom').textContent = startIndex;
            document.getElementById('showingTo').textContent = endIndex;
            document.getElementById('totalRecords').textContent = totalRecords;
        }

        function changePage(page) {
            const totalPages = Math.ceil(totalRecords / pageSize) || 1;
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            loadUsers();
            // Scroll to top of table
            document.querySelector('.card').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        // Expose changePage to global scope for onclick handlers
        window.changePage = changePage;

        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAll');
            const checkboxes = document.querySelectorAll('.user-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAll.checked;
                const userId = parseInt(checkbox.value);
                if (selectAll.checked) {
                    selectedUsers.add(userId);
                    } else {
                    selectedUsers.delete(userId);
                }
            });
        }

        function toggleUserSelection(userId) {
            const checkbox = document.querySelector(`.user-checkbox[value="${userId}"]`);
            if (checkbox.checked) {
                selectedUsers.add(userId);
            } else {
                selectedUsers.delete(userId);
            }
            updateSelectAllCheckbox();
        }

        function updateSelectAllCheckbox() {
            const checkboxes = document.querySelectorAll('.user-checkbox');
            const selectAll = document.getElementById('selectAll');
            if (checkboxes.length === 0) {
                selectAll.checked = false;
                return;
            }
            selectAll.checked = Array.from(checkboxes).every(cb => cb.checked);
        }

        function editSelectedStatus() {
            if (selectedUsers.size === 0) {
                showAlert('Vui lòng chọn ít nhất một người dùng', 'warning');
                return;
            }
            
            // Update selected count in modal
            document.getElementById('selectedCount').textContent = selectedUsers.size;
            
            // Show modal
            const modal = new bootstrap.Modal(document.getElementById('statusUpdateModal'));
            modal.show();
        }
        
        function confirmUpdateStatus() {
            // Get selected status
            const newStatus = document.getElementById('newStatusSelect').value;
            
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('statusUpdateModal'));
            modal.hide();
            
            // Update all selected users
            updateMultipleUserStatuses(Array.from(selectedUsers), newStatus);
        }
        
        async function updateMultipleUserStatuses(userIds, newStatus) {
            const token = localStorage.getItem('authToken');
            let successCount = 0;
            let failCount = 0;
            
            showAlert(`Đang cập nhật ${userIds.length} người dùng...`, 'info');
            
            // Update all users sequentially
            for (const userId of userIds) {
                try {
                    const response = await fetch(`https://localhost:7173/api/AutoOwner/${userId}/status`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': token ? `Bearer ${token}` : ''
                        },
                        body: JSON.stringify({ statusCode: newStatus })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        successCount++;
                    } else {
                        failCount++;
                        console.error(`Failed to update user ${userId}:`, data.message);
                    }
                } catch (error) {
                    failCount++;
                    console.error(`Error updating user ${userId}:`, error);
                }
            }
            
            // Clear selection
            selectedUsers.clear();
            document.getElementById('selectAll').checked = false;
            document.querySelectorAll('.user-checkbox').forEach(cb => cb.checked = false);
            
            // Reload data
            loadUsers();
            
            // Show result
            if (failCount === 0) {
                showAlert(`Đã cập nhật thành công ${successCount} người dùng sang trạng thái "${newStatus === 'ACTIVE' ? 'Hoạt động' : 'Không hoạt động'}"`, 'success');
            } else {
                showAlert(`Đã cập nhật ${successCount} người dùng thành công, ${failCount} người dùng thất bại`, 'warning');
            }
        }


        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.card-body').insertBefore(alertDiv, document.querySelector('.table-responsive'));
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }
    </script>

<!-- ✅ Modal chọn trạng thái -->
<div class="modal fade" id="statusUpdateModal" tabindex="-1" aria-labelledby="statusUpdateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="statusUpdateModalLabel">Cập nhật trạng thái</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Bạn đã chọn <strong id="selectedCount">0</strong> người dùng.</p>
                <div class="mb-3">
                    <label for="newStatusSelect" class="form-label">Chọn trạng thái mới:</label>
                    <select class="form-select" id="newStatusSelect">
                        <option value="ACTIVE">Hoạt động</option>
                        <option value="INACTIVE">Không hoạt động</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-primary" onclick="confirmUpdateStatus()">Xác nhận</button>
            </div>
        </div>
    </div>
</div>
}
