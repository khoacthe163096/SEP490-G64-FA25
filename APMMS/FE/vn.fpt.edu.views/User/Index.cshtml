 @{
    ViewData["Title"] = "Danh sách người dùng";
    Layout = "~/vn.fpt.edu.views/Shared/_DashboardLayout.cshtml";
    var apiBaseUrl = ViewBag.ApiBaseUrl ?? "https://localhost:7173/api";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Danh sách người dùng</h4>
                    <a href="/Users/Create" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Thêm người dùng
                    </a>
                </div>
                <div class="card-body">
                    <!-- Search and Filter -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="searchInput" placeholder="Tìm kiếm người dùng...">
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="statusFilter">
                                <option value="">Tất cả trạng thái</option>
                                <option value="ACTIVE">Hoạt động</option>
                                <option value="INACTIVE">Không hoạt động</option>
                            </select>
                        </div>
                        <div class="col-md-3">
                            <select class="form-select" id="roleFilter" style="display: none;">
                                <option value="7" selected>Auto Owner</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-outline-secondary w-100" onclick="resetFilters()">
                                <i class="fas fa-refresh"></i> Reset
                            </button>
                        </div>
                    </div>

                    <!-- Table -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>ID</th>
                                    <th>Họ tên</th>
                                    <th>Email</th>
                                    <th>Số điện thoại</th>
                                    <th>Vai trò</th>
                                    <th>Trạng thái</th>
                                    <th>Ngày tạo</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody id="usersTableBody">
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination Info and Controls -->
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div class="text-muted" id="paginationInfo">
                            Hiển thị <span id="showingFrom">0</span> - <span id="showingTo">0</span> của <span id="totalRecords">0</span> kết quả
                        </div>
                        <nav aria-label="Page navigation">
                            <ul class="pagination mb-0" id="pagination">
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let currentPage = 1;
        const pageSize = 10;
        let totalRecords = 0;

        document.addEventListener('DOMContentLoaded', function() {
            loadUsers();
            
            // Search functionality
            document.getElementById('searchInput').addEventListener('input', debounce(function() {
                currentPage = 1;
                loadUsers();
            }, 500));
            document.getElementById('statusFilter').addEventListener('change', function() {
                currentPage = 1;
                loadUsers();
            });
            document.getElementById('roleFilter').addEventListener('change', function() {
                currentPage = 1;
                loadUsers();
            });
        });

        const API_BASE_URL = '@apiBaseUrl';
        
        function loadUsers() {
            const search = document.getElementById('searchInput').value;
            const status = document.getElementById('statusFilter').value;
            const role = document.getElementById('roleFilter').value;

            // Show loading
            document.getElementById('usersTableBody').innerHTML = `
                <tr>
                    <td colspan="8" class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </td>
                </tr>
            `;

            fetch(`${API_BASE_URL}/AutoOwner?page=${currentPage}&pageSize=${pageSize}&search=${encodeURIComponent(search || '')}&status=${encodeURIComponent(status || '')}&role=${encodeURIComponent(role || '')}`)
                .then(async response => {
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ message: `HTTP ${response.status}: ${response.statusText}` }));
                        throw new Error(errorData.message || 'Lỗi khi tải dữ liệu');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        totalRecords = data.totalCount || 0;
                        renderUsersTable(data.data || []);
                        renderPagination(data.totalPages || 1, data.currentPage || currentPage);
                        updatePaginationInfo();
                    } else {
                        showAlert('Lỗi khi tải dữ liệu: ' + (data.message || 'Unknown error'), 'danger');
                        totalRecords = 0;
                        updatePaginationInfo();
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('Có lỗi xảy ra khi tải dữ liệu: ' + error.message, 'danger');
                    // Hiển thị empty table
                    document.getElementById('usersTableBody').innerHTML = '<tr><td colspan="8" class="text-center text-danger">Không thể tải dữ liệu</td></tr>';
                    totalRecords = 0;
                    updatePaginationInfo();
                });
        }

        function renderUsersTable(users) {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '';

            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted">Không có dữ liệu</td></tr>';
                return;
            }

            users.forEach((user, index) => {
                const row = document.createElement('tr');
                const fullName = `${user.firstName || ''} ${user.lastName || ''}`.trim() || user.username || '-';
                const isActive = user.statusCode === 'ACTIVE' || (user.statusCode == null && !user.isDelete);
                row.innerHTML = `
                    <td>${user.id}</td>
                    <td>${fullName}</td>
                    <td>${user.email || '-'}</td>
                    <td>${user.phone || '-'}</td>
                    <td><span class="badge bg-info">${user.roleName || 'Auto Owner'}</span></td>
                    <td><span class="badge ${isActive ? 'bg-success' : 'bg-secondary'}">${isActive ? 'Hoạt động' : 'Không hoạt động'}</span></td>
                    <td>${user.createdDate ? new Date(user.createdDate).toLocaleDateString('vi-VN') : '-'}</td>
                    <td>
                        <div class="btn-group" role="group">
                            <a href="/Users/Details/${user.id}" class="btn btn-sm btn-outline-info" title="Xem chi tiết">
                                <i class="fas fa-eye"></i>
                            </a>
                            <a href="/Users/Edit/${user.id}" class="btn btn-sm btn-outline-warning" title="Sửa">
                                <i class="fas fa-edit"></i>
                            </a>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteUser(${user.id})" title="Xóa">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        function renderPagination(totalPages, currentPageParam) {
            const pagination = document.getElementById('pagination');
            pagination.innerHTML = '';

            // Update currentPage if provided
            if (currentPageParam) {
                currentPage = currentPageParam;
            }

            if (totalPages <= 1) {
                pagination.innerHTML = '<li class="page-item disabled"><span class="page-link">Trang 1 / 1</span></li>';
                updatePaginationInfo();
                return;
            }

            // Previous button
            const prevDisabled = currentPage === 1 ? 'disabled' : '';
            pagination.innerHTML = `
                <li class="page-item ${prevDisabled}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;">
                        <i class="fas fa-chevron-left"></i> Trước
                    </a>
                </li>
            `;

            // Page numbers (show max 5 pages around current)
            const maxPagesToShow = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxPagesToShow / 2));
            let endPage = Math.min(totalPages, startPage + maxPagesToShow - 1);

            if (endPage - startPage < maxPagesToShow - 1) {
                startPage = Math.max(1, endPage - maxPagesToShow + 1);
            }

            // First page
            if (startPage > 1) {
                pagination.innerHTML += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="changePage(1); return false;">1</a>
                    </li>
                `;
                if (startPage > 2) {
                    pagination.innerHTML += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                }
            }

            // Page numbers
            for (let i = startPage; i <= endPage; i++) {
                const active = i === currentPage ? 'active' : '';
                pagination.innerHTML += `
                    <li class="page-item ${active}">
                        <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>
                    </li>
                `;
            }

            // Last page
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    pagination.innerHTML += '<li class="page-item disabled"><span class="page-link">...</span></li>';
                }
                pagination.innerHTML += `
                    <li class="page-item">
                        <a class="page-link" href="#" onclick="changePage(${totalPages}); return false;">${totalPages}</a>
                    </li>
                `;
            }

            // Next button
            const nextDisabled = currentPage === totalPages ? 'disabled' : '';
            pagination.innerHTML += `
                <li class="page-item ${nextDisabled}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;">
                        Sau <i class="fas fa-chevron-right"></i>
                    </a>
                </li>
            `;

            updatePaginationInfo();
        }

        function updatePaginationInfo() {
            const startIndex = totalRecords === 0 ? 0 : (currentPage - 1) * pageSize + 1;
            const endIndex = Math.min(currentPage * pageSize, totalRecords);
            
            document.getElementById('showingFrom').textContent = startIndex;
            document.getElementById('showingTo').textContent = endIndex;
            document.getElementById('totalRecords').textContent = totalRecords;
        }

        function changePage(page) {
            const totalPages = Math.ceil(totalRecords / pageSize) || 1;
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            loadUsers();
            // Scroll to top of table
            document.querySelector('.card').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }
        
        // Expose changePage to global scope for onclick handlers
        window.changePage = changePage;

        function deleteUser(id) {
            if (confirm('Bạn có chắc chắn muốn xóa người dùng này?')) {
                fetch(`${API_BASE_URL}/AutoOwner/${id}`, {
                    method: 'DELETE'
                })
                .then(response => {
                    if (response.ok || response.status === 204) {
                        showAlert('Xóa người dùng thành công', 'success');
                        loadUsers();
                    } else {
                        return response.json().then(data => {
                            showAlert('Lỗi khi xóa: ' + (data.message || 'Unknown error'), 'danger');
                        });
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showAlert('Có lỗi xảy ra khi xóa', 'danger');
                });
            }
        }

        function resetFilters() {
            document.getElementById('searchInput').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('roleFilter').value = '';
            currentPage = 1;
            loadUsers();
        }


        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
            alertDiv.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.querySelector('.card-body').insertBefore(alertDiv, document.querySelector('.table-responsive'));
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }
    </script>
}
