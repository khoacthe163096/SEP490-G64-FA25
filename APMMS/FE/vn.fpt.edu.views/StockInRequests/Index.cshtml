@{
    ViewData["Title"] = "Danh sách yêu cầu nhập kho";
    Layout = "~/vn.fpt.edu.views/Shared/_DashboardLayout.cshtml";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Danh sách yêu cầu nhập kho</h4>
                    <a href="/StockInRequests/Create" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Tạo yêu cầu nhập kho
                    </a>
                </div>
                <div class="card-body">
                    <!-- Search and Filter -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="searchInput" placeholder="Tìm kiếm theo mã, mô tả...">
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="statusFilter">
                                <option value="">Tất cả trạng thái</option>
                                <option value="PENDING">Chờ duyệt</option>
                                <option value="APPROVED">Đã duyệt</option>
                                <option value="CANCELLED">Đã hủy</option>
                                <option value="CREATED">Đã tạo</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-outline-secondary" id="filterBtn">
                                <i class="fas fa-filter"></i> Lọc
                            </button>
                        </div>
                    </div>

                    <!-- Table -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover align-middle">
                            <thead class="table-dark">
                                <tr>
                                    <th>Mã yêu cầu</th>
                                    <th>Mô tả</th>
                                    <th>Chi nhánh</th>
                                    <th>Số linh kiện</th>
                                    <th>Người tạo</th>
                                    <th>Ngày tạo</th>
                                    <th>Trạng thái</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody id="stockInRequestsTableBody">
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination Info and Controls -->
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div class="text-muted" id="paginationInfo">
                            Hiển thị <span id="showingFrom">0</span> - <span id="showingTo">0</span> của <span id="totalRecords">0</span> kết quả
                        </div>
                        <nav aria-label="Page navigation">
                            <ul class="pagination mb-0" id="pagination">
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let currentPage = 1;
        const pageSize = 10;
        let totalRecords = 0;
        let totalPages = 1;

        $(document).ready(function() {
            loadStockInRequests();

            // Search với debounce
            let searchTimeout;
            $('#searchInput').on('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    currentPage = 1;
                    loadStockInRequests();
                }, 500);
            });

            // Filter button
            $('#filterBtn').click(function() {
                currentPage = 1;
                loadStockInRequests();
            });

            // Status filter change
            $('#statusFilter').change(function() {
                currentPage = 1;
                loadStockInRequests();
            });
        });

        function loadStockInRequests() {
            const search = $('#searchInput').val();
            const status = $('#statusFilter').val();

            // Show loading
            $('#stockInRequestsTableBody').html(`
                <tr>
                    <td colspan="8" class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </td>
                </tr>
            `);

            $.ajax({
                url: '/StockInRequests/ListData',
                method: 'GET',
                data: {
                    page: currentPage,
                    pageSize: pageSize,
                    search: search,
                    statusCode: status
                },
                success: function(result) {
                    console.log('ListData response:', result);
                    if (result.success && result.data) {
                        console.log('Data items count:', result.data.length);
                        if (result.data.length > 0) {
                            console.log('First item:', result.data[0]);
                            console.log('First item ID:', result.data[0].StockInRequestId || result.data[0].stockInRequestId || result.data[0].Id || result.data[0].id);
                        }
                        renderTable(result.data);
                        totalRecords = result.totalCount || 0;
                        totalPages = result.totalPages || 1;
                        updatePagination();
                    } else {
                        console.error('No data in response:', result);
                        $('#stockInRequestsTableBody').html('<tr><td colspan="8" class="text-center text-muted">Không có dữ liệu</td></tr>');
                        totalRecords = 0;
                        totalPages = 0;
                        updatePagination();
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error loading stock in requests:', error);
                    $('#stockInRequestsTableBody').html('<tr><td colspan="8" class="text-center text-danger">Lỗi tải dữ liệu: ' + error + '</td></tr>');
                    totalRecords = 0;
                    totalPages = 0;
                    updatePagination();
                }
            });
        }

        function renderTable(items) {
            const tbody = $('#stockInRequestsTableBody');
            tbody.empty();

            if (!items || items.length === 0) {
                tbody.html('<tr><td colspan="8" class="text-center text-muted">Không có dữ liệu</td></tr>');
                return;
            }

            items.forEach(function(item) {
                // BE trả về PascalCase, nhưng kiểm tra cả camelCase để chắc chắn
                const itemId = item.StockInRequestId || item.stockInRequestId || item.Id || item.id || 0;
                
                console.log('Processing item:', {
                    raw: item,
                    StockInRequestId: item.StockInRequestId,
                    stockInRequestId: item.stockInRequestId,
                    Id: item.Id,
                    id: item.id,
                    finalId: itemId
                });
                
                if (!itemId || itemId === 0) {
                    console.error('Item missing ID:', item);
                    return; // Bỏ qua item không có ID
                }
                
                const statusCode = item.statusCode || item.StatusCode || '';
                let statusClass = 'bg-secondary';
                let statusText = 'Không xác định';
                if (statusCode === 'PENDING') {
                    statusClass = 'bg-warning';
                    statusText = 'Chờ duyệt';
                } else if (statusCode === 'APPROVED') {
                    statusClass = 'bg-success';
                    statusText = 'Đã duyệt';
                } else if (statusCode === 'CANCELLED') {
                    statusClass = 'bg-danger';
                    statusText = 'Đã hủy';
                } else if (statusCode === 'CREATED') {
                    statusClass = 'bg-info';
                    statusText = 'Đã tạo';
                }

                const branchName = item.branchName || item.BranchName || 'N/A';
                const detailCount = (item.details || item.Details) ? (item.details || item.Details).length : 0;
                const createdByName = item.createdByName || item.CreatedByName || 'N/A';
                const createdDate = (item.createdAt || item.CreatedAt) ? new Date(item.createdAt || item.CreatedAt).toLocaleDateString('vi-VN') : 'N/A';
                const description = (item.description || item.Description) ? ((item.description || item.Description).length > 50 ? (item.description || item.Description).substring(0, 50) + '...' : (item.description || item.Description)) : 'N/A';
                const code = item.code || item.Code || '';

                const row = `
                    <tr data-id="${itemId}">
                        <td><a href="/StockInRequests/${itemId}" class="text-decoration-none fw-semibold">${code}</a></td>
                        <td>${description}</td>
                        <td>${branchName}</td>
                        <td>${detailCount}</td>
                        <td>${createdByName}</td>
                        <td>${createdDate}</td>
                        <td><span class="badge ${statusClass}">${statusText}</span></td>
                        <td>
                            <a href="/StockInRequests/${itemId}" class="btn btn-sm btn-info" title="Xem chi tiết">
                                <i class="fas fa-eye"></i>
                            </a>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });
        }

        function updatePagination() {
            const showingFrom = totalRecords === 0 ? 0 : (currentPage - 1) * pageSize + 1;
            const showingTo = Math.min(currentPage * pageSize, totalRecords);
            
            $('#showingFrom').text(showingFrom);
            $('#showingTo').text(showingTo);
            $('#totalRecords').text(totalRecords);

            const pagination = $('#pagination');
            pagination.empty();

            if (totalPages <= 1) {
                return;
            }

            // Previous button
            const prevDisabled = currentPage === 1 ? 'disabled' : '';
            pagination.append(`
                <li class="page-item ${prevDisabled}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;">Trước</a>
                </li>
            `);

            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    const active = i === currentPage ? 'active' : '';
                    pagination.append(`
                        <li class="page-item ${active}">
                            <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>
                        </li>
                    `);
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    pagination.append(`<li class="page-item disabled"><span class="page-link">...</span></li>`);
                }
            }

            // Next button
            const nextDisabled = currentPage === totalPages ? 'disabled' : '';
            pagination.append(`
                <li class="page-item ${nextDisabled}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;">Sau</a>
                </li>
            `);
        }

        function changePage(page) {
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            loadStockInRequests();
            $('html, body').animate({ scrollTop: 0 }, 'fast');
        }
    </script>
}

