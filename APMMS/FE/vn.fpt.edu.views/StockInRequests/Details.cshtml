@{
    ViewData["Title"] = "Chi tiết yêu cầu nhập kho";
    Layout = "~/vn.fpt.edu.views/Shared/_DashboardLayout.cshtml";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Chi tiết yêu cầu nhập kho</h4>
                    <div class="d-flex gap-2">
                        <div id="actionButtons">
                            <!-- Buttons sẽ được thêm bằng JavaScript dựa trên trạng thái -->
                        </div>
                        <a href="/StockInRequests" class="btn btn-secondary">
                            <i class="fas fa-arrow-left"></i> Quay lại
                        </a>
                    </div>
                </div>
                <div class="card-body">
                    <div id="loadingSpinner" class="text-center py-5">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </div>

                    <div id="contentArea" style="display: none;">
                        <div class="mb-4">
                            <h5 class="mb-3">Thông tin cơ bản</h5>
                            <div class="row">
                                <div class="col-md-6">
                                    <dl class="row mb-3">
                                        <dt class="col-sm-4 fw-bold">Mã:</dt>
                                        <dd class="col-sm-8" id="code">-</dd>
                                    </dl>
                                    <dl class="row mb-3">
                                        <dt class="col-sm-4 fw-bold">Tình trạng:</dt>
                                        <dd class="col-sm-8" id="status">-</dd>
                                    </dl>
                                    <dl class="row mb-3">
                                        <dt class="col-sm-4 fw-bold">Người tạo:</dt>
                                        <dd class="col-sm-8" id="createdByName">-</dd>
                                    </dl>
                                    <dl class="row mb-3">
                                        <dt class="col-sm-4 fw-bold">Ngày tạo:</dt>
                                        <dd class="col-sm-8" id="createdAt">-</dd>
                                    </dl>
                                </div>
                                <div class="col-md-6">
                                    <dl class="row mb-3">
                                        <dt class="col-sm-4 fw-bold">Mô tả:</dt>
                                        <dd class="col-sm-8" id="description">-</dd>
                                    </dl>
                                    <dl class="row mb-3">
                                        <dt class="col-sm-4 fw-bold">Ghi chú:</dt>
                                        <dd class="col-sm-8" id="note">-</dd>
                                    </dl>
                                    <dl class="row mb-3">
                                        <dt class="col-sm-4 fw-bold">Chi nhánh:</dt>
                                        <dd class="col-sm-8" id="branchName">-</dd>
                                    </dl>
                                </div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <h5 class="mb-3">Danh sách các linh kiện</h5>
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="width: 60px;">STT</th>
                                            <th>Mã</th>
                                            <th>Tên</th>
                                            <th>Số Lượng</th>
                                        </tr>
                                    </thead>
                                    <tbody id="detailsTableBody">
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Thông báo -->
<div class="modal fade" id="messageModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header" id="messageModalHeader">
                <h5 class="modal-title" id="messageModalTitle">Thông báo</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="messageModalBody">
                <p id="messageModalText"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal" id="messageModalOkBtn">OK</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Xác nhận -->
<div class="modal fade" id="confirmModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-warning">
                <h5 class="modal-title">Xác nhận</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p id="confirmModalText"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" id="confirmModalCancelBtn">Hủy</button>
                <button type="button" class="btn btn-primary" id="confirmModalOkBtn">Xác nhận</button>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Nhập lý do hủy -->
<div class="modal fade" id="cancelNoteModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">Hủy yêu cầu nhập kho</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p class="mb-3">Nhập lý do hủy (nếu có):</p>
                <textarea class="form-control" id="cancelNoteInput" rows="3" placeholder="Nhập lý do hủy..."></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-danger" id="cancelNoteConfirmBtn">Xác nhận hủy</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Lấy ID từ URL - có thể là /StockInRequests/{id} hoặc /StockInRequests/Details/{id}
            const fullUrl = window.location.href;
            const pathname = window.location.pathname;
            const searchParams = new URLSearchParams(window.location.search);
            
            console.log('Full URL:', fullUrl);
            console.log('Pathname:', pathname);
            console.log('Search params:', searchParams.toString());
            
            let id = null;
            
            // Thử lấy từ query string trước
            const idFromQuery = searchParams.get('id');
            if (idFromQuery) {
                const parsed = parseInt(idFromQuery, 10);
                if (!isNaN(parsed) && parsed > 0) {
                    id = parsed;
                    console.log('Got ID from query string:', id);
                }
            }
            
            // Nếu không có trong query string, parse từ pathname
            if (!id) {
                const urlParts = pathname.split('/').filter(part => part.length > 0);
                console.log('URL parts:', urlParts);
                
                // Tìm phần cuối cùng là số
                for (let i = urlParts.length - 1; i >= 0; i--) {
                    const part = urlParts[i];
                    console.log(`Checking part[${i}]: "${part}"`);
                    const parsedId = parseInt(part, 10);
                    if (!isNaN(parsedId) && parsedId > 0) {
                        id = parsedId;
                        console.log('Found ID in pathname:', id);
                        break;
                    }
                }
            }
            
            console.log('Final parsed ID:', id);
            
            if (!id || id <= 0) {
                console.error('Invalid ID:', id);
                $('#loadingSpinner').html(`<p class="text-danger">ID không hợp lệ (${id}). URL: ${pathname}. Vui lòng quay lại danh sách.</p>`);
                return;
            }
            
            loadStockInRequestDetails(id);
        });

        function loadStockInRequestDetails(id) {
            if (!id || id <= 0) {
                $('#loadingSpinner').html('<p class="text-danger">ID không hợp lệ</p>');
                return;
            }
            
            console.log('Loading details for ID:', id);
            
            $.ajax({
                url: `/StockInRequests/${id}/Data`,
                method: 'GET',
                success: function(result) {
                    console.log('GetData response:', result);
                    console.log('Result type:', typeof result);
                    console.log('Result.success:', result?.success);
                    console.log('Result.data:', result?.data);
                    
                    // Kiểm tra cả success và data
                    if (result && (result.success === true || result.Success === true)) {
                        const data = result.data || result.Data;
                        if (data) {
                            console.log('Data object:', data);
                            populateDetails(data);
                            $('#loadingSpinner').hide();
                            $('#contentArea').show();
                        } else {
                            console.error('Data is null or undefined');
                            $('#loadingSpinner').html('<p class="text-danger">Không tìm thấy dữ liệu</p>');
                        }
                    } else {
                        const errorMsg = result?.message || result?.Message || 'Không tìm thấy dữ liệu';
                        console.error('Request failed:', errorMsg);
                        $('#loadingSpinner').html(`<p class="text-danger">${errorMsg}</p>`);
                    }
                },
                error: function(xhr, status, error) {
                    console.error('AJAX error:', xhr, status, error);
                    console.error('Response text:', xhr.responseText);
                    let errorMsg = 'Lỗi tải dữ liệu';
                    if (xhr.responseJSON) {
                        errorMsg = xhr.responseJSON.message || xhr.responseJSON.Message || errorMsg;
                    }
                    $('#loadingSpinner').html(`<p class="text-danger">${errorMsg}</p>`);
                }
            });
        }

        function populateDetails(data) {
            console.log('Populating details with data:', data);
            
            // Handle cả PascalCase và camelCase
            const code = data.code || data.Code || '-';
            const description = data.description || data.Description || '-';
            const note = data.note || data.Note || '-';
            const branchName = data.branchName || data.BranchName || '-';
            const statusCode = data.statusCode || data.StatusCode || '';
            const createdAt = data.createdAt || data.CreatedAt;
            const createdByName = data.createdByName || data.CreatedByName || '-';
            const lastModifiedDate = data.lastModifiedDate || data.LastModifiedDate;
            const stockInRequestId = data.stockInRequestId || data.StockInRequestId || data.id || data.Id || 0;
            const details = data.details || data.Details || [];
            
            $('#code').text(code);
            $('#description').text(description);
            $('#note').text(note);
            $('#branchName').text(branchName);
            
            let statusClass = 'bg-secondary';
            let statusText = 'Không xác định';
            if (statusCode === 'PENDING') {
                statusClass = 'bg-warning';
                statusText = 'Chờ duyệt';
            } else if (statusCode === 'APPROVED') {
                statusClass = 'bg-success';
                statusText = 'Đã duyệt';
            } else if (statusCode === 'CANCELLED') {
                statusClass = 'bg-danger';
                statusText = 'Đã hủy';
            } else if (statusCode === 'CREATED') {
                statusClass = 'bg-info';
                statusText = 'Đã tạo';
            } else if (statusCode === 'CANCELLED') {
                statusClass = 'bg-danger';
                statusText = 'Đã hủy';
            }
            $('#status').html(`<span class="badge ${statusClass}">${statusText}</span>`);

            $('#createdByName').text(createdByName);
            $('#createdAt').text(createdAt ? new Date(createdAt).toLocaleString('vi-VN') : '-');
            $('#lastModifiedDate').text(lastModifiedDate ? new Date(lastModifiedDate).toLocaleString('vi-VN') : '-');

            // Render details
            const tbody = $('#detailsTableBody');
            tbody.empty();
            if (details && details.length > 0) {
                console.log('Rendering details:', details);
                details.forEach(function(detail, index) {
                    const componentCode = detail.componentCode || detail.ComponentCode || detail.componentId || detail.ComponentId || '-';
                    const componentName = detail.componentName || detail.ComponentName || '-';
                    const quantity = detail.quantity || detail.Quantity || 0;
                    
                    const row = `
                        <tr>
                            <td>${index + 1}</td>
                            <td>${componentCode}</td>
                            <td>${componentName}</td>
                            <td>${quantity}</td>
                        </tr>
                    `;
                    tbody.append(row);
                });
            } else {
                console.log('No details found');
                tbody.html('<tr><td colspan="4" class="text-center text-muted">Không có dữ liệu</td></tr>');
            }

            // Render action buttons theo role và status
            const actionButtons = $('#actionButtons');
            actionButtons.empty();
            
            // Lấy role từ JWT token trong localStorage
            let roleId = 0;
            let roleName = '';
            
            try {
                const token = localStorage.getItem('authToken');
                if (token) {
                    const payload = JSON.parse(atob(token.split('.')[1]));
                    roleId = parseInt(payload['RoleId'] || payload['role_id'] || '0');
                    roleName = payload['http://schemas.microsoft.com/ws/2008/06/identity/claims/role'] || 
                               payload['role'] || 
                               payload['RoleName'] || 
                               '';
                    console.log('User role from JWT - RoleId:', roleId, 'RoleName:', roleName);
                }
            } catch (e) {
                console.error('Error parsing JWT token:', e);
            }
            
            // Fallback: Lấy từ sessionStorage nếu không có trong token
            if (!roleId || roleId === 0) {
                roleId = parseInt(sessionStorage.getItem('RoleId') || '0');
            }
            if (!roleName) {
                roleName = sessionStorage.getItem('RoleName') || '';
            }
            
            // Check role theo database:
            // id 2: Branch Manager (Giám đốc chi nhánh) - duyệt và hủy
            // id 5: Warehouse Keeper (Quản lý kho) - gửi đơn
            const roleNameLower = roleName.toLowerCase();
            const isBranchManager = roleNameLower.includes('branch manager') || 
                                   roleNameLower.includes('giám đốc') ||
                                   roleId === 2; // Chỉ roleId = 2 (Branch Manager)
            const isWarehouseKeeper = roleNameLower.includes('warehouse keeper') || 
                                     roleNameLower.includes('quản lý kho') ||
                                     roleNameLower.includes('warehouse') ||
                                     roleId === 5; // Chỉ roleId = 5 (Warehouse Keeper)
            
            console.log('Final role check - isBranchManager:', isBranchManager, 'isWarehouseKeeper:', isWarehouseKeeper);
            
            let buttonsHtml = '';
            
            // BRANCH MANAGER (roleId = 2): Có thể duyệt và hủy khi status = PENDING
            if (isBranchManager && statusCode === 'PENDING' && stockInRequestId > 0) {
                buttonsHtml = `
                    <button type="button" class="btn btn-success" onclick="approveRequest(${stockInRequestId})">
                        <i class="fas fa-check"></i> Duyệt
                    </button>
                    <button type="button" class="btn btn-danger" onclick="cancelRequest(${stockInRequestId})">
                        <i class="fas fa-times"></i> Hủy
                    </button>
                `;
            }
            // WAREHOUSE KEEPER (roleId = 5): Có thể gửi đơn khi status = CREATED hoặc CANCELLED
            else if (isWarehouseKeeper && (statusCode === 'CREATED' || statusCode === 'CANCELLED') && stockInRequestId > 0) {
                buttonsHtml = `
                    <button type="button" class="btn btn-primary" onclick="sendRequest(${stockInRequestId})">
                        <i class="fas fa-paper-plane"></i> Gửi đơn
                    </button>
                `;
            }
            
            if (buttonsHtml) {
                actionButtons.html(buttonsHtml);
            }
        }

        function sendRequest(id) {
            showConfirm('Bạn có chắc chắn muốn gửi yêu cầu này?', function() {
                $.ajax({
                    url: `/StockInRequests/${id}/Send`,
                    method: 'POST',
                    success: function(result) {
                        // Đóng tất cả modal
                        cleanupModals();
                        
                        if (result && result.success) {
                            showMessage('Thành công', 'Gửi yêu cầu nhập kho thành công', 'success', function() {
                                location.reload();
                            });
                        } else {
                            const errorMsg = result?.message || 'Không thể gửi yêu cầu';
                            showMessage('Lỗi', errorMsg, 'error');
                        }
                    },
                    error: function(xhr, status, error) {
                        cleanupModals();
                        let errorMsg = error;
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMsg = xhr.responseJSON.message;
                        } else if (xhr.responseJSON && xhr.responseJSON.error) {
                            errorMsg = xhr.responseJSON.error;
                        }
                        showMessage('Lỗi', errorMsg, 'error');
                    }
                });
            });
        }

        function approveRequest(id) {
            showConfirm('Bạn có chắc chắn muốn duyệt yêu cầu này?', function() {
                $.ajax({
                    url: `/StockInRequests/${id}/Approve`,
                    method: 'POST',
                    success: function(result) {
                        // Đóng tất cả modal
                        cleanupModals();
                        
                        if (result && result.success) {
                            showMessage('Thành công', 'Duyệt yêu cầu thành công', 'success', function() {
                                location.reload();
                            });
                        } else {
                            const errorMsg = result?.message || 'Không thể duyệt yêu cầu';
                            showMessage('Lỗi', errorMsg, 'error');
                        }
                    },
                    error: function(xhr, status, error) {
                        cleanupModals();
                        let errorMsg = error;
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMsg = xhr.responseJSON.message;
                        } else if (xhr.responseJSON && xhr.responseJSON.error) {
                            errorMsg = xhr.responseJSON.error;
                        }
                        showMessage('Lỗi', errorMsg, 'error');
                    }
                });
            });
        }

        function cancelRequest(id) {
            // Đóng tất cả modal cũ
            cleanupModals();
            
            // Reset input
            $('#cancelNoteInput').val('');
            
            // Lưu ID vào button để dùng sau
            $('#cancelNoteConfirmBtn').off('click').on('click', function() {
                const note = $('#cancelNoteInput').val() || '';
                
                // Đóng modal nhập lý do
                const modal = bootstrap.Modal.getInstance($('#cancelNoteModal')[0]);
                if (modal) {
                    modal.hide();
                }
                cleanupModals();
                
                $.ajax({
                    url: `/StockInRequests/${id}/Cancel`,
                    method: 'POST',
                    contentType: 'application/json',
                    data: JSON.stringify({ note: note }),
                    success: function(result) {
                        cleanupModals();
                        
                        if (result && result.success) {
                            showMessage('Thành công', 'Hủy yêu cầu thành công', 'success', function() {
                                location.reload();
                            });
                        } else {
                            const errorMsg = result?.message || 'Không thể hủy yêu cầu';
                            showMessage('Lỗi', errorMsg, 'error');
                        }
                    },
                    error: function(xhr, status, error) {
                        cleanupModals();
                        let errorMsg = error;
                        if (xhr.responseJSON && xhr.responseJSON.message) {
                            errorMsg = xhr.responseJSON.message;
                        } else if (xhr.responseJSON && xhr.responseJSON.error) {
                            errorMsg = xhr.responseJSON.error;
                        }
                        showMessage('Lỗi', errorMsg, 'error');
                    }
                });
            });
            
            // Hiển thị modal nhập lý do
            $('#cancelNoteModal').modal('show');
        }

        function showMessage(title, message, type, callback) {
            // Đóng tất cả modal đang mở trước
            cleanupModals();

            const modal = $('#messageModal');
            const header = $('#messageModalHeader');
            const titleEl = $('#messageModalTitle');
            const textEl = $('#messageModalText');
            const okBtn = $('#messageModalOkBtn');

            titleEl.text(title);
            textEl.text(message);

            // Set màu sắc theo type
            header.removeClass('bg-success bg-danger bg-warning bg-primary');
            okBtn.removeClass('btn-success btn-danger btn-warning');
            
            if (type === 'success') {
                header.addClass('bg-success text-white');
                okBtn.addClass('btn-success');
            } else if (type === 'error') {
                header.addClass('bg-danger text-white');
                okBtn.addClass('btn-danger');
            } else if (type === 'warning') {
                header.addClass('bg-warning text-dark');
                okBtn.addClass('btn-warning');
            } else {
                header.addClass('bg-primary text-white');
            }

            // Xóa callback cũ và thêm callback mới
            modal.off('hidden.bs.modal');
            if (callback) {
                modal.on('hidden.bs.modal', function() {
                    callback();
                });
            }

            // Hiển thị modal
            modal.modal('show');
        }

        function showConfirm(message, onConfirm) {
            // Đóng tất cả modal đang mở trước
            cleanupModals();

            const modal = $('#confirmModal');
            const textEl = $('#confirmModalText');
            const okBtn = $('#confirmModalOkBtn');
            const cancelBtn = $('#confirmModalCancelBtn');

            textEl.text(message);

            // Xóa event handlers cũ
            okBtn.off('click');
            cancelBtn.off('click');

            // Thêm event handlers mới
            okBtn.on('click', function() {
                const modalInstance = bootstrap.Modal.getInstance(modal[0]);
                if (modalInstance) {
                    modalInstance.hide();
                }
                cleanupModals();
                if (onConfirm) {
                    onConfirm();
                }
            });

            cancelBtn.on('click', function() {
                const modalInstance = bootstrap.Modal.getInstance(modal[0]);
                if (modalInstance) {
                    modalInstance.hide();
                }
                cleanupModals();
            });

            // Hiển thị modal
            modal.modal('show');
        }

        function cleanupModals() {
            // Đóng tất cả modal
            $('.modal').modal('hide');
            
            // Xóa backdrop và reset body styles
            setTimeout(function() {
                $('.modal-backdrop').remove();
                $('body').removeClass('modal-open');
                $('body').css('overflow', '');
                $('body').css('padding-right', '');
            }, 300);
        }
    </script>
}

