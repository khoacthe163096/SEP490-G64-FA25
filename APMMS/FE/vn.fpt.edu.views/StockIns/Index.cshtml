@{
    ViewData["Title"] = "Danh sách phiếu nhập kho";
    Layout = "~/vn.fpt.edu.views/Shared/_DashboardLayout.cshtml";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Danh sách phiếu nhập kho</h4>
                </div>
                <div class="card-body">
                    <!-- Action Bar -->
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <div class="d-flex gap-2">
                            <a href="/StockIns/Create" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Thêm mới
                            </a>
                            <select class="form-select" id="statusFilter" style="width: auto;">
                                <option value="">Chọn trạng thái</option>
                                <option value="PENDING">Chờ duyệt</option>
                                <option value="APPROVED">Đã duyệt</option>
                                <option value="COMPLETED">Hoàn thành</option>
                                <option value="CANCELLED">Đã hủy</option>
                            </select>
                        </div>
                        <div class="d-flex gap-2">
                            <input type="text" class="form-control" id="searchInput" placeholder="Tìm kiếm phiếu nhập kho" style="width: 300px;">
                        </div>
                    </div>

                    <!-- Table -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th style="width: 60px;">STT</th>
                                    <th>Mã</th>
                                    <th>Ngày tạo</th>
                                    <th>Tình trạng</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody id="stockInsTableBody">
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination Info and Controls -->
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div class="text-muted" id="paginationInfo">
                            Hiển thị <span id="showingFrom">0</span> - <span id="showingTo">0</span> của <span id="totalRecords">0</span> kết quả
                        </div>
                        <nav aria-label="Page navigation">
                            <ul class="pagination mb-0" id="pagination">
                            </ul>
                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let currentPage = 1;
        const pageSize = 10;
        let totalRecords = 0;
        let totalPages = 1;

        $(document).ready(function() {
            loadStockIns();

            let searchTimeout;
            $('#searchInput').on('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    currentPage = 1;
                    loadStockIns();
                }, 500);
            });

            $('#statusFilter').change(function() {
                currentPage = 1;
                loadStockIns();
            });
        });

        function loadStockIns() {
            const search = $('#searchInput').val();
            const status = $('#statusFilter').val();

            $('#stockInsTableBody').html(`
                <tr>
                    <td colspan="5" class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </td>
                </tr>
            `);

            $.ajax({
                url: '/StockIns/ListData',
                method: 'GET',
                data: {
                    page: currentPage,
                    pageSize: pageSize,
                    search: search,
                    statusCode: status
                },
                success: function(result) {
                    if (result.success && result.data) {
                        renderTable(result.data);
                        totalRecords = result.totalCount || 0;
                        totalPages = result.totalPages || 1;
                        updatePagination();
                    } else {
                        $('#stockInsTableBody').html('<tr><td colspan="5" class="text-center text-muted">Không có dữ liệu</td></tr>');
                        totalRecords = 0;
                        totalPages = 0;
                        updatePagination();
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error loading stock ins:', error);
                    $('#stockInsTableBody').html('<tr><td colspan="5" class="text-center text-danger">Lỗi tải dữ liệu: ' + error + '</td></tr>');
                    totalRecords = 0;
                    totalPages = 0;
                    updatePagination();
                }
            });
        }

        function renderTable(items) {
            const tbody = $('#stockInsTableBody');
            tbody.empty();

            if (!items || items.length === 0) {
                tbody.html('<tr><td colspan="5" class="text-center text-muted">Không có dữ liệu</td></tr>');
                return;
            }

            items.forEach(function(item, index) {
                let statusClass = 'bg-secondary';
                let statusText = 'Không xác định';
                if (item.statusCode === 'PENDING') {
                    statusClass = 'bg-warning';
                    statusText = 'Chờ duyệt';
                } else if (item.statusCode === 'APPROVED') {
                    statusClass = 'bg-success';
                    statusText = 'Đã duyệt';
                } else if (item.statusCode === 'COMPLETED') {
                    statusClass = 'bg-success';
                    statusText = 'Đã hoàn thành';
                } else if (item.statusCode === 'CANCELLED') {
                    statusClass = 'bg-danger';
                    statusText = 'Đã hủy';
                }

                const createdDate = item.createdAt ? new Date(item.createdAt).toLocaleString('vi-VN') : 'N/A';
                const code = item.code || item.stockInId || 'N/A';

                const row = `
                    <tr data-id="${item.stockInId}">
                        <td>${index + 1}</td>
                        <td><a href="/StockIns/${item.stockInId}" class="text-decoration-none fw-semibold">${code}</a></td>
                        <td>${createdDate}</td>
                        <td><span class="badge ${statusClass}">${statusText}</span></td>
                        <td>
                            <a href="/StockIns/${item.stockInId}" class="btn btn-sm btn-info" title="Xem chi tiết">
                                <i class="fas fa-eye"></i>
                            </a>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });
        }

        function updatePagination() {
            const showingFrom = totalRecords === 0 ? 0 : (currentPage - 1) * pageSize + 1;
            const showingTo = Math.min(currentPage * pageSize, totalRecords);
            
            $('#showingFrom').text(showingFrom);
            $('#showingTo').text(showingTo);
            $('#totalRecords').text(totalRecords);

            const pagination = $('#pagination');
            pagination.empty();

            if (totalPages <= 1) {
                return;
            }

            const prevDisabled = currentPage === 1 ? 'disabled' : '';
            pagination.append(`
                <li class="page-item ${prevDisabled}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;">Trước</a>
                </li>
            `);

            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    const active = i === currentPage ? 'active' : '';
                    pagination.append(`
                        <li class="page-item ${active}">
                            <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>
                        </li>
                    `);
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    pagination.append(`<li class="page-item disabled"><span class="page-link">...</span></li>`);
                }
            }

            const nextDisabled = currentPage === totalPages ? 'disabled' : '';
            pagination.append(`
                <li class="page-item ${nextDisabled}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;">Sau</a>
                </li>
            `);
        }

        function changePage(page) {
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            loadStockIns();
            $('html, body').animate({ scrollTop: 0 }, 'fast');
        }
    </script>
}

