@{
    ViewData["Title"] = "Tạo phiếu nhập kho";
    Layout = "~/vn.fpt.edu.views/Shared/_DashboardLayout.cshtml";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Tạo phiếu nhập kho</h4>
                    <a href="/StockIns" class="btn btn-secondary">
                        <i class="fas fa-arrow-left"></i> Quay lại
                    </a>
                </div>
                <div class="card-body">
                    <form id="createStockInForm">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="stockInRequestCode" class="form-label">Mã yêu cầu nhập kho <span class="text-danger">*</span></label>
                                <div class="input-group">
                                    <input type="text" class="form-control" id="stockInRequestCode" name="stockInRequestCode" placeholder="Nhập mã yêu cầu hoặc chọn từ danh sách" required>
                                    <button type="button" class="btn btn-outline-primary" id="selectRequestBtn">
                                        <i class="fas fa-search"></i> Chọn yêu cầu
                                    </button>
                                </div>
                                <small class="text-muted">Chỉ có thể tạo phiếu từ yêu cầu đã được duyệt (APPROVED)</small>
                            </div>
                        </div>

                        <div id="requestInfo" style="display: none;" class="mb-3">
                            <div class="alert alert-info">
                                <strong>Thông tin yêu cầu:</strong>
                                <div id="requestInfoContent"></div>
                            </div>
                        </div>

                        <div class="mb-4">
                            <h5 class="mb-3">Danh sách linh kiện</h5>
                            <div class="table-responsive">
                                <table class="table table-bordered table-hover">
                                    <thead class="table-light">
                                        <tr>
                                            <th style="width: 60px;">STT</th>
                                            <th>Mã linh kiện</th>
                                            <th>Tên linh kiện</th>
                                            <th>Loại</th>
                                            <th>Số lượng yêu cầu</th>
                                            <th>Số lượng thực tế</th>
                                            <th>Giá nhập</th>
                                            <th>Giá xuất</th>
                                        </tr>
                                    </thead>
                                    <tbody id="componentsTableBody">
                                        <tr>
                                            <td colspan="8" class="text-center text-muted">Vui lòng chọn yêu cầu nhập kho</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                        </div>

                        <div class="d-flex justify-content-end gap-2">
                            <a href="/StockIns" class="btn btn-secondary">Hủy</a>
                            <button type="submit" class="btn btn-primary" id="submitBtn" disabled>
                                <i class="fas fa-save"></i> Tạo phiếu nhập kho
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal: Chọn yêu cầu nhập kho -->
<div class="modal fade" id="selectRequestModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chọn yêu cầu nhập kho đã duyệt</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <input type="text" class="form-control" id="modalRequestSearch" placeholder="Tìm kiếm theo mã...">
                </div>
                <div class="table-responsive" style="max-height: 500px; overflow-y: auto;">
                    <table class="table table-hover">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th>Chọn</th>
                                <th>Mã yêu cầu</th>
                                <th>Mô tả</th>
                                <th>Chi nhánh</th>
                                <th>Số linh kiện</th>
                                <th>Ngày tạo</th>
                            </tr>
                        </thead>
                        <tbody id="availableRequestsTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                <button type="button" class="btn btn-primary" id="confirmSelectRequestBtn">Chọn</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let selectedRequest = null;
        let availableRequests = [];

        $(document).ready(function() {
            loadApprovedRequests();

            $('#selectRequestBtn').click(function() {
                $('#selectRequestModal').modal('show');
            });

            $('#modalRequestSearch').on('input', function() {
                filterAvailableRequests();
            });

            $('#confirmSelectRequestBtn').click(function() {
                const checked = $('input[type="radio"]:checked', '#availableRequestsTableBody');
                if (checked.length === 0) {
                    alert('Vui lòng chọn một yêu cầu');
                    return;
                }
                const requestId = checked.val();
                const request = availableRequests.find(r => r.stockInRequestId == requestId);
                if (request) {
                    selectRequest(request);
                    $('#selectRequestModal').modal('hide');
                }
            });

            $('#createStockInForm').submit(function(e) {
                e.preventDefault();
                createStockIn();
            });
        });

        function loadApprovedRequests() {
            $.ajax({
                url: '/StockInRequests/ListData',
                method: 'GET',
                data: { page: 1, pageSize: 1000, statusCode: 'APPROVED' },
                success: function(result) {
                    if (result.success && result.data) {
                        availableRequests = result.data;
                        renderAvailableRequests();
                    }
                }
            });
        }

        function renderAvailableRequests() {
            const tbody = $('#availableRequestsTableBody');
            tbody.empty();
            
            if (availableRequests.length === 0) {
                tbody.html('<tr><td colspan="6" class="text-center text-muted">Không có yêu cầu đã duyệt</td></tr>');
                return;
            }

            availableRequests.forEach(function(request) {
                const createdDate = request.createdAt ? new Date(request.createdAt).toLocaleDateString('vi-VN') : 'N/A';
                const detailCount = request.details ? request.details.length : 0;
                const row = `
                    <tr>
                        <td>
                            <input type="radio" name="selectedRequest" value="${request.stockInRequestId}">
                        </td>
                        <td>${request.code || ''}</td>
                        <td>${request.description || '-'}</td>
                        <td>${request.branchName || '-'}</td>
                        <td>${detailCount}</td>
                        <td>${createdDate}</td>
                    </tr>
                `;
                tbody.append(row);
            });
        }

        function filterAvailableRequests() {
            const search = $('#modalRequestSearch').val().toLowerCase();
            $('#availableRequestsTableBody tr').each(function() {
                const text = $(this).text().toLowerCase();
                $(this).toggle(text.includes(search));
            });
        }

        function selectRequest(request) {
            selectedRequest = request;
            $('#stockInRequestCode').val(request.code);
            
            // Hiển thị thông tin yêu cầu
            $('#requestInfoContent').html(`
                <div class="row mt-2">
                    <div class="col-md-6">
                        <strong>Mã:</strong> ${request.code || '-'}<br>
                        <strong>Mô tả:</strong> ${request.description || '-'}<br>
                        <strong>Chi nhánh:</strong> ${request.branchName || '-'}
                    </div>
                    <div class="col-md-6">
                        <strong>Người tạo:</strong> ${request.createdByName || '-'}<br>
                        <strong>Ngày tạo:</strong> ${request.createdAt ? new Date(request.createdAt).toLocaleString('vi-VN') : '-'}
                    </div>
                </div>
            `);
            $('#requestInfo').show();

            // Render components
            renderComponents(request.details || []);
            $('#submitBtn').prop('disabled', false);
        }

        function renderComponents(details) {
            const tbody = $('#componentsTableBody');
            tbody.empty();

            if (!details || details.length === 0) {
                tbody.html('<tr><td colspan="8" class="text-center text-muted">Không có linh kiện</td></tr>');
                return;
            }

            details.forEach(function(detail, index) {
                const importPrice = detail.importPricePerUnit ? new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(detail.importPricePerUnit) : '-';
                const exportPrice = detail.exportPricePerUnit ? new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(detail.exportPricePerUnit) : '-';
                const row = `
                    <tr>
                        <td>${index + 1}</td>
                        <td>${detail.componentCode || detail.componentId || '-'}</td>
                        <td>${detail.componentName || '-'}</td>
                        <td>${detail.typeComponentName || '-'}</td>
                        <td>${detail.quantity || 0}</td>
                        <td>
                            <input type="number" class="form-control form-control-sm" 
                                   value="${detail.quantity || 0}" min="0" 
                                   data-component-id="${detail.componentId}"
                                   style="width: 100px;">
                        </td>
                        <td>${importPrice}</td>
                        <td>${exportPrice}</td>
                    </tr>
                `;
                tbody.append(row);
            });
        }

        function createStockIn() {
            if (!selectedRequest) {
                alert('Vui lòng chọn yêu cầu nhập kho');
                return;
            }

            // Collect quantity after check
            const details = [];
            $('#componentsTableBody tr').each(function() {
                const componentId = $(this).find('input[type="number"]').data('component-id');
                const quantityAfterCheck = parseInt($(this).find('input[type="number"]').val()) || 0;
                if (componentId) {
                    const originalDetail = selectedRequest.details.find(d => d.componentId == componentId);
                    if (originalDetail) {
                        details.push({
                            componentId: componentId,
                            quantity: originalDetail.quantity,
                            quantityAfterCheck: quantityAfterCheck,
                            importPricePerUnit: originalDetail.importPricePerUnit,
                            exportPricePerUnit: originalDetail.exportPricePerUnit,
                            componentCode: originalDetail.componentCode,
                            componentName: originalDetail.componentName
                        });
                    }
                }
            });

            const formData = {
                stockInRequestId: selectedRequest.stockInRequestId,
                stockInRequestCode: selectedRequest.code,
                statusCode: 'CREATED',
                details: details
            };

            $.ajax({
                url: '/StockIns/Create',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(formData),
                success: function(result) {
                    if (result.success) {
                        alert('Tạo phiếu nhập kho thành công');
                        window.location.href = '/StockIns';
                    } else {
                        alert('Lỗi: ' + (result.message || 'Không thể tạo phiếu nhập kho'));
                    }
                },
                error: function(xhr, status, error) {
                    const errorMsg = xhr.responseJSON?.message || error;
                    alert('Lỗi: ' + errorMsg);
                }
            });
        }
    </script>
}

