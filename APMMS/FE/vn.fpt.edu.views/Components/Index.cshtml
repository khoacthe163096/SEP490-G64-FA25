@{
    ViewData["Title"] = "Danh sách linh kiện";
    Layout = "~/vn.fpt.edu.views/Shared/_DashboardLayout.cshtml";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">Danh sách linh kiện</h4>
                    <a href="/Components/Create" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Thêm linh kiện mới
                    </a>
                </div>
                <div class="card-body">
                    <!-- Search and Filter -->
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <input type="text" class="form-control" id="searchInput" placeholder="Tìm kiếm linh kiện...">
                        </div>
                        <div class="col-md-2">
                            <select class="form-select" id="statusFilter">
                                <option value="">Tất cả trạng thái</option>
                                <option value="ACTIVE">Có sẵn</option>
                                <option value="OUT_OF_STOCK">Hết hàng</option>
                                <option value="DISCONTINUED">Ngừng sản xuất</option>
                            </select>
                        </div>
                        <div class="col-md-2">
                            <button class="btn btn-outline-secondary" id="filterBtn">
                                <i class="fas fa-filter"></i> Lọc
                            </button>
                        </div>
                    </div>

                    <!-- Table -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover align-middle">
                            <thead class="table-dark">
                                <tr>
                                    <th>Mã</th>
                                    <th>Tên linh kiện</th>
                                    <th>Loại</th>
                                    <th>Số lượng</th>
                                    <th>Giá</th>
                                    <th>Chi nhánh</th>
                                    <th>Trạng thái</th>
                                    <th>Thao tác</th>
                                </tr>
                            </thead>
                            <tbody id="componentsTableBody">
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Pagination Info and Controls -->
                    <div class="d-flex justify-content-between align-items-center mt-3">
                        <div class="text-muted" id="paginationInfo">
                            Hiển thị <span id="showingFrom">0</span> - <span id="showingTo">0</span> của <span id="totalRecords">0</span> kết quả
                        </div>
                    <nav aria-label="Page navigation">
                            <ul class="pagination mb-0" id="pagination">
                        </ul>
                    </nav>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        let currentPage = 1;
        const pageSize = 10;
        let totalRecords = 0;
        let totalPages = 1;

        $(document).ready(function() {
            loadComponents();

            // Search với debounce
            let searchTimeout;
            $('#searchInput').on('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    currentPage = 1;
                    loadComponents();
                }, 500);
            });

            // Filter button
            $('#filterBtn').click(function() {
                currentPage = 1;
                loadComponents();
            });

            // Status filter change
            $('#statusFilter').change(function() {
                currentPage = 1;
                loadComponents();
            });
        });

        function loadComponents() {
            const search = $('#searchInput').val();
            const status = $('#statusFilter').val();

            // Show loading
            $('#componentsTableBody').html(`
                <tr>
                    <td colspan="8" class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Loading...</span>
                        </div>
                    </td>
                </tr>
            `);

            $.ajax({
                url: '/Components/ListData',
                method: 'GET',
                data: {
                    page: currentPage,
                    pageSize: pageSize,
                    search: search,
                    statusCode: status
                },
                success: function(result) {
                    if (result.success && result.data) {
                        renderTable(result.data);
                        totalRecords = result.totalCount || 0;
                        totalPages = result.totalPages || 1;
                        updatePagination();
                    } else {
                        $('#componentsTableBody').html('<tr><td colspan="8" class="text-center text-muted">Không có dữ liệu</td></tr>');
                        totalRecords = 0;
                        totalPages = 0;
                        updatePagination();
                    }
                },
                error: function(xhr, status, error) {
                    console.error('Error loading components:', error);
                    $('#componentsTableBody').html('<tr><td colspan="8" class="text-center text-danger">Lỗi tải dữ liệu: ' + error + '</td></tr>');
                    totalRecords = 0;
                    totalPages = 0;
                    updatePagination();
                }
            });
        }

        function renderTable(items) {
            const tbody = $('#componentsTableBody');
            tbody.empty();

            if (!items || items.length === 0) {
                tbody.html('<tr><td colspan="8" class="text-center text-muted">Không có dữ liệu</td></tr>');
                return;
            }

            items.forEach(function(item) {
                let statusClass = 'bg-secondary';
                let statusText = 'Không xác định';
                if (item.statusCode === 'ACTIVE') {
                    statusClass = 'bg-success';
                    statusText = 'Có sẵn';
                } else if (item.statusCode === 'OUT_OF_STOCK') {
                    statusClass = 'bg-warning';
                    statusText = 'Hết hàng';
                } else if (item.statusCode === 'DISCONTINUED') {
                    statusClass = 'bg-danger';
                    statusText = 'Ngừng sản xuất';
                }

                const branchName = item.branchName || item.branchId || 'N/A';
                const typeComponentName = item.typeComponentName || 'N/A';
                const unitPrice = item.unitPrice ? new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' }).format(item.unitPrice) : 'N/A';

                const row = `
                    <tr data-id="${item.id}">
                        <td>${item.code || item.id}</td>
                        <td>${item.name || ''}</td>
                        <td>${typeComponentName}</td>
                        <td>${item.quantityStock || 0}</td>
                        <td>${unitPrice}</td>
                        <td>${branchName}</td>
                        <td><span class="badge ${statusClass}">${statusText}</span></td>
                        <td>
                            <a href="/Components/Details/${item.id}" class="btn btn-sm btn-outline-info">
                                <i class="fas fa-eye"></i>
                            </a>
                            <a href="/Components/Edit/${item.id}" class="btn btn-sm btn-outline-primary">
                                <i class="fas fa-edit"></i>
                            </a>
                            <button class="btn btn-sm btn-outline-warning toggle-status" data-id="${item.id}" data-status="${item.statusCode}">
                                <i class="fas fa-toggle-on"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });

            // Bind toggle status event
            $('.toggle-status').click(function() {
                const id = $(this).data('id');
                const current = $(this).data('status');
                const next = current === 'ACTIVE' ? 'OUT_OF_STOCK' : 'ACTIVE';
                if (!confirm(`Xác nhận chuyển sang trạng thái "${next}"?`)) return;

                $.post('/Components/ToggleStatus', { id: id, statusCode: next })
                    .done(function(res) {
                        if (res.success) {
                            showAlert('Cập nhật trạng thái thành công!', 'success');
                            loadComponents();
                        } else {
                            showAlert('Không thể cập nhật trạng thái!', 'danger');
                        }
                    })
                    .fail(function() {
                        showAlert('Lỗi khi gọi API!', 'danger');
                    });
            });
        }

        function updatePagination() {
            const showingFrom = totalRecords === 0 ? 0 : (currentPage - 1) * pageSize + 1;
            const showingTo = Math.min(currentPage * pageSize, totalRecords);
            
            $('#showingFrom').text(showingFrom);
            $('#showingTo').text(showingTo);
            $('#totalRecords').text(totalRecords);

            const pagination = $('#pagination');
            pagination.empty();

            if (totalPages <= 1) {
                return;
            }

            // Previous button
            const prevDisabled = currentPage === 1 ? 'disabled' : '';
            pagination.append(`
                <li class="page-item ${prevDisabled}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage - 1}); return false;">Trước</a>
                </li>
            `);

            // Page numbers
            for (let i = 1; i <= totalPages; i++) {
                if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                    const active = i === currentPage ? 'active' : '';
                    pagination.append(`
                        <li class="page-item ${active}">
                            <a class="page-link" href="#" onclick="changePage(${i}); return false;">${i}</a>
                        </li>
                    `);
                } else if (i === currentPage - 3 || i === currentPage + 3) {
                    pagination.append(`<li class="page-item disabled"><span class="page-link">...</span></li>`);
                }
            }

            // Next button
            const nextDisabled = currentPage === totalPages ? 'disabled' : '';
            pagination.append(`
                <li class="page-item ${nextDisabled}">
                    <a class="page-link" href="#" onclick="changePage(${currentPage + 1}); return false;">Sau</a>
                </li>
            `);
        }

        function changePage(page) {
            if (page < 1 || page > totalPages) return;
            currentPage = page;
            loadComponents();
            $('html, body').animate({ scrollTop: 0 }, 'fast');
        }

        function showAlert(message, type = 'info') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
            alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);';
            alertDiv.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'danger' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'} me-2"></i>${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            document.body.appendChild(alertDiv);

            setTimeout(() => {
                if (alertDiv.parentNode) {
                    alertDiv.remove();
                }
            }, 3000);
        }
    </script>
}
